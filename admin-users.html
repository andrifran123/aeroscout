<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AeroScout Admin | Users</title>
    <style>
        :root {
            --nav: #0b2a6f;
            --nav2: #081a45;
            --text: #0e1830;
            --muted: #6b7890;
            --accent: #1b66ff;
            --accent2: #00b7a8;
            --danger: #e53935;
            --warning: #ff9800;
            --success: #4caf50;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
            background: linear-gradient(135deg, #07183d 0%, #0b2a6f 100%);
            min-height: 100vh;
            color: #fff;
        }

        .container {
            max-width: 1300px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* Header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 12px;
        }

        h1 {
            font-size: 2rem;
            margin: 0 0 6px 0;
        }

        .subtitle {
            color: rgba(255,255,255,0.6);
            margin: 0;
            font-size: 14px;
        }

        .nav-links {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .nav-link {
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            font-size: 14px;
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.15);
            background: rgba(255,255,255,0.07);
            transition: all 0.2s;
        }

        .nav-link:hover {
            background: rgba(255,255,255,0.14);
            color: #fff;
        }

        /* Stats grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 16px;
            margin: 28px 0;
        }

        .stat-box {
            background: rgba(255,255,255,0.08);
            border-radius: 14px;
            padding: 18px 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .stat-value {
            font-size: 30px;
            font-weight: 700;
            color: var(--accent);
            line-height: 1;
            margin-bottom: 6px;
        }

        .stat-value.green { color: var(--success); }
        .stat-value.yellow { color: var(--warning); }
        .stat-value.teal { color: var(--accent2); }
        .stat-value.red { color: var(--danger); }

        .stat-label {
            font-size: 12px;
            color: rgba(255,255,255,0.5);
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .toolbar-left {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-input {
            padding: 10px 16px;
            border-radius: 10px;
            border: 1.5px solid rgba(255,255,255,0.15);
            background: rgba(255,255,255,0.06);
            color: #fff;
            font-size: 14px;
            outline: none;
            width: 260px;
            transition: border-color 0.2s;
        }

        .search-input:focus {
            border-color: var(--accent);
        }

        .search-input::placeholder {
            color: rgba(255,255,255,0.35);
        }

        .filter-select {
            padding: 10px 14px;
            border-radius: 10px;
            border: 1.5px solid rgba(255,255,255,0.15);
            background: rgba(255,255,255,0.06);
            color: #fff;
            font-size: 14px;
            outline: none;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .filter-select:focus {
            border-color: var(--accent);
        }

        .filter-select option {
            background: #0b2a6f;
            color: #fff;
        }

        .btn-refresh {
            padding: 10px 18px;
            border-radius: 10px;
            border: 1.5px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.08);
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-refresh:hover {
            background: rgba(255,255,255,0.14);
        }

        .record-count {
            font-size: 13px;
            color: rgba(255,255,255,0.5);
            white-space: nowrap;
        }

        /* Table section */
        .table-section {
            background: rgba(255,255,255,0.04);
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.1);
            overflow: hidden;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        thead th {
            background: rgba(255,255,255,0.06);
            padding: 12px 14px;
            text-align: left;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: rgba(255,255,255,0.5);
            white-space: nowrap;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            cursor: pointer;
            user-select: none;
        }

        thead th:hover {
            color: rgba(255,255,255,0.8);
            background: rgba(255,255,255,0.1);
        }

        thead th .sort-icon {
            margin-left: 4px;
            opacity: 0.4;
        }

        thead th.sorted .sort-icon {
            opacity: 1;
            color: var(--accent);
        }

        tbody tr {
            border-bottom: 1px solid rgba(255,255,255,0.05);
            transition: background 0.15s;
        }

        tbody tr:last-child {
            border-bottom: none;
        }

        tbody tr:hover {
            background: rgba(255,255,255,0.04);
        }

        td {
            padding: 12px 14px;
            vertical-align: middle;
            color: rgba(255,255,255,0.85);
        }

        .td-email {
            font-weight: 500;
            max-width: 240px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 13px;
        }

        .td-email a {
            color: var(--accent);
            text-decoration: none;
        }

        .td-email a:hover {
            text-decoration: underline;
        }

        .td-date {
            white-space: nowrap;
            color: rgba(255,255,255,0.55);
            font-size: 12px;
        }

        .td-bool {
            text-align: center;
        }

        .td-alerts {
            text-align: center;
            font-weight: 600;
        }

        /* Status badges */
        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            white-space: nowrap;
        }

        .badge-active {
            background: rgba(76, 175, 80, 0.2);
            color: #6fdb73;
            border: 1px solid rgba(76, 175, 80, 0.4);
        }

        .badge-trial {
            background: rgba(255, 152, 0, 0.2);
            color: #ffb74d;
            border: 1px solid rgba(255, 152, 0, 0.4);
        }

        .badge-free {
            background: rgba(255,255,255,0.07);
            color: rgba(255,255,255,0.5);
            border: 1px solid rgba(255,255,255,0.15);
        }

        .badge-cancelled {
            background: rgba(229, 57, 53, 0.15);
            color: #ef9a9a;
            border: 1px solid rgba(229, 57, 53, 0.35);
        }

        .badge-unknown {
            background: rgba(255,255,255,0.05);
            color: rgba(255,255,255,0.35);
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* Boolean indicators */
        .bool-yes {
            color: var(--success);
            font-weight: 700;
        }

        .bool-no {
            color: rgba(255,255,255,0.25);
        }

        /* Loading and empty states */
        .state-panel {
            text-align: center;
            padding: 60px 20px;
            color: rgba(255,255,255,0.4);
        }

        .state-panel .state-icon {
            font-size: 40px;
            margin-bottom: 14px;
        }

        .state-panel p {
            margin: 0;
            font-size: 15px;
        }

        /* Access denied */
        .access-denied {
            text-align: center;
            padding: 80px 20px;
        }

        .access-denied .icon {
            font-size: 56px;
            margin-bottom: 20px;
        }

        .access-denied h2 {
            font-size: 1.8rem;
            margin: 0 0 12px 0;
            color: var(--danger);
        }

        .access-denied p {
            color: rgba(255,255,255,0.5);
            margin: 0 0 24px 0;
        }

        .access-denied a {
            color: var(--accent);
            text-decoration: none;
        }

        /* Error banner */
        .error-banner {
            background: rgba(229, 57, 53, 0.15);
            border: 1px solid rgba(229, 57, 53, 0.4);
            border-radius: 10px;
            padding: 12px 16px;
            margin-bottom: 20px;
            color: #ff6b6b;
            font-size: 14px;
            display: none;
        }

        .error-banner.show { display: block; }

        /* Spinner */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.2);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
            vertical-align: middle;
            margin-right: 8px;
        }

        /* Gumroad email cell */
        .gumroad-email {
            font-size: 11px;
            color: rgba(255,255,255,0.45);
            margin-top: 2px;
        }

        /* Row highlight for premium */
        tbody tr.row-premium {
            background: rgba(76, 175, 80, 0.04);
        }

        tbody tr.row-trial {
            background: rgba(255, 152, 0, 0.03);
        }

        /* Tooltip-style full text on hover for truncated cells */
        td[title] {
            cursor: default;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            padding: 16px;
            border-top: 1px solid rgba(255,255,255,0.07);
        }

        .page-btn {
            padding: 6px 14px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.15);
            background: rgba(255,255,255,0.06);
            color: #fff;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .page-btn:hover:not(:disabled) {
            background: rgba(255,255,255,0.12);
        }

        .page-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .page-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            font-weight: 600;
        }

        .page-info {
            font-size: 13px;
            color: rgba(255,255,255,0.45);
            padding: 0 8px;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 600px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .search-input {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="mainContainer">

        <!-- Access Denied State (hidden by default) -->
        <div id="accessDenied" style="display: none;">
            <div class="access-denied">
                <div class="icon">&#128274;</div>
                <h2>Access Denied</h2>
                <p>You must be signed in as an administrator to view this page.</p>
                <a href="index.html">Return to site</a>
            </div>
        </div>

        <!-- Main Admin Content -->
        <div id="adminContent" style="display: none;">

            <div class="page-header">
                <div>
                    <h1>User Management</h1>
                    <p class="subtitle">AeroScout subscriber and account overview</p>
                </div>
                <div class="nav-links">
                    <a href="admin-airlines.html" class="nav-link">Airline Manager</a>
                    <a href="index.html" class="nav-link">Main Site</a>
                </div>
            </div>

            <!-- Error Banner -->
            <div class="error-banner" id="errorBanner"></div>

            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-value" id="statTotal">-</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value teal" id="statConfirmed">-</div>
                    <div class="stat-label">Confirmed</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value green" id="statPremium">-</div>
                    <div class="stat-label">Premium (Paid)</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value yellow" id="statTrial">-</div>
                    <div class="stat-label">Trial</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="statFree">-</div>
                    <div class="stat-label">Free</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value teal" id="statAlerts">-</div>
                    <div class="stat-label">Active Job Alerts</div>
                </div>
            </div>

            <!-- Toolbar -->
            <div class="toolbar">
                <div class="toolbar-left">
                    <input
                        type="text"
                        class="search-input"
                        id="searchInput"
                        placeholder="Search by email..."
                    >
                    <select class="filter-select" id="statusFilter">
                        <option value="">All statuses</option>
                        <option value="active">Active / Paid</option>
                        <option value="trial">Trial</option>
                        <option value="free">Free</option>
                        <option value="cancelled">Cancelled</option>
                        <option value="premium">Is Premium</option>
                    </select>
                    <button class="btn-refresh" id="refreshBtn">Refresh</button>
                </div>
                <div class="record-count" id="recordCount"></div>
            </div>

            <!-- Table -->
            <div class="table-section">
                <div class="table-wrapper">
                    <table id="usersTable">
                        <thead>
                            <tr>
                                <th onclick="sortTable('email')" id="th-email">
                                    Email <span class="sort-icon">&#8597;</span>
                                </th>
                                <th onclick="sortTable('created_at')" id="th-created_at" class="sorted">
                                    Signed Up <span class="sort-icon">&#8595;</span>
                                </th>
                                <th onclick="sortTable('subscription_status')" id="th-subscription_status">
                                    Status <span class="sort-icon">&#8597;</span>
                                </th>
                                <th onclick="sortTable('is_premium')" id="th-is_premium">
                                    Premium <span class="sort-icon">&#8597;</span>
                                </th>
                                <th onclick="sortTable('premium_since')" id="th-premium_since">
                                    Premium Since <span class="sort-icon">&#8597;</span>
                                </th>
                                <th onclick="sortTable('trial_ends_at')" id="th-trial_ends_at">
                                    Trial Ends <span class="sort-icon">&#8597;</span>
                                </th>
                                <th onclick="sortTable('alert_count')" id="th-alert_count">
                                    Alerts <span class="sort-icon">&#8597;</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="7">
                                    <div class="state-panel">
                                        <div><span class="spinner"></span> Loading users...</div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="paginationBar"></div>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://ziboktbmbyjbhifsdypa.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InppYm9rdGJtYnlqYmhpZnNkeXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3NjMwODUsImV4cCI6MjA4MjMzOTA4NX0.eayvAsTuezEJZ-SIvEjZmrYaUxmJtntV8pK8fyUBnbY';
        const ADMIN_EMAIL = 'andrifreyr9@gmail.com';

        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ── State ──────────────────────────────────────────────────────────────
        let allUsers = [];       // Full dataset (profiles merged with alert counts)
        let filteredUsers = [];  // After search + filter
        let sortKey = 'created_at';
        let sortDir = 'desc';    // 'asc' | 'desc'

        const PAGE_SIZE = 50;
        let currentPage = 1;

        // ── Boot ───────────────────────────────────────────────────────────────
        async function boot() {
            const { data: { session } } = await db.auth.getSession();

            if (!session || session.user.email !== ADMIN_EMAIL) {
                document.getElementById('accessDenied').style.display = 'block';
                return;
            }

            document.getElementById('adminContent').style.display = 'block';
            await loadData();
        }

        // ── Load Data ──────────────────────────────────────────────────────────
        async function loadData() {
            setTableLoading(true);
            hideError();

            try {
                // Fetch all profiles (paginate to avoid 1000-row cap)
                let profiles = [];
                let from = 0;
                const pageSize = 1000;
                while (true) {
                    const { data: batch, error: batchErr } = await db
                        .from('profiles')
                        .select('*')
                        .order('created_at', { ascending: false })
                        .range(from, from + pageSize - 1);

                    if (batchErr) throw batchErr;
                    if (!batch || batch.length === 0) break;
                    profiles = profiles.concat(batch);
                    if (batch.length < pageSize) break;
                    from += pageSize;
                }

                // Fetch active alert counts grouped by user_id
                const { data: alertData, error: alertErr } = await db
                    .from('job_alert_subscriptions')
                    .select('user_id, active')
                    .eq('active', true);

                // Aggregate alert counts client-side (no GROUP BY in anon key RPC)
                const alertMap = {};
                let totalAlerts = 0;
                if (alertData) {
                    for (const row of alertData) {
                        alertMap[row.user_id] = (alertMap[row.user_id] || 0) + 1;
                        totalAlerts++;
                    }
                }

                // Merge alert counts into profiles
                allUsers = profiles.map(p => ({
                    ...p,
                    alert_count: alertMap[p.id] || 0
                }));

                // Compute and render stats
                renderStats(allUsers, totalAlerts);

                // Apply current filter/sort
                applyFiltersAndSort();

            } catch (err) {
                showError('Failed to load data: ' + err.message);
                setTableLoading(false);
            }
        }

        // ── Stats ──────────────────────────────────────────────────────────────
        function renderStats(users, totalAlerts) {
            const total = users.length;

            // "Confirmed" = has email_confirmed_at or confirmed_at set (proxy: has any subscription_status OR is_premium)
            // Since we don't have auth.users, we approximate confirmed as profiles that have been active in some way
            // Best proxy: profile exists (all profiles are from confirmed signups in most setups)
            // We'll show total as confirmed since profiles are only created post-confirmation
            const confirmed = users.filter(u =>
                u.subscription_status || u.is_premium || u.gumroad_customer_email
            ).length;

            const premium = users.filter(u => u.is_premium === true).length;

            const trial = users.filter(u => {
                const s = (u.subscription_status || '').toLowerCase();
                return s === 'trial' || s === 'trialing';
            }).length;

            const cancelled = users.filter(u => {
                const s = (u.subscription_status || '').toLowerCase();
                return s === 'cancelled' || s === 'canceled';
            }).length;

            const free = users.filter(u => {
                if (u.is_premium) return false;
                const s = (u.subscription_status || '').toLowerCase();
                return !s || s === 'free' || s === 'inactive';
            }).length;

            document.getElementById('statTotal').textContent = total;
            document.getElementById('statConfirmed').textContent = confirmed;
            document.getElementById('statPremium').textContent = premium;
            document.getElementById('statTrial').textContent = trial;
            document.getElementById('statFree').textContent = free;
            document.getElementById('statAlerts').textContent = totalAlerts;
        }

        // ── Filter + Sort ──────────────────────────────────────────────────────
        function applyFiltersAndSort() {
            const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;

            // Filter
            filteredUsers = allUsers.filter(u => {
                // Search
                if (searchTerm) {
                    const email = (u.email || u.gumroad_customer_email || '').toLowerCase();
                    const gumroad = (u.gumroad_customer_email || '').toLowerCase();
                    if (!email.includes(searchTerm) && !gumroad.includes(searchTerm)) {
                        return false;
                    }
                }

                // Status filter
                if (statusFilter) {
                    const s = (u.subscription_status || '').toLowerCase();
                    if (statusFilter === 'active') {
                        const isActive = s === 'active' || s === 'paid' || u.is_premium;
                        if (!isActive) return false;
                    } else if (statusFilter === 'trial') {
                        if (s !== 'trial' && s !== 'trialing') return false;
                    } else if (statusFilter === 'free') {
                        if (u.is_premium) return false;
                        if (s && s !== 'free' && s !== 'inactive' && s !== '') return false;
                    } else if (statusFilter === 'cancelled') {
                        if (s !== 'cancelled' && s !== 'canceled') return false;
                    } else if (statusFilter === 'premium') {
                        if (!u.is_premium) return false;
                    }
                }

                return true;
            });

            // Sort
            filteredUsers.sort((a, b) => {
                let valA = a[sortKey];
                let valB = b[sortKey];

                // Handle nulls — always push to bottom
                if (valA === null || valA === undefined) valA = sortDir === 'asc' ? '\uFFFF' : '';
                if (valB === null || valB === undefined) valB = sortDir === 'asc' ? '\uFFFF' : '';

                if (typeof valA === 'boolean') {
                    valA = valA ? 1 : 0;
                    valB = valB ? 1 : 0;
                }

                if (typeof valA === 'number' && typeof valB === 'number') {
                    return sortDir === 'asc' ? valA - valB : valB - valA;
                }

                const strA = String(valA).toLowerCase();
                const strB = String(valB).toLowerCase();
                const cmp = strA.localeCompare(strB);
                return sortDir === 'asc' ? cmp : -cmp;
            });

            currentPage = 1;
            renderTable();
            renderPagination();
            updateRecordCount();
        }

        // ── Sort ───────────────────────────────────────────────────────────────
        function sortTable(key) {
            if (sortKey === key) {
                sortDir = sortDir === 'asc' ? 'desc' : 'asc';
            } else {
                sortKey = key;
                sortDir = key === 'created_at' || key === 'premium_since' || key === 'trial_ends_at' ? 'desc' : 'asc';
            }

            // Update header classes and icons
            document.querySelectorAll('thead th').forEach(th => {
                th.classList.remove('sorted');
                const icon = th.querySelector('.sort-icon');
                if (icon) icon.innerHTML = '&#8597;';
            });

            const activeTh = document.getElementById('th-' + key);
            if (activeTh) {
                activeTh.classList.add('sorted');
                const icon = activeTh.querySelector('.sort-icon');
                if (icon) icon.innerHTML = sortDir === 'asc' ? '&#8593;' : '&#8595;';
            }

            applyFiltersAndSort();
        }

        // ── Render Table ───────────────────────────────────────────────────────
        function renderTable() {
            const tbody = document.getElementById('usersTableBody');

            if (filteredUsers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7">
                            <div class="state-panel">
                                <div class="state-icon">&#128269;</div>
                                <p>No users match your filters.</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            const start = (currentPage - 1) * PAGE_SIZE;
            const end = start + PAGE_SIZE;
            const pageUsers = filteredUsers.slice(start, end);

            const rows = pageUsers.map(u => {
                const statusBadge = getStatusBadge(u);
                const rowClass = u.is_premium ? 'row-premium' : (isTrialUser(u) ? 'row-trial' : '');

                const displayEmail = u.email || u.gumroad_customer_email || '<span style="color:rgba(255,255,255,0.3)">unknown</span>';
                const gumroadLine = u.gumroad_customer_email && u.gumroad_customer_email !== u.email
                    ? `<div class="gumroad-email">Gumroad: ${esc(u.gumroad_customer_email)}</div>`
                    : '';

                return `
                    <tr class="${rowClass}">
                        <td class="td-email" title="${esc(u.email || u.gumroad_customer_email || '')}">
                            ${u.email ? esc(u.email) : displayEmail}
                            ${gumroadLine}
                        </td>
                        <td class="td-date">${formatDate(u.created_at)}</td>
                        <td>${statusBadge}</td>
                        <td class="td-bool">${u.is_premium ? '<span class="bool-yes">Yes</span>' : '<span class="bool-no">No</span>'}</td>
                        <td class="td-date">${u.premium_since ? formatDate(u.premium_since) : '<span style="color:rgba(255,255,255,0.2)">—</span>'}</td>
                        <td class="td-date">${u.trial_ends_at ? formatDate(u.trial_ends_at) : '<span style="color:rgba(255,255,255,0.2)">—</span>'}</td>
                        <td class="td-alerts">${u.alert_count > 0 ? `<span style="color:var(--accent2)">${u.alert_count}</span>` : '<span style="color:rgba(255,255,255,0.2)">0</span>'}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = rows.join('');
        }

        // ── Pagination ─────────────────────────────────────────────────────────
        function renderPagination() {
            const bar = document.getElementById('paginationBar');
            const totalPages = Math.ceil(filteredUsers.length / PAGE_SIZE);

            if (totalPages <= 1) {
                bar.innerHTML = '';
                return;
            }

            let html = '';

            html += `<button class="page-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>&lsaquo; Prev</button>`;

            // Show up to 7 page buttons, with ellipsis
            const pages = getPaginationPages(currentPage, totalPages);
            let lastPage = null;
            for (const p of pages) {
                if (lastPage !== null && p > lastPage + 1) {
                    html += `<span class="page-info">...</span>`;
                }
                html += `<button class="page-btn ${p === currentPage ? 'active' : ''}" onclick="goToPage(${p})">${p}</button>`;
                lastPage = p;
            }

            html += `<button class="page-btn" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next &rsaquo;</button>`;

            bar.innerHTML = html;
        }

        function getPaginationPages(current, total) {
            if (total <= 7) {
                return Array.from({ length: total }, (_, i) => i + 1);
            }
            const pages = new Set([1, 2, total - 1, total]);
            for (let i = Math.max(1, current - 1); i <= Math.min(total, current + 1); i++) {
                pages.add(i);
            }
            return Array.from(pages).sort((a, b) => a - b);
        }

        function goToPage(page) {
            const totalPages = Math.ceil(filteredUsers.length / PAGE_SIZE);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            renderTable();
            renderPagination();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function updateRecordCount() {
            const el = document.getElementById('recordCount');
            const total = filteredUsers.length;
            const allCount = allUsers.length;
            if (total === allCount) {
                el.textContent = `${total} users`;
            } else {
                el.textContent = `${total} of ${allCount} users`;
            }
        }

        // ── Helpers ────────────────────────────────────────────────────────────
        function isTrialUser(u) {
            const s = (u.subscription_status || '').toLowerCase();
            return s === 'trial' || s === 'trialing';
        }

        function getStatusBadge(u) {
            const s = (u.subscription_status || '').toLowerCase();

            if (s === 'active' || s === 'paid') {
                return `<span class="badge badge-active">Active</span>`;
            }
            if (s === 'trial' || s === 'trialing') {
                return `<span class="badge badge-trial">Trial</span>`;
            }
            if (s === 'cancelled' || s === 'canceled') {
                return `<span class="badge badge-cancelled">Cancelled</span>`;
            }
            if (u.is_premium) {
                return `<span class="badge badge-active">Premium</span>`;
            }
            if (!s || s === 'free' || s === 'inactive') {
                return `<span class="badge badge-free">Free</span>`;
            }
            // Unknown status — display raw value
            return `<span class="badge badge-unknown">${esc(u.subscription_status)}</span>`;
        }

        function formatDate(iso) {
            if (!iso) return '—';
            try {
                const d = new Date(iso);
                return d.toLocaleDateString('en-GB', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                }) + ' ' + d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
            } catch (e) {
                return iso;
            }
        }

        function esc(str) {
            if (!str) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function setTableLoading(isLoading) {
            if (isLoading) {
                document.getElementById('usersTableBody').innerHTML = `
                    <tr>
                        <td colspan="7">
                            <div class="state-panel">
                                <div><span class="spinner"></span> Loading users...</div>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }

        function showError(msg) {
            const el = document.getElementById('errorBanner');
            el.textContent = msg;
            el.classList.add('show');
        }

        function hideError() {
            document.getElementById('errorBanner').classList.remove('show');
        }

        // ── Event Listeners ────────────────────────────────────────────────────
        document.getElementById('searchInput').addEventListener('input', () => applyFiltersAndSort());
        document.getElementById('statusFilter').addEventListener('change', () => applyFiltersAndSort());
        document.getElementById('refreshBtn').addEventListener('click', () => loadData());

        // ── Init ───────────────────────────────────────────────────────────────
        boot();
    </script>
</body>
</html>
