<!doctype html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=AW-17913572733"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'AW-17913572733');
  </script>
  <!-- Event snippet for Page view conversion page -->
  <script>
    function gtag_report_conversion(url) {
      var callback = function () {
        if (typeof(url) != 'undefined') {
          window.location = url;
        }
      };
      gtag('event', 'conversion', {
        'send_to': 'AW-17913572733/GUwKCJ61xu4bEJT30t1C',
        'value': 1.0,
        'currency': 'USD',
        'event_callback': callback
      });
      return false;
    }
  </script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Browse 1000+ pilot jobs and cabin crew positions worldwide. Find openings at Emirates, Qatar Airways, Ryanair, easyJet and more. Updated daily with new aviation jobs." />
  <meta name="robots" content="index, follow" />
  <title>AeroScout | Browse Pilot & Cabin Crew Jobs</title>
  <link rel="canonical" href="https://www.aeroscout.net/Jobs.html" />
  <meta property="og:title" content="AeroScout | Browse Pilot & Cabin Crew Jobs" />
  <meta property="og:description" content="Browse 1000+ pilot jobs and cabin crew positions worldwide. Find openings at Emirates, Qatar Airways, Ryanair, easyJet and more." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://www.aeroscout.net/Jobs.html" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="AeroScout | Browse Pilot & Cabin Crew Jobs" />
  <meta name="twitter:description" content="Browse 1000+ pilot jobs and cabin crew positions worldwide." />
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "AeroScout",
    "url": "https://www.aeroscout.net",
    "description": "The largest aviation job database for pilots and cabin crew"
  }
  </script>
  <!-- Mapbox GL JS - lazy loaded when map is opened -->
  <style>
    :root{
      --nav:#0b2a6f;
      --nav2:#081a45;
      --text:#0e1830;
      --muted:#6b7890;
      --accent:#1b66ff;
      --accent2:#00b7a8;

      --shadow: 0 18px 46px rgba(13, 36, 90, .14);
      --softShadow: 0 10px 26px rgba(13, 36, 90, .10);

      --radius:22px;
      --maxw:1540px;

      --borderSoft: rgba(255,255,255,.22);
      --innerStroke: rgba(12, 28, 64, .05);
      --lineSoft: rgba(210,222,245,.55);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:#07183d;
    }

    /* AEROSCOUT Logo - inside topbar */
    .site-logo {
      text-decoration: none;
      color: white;
      font-size: 1.4rem;
      font-weight: 800;
      letter-spacing: 0.5px;
      white-space: nowrap;
    }
    @media (max-width: 1100px) {
      .site-logo {
        font-size: 1.25rem;
      }
    }
    @media (max-width: 768px) {
      .site-logo {
        font-size: 1.1rem;
      }
    }

    /* ✅ AIRPLANE BACKGROUND THAT READS AS "WING + SKY" */
    .stage{
      min-height:100%;
      position:relative;
      background:#07183d; /* fallback */
    }

    /* Photo layer (blurred slightly so UI is readable but still clearly a photo) */
    .stage::before{
      content:"";
      position:fixed;
      inset:-24px; /* extend so blur doesn’t show edges */
      z-index:0;

      /* IMPORTANT: This image is DIFFERENT from the one you posted. */
      background-image: url("/images/jobs-bg.webp");
      background-size: cover;
      background-position: 78% center; /* push wing into the visible right side */
      background-repeat:no-repeat;

      filter: blur(2.5px) saturate(1.15) contrast(1.05);
      transform: scale(1.03);
    }

    /* Overlay layer (lighter than before so the wing/sky is visible) */
    .stage::after{
      content:"";
      position:fixed;
      inset:0;
      z-index:1;
      pointer-events:none;

      background:
        radial-gradient(1100px 700px at 70% 15%, rgba(255,255,255,.22), transparent 62%),
        radial-gradient(900px 600px at 20% 25%, rgba(27,102,255,.14), transparent 62%),
        radial-gradient(900px 600px at 85% 35%, rgba(0,183,168,.10), transparent 62%),
        linear-gradient(180deg, rgba(7,24,61,.55), rgba(255,255,255,.10) 55%, rgba(255,255,255,.20));
    }

    .shell{
      max-width: 1900px;
      margin: 0 auto;
      padding: 22px 18px 0;
      position:relative;
      z-index:2; /* above background layers */
      min-height: 100vh;
    }

    .frame{
      background: rgba(255,255,255,.78);
      border: 1px solid var(--borderSoft);
      border-bottom: none;
      border-radius: calc(var(--radius) + 10px) calc(var(--radius) + 10px) 0 0;
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      padding: 12px;
      padding-bottom: 0;
      min-height: calc(100vh - 22px);
    }

    .topbar{
      background: linear-gradient(90deg, var(--nav), var(--nav2));
      border-radius: 18px;
      padding: 14px;
      color:#fff;
      box-shadow: var(--softShadow);
      position:sticky;
      top:14px;
      z-index:10;
      border: 1px solid rgba(255,255,255,.10);
    }

    .topbar-row{
      display:grid;
      grid-template-columns: auto 1fr 1fr auto auto auto;
      gap: 16px;
      align-items:center;
    }

    /* Topbar responsive - hide location dropdown to make room on smaller screens */
    @media (max-width: 1200px) {
      .topbar-row {
        grid-template-columns: auto 1fr auto auto auto;
        gap: 12px;
      }
      .topbar-row > .pill:has(select) {
        display: none;
      }
      .pill {
        padding: 12px 16px;
      }
      .pill input {
        font-size: 14px;
      }
      .btn {
        padding: 10px 16px;
        font-size: 14px;
      }
      .meta {
        grid-column: 1 / -1;
      }
    }


    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      letter-spacing:.2px;
      white-space:nowrap;
    }
    .logo{
      width:34px;height:34px;
      border-radius:10px;
      background:
        radial-gradient(circle at 30% 30%, #ffffff, rgba(255,255,255,.0) 55%),
        linear-gradient(135deg, rgba(27,102,255,1), rgba(0,183,168,1));
      box-shadow: 0 6px 18px rgba(0,0,0,.18);
      position:relative;
    }
    .logo:after{
      content:"";
      position:absolute; inset:9px 8px 9px 8px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,.55);
    }

    .pill{
      display:flex;
      align-items:center;
      gap:10px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 999px;
      padding: 14px 18px;
      backdrop-filter: blur(10px);
    }
    .pill input, .pill select{
      width:100%;
      background: transparent;
      border:none;
      outline:none;
      color:#fff;
      font-size: 15px;
    }
    .pill select option{color:#111}
    .pill .icon{width:18px;height:18px;opacity:.9;flex:0 0 auto}

    .btn{
      background: linear-gradient(135deg, #ffffff, #dbe8ff);
      color: #0b2a6f;
      border:none;
      border-radius: 999px;
      padding: 11px 14px;
      font-weight:800;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:10px;
      box-shadow: 0 10px 18px rgba(0,0,0,.18);
      transition: transform .12s ease, filter .12s ease;
      white-space:nowrap;
    }
    .btn:hover{transform: translateY(-1px); filter: brightness(1.02);}
    .btn:active{transform: translateY(0); filter: brightness(.98);}

    .saved-jobs-btn {
      position: relative;
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.2);
      cursor: pointer;
      padding: 9px 14px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      gap: 6px;
      color: #fff;
      font-size: 13px;
      font-weight: 700;
      font-family: 'Inter', sans-serif;
      transition: background 0.15s, transform 0.12s;
      white-space: nowrap;
    }
    .saved-jobs-btn svg {
      flex-shrink: 0;
    }
    .saved-jobs-btn:hover {
      background: rgba(255,255,255,0.22);
      transform: translateY(-1px);
    }
    .saved-jobs-btn.active {
      background: rgba(27,102,255,0.5);
      border-color: rgba(27,102,255,0.7);
    }
    .saved-badge {
      background: none;
      color: rgba(255,255,255,0.9);
      font-size: 13px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }

    .meta{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:10px;
      font-size:13px;
      opacity:.92;
      white-space:nowrap;
    }

    .grid{
      display:grid;
      grid-template-columns: 300px 1fr;
      gap:16px;
      margin-top:14px;
      align-items:start;
    }

    .panel{
      background: rgba(255,255,255,.86);
      border: 1px solid var(--borderSoft);
      border-radius: var(--radius);
      box-shadow: var(--softShadow);
      overflow:hidden;
      position:relative;
    }
    .panel::before{
      content:"";
      position:absolute; inset:0;
      border-radius: inherit;
      box-shadow: inset 0 0 0 1px var(--innerStroke);
      pointer-events:none;
    }

    .filters{ padding:20px; }
    #filtersPanel{ position:sticky; top:20px; align-self:start; max-height:calc(100vh - 40px); overflow-y:auto; }

    /* Profile Summary Card */
    .profile-summary {
      background: #0a192f;
      color: white;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 24px;
    }
    .profile-label {
      font-size: 11px;
      opacity: 0.7;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .profile-val {
      font-size: 14px;
      font-weight: 700;
      margin: 4px 0 12px 0;
      display: block;
    }
    .profile-summary .eligible-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .profile-summary .eligible-toggle label {
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
    }
    .profile-summary input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }
    .profile-summary .edit-profile-btn {
      background: rgba(255,255,255,0.15);
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
      margin-top: 10px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .profile-summary .edit-profile-btn:hover {
      background: rgba(255,255,255,0.25);
    }

    /* Profile Editor Modal */
    .profile-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.6);
      z-index: 10000;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(4px);
    }
    .profile-modal-overlay.active {
      display: flex;
    }
    .profile-modal {
      background: white;
      border-radius: 16px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .profile-modal-header {
      background: #0a192f;
      color: white;
      padding: 20px 24px;
      border-radius: 16px 16px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .profile-modal-header h2 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
    }
    .profile-modal-close {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.2s;
    }
    .profile-modal-close:hover {
      opacity: 1;
    }
    .profile-modal-body {
      padding: 24px;
    }
    .profile-form-section {
      margin-bottom: 24px;
    }
    .profile-form-section h3 {
      font-size: 13px;
      font-weight: 700;
      color: #0a192f;
      margin: 0 0 12px 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .profile-form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }
    .profile-form-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .profile-form-group.full-width {
      grid-column: span 2;
    }
    .profile-form-group label {
      font-size: 11px;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
    }
    .profile-form-group input,
    .profile-form-group select {
      padding: 10px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s;
    }
    .profile-form-group input:focus,
    .profile-form-group select:focus {
      outline: none;
      border-color: #1e3a5f;
    }
    .type-ratings-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .type-rating-chip {
      display: flex;
      align-items: center;
      gap: 6px;
      background: #e8f4fd;
      color: #1e3a5f;
      padding: 6px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    .type-rating-chip .remove-rating {
      background: none;
      border: none;
      color: #1e3a5f;
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
      opacity: 0.6;
    }
    .type-rating-chip .remove-rating:hover {
      opacity: 1;
    }
    .add-type-rating {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    .add-type-rating input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 13px;
    }
    .add-type-rating button {
      padding: 8px 16px;
      background: #1e3a5f;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      cursor: pointer;
    }
    .type-rating-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      max-height: 220px;
      overflow-y: auto;
      z-index: 10001;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      margin-top: 4px;
    }
    .type-rating-dropdown.visible {
      display: block;
    }
    .type-rating-option {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #f1f5f9;
    }
    .type-rating-option:last-child {
      border-bottom: none;
    }
    .type-rating-option:hover {
      background: #f0f7ff;
    }
    .type-rating-option .tr-name {
      font-size: 13px;
      font-weight: 600;
      color: #1e3a5f;
    }
    .type-rating-option .tr-label {
      font-size: 11px;
      color: #64748b;
      margin-top: 1px;
    }
    .type-rating-option.disabled {
      opacity: 0.4;
      cursor: default;
      pointer-events: none;
    }
    .work-rights-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }
    .work-rights-grid label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #334155;
      cursor: pointer;
    }
    .work-rights-grid input[type="checkbox"] {
      width: 16px;
      height: 16px;
    }
    .profile-modal-footer {
      padding: 16px 24px;
      border-top: 1px solid #e2e8f0;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
    .profile-modal-footer button {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .profile-cancel-btn {
      background: #f1f5f9;
      border: none;
      color: #64748b;
    }
    .profile-cancel-btn:hover {
      background: #e2e8f0;
    }
    .profile-save-btn {
      background: #1e3a5f;
      border: none;
      color: white;
    }
    .profile-save-btn:hover {
      background: #2d4a6f;
    }
    .profile-save-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Section Titles */
    .section-title {
      font-size: 13px;
      font-weight: 800;
      color: #0a192f;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .section-title span {
      font-weight: 500;
      color: #64748b;
      font-size: 12px;
    }

    /* Filter Tiles */
    .tile-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 20px;
    }
    .filter-tile {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 13px;
      font-weight: 600;
      color: #334155;
    }
    .filter-tile:hover {
      border-color: #3b82f6;
      color: #3b82f6;
    }
    .filter-tile.active {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
      box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
    }

    /* Range Slider */
    .range-section {
      margin: 20px 0;
    }
    .range-slider {
      width: 100%;
      margin: 10px 0;
      cursor: pointer;
      -webkit-appearance: none;
      height: 6px;
      background: #e2e8f0;
      border-radius: 3px;
      outline: none;
    }
    .range-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      background: white;
      border: 3px solid #3b82f6;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    .range-slider::-moz-range-thumb {
      width: 18px;
      height: 18px;
      background: white;
      border: 3px solid #3b82f6;
      border-radius: 50%;
      cursor: pointer;
    }
    .range-labels {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #64748b;
    }

    /* Dual Range Slider */
    .dual-range-container {
      position: relative;
      width: 100%;
      height: 40px;
      margin: 10px 0;
    }
    .dual-range-track {
      position: absolute;
      width: 100%;
      height: 6px;
      background: #e2e8f0;
      border-radius: 3px;
      top: 50%;
      transform: translateY(-50%);
    }
    .dual-range-highlight {
      position: absolute;
      height: 6px;
      background: #3b82f6;
      border-radius: 3px;
      top: 50%;
      transform: translateY(-50%);
    }
    .dual-range-container input[type="range"] {
      position: absolute;
      width: 100%;
      height: 6px;
      background: transparent;
      pointer-events: none;
      -webkit-appearance: none;
      top: 50%;
      transform: translateY(-50%);
      margin: 0;
    }
    .dual-range-container input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      background: white;
      border: 3px solid #3b82f6;
      border-radius: 50%;
      cursor: pointer;
      pointer-events: auto;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .dual-range-container input[type="range"]::-moz-range-thumb {
      width: 20px;
      height: 20px;
      background: white;
      border: 3px solid #3b82f6;
      border-radius: 50%;
      cursor: pointer;
      pointer-events: auto;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    /* Result Bar */
    .result-bar {
      margin-top: 20px;
      background: #3b82f6;
      color: white;
      padding: 14px;
      border-radius: 10px;
      text-align: center;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      transition: background 0.15s ease;
      border: none;
      width: 100%;
    }
    .result-bar:hover {
      background: #2563eb;
    }
    .result-count {
      background: rgba(255,255,255,0.2);
      padding: 3px 10px;
      border-radius: 4px;
      font-size: 12px;
    }

    /* Job Type Toggle (Pilot/Cabin Crew) */
    .job-type-toggle {
      display: flex;
      background: #e8eef7;
      border-radius: 12px;
      padding: 4px;
      margin-bottom: 16px;
    }
    .job-type-btn {
      flex: 1;
      padding: 12px 16px;
      border: none;
      background: transparent;
      border-radius: 9px;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      color: #6b7890;
    }
    .job-type-btn.active {
      background: linear-gradient(135deg, var(--nav), var(--nav2));
      color: #fff;
      box-shadow: 0 4px 12px rgba(11, 42, 111, 0.25);
    }
    .job-type-btn:hover:not(.active) {
      background: rgba(11, 42, 111, 0.08);
    }

    /* Clear Filters Button */
    .clear-btn {
      width: 100%;
      background: transparent;
      border: 1px dashed #6b7890;
      color: #6b7890;
      padding: 12px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.15s ease;
      margin-top: 10px;
    }
    .clear-btn:hover {
      background: #f1f5f9;
      border-color: #3b82f6;
      color: #3b82f6;
    }

    /* Job Alert Button */
    .alert-btn {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 14px 16px;
      background: linear-gradient(135deg, #1b66ff 0%, #00b7a8 100%);
      border: none;
      border-radius: 12px;
      color: #fff;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 16px;
      box-shadow: 0 4px 14px rgba(27, 102, 255, 0.25);
    }
    .alert-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(27, 102, 255, 0.35);
    }
    .alert-btn:active {
      transform: translateY(0);
    }
    .alert-btn svg {
      flex-shrink: 0;
    }

    /* Alert Modal */
    .alert-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(4px);
      z-index: 1000;
      display: none;
      align-items: flex-start;
      justify-content: center;
      padding: 40px 20px;
      overflow-y: auto;
    }
    .alert-modal-overlay.active {
      display: flex;
    }
    .alert-modal {
      background: white;
      border-radius: 16px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
      overflow: hidden;
      margin: auto;
    }
    .alert-modal-header {
      background: #f8fafc;
      border-bottom: 1px solid #e5e7eb;
      padding: 20px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .alert-modal-header h2 {
      margin: 0;
      font-size: 18px;
      color: #111827;
    }
    .alert-modal-body {
      padding: 20px 24px;
      max-height: 60vh;
      overflow-y: auto;
    }
    .alert-profile-note {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      background: #f0f9ff;
      border: 1px solid #bae6fd;
      border-radius: 8px;
      font-size: 13px;
      color: #0369a1;
      margin-bottom: 20px;
    }
    .alert-profile-note svg {
      flex-shrink: 0;
    }
    .alert-section {
      margin-bottom: 20px;
    }
    .alert-section-title {
      font-size: 12px;
      font-weight: 600;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 10px;
    }
    .alert-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .alert-chip {
      padding: 8px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
      border: 1px solid #e5e7eb;
      background: #fff;
      color: #374151;
    }
    .alert-chip:hover {
      border-color: #3b82f6;
      color: #3b82f6;
    }
    .alert-chip.selected {
      background: #3b82f6;
      border-color: #3b82f6;
      color: white;
    }
    .alert-input-group {
      margin-bottom: 16px;
    }
    .alert-input-group label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    .alert-input-group input, .alert-input-group select {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.15s;
      background: #fff;
    }
    .alert-input-group input:focus, .alert-input-group select:focus {
      outline: none;
      border-color: #3b82f6;
    }
    .alert-modal-footer {
      padding: 16px 24px;
      background: #f8fafc;
      border-top: 1px solid #e5e7eb;
    }
    .alert-submit-btn {
      width: 100%;
      background: #3b82f6;
      border: none;
      color: white;
      padding: 14px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .alert-submit-btn:hover {
      background: #2563eb;
    }
    .alert-submit-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    .alert-disclaimer {
      margin-top: 12px;
      font-size: 11px;
      color: #9ca3af;
      text-align: center;
    }
    .alert-success {
      text-align: center;
      padding: 40px 20px;
    }
    .alert-success svg {
      width: 56px;
      height: 56px;
      color: #10b981;
      margin-bottom: 16px;
    }
    .alert-success h3 {
      margin: 0 0 8px;
      font-size: 18px;
      color: #111827;
    }
    .alert-success p {
      color: #6b7280;
      margin: 0;
      font-size: 14px;
    }
    .alert-close-btn {
      background: none;
      border: none;
      color: #9ca3af;
      width: 32px;
      height: 32px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }
    .alert-close-btn:hover {
      background: #e5e7eb;
    }

    /* Multi-select dropdown for Aircraft */
    .multi-select {
      position: relative;
      width: 100%;
    }
    .multi-select-trigger {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      background: #fff;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: border-color 0.15s;
    }
    .multi-select-trigger:hover {
      border-color: #3b82f6;
    }
    .multi-select.open .multi-select-trigger {
      border-color: #3b82f6;
      border-bottom-left-radius: 0;
      border-bottom-right-radius: 0;
    }
    .multi-select-trigger svg {
      transition: transform 0.15s;
    }
    .multi-select.open .multi-select-trigger svg {
      transform: rotate(180deg);
    }
    .multi-select-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #fff;
      border: 1px solid #3b82f6;
      border-top: none;
      border-radius: 0 0 8px 8px;
      max-height: 250px;
      overflow-y: auto;
      z-index: 100;
      display: none;
    }
    .multi-select.open .multi-select-dropdown {
      display: block;
    }
    .multi-select-group {
      padding: 8px 0;
      border-bottom: 1px solid #f3f4f6;
    }
    .multi-select-group:last-child {
      border-bottom: none;
    }
    .multi-select-group-label {
      padding: 6px 14px;
      font-size: 11px;
      font-weight: 600;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .multi-select-option {
      padding: 10px 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background 0.1s;
    }
    .multi-select-option:hover {
      background: #f3f4f6;
    }
    .multi-select-option.selected {
      background: #eff6ff;
    }
    .multi-select-checkbox {
      width: 18px;
      height: 18px;
      border: 2px solid #d1d5db;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.15s;
    }
    .multi-select-option.selected .multi-select-checkbox {
      background: #3b82f6;
      border-color: #3b82f6;
    }
    .multi-select-checkbox svg {
      display: none;
      width: 12px;
      height: 12px;
      color: white;
    }
    .multi-select-option.selected .multi-select-checkbox svg {
      display: block;
    }
    .multi-select-label {
      font-size: 14px;
      color: #374151;
    }
    .multi-select-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 10px;
    }
    .multi-select-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      border-radius: 16px;
      font-size: 12px;
      color: #1d4ed8;
    }
    .multi-select-tag-remove {
      cursor: pointer;
      display: flex;
      align-items: center;
      opacity: 0.7;
      transition: opacity 0.1s;
    }
    .multi-select-tag-remove:hover {
      opacity: 1;
    }

    /* Frequency Toggle */
    .frequency-toggle {
      display: flex;
      gap: 10px;
      margin-top: 8px;
    }
    .frequency-option {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      background: #fff;
      cursor: pointer;
      transition: all 0.15s;
      font-size: 14px;
      font-weight: 500;
      color: #374151;
    }
    .frequency-option:hover {
      border-color: #3b82f6;
    }
    .frequency-option.selected {
      border-color: #3b82f6;
      background: #eff6ff;
      color: #1d4ed8;
    }
    .frequency-option .freq-icon {
      font-size: 16px;
    }
    .frequency-option .freq-label {
      font-weight: 600;
    }
    .frequency-option .freq-desc {
      font-size: 11px;
      color: #6b7280;
      font-weight: 400;
    }
    .frequency-option.selected .freq-desc {
      color: #3b82f6;
    }

    /* Required field indicator */
    .alert-section-title .required {
      color: #ef4444;
      margin-left: 2px;
    }
    .alert-validation-error {
      color: #ef4444;
      font-size: 12px;
      margin-top: 6px;
      display: none;
    }
    .alert-section.error .alert-chips,
    .alert-section.error .frequency-toggle {
      border: 2px solid #fecaca;
      border-radius: 12px;
      padding: 8px;
      margin: -8px;
      background: #fef2f2;
      color: #374151;
    }

    /* Eligibility Delta Slider */
    .delta-section {
      background: #fef9e7;
      border: 1px solid #f9e79f;
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 20px;
      position: relative;
    }

    /* Premium Lock Overlay */
    .premium-lock {
      position: absolute;
      inset: 0;
      background: rgba(254, 249, 231, 0.85);
      backdrop-filter: blur(3px);
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      z-index: 5;
    }
    .premium-lock.hidden {
      display: none;
    }
    .premium-lock-icon {
      font-size: 20px;
    }
    .premium-lock-text {
      font-size: 12px;
      font-weight: 700;
      color: #7d6608;
    }
    .premium-unlock-btn {
      background: linear-gradient(135deg, #f4d03f, #e9b32a);
      color: #5a4a00;
      border: none;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .premium-unlock-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(244, 208, 63, 0.4);
    }

    /* Premium badge styling */
    .premium-badge {
      background: linear-gradient(135deg, #f4d03f, #e9b32a);
      color: #5a4a00;
      font-size: 9px;
      font-weight: 800;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 6px;
      text-transform: uppercase;
    }

    /* Sort by Salary Button */
    .sort-salary-section {
      margin: 16px 0;
    }
    .sort-salary-btn {
      width: 100%;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .sort-salary-btn.unlocked {
      background: linear-gradient(135deg, #f4d03f, #e9b32a);
      border: 1px solid #d4a82a;
      color: #5a4a00;
    }
    .sort-salary-btn.unlocked:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(244, 208, 63, 0.4);
    }
    .sort-salary-btn.unlocked.active {
      background: linear-gradient(135deg, #e9b32a, #d4a000);
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1), 0 4px 12px rgba(244, 208, 63, 0.4);
    }
    .sort-salary-btn.locked {
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
      color: #94a3b8;
      cursor: not-allowed;
      position: relative;
    }
    .sort-salary-btn .lock-icon {
      font-size: 14px;
    }
    .sort-salary-btn .premium-tag {
      font-size: 9px;
      background: linear-gradient(135deg, #f4d03f, #e9b32a);
      color: #5a4a00;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 800;
      text-transform: uppercase;
    }

    /* Salary Notice Modal */
    .salary-notice-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
    }
    .salary-notice-overlay.visible {
      opacity: 1;
      visibility: visible;
    }
    .salary-notice-modal {
      background: white;
      border-radius: 12px;
      padding: 24px;
      max-width: 400px;
      margin: 20px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.3);
      transform: scale(0.9);
      transition: transform 0.2s ease;
    }
    .salary-notice-overlay.visible .salary-notice-modal {
      transform: scale(1);
    }
    .salary-notice-modal h3 {
      margin: 0 0 12px 0;
      font-size: 16px;
      color: #1e293b;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .salary-notice-modal p {
      margin: 0 0 20px 0;
      font-size: 14px;
      color: #64748b;
      line-height: 1.5;
    }
    .salary-notice-modal .btn-row {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    .salary-notice-modal .btn-cancel {
      padding: 8px 16px;
      border: 1px solid #e2e8f0;
      background: white;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      color: #64748b;
    }
    .salary-notice-modal .btn-confirm {
      padding: 8px 16px;
      border: none;
      background: linear-gradient(135deg, #f4d03f, #e9b32a);
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      color: #5a4a00;
    }
    .salary-notice-modal .btn-confirm:hover {
      box-shadow: 0 4px 12px rgba(244, 208, 63, 0.4);
    }

    /* Upgrade Modal */
    .upgrade-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 1001;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
    }
    .upgrade-modal-overlay.visible {
      opacity: 1;
      visibility: visible;
    }
    .upgrade-modal {
      background: white;
      border-radius: 16px;
      padding: 28px;
      max-width: 600px;
      width: 94%;
      margin: 20px;
      box-shadow: 0 25px 60px rgba(0,0,0,0.35);
      transform: scale(0.9);
      transition: transform 0.2s ease;
      position: relative;
    }
    .upgrade-modal-overlay.visible .upgrade-modal {
      transform: scale(1);
    }
    .upgrade-modal-close {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 32px;
      height: 32px;
      border: none;
      background: #f1f5f9;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #64748b;
      transition: all 0.15s;
    }
    .upgrade-modal-close:hover {
      background: #e2e8f0;
      color: #1e293b;
    }
    .upgrade-modal h3 {
      margin: 0 0 20px 0;
      font-size: 20px;
      color: #1e293b;
      text-align: center;
    }
    .upgrade-modal h3 span {
      background: linear-gradient(135deg, #f4d03f, #e9b32a);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .upgrade-features {
      list-style: none;
      padding: 0;
      margin: 0 0 20px 0;
    }
    .upgrade-features li {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 0;
      font-size: 15px;
      color: #334155;
      border-bottom: 1px solid #f1f5f9;
    }
    .upgrade-features li:last-child {
      border-bottom: none;
    }
    .upgrade-features li svg {
      flex-shrink: 0;
      color: #22c55e;
    }
    .upgrade-preview-img {
      width: 100%;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    }
    .upgrade-carousel {
      position: relative;
      width: 100%;
      margin-bottom: 20px;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    }
    .upgrade-carousel-track {
      display: flex;
      transition: transform 0.3s ease;
    }
    .upgrade-carousel-track img {
      width: 100%;
      flex-shrink: 0;
      display: block;
      border-radius: 0;
      object-fit: contain;
      background: #f1f5f9;
    }
    .upgrade-carousel-arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(255,255,255,0.92);
      border: 1px solid rgba(0,0,0,0.08);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2;
      transition: all 0.15s;
    }
    .upgrade-carousel-arrow:hover {
      background: #fff;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .upgrade-carousel-arrow.left { left: 8px; }
    .upgrade-carousel-arrow.right { right: 8px; }
    .upgrade-carousel-arrow svg {
      width: 16px;
      height: 16px;
      stroke: #334155;
      fill: none;
      stroke-width: 2.5;
    }
    .upgrade-carousel-dots {
      display: flex;
      justify-content: center;
      gap: 6px;
      margin-top: 10px;
      margin-bottom: 16px;
    }
    .upgrade-carousel-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #cbd5e1;
      border: none;
      padding: 0;
      cursor: pointer;
      transition: all 0.2s;
    }
    .upgrade-carousel-dot.active {
      background: #1b66ff;
      transform: scale(1.2);
    }
    .upgrade-buy-btn {
      width: 100%;
      padding: 14px 24px;
      border: none;
      background: linear-gradient(135deg, #1b66ff, #0052e0);
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.15s;
    }
    .upgrade-buy-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(27, 102, 255, 0.4);
    }
    .upgrade-buy-btn .price {
      background: rgba(255,255,255,0.2);
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 14px;
    }

    .delta-section .section-title {
      margin-bottom: 8px;
      color: #7d6608;
    }
    .delta-section .section-title span {
      color: #b7950b;
      font-weight: 700;
    }
    .delta-slider {
      width: 100%;
      margin: 8px 0;
      cursor: pointer;
      -webkit-appearance: none;
      height: 6px;
      background: linear-gradient(90deg, #f9e79f 0%, #f4d03f 100%);
      border-radius: 3px;
      outline: none;
    }
    .delta-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      background: white;
      border: 3px solid #f4d03f;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    .delta-slider::-moz-range-thumb {
      width: 18px;
      height: 18px;
      background: white;
      border: 3px solid #f4d03f;
      border-radius: 50%;
      cursor: pointer;
    }
    .delta-labels {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: #7d6608;
    }

    /* Eligibility Badges */
    .eligibility-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
    }
    .eligibility-badge.eligible {
      background: #d4edda;
      color: #155724;
    }
    .eligibility-badge.within-reach {
      background: #fff3cd;
      color: #856404;
    }
    .eligibility-badge.not-eligible {
      background: #f8d7da;
      color: #721c24;
    }

    /* Eligibility badge with tooltip */
    .eligibility-wrapper {
      position: relative;
      display: inline-block;
    }
    .eligibility-badge.clickable {
      cursor: pointer;
      transition: transform 0.1s ease;
    }
    .eligibility-badge.clickable:hover {
      transform: scale(1.05);
    }

    /* Breakdown Tooltip */
    .eligibility-tooltip {
      position: absolute;
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      background: #1e293b;
      color: white;
      padding: 12px 14px;
      border-radius: 10px;
      font-size: 12px;
      min-width: 220px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.25);
      z-index: 100;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s ease, visibility 0.2s ease;
    }
    .eligibility-wrapper:hover .eligibility-tooltip,
    .eligibility-tooltip.visible {
      opacity: 1;
      visibility: visible;
    }
    .eligibility-tooltip::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: #1e293b;
    }
    .tooltip-title {
      font-weight: 700;
      font-size: 13px;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(255,255,255,0.15);
    }
    .tooltip-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 6px 0;
    }
    .tooltip-label {
      color: #94a3b8;
    }
    .tooltip-value {
      font-weight: 600;
    }
    .tooltip-value.met {
      color: #4ade80;
    }
    .tooltip-value.short {
      color: #fbbf24;
    }
    .tooltip-value.missing {
      color: #f87171;
    }
    .tooltip-gap {
      font-size: 10px;
      opacity: 0.7;
      margin-left: 6px;
    }

    .results-head{ padding:14px 14px 0; }

    .banner{
      height:150px;
      border-radius: 18px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.30);
      box-shadow: 0 12px 26px rgba(13,36,90,.10);
      background:
        linear-gradient(90deg, rgba(11,42,111,.82), rgba(11,42,111,.22)),
        radial-gradient(900px 260px at 80% 50%, rgba(255,255,255,.25), transparent 65%),
        linear-gradient(180deg, #6fb1ff, #d4f0ff 55%, rgba(255,255,255,.85));
      display:flex;
      align-items:flex-end;
      padding:16px;
      color:#fff;
    }
    .banner .tag{
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.22);
      border-radius:999px;
      padding:7px 10px;
      font-weight:800;
      font-size:12px;
      letter-spacing:.3px;
      width:max-content;
    }
    .banner h2{ margin:8px 0 0; font-size:18px; line-height:1.2; }
    .banner p{ margin:6px 0 0; opacity:.9; font-size:13px; max-width: 74ch; }

    .cards{ padding:10px; display:grid; gap:8px; }

    /* Load More Section */
    .load-more-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px 0;
      border-top: 1px solid #e2e8f0;
      margin: 20px 14px 0;
    }

    .load-more-btn {
      background: #ffffff;
      color: #0f172a;
      border: 1.5px solid #0f172a;
      padding: 12px 30px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      font-size: 0.85rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      transition: 0.2s;
      border-radius: 4px;
    }

    .load-more-btn:hover {
      background: #0f172a;
      color: #ffffff;
    }

    .load-more-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .results-count {
      font-size: 0.75rem;
      color: #64748b;
      margin-top: 12px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .card {
      background: white;
      border-radius: 14px;
      border: 1px solid #e2e8f0;
      padding: 16px 20px;
      display: grid;
      grid-template-columns: 100px 1fr 150px;
      grid-template-rows: auto auto auto;
      gap: 6px 14px;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.08);
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }
    .card.visa-sponsor {
      background: #f1f8e9;
      border-color: #a5d6a7;
    }

    .company-logo {
      grid-row: 1 / span 2;
      width: 100px;
      height: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 24px;
      color: #0b2a6f;
      flex-shrink: 0;
    }
    .company-logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .job-title {
      font-size: 16px;
      font-weight: 700;
      margin: 0;
      color: #1e293b;
      align-self: center;
    }

    .airline-name {
      margin-left: 12px;
      font-size: 12px;
      font-weight: 500;
      color: #475569;
      letter-spacing: 0.3px;
      background: rgba(71, 85, 105, 0.06);
      padding: 2px 8px;
      border-radius: 4px;
      border: 1px solid rgba(71, 85, 105, 0.15);
    }

    .attributes {
      display: flex;
      gap: 10px;
      color: #64748b;
      font-size: 12px;
      flex-wrap: wrap;
      align-items: center;
    }
    .attr-item b {
      color: #334155;
    }
    .attr-pill {
      background: #e3f2fd;
      color: #1565c0;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }
    .attr-pill.green {
      background: white;
      color: #2e7d32;
      border: 1.5px solid #4caf50;
    }

    .apply-container {
      text-align: right;
      grid-column: 3;
      grid-row: 1;
      align-self: center;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
    }
    .apply-btn {
      background: #0b2a6f;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 600;
      font-size: 13px;
      display: inline-block;
      transition: background 0.15s ease;
    }
    .apply-btn:hover {
      background: #081a45;
    }

    .stats-row {
      grid-column: 2;
      display: flex;
      gap: 24px;
      margin-top: 4px;
      padding-top: 8px;
      border-top: 1px dashed #e2e8f0;
    }
    .stat-box {
      display: flex;
      flex-direction: column;
    }
    .stat-label {
      font-size: 10px;
      text-transform: uppercase;
      color: #94a3b8;
      font-weight: 700;
    }
    .stat-value {
      font-size: 15px;
      font-weight: 700;
      color: #0f172a;
    }

    .card-footer-actions {
      grid-column: 3;
      grid-row: 3;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 16px;
      align-self: end;
    }

    .expand-link {
      color: #64748b;
      font-size: 12px;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      white-space: nowrap;
    }
    .expand-link:hover {
      color: #334155;
      text-decoration: underline;
    }
    .arrow-v {
      width: 8px;
      height: 8px;
      border-right: 2px solid currentColor;
      border-bottom: 2px solid currentColor;
      transform: rotate(45deg);
      margin-bottom: 4px;
      transition: transform 0.2s ease;
    }
    .expand-link.expanded .arrow-v {
      transform: rotate(-135deg);
      margin-bottom: 0;
      margin-top: 4px;
    }

    /* Expandable job description section */
    .job-description {
      grid-column: 1 / -1;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease, padding 0.3s ease;
      background: #f8fafc;
      border-radius: 10px;
      margin-top: 0;
    }
    .job-description.expanded {
      max-height: 400px;
      overflow-y: auto;
      padding: 16px 20px;
      margin-top: 12px;
      border: 1px solid #e2e8f0;
    }
    .job-description-content {
      font-size: 14px;
      line-height: 1.6;
      color: #000000;
    }
    .job-description-content:empty::before {
      content: "No description available for this position.";
      color: #94a3b8;
      font-style: italic;
    }

    /* Requirements list styling */
    .requirements-list {
      list-style: none;
      padding: 0;
      margin: 8px 0 0 0;
    }
    .requirements-list li {
      position: relative;
      padding-left: 16px;
      margin-bottom: 6px;
      font-size: 13px;
      line-height: 1.5;
      color: #1e293b;
    }
    .requirements-list li::before {
      content: "•";
      position: absolute;
      left: 0;
      color: #0b2a6f;
      font-weight: bold;
    }
    .requirements-title {
      font-weight: 600;
      color: #475569;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 12px;
      margin-bottom: 4px;
    }

    .save-btn {
      position: absolute;
      top: 0;
      right: 0;
      background: #f5f5f5;
      border: none;
      cursor: pointer;
      padding: 8px 10px;
      border-radius: 0 16px 0 12px;
      transition: background 0.15s ease;
    }
    .save-btn:hover {
      background: #e0e0e0;
    }
    .save-btn svg {
      width: 18px;
      height: 18px;
      fill: none;
      stroke: #666;
      stroke-width: 2;
    }
    .save-btn:hover svg {
      stroke: #333;
    }
    .save-btn.saved {
      background: #e8f0fe;
    }
    .save-btn.saved svg {
      fill: #1b66ff;
      stroke: #1b66ff;
    }
    .save-btn.saved:hover {
      background: #d2e3fc;
    }
    .save-btn.saved:hover svg {
      fill: #0b4ecf;
      stroke: #0b4ecf;
    }

    /* Track Button (Option A - below Apply Now) */
    .track-btn {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      background: #fff;
      border: 1.5px solid #e2e8f0;
      color: #475569;
      padding: 6px 14px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.15s;
    }
    .track-btn:hover {
      border-color: #059669;
      color: #059669;
    }
    .track-btn svg {
      width: 14px;
      height: 14px;
      stroke: currentColor;
      fill: none;
      stroke-width: 2;
    }
    .track-btn.tracked {
      background: #ecfdf5;
      border-color: #a7f3d0;
      color: #059669;
    }
    .track-btn.tracked:hover {
      background: #d1fae5;
    }
    .share-btn {
      display: flex;
      align-items: center;
      gap: 5px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
      color: #64748b;
      font-size: 12px;
      white-space: nowrap;
      transition: all 0.15s ease;
    }
    .share-btn:hover {
      color: #1b66ff;
    }
    .share-btn svg {
      stroke: currentColor;
      width: 14px;
      height: 14px;
    }
    .share-btn span {
      position: relative;
      top: 1px;
    }

    .mobile-toggle{ display:none; margin-top:12px; width:100%; gap:8px; justify-content:center; }

    /* Tablet breakpoint */
    /* Large Desktop - 1441px+ */
    @media (min-width: 1441px) {
      .card {
        grid-template-columns: 110px 1fr 160px;
        padding: 18px 22px;
      }
      .company-logo {
        width: 110px;
        height: 110px;
        font-size: 26px;
      }
      .job-title {
        font-size: 17px;
      }
      .apply-btn {
        padding: 10px 18px;
        font-size: 14px;
      }
      .stats-row {
        gap: 28px;
      }
    }

    /* Desktop - 1025px to 1440px (default styles already cover this) */
    /* Default: grid-template-columns: 100px 1fr 150px, logo: 100px x 100px */

    /* Tablet & Laptop - 769px to 1024px */
    @media (max-width: 1024px) {
      .card {
        grid-template-columns: 90px 1fr 140px;
        padding: 14px 16px;
        gap: 5px 12px;
      }
      .company-logo {
        width: 90px;
        height: 90px;
        font-size: 22px;
      }
      .job-title {
        font-size: 15px;
      }
      .apply-btn {
        padding: 7px 14px;
        font-size: 12px;
      }
      .attributes {
        font-size: 11px;
        gap: 8px;
      }
      .stats-row {
        gap: 20px;
      }
    }

    /* Medium Screens - Tablet Portrait */
    @media (max-width: 980px){
      .topbar-row{ grid-template-columns: auto 1fr auto auto auto; }
      .meta{ justify-content: flex-start; }
      .grid{ grid-template-columns: 1fr; }
      .mobile-toggle{ display: block; }
      .card{
        grid-template-columns: 80px 1fr 120px;
        padding: 14px 16px;
        gap: 5px 10px;
      }
      .company-logo {
        width: 80px;
        height: 80px;
        font-size: 20px;
      }
      .job-title {
        font-size: 14px;
      }
      .apply-btn {
        padding: 7px 12px;
        font-size: 11px;
      }
      .attributes {
        font-size: 11px;
        gap: 6px;
      }
      .stats{ display: none; }
      .stage::before, .stage::after{ position: absolute; }
      #filtersPanel { display: none; }
    }

    /* Mobile Styles */
    @media (max-width: 768px) {
      html, body {
        overflow-x: hidden;
        overflow-y: auto;
        height: auto;
      }

      /* Hide fixed logo on mobile */
      .stage { min-height: auto; }
      .stage::before { display: none; }
      .stage::after { display: none; }

      .shell {
        padding: 0;
        background: #f8fafc;
      }

      .frame {
        padding: 0;
        border-radius: 0;
        min-height: auto;
        background: #f8fafc;
        border: none;
        box-shadow: none;
      }

      /* Top bar / Header - Clean compact design */
      .topbar {
        padding: 12px 16px;
        border-radius: 0;
        position: sticky;
        top: 0;
        margin: 0;
        background: var(--nav);
      }

      .topbar-row {
        gap: 8px;
        display: grid;
        grid-template-columns: 1fr auto auto auto;
        align-items: center;
      }

      /* Logo on its own row */
      .site-logo {
        grid-column: 1 / -1;
        margin-bottom: 4px;
      }

      .pill {
        padding: 10px 14px;
        border-radius: 8px;
        background: rgba(255,255,255,0.15);
        border: none;
      }
      .pill input, .pill select {
        font-size: 15px;
      }
      .pill .icon { width: 16px; height: 16px; }

      /* Hide location dropdown on mobile */
      .pill:has(select) { display: none; }

      .btn {
        padding: 10px 16px;
        font-size: 13px;
        border-radius: 8px;
        white-space: nowrap;
      }
      .btn .icon { display: none; }

      .saved-jobs-btn {
        padding: 8px 12px;
        font-size: 12px;
        border-radius: 8px;
      }
      .saved-jobs-btn span:not(.saved-badge):not(#savedCount) {
        display: none;
      }

      .meta {
        grid-column: 1 / -1;
        font-size: 11px;
        justify-content: center;
        margin-top: 6px;
        text-align: center;
        opacity: 0.8;
      }

      .mobile-toggle {
        grid-column: 1 / -1;
        margin-top: 8px;
        border-radius: 8px;
        padding: 10px 16px;
        font-size: 13px;
      }

      /* Filter panel - fullscreen overlay with close button */
      #filtersPanel {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1000;
        border-radius: 0;
        max-height: 100vh;
        overflow-y: auto;
        background: white;
      }

      #filtersPanel.show { display: block; }

      .filters {
        padding: 20px;
        padding-top: 70px;
        padding-bottom: 100px;
      }

      /* Close button for filters - actual clickable button */
      .close-filters-btn {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        padding: 18px 20px;
        background: var(--nav);
        color: white;
        font-weight: 700;
        font-size: 15px;
        z-index: 1001;
        border: none;
        cursor: pointer;
        text-align: left;
        display: none;
        font-family: inherit;
      }
      .close-filters-btn:active {
        background: var(--nav2);
      }
      #filtersPanel.show .close-filters-btn {
        display: block;
      }

      .profile-summary {
        padding: 16px;
        margin-bottom: 20px;
        border-radius: 10px;
      }

      .tile-group {
        gap: 8px;
        margin-bottom: 20px;
      }
      .filter-tile {
        padding: 12px 8px;
        font-size: 12px;
        border-radius: 8px;
      }

      .section-title {
        font-size: 13px;
        margin-bottom: 10px;
        margin-top: 16px;
      }
      .section-title:first-of-type { margin-top: 0; }

      .delta-section {
        padding: 14px;
        margin-bottom: 16px;
        border-radius: 10px;
      }

      .result-bar {
        border-radius: 8px;
        padding: 14px;
        margin-top: 20px;
      }

      .clear-btn {
        border-radius: 8px;
        padding: 12px;
      }

      /* Lock body scroll when filters open */
      body.filters-open {
        overflow: hidden;
        position: fixed;
        width: 100%;
      }

      /* Main content area */
      .grid { margin-top: 0; }

      .panel {
        border-radius: 0;
        border: none;
        box-shadow: none;
        background: transparent;
      }
      .panel::before { display: none; }

      /* Job Cards - Apply button top right */
      .cards {
        padding: 12px;
        gap: 10px;
        background: #f8fafc;
        overflow-x: hidden;
      }

      .card {
        display: block;
        position: relative;
        padding: 14px;
        padding-top: 16px;
        border-radius: 10px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        overflow: hidden;
      }

      .company-logo {
        width: 70px;
        height: 70px;
        font-size: 18px;
        float: left;
        margin-right: 12px;
        margin-bottom: 10px;
      }

      .job-title {
        font-size: 14px;
        line-height: 1.3;
        margin-bottom: 2px;
        padding-right: 70px;
      }

      .airline-name {
        display: block;
        margin-left: 0;
        margin-top: 4px;
        margin-bottom: 6px;
        font-size: 12px;
        background: none;
        border: none;
        padding: 0;
        color: #64748b;
      }
      .airline-name::before {
        content: none;
      }

      /* Apply button - top right corner */
      .apply-container {
        position: absolute;
        top: 14px;
        right: 10px;
        text-align: right;
        margin: 0;
      }

      .apply-btn {
        padding: 6px 10px;
        font-size: 10px;
        border-radius: 5px;
        display: inline-block;
        white-space: nowrap;
      }

      .attributes {
        clear: both;
        flex-wrap: wrap;
        gap: 5px;
        font-size: 11px;
        margin-top: 10px;
        display: flex;
      }

      .attr-item {
        font-size: 11px;
      }
      .attr-item b { display: none; }

      .attr-pill {
        font-size: 10px;
        padding: 3px 7px;
        border-radius: 4px;
      }

      .stats-row {
        display: flex;
        gap: 16px;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #eee;
      }

      .stat-label { font-size: 9px; }
      .stat-value { font-size: 13px; }

      .expand-link {
        display: flex;
        margin-top: 10px;
        font-size: 12px;
      }

      .share-btn {
        margin-top: 2px;
      }
      .share-btn span {
        top: 2px;
      }

      .save-btn {
        padding: 6px 8px;
        border-radius: 0 12px 0 8px;
      }
      .save-btn svg {
        width: 16px;
        height: 16px;
      }

      .track-btn {
        padding: 5px 10px;
        font-size: 10px;
      }

      /* Load more section */
      .load-more-container {
        padding: 24px 16px;
        margin: 0;
        background: #f8fafc;
        border-top: none;
      }
      .load-more-btn {
        padding: 12px 20px;
        font-size: 0.75rem;
        border-radius: 6px;
      }
      .results-count {
        font-size: 0.65rem;
        margin-top: 10px;
      }

      /* Banner */
      .banner {
        display: none;
      }

      /* Eligibility badges */
      .eligibility-badge {
        font-size: 9px;
        padding: 2px 6px;
      }
      .eligibility-tooltip {
        display: none;
      }
    }

    /* Small phones */
    @media (max-width: 480px) {
      .cards {
        padding: 10px;
      }
      .card {
        padding: 12px;
      }
      .company-logo {
        width: 60px;
        height: 60px;
        font-size: 16px;
        margin-right: 10px;
      }
      .job-title {
        font-size: 13px;
        padding-right: 65px;
      }
      .apply-container {
        right: 8px;
        top: 12px;
      }
      .apply-btn {
        padding: 5px 8px;
        font-size: 9px;
      }
      .attr-pill {
        font-size: 9px;
        padding: 2px 6px;
      }
      .stat-value {
        font-size: 12px;
      }
    }

    /* Extra Small phones */
    @media (max-width: 380px) {
      .topbar { padding: 10px 12px; }

      .pill { padding: 8px 12px; }
      .pill input, .pill select { font-size: 14px; }

      .cards { padding: 8px; gap: 8px; }

      .card { padding: 10px; }

      .company-logo {
        width: 55px;
        height: 55px;
        font-size: 14px;
        margin-right: 8px;
      }

      .job-title {
        font-size: 12px;
        padding-right: 60px;
      }

      .apply-container {
        right: 6px;
        top: 10px;
      }

      .apply-btn {
        padding: 4px 7px;
        font-size: 9px;
      }

      .airline-name {
        display: block;
        font-size: 10px;
        margin-left: 0;
        margin-top: 3px;
        background: none;
        border: none;
        padding: 0;
      }
      .airline-name::before { content: none; }

      .apply-btn {
        padding: 6px 10px;
        font-size: 10px;
      }

      .attr-pill {
        font-size: 9px;
        padding: 2px 5px;
      }

      .stats-row {
        gap: 12px;
      }

      .stat-value {
        font-size: 11px;
      }

      .expand-link {
        font-size: 11px;
      }
    }

    /* Very small screens */
    @media (max-width: 320px) {
      .company-logo {
        width: 60px;
        height: 60px;
        font-size: 15px;
      }
      .job-title {
        font-size: 11px;
        padding-right: 75px;
      }
      .apply-btn {
        padding: 5px 8px;
        font-size: 9px;
      }
    }

    .svg{display:block}

    /* Map Search Button */
    .map-search-btn {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 14px 16px;
      background: linear-gradient(135deg, #1b66ff 0%, #00b7a8 100%);
      border: none;
      border-radius: 12px;
      color: #fff;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 16px;
      box-shadow: 0 4px 14px rgba(27, 102, 255, 0.25);
    }
    .map-search-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(27, 102, 255, 0.35);
    }
    .map-search-btn:active {
      transform: translateY(0);
    }
    .map-search-btn svg {
      flex-shrink: 0;
    }
    .map-search-btn .lock-icon,
    .alert-btn .lock-icon {
      font-size: 14px;
    }
    .map-search-btn .lock-icon.hidden,
    .alert-btn .lock-icon.hidden {
      display: none;
    }
    .map-search-btn .premium-tag,
    .alert-btn .premium-tag,
    .saved-jobs-btn .premium-tag {
      background: rgba(255,255,255,0.2);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
    }

    /* Map Overlay */
    .map-overlay {
      position: fixed;
      inset: 0;
      background: rgba(7, 24, 61, 0.85);
      backdrop-filter: blur(8px);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    .map-overlay.visible {
      opacity: 1;
      visibility: visible;
    }
    .map-container {
      width: 94%;
      height: 90%;
      max-width: 1600px;
      background: #fff;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 30px 80px rgba(0, 0, 0, 0.4);
      display: flex;
      flex-direction: column;
      transform: scale(0.95);
      transition: transform 0.3s ease;
    }
    .map-overlay.visible .map-container {
      transform: scale(1);
    }
    .map-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      background: linear-gradient(90deg, var(--nav), var(--nav2));
      color: #fff;
    }
    .map-header h2 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .map-close-btn {
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.25);
      color: #fff;
      width: 36px;
      height: 36px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .map-close-btn:hover {
      background: rgba(255, 255, 255, 0.25);
    }
    .map-content {
      flex: 1;
      position: relative;
    }
    #mapbox-map {
      width: 100%;
      height: 100%;
    }
    .map-loading {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #f8fafc;
      gap: 12px;
    }
    .map-loading.hidden {
      display: none;
    }
    .map-loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #e2e8f0;
      border-top-color: #1b66ff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .map-loading-text {
      font-size: 14px;
      color: var(--muted);
    }
    .map-stats {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(255, 255, 255, 0.95);
      padding: 12px 16px;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      font-size: 13px;
      z-index: 10;
    }
    .map-stats strong {
      color: var(--accent);
    }

    /* Mapbox popup customization */
    .mapboxgl-popup-content {
      padding: 0;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      min-width: 260px;
    }
    .mapboxgl-popup-close-button {
      font-size: 20px;
      padding: 8px 12px;
      color: #fff;
      z-index: 10;
    }
    .mapboxgl-popup-close-button:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    .job-popup {
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    .job-popup-header {
      background: linear-gradient(135deg, var(--nav), var(--nav2));
      color: #fff;
      padding: 14px 16px;
    }
    .job-popup-location {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .job-popup-count {
      font-size: 12px;
      opacity: 0.85;
    }
    .job-popup-body {
      padding: 12px 16px;
      max-height: 200px;
      overflow-y: auto;
    }
    .job-popup-item {
      padding: 10px 0;
      border-bottom: 1px solid #f1f5f9;
    }
    .job-popup-item:last-child {
      border-bottom: none;
    }
    .job-popup-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 2px;
    }
    .job-popup-airline {
      font-size: 11px;
      color: var(--muted);
    }
    .job-popup-footer {
      padding: 12px 16px;
      background: #f8fafc;
      border-top: 1px solid #e2e8f0;
    }
    .job-popup-view-btn {
      width: 100%;
      padding: 10px 16px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .job-popup-view-btn:hover {
      background: #0052cc;
    }

    /* Cluster markers */
    .cluster-marker {
      background: linear-gradient(135deg, #1b66ff, #00b7a8);
      color: #fff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      box-shadow: 0 4px 14px rgba(27, 102, 255, 0.4);
      border: 3px solid #fff;
    }

    /* Map Job Preview Panel */
    .map-job-preview {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.98);
      border-top: 1px solid #e2e8f0;
      padding: 12px 16px;
      transform: translateY(100%);
      transition: transform 0.3s ease;
      z-index: 20;
      box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.15);
    }
    .map-job-preview.visible {
      transform: translateY(0);
    }
    .map-job-preview-close {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #f1f5f9;
      border: none;
      width: 28px;
      height: 28px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 5;
    }
    .map-job-preview-close:hover {
      background: #e2e8f0;
    }
    .map-job-preview .card {
      box-shadow: none;
      border: none;
      background: transparent;
      margin: 0;
      padding: 8px 0;
    }
    .map-job-preview .save-btn {
      display: none;
    }
  </style>
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="manifest" href="/site.webmanifest">
</head>

<body>
  <div class="stage">
    <div class="shell">
      <div class="frame">
        <header class="topbar">
          <div class="topbar-row">
            <!-- AEROSCOUT logo inside topbar -->
            <a href="index.html" class="site-logo">AEROSCOUT</a>

            <div class="pill">
              <svg class="icon svg" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M21 21l-4.2-4.2m1.7-5.3a7 7 0 11-14 0 7 7 0 0114 0z" stroke="white" stroke-width="2" stroke-linecap="round"/>
              </svg>
              <input id="q" placeholder="Search position, operator, aircraft…" />
            </div>

            <div class="pill">
              <svg class="icon svg" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M12 21s7-4.6 7-11a7 7 0 10-14 0c0 6.4 7 11 7 11z" stroke="white" stroke-width="2" stroke-linecap="round"/>
                <path d="M12 11.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z" stroke="white" stroke-width="2"/>
              </svg>
              <select id="loc">
                <option value="">Any location</option>
                <option>United States</option>
                <option>Europe</option>
                <option>Middle East</option>
                <option>Asia</option>
                <option>Oceania</option>
              </select>
            </div>

            <button class="btn" id="searchBtn" type="button">
              <svg class="icon svg" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M10 18a8 8 0 100-16 8 8 0 000 16z" stroke="#0b2a6f" stroke-width="2"/>
                <path d="M21 21l-4.35-4.35" stroke="#0b2a6f" stroke-width="2" stroke-linecap="round"/>
              </svg>
              Search
            </button>

            <button class="saved-jobs-btn" id="savedJobsBtn" onclick="toggleSavedFilter()" title="Saved jobs">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
              </svg>
              <span>Saved</span>
              <span id="savedBadge" class="saved-badge" style="display:none;">
                <span id="savedCount">0</span>
              </span>
            </button>

            <a href="Tracker.html" class="saved-jobs-btn" id="trackerNavBtn" style="text-decoration:none;" onclick="if(!isPremium){event.preventDefault();redirectToUpgrade();}">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/>
              </svg>
              <span>Tracker</span>
              <span class="premium-tag tracker-pro-tag">Pro</span>
            </a>

            <div class="meta" style="grid-column: 1 / -1;">
              <span id="count" style="font-size:15px;font-weight:700;"><span id="jobTypeLabel">Active pilot jobs</span> as of <span id="gmtTime"></span>: <span id="jobCount">0</span></span>
            </div>
          </div>

          <button class="btn mobile-toggle" id="toggleFilters" type="button">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0;">
              <line x1="4" y1="6" x2="20" y2="6"/><line x1="6" y1="12" x2="18" y2="12"/><line x1="8" y1="18" x2="16" y2="18"/>
            </svg>
            Filters
          </button>
        </header>

        <main class="grid">
          <aside class="panel" id="filtersPanel">
            <div class="filters">
              <!-- Job Type Toggle (Pilot/Cabin Crew) -->
              <div class="job-type-toggle">
                <button class="job-type-btn active" id="pilotBtn" data-type="pilot">Pilot Jobs</button>
                <button class="job-type-btn" id="cabinCrewBtn" data-type="cabin_crew">Cabin Crew</button>
              </div>

              <!-- Search by Map Button (Premium) -->
              <button class="map-search-btn" id="openMapBtn" type="button">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon>
                  <line x1="8" y1="2" x2="8" y2="18"></line>
                  <line x1="16" y1="6" x2="16" y2="22"></line>
                </svg>
                Search by Map
                <span class="premium-tag">Pro</span>
              </button>

              <!-- Job Alert Button (Premium) -->
              <button class="alert-btn" id="alertBtn" type="button">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                  <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                </svg>
                Get Job Alerts
                <span class="premium-tag">Pro</span>
              </button>

              <!-- Profile Summary Card -->
              <div class="profile-summary">
                <span class="profile-label">Your Experience</span>
                <span class="profile-val" id="profileDisplay">1,200h Total · CPL · A320</span>
                <div class="eligible-toggle">
                  <input type="checkbox" id="eligibleOnly">
                  <label for="eligibleOnly">Show eligible only</label>
                </div>
                <button class="edit-profile-btn" id="editProfileBtn">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                  </svg>
                  Edit Profile
                  <span class="premium-tag" style="background:#3b82f6;color:#fff;padding:2px 6px;border-radius:8px;font-size:9px;margin-left:4px;">Pro</span>
                </button>
              </div>

              <!-- Eligibility Delta Slider (Premium Feature) -->
              <div class="delta-section" id="deltaSection">
                <div class="premium-lock" id="premiumLock">
                  <span class="premium-lock-text">Premium Feature</span>
                  <button class="premium-unlock-btn" id="unlockBtn">Upgrade to Pro</button>
                </div>
                <div class="delta-content" id="deltaContent">
                  <div class="section-title">Jobs within reach <span class="premium-badge">Pro</span> <span id="deltaLabel" style="margin-left:auto;">≤ 3,000 hrs away</span></div>
                  <input type="range" class="delta-slider" id="deltaSlider" min="0" max="3000" step="100" value="3000">
                  <div class="delta-labels">
                    <span>Eligible now</span>
                    <span>3,000 hrs away</span>
                  </div>
                  <!-- Include blockers toggle -->
                  <div class="blocker-toggle" style="margin-top:12px; padding-top:10px; border-top:1px dashed #f9e79f;">
                    <label style="display:flex; align-items:center; gap:8px; font-size:11px; color:#7d6608; cursor:pointer;">
                      <input type="checkbox" id="includeBlockers" style="width:14px; height:14px;">
                      <span>Include jobs with blockers</span>
                    </label>
                    <div style="font-size:10px; color:#b7950b; margin-top:4px; margin-left:22px;">Show type ratings & licenses I don't have</div>
                  </div>
                  <!-- Turn off button -->
                  <button type="button" id="turnOffDeltaBtn" style="width:100%; margin-top:12px; padding:8px 12px; background:#f5ecd3; border:1px solid #d4c896; border-radius:6px; color:#7d6608; font-size:12px; cursor:pointer; transition:all 0.2s;">Turn off Eligibility</button>
                </div>
                <!-- Disabled state message -->
                <div class="delta-disabled" id="deltaDisabled" style="display:none; text-align:center; padding:10px;">
                  <div style="font-size:12px; color:#7d6608; margin-bottom:8px;">Eligibility filter is off</div>
                  <button type="button" id="turnOnDeltaBtn" style="padding:6px 16px; background:#1e3a5f; border:none; border-radius:6px; color:white; font-size:12px; cursor:pointer;">Turn on</button>
                </div>
              </div>

              <!-- Type Preference (Pilot only) -->
              <div class="section-title pilot-filter" id="typePrefTitle">Type Preference</div>
              <div class="tile-group pilot-filter" id="typePrefGroup">
                <div class="filter-tile" data-filter="ntr" id="ntrTile">NTR</div>
                <div class="filter-tile" data-filter="typed" id="typedTile">Type-Rated</div>
              </div>

              <!-- License (Pilot only) -->
              <div class="section-title pilot-filter" id="licenseTitle">License</div>
              <div class="tile-group pilot-filter" id="licenseGroup">
                <div class="filter-tile" data-filter="atpl" id="atplTile">ATPL</div>
                <div class="filter-tile" data-filter="cpl" id="cplTile">CPL</div>
                <div class="filter-tile" data-filter="fatpl" id="fatplTile">fATPL</div>
              </div>

              <!-- Operator Type -->
              <div class="section-title">Operator Type</div>
              <div class="tile-group">
                <div class="filter-tile" data-filter="op-airline" id="opAirlineTile">Airline</div>
                <div class="filter-tile" data-filter="op-bizav" id="opBizavTile">BizAv</div>
                <div class="filter-tile pilot-filter" data-filter="op-government" id="opGovernmentTile">Government</div>
                <div class="filter-tile pilot-filter" data-filter="op-medical" id="opMedicalTile">Medical</div>
                <div class="filter-tile pilot-filter" data-filter="op-instructor" id="opInstructorTile">Instructor</div>
              </div>

              <!-- Perks -->
              <div class="section-title">Perks</div>
              <div class="tile-group">
                <div class="filter-tile" data-filter="visa" id="visaTile">Visa Sponsor</div>
                <div class="filter-tile pilot-filter" data-filter="direct" id="directTile">Direct Entry</div>
              </div>

              <!-- Sort by Salary (Premium Feature) -->
              <div class="sort-salary-section">
                <button type="button" class="sort-salary-btn locked" id="sortSalaryBtn">
                  <span>Sort by Salary</span>
                  <span class="premium-tag">Pro</span>
                </button>
              </div>

              <!-- Flight Time Range (Pilot only) -->
              <div class="section-title pilot-filter" id="flightTimeTitle">Total Flight Time <span id="ftLabel">0 - 10,000+</span></div>
              <div class="range-section pilot-filter" id="flightTimeSection">
                <div class="dual-range-container">
                  <div class="dual-range-track"></div>
                  <div class="dual-range-highlight" id="ftHighlight"></div>
                  <input type="range" id="ftSliderMin" min="0" max="10000" step="100" value="0">
                  <input type="range" id="ftSliderMax" min="0" max="10000" step="100" value="10000">
                </div>
                <div class="range-labels">
                  <span>0 hrs</span>
                  <span>10,000+</span>
                </div>
              </div>

              <!-- Result Bar -->
              <button class="result-bar" id="applyBtn" type="button">
                <span>Show Results</span>
                <span class="result-count" id="matchCount">6 Jobs</span>
              </button>
              <button class="clear-btn" id="clearBtn" type="button">Clear Filters</button>
            </div>
          </aside>

          <section class="panel">
            <div class="cards" id="cards"></div>
            <div class="load-more-container" id="loadMoreContainer">
              <button class="load-more-btn" id="loadMoreBtn">Load More Jobs</button>
              <div class="results-count" id="resultsCount">Displaying 0 of 0 active vacancies</div>
            </div>
          </section>
        </main>
      </div>
    </div>
  </div>

  <!-- Job Alert Modal -->
  <div class="alert-modal-overlay" id="alertModal">
    <div class="alert-modal">
      <div class="alert-modal-header">
        <h2>Job Alerts</h2>
        <button class="alert-close-btn" id="closeAlertModal">&times;</button>
      </div>
      <div class="alert-modal-body" id="alertModalBody">
        <!-- Profile Note -->
        <div class="alert-profile-note">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M12 16v-4"></path>
            <path d="M12 8h.01"></path>
          </svg>
          <span>Your experience profile (hours, license, aircraft) will be used for eligibility matching</span>
        </div>

        <!-- Rank / Position (Required) -->
        <div class="alert-section" id="rankSection">
          <div class="alert-section-title">Rank / Position<span class="required">*</span></div>
          <div class="alert-chips">
            <span class="alert-chip" data-alert-filter="rank" data-value="captain">Captain</span>
            <span class="alert-chip" data-alert-filter="rank" data-value="senior_fo">Senior First Officer</span>
            <span class="alert-chip" data-alert-filter="rank" data-value="first_officer">First Officer</span>
            <span class="alert-chip" data-alert-filter="rank" data-value="second_officer">Second Officer / Cruise Relief</span>
            <span class="alert-chip" data-alert-filter="rank" data-value="cadet">Cadet / Trainee</span>
          </div>
          <div class="alert-validation-error" id="rankError">Please select at least one rank</div>
        </div>

        <!-- License Authority -->
        <div class="alert-section">
          <div class="alert-section-title">License Authority</div>
          <div class="alert-chips">
            <span class="alert-chip" data-alert-filter="license_authority" data-value="easa">EASA</span>
            <span class="alert-chip" data-alert-filter="license_authority" data-value="faa">FAA</span>
            <span class="alert-chip" data-alert-filter="license_authority" data-value="uk_caa">UK CAA</span>
            <span class="alert-chip" data-alert-filter="license_authority" data-value="icao">ICAO</span>
          </div>
        </div>

        <!-- Region (Required) -->
        <div class="alert-section" id="regionSection">
          <div class="alert-section-title">Region<span class="required">*</span></div>
          <div class="alert-chips">
            <span class="alert-chip" data-alert-filter="region" data-value="europe">Europe</span>
            <span class="alert-chip" data-alert-filter="region" data-value="middle_east">Middle East</span>
            <span class="alert-chip" data-alert-filter="region" data-value="asia">Asia</span>
            <span class="alert-chip" data-alert-filter="region" data-value="north_america">North America</span>
            <span class="alert-chip" data-alert-filter="region" data-value="south_america">South America</span>
            <span class="alert-chip" data-alert-filter="region" data-value="africa">Africa</span>
            <span class="alert-chip" data-alert-filter="region" data-value="oceania">Oceania</span>
            <span class="alert-chip" data-alert-filter="region" data-value="worldwide">Worldwide</span>
          </div>
          <div class="alert-validation-error" id="regionError">Please select at least one region</div>
        </div>

        <!-- Aircraft Family -->
        <div class="alert-section">
          <div class="alert-section-title">Aircraft Family</div>
          <div class="multi-select" id="aircraftMultiSelect">
            <div class="multi-select-trigger" id="aircraftTrigger">
              <span id="aircraftPlaceholder">Select aircraft types...</span>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </div>
            <div class="multi-select-dropdown" id="aircraftDropdown">
              <!-- Airbus Narrowbody -->
              <div class="multi-select-group">
                <div class="multi-select-group-label">Airbus Narrowbody</div>
                <div class="multi-select-option" data-value="a320" data-label="A320 Family">
                  <div class="multi-select-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
                  <span class="multi-select-label">A320 Family (A318/A319/A320/A321)</span>
                </div>
                <div class="multi-select-option" data-value="a220" data-label="A220">
                  <div class="multi-select-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
                  <span class="multi-select-label">A220 (A220-100/A220-300)</span>
                </div>
              </div>
              <!-- Airbus Widebody -->
              <div class="multi-select-group">
                <div class="multi-select-group-label">Airbus Widebody</div>
                <div class="multi-select-option" data-value="a330" data-label="A330">
                  <div class="multi-select-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
                  <span class="multi-select-label">A330 (A330-200/A330-300/A330neo)</span>
                </div>
                <div class="multi-select-option" data-value="a340" data-label="A340">
                  <div class="multi-select-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
                  <span class="multi-select-label">A340</span>
                </div>
                <div class="multi-select-option" data-value="a350" data-label="A350">
                  <div class="multi-select-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
                  <span class="multi-select-label">A350 (A350-900/A350-1000)</span>
                </div>
                <div class="multi-select-option" data-value="a380" data-label="A380">
                  <div class="multi-select-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
                  <span class="multi-select-label">A380</span>
                </div>
              </div>
              <!-- Boeing Narrowbody -->
              <div class="multi-select-group">
                <div class="multi-select-group-label">Boeing Narrowbody</div>
                <div class="multi-select-option" data-value="b737" data-label="B737 Family">
                  <div class="multi-select-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
                  <span class="multi-select-label">B737 Family (B737NG/B737 MAX)</span>
                </div>
                <div class="multi-select-option" data-value="b757" data-label="B757">
                  <div class="multi-select-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
                  <span class="multi-select-label">B757</span>
                </div>
              </div>
              <!-- Boeing Widebody -->
              <div class="multi-select-group">
                <div class="multi-select-group-label">Boeing Widebody</div>
                <div class="multi-select-option" data-value="b747" data-label="B747">
                  <div class="multi-select-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
                  <span class="multi-select-label">B747</span>
                </div>
                <div class="multi-select-option" data-value="b767" data-label="B767">
                  <div class="multi-select-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
                  <span class="multi-select-label">B767</span>
                </div>
                <div class="multi-select-option" data-value="b777" data-label="B777">
                  <div class="multi-select-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
                  <span class="multi-select-label">B777</span>
                </div>
                <div class="multi-select-option" data-value="b787" data-label="B787">
                  <div class="multi-select-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
                  <span class="multi-select-label">B787 Dreamliner</span>
                </div>
              </div>
              <!-- Regional Jets -->
              <div class="multi-select-group">
                <div class="multi-select-group-label">Regional Jets</div>
                <div class="multi-select-option" data-value="e-jet" data-label="Embraer E-Jet">
                  <div class="multi-select-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
                  <span class="multi-select-label">Embraer E-Jet (E170/E175/E190/E195)</span>
                </div>
                <div class="multi-select-option" data-value="crj" data-label="CRJ">
                  <div class="multi-select-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
                  <span class="multi-select-label">CRJ (CRJ-200/700/900/1000)</span>
                </div>
                <div class="multi-select-option" data-value="erj" data-label="ERJ">
                  <div class="multi-select-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
                  <span class="multi-select-label">ERJ (ERJ-135/140/145)</span>
                </div>
              </div>
              <!-- Turboprops -->
              <div class="multi-select-group">
                <div class="multi-select-group-label">Turboprops</div>
                <div class="multi-select-option" data-value="atr" data-label="ATR">
                  <div class="multi-select-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
                  <span class="multi-select-label">ATR (ATR 42/ATR 72)</span>
                </div>
                <div class="multi-select-option" data-value="dash8" data-label="Dash 8">
                  <div class="multi-select-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
                  <span class="multi-select-label">Dash 8 / DHC-8 (Q100-Q400)</span>
                </div>
                <div class="multi-select-option" data-value="saab" data-label="Saab">
                  <div class="multi-select-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
                  <span class="multi-select-label">Saab 340/2000</span>
                </div>
                <div class="multi-select-option" data-value="metroliner" data-label="Metroliner">
                  <div class="multi-select-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
                  <span class="multi-select-label">Metroliner / Metro</span>
                </div>
              </div>
              <!-- Business Jets -->
              <div class="multi-select-group">
                <div class="multi-select-group-label">Business Jets - Large Cabin</div>
                <div class="multi-select-option" data-value="gulfstream" data-label="Gulfstream">
                  <div class="multi-select-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
                  <span class="multi-select-label">Gulfstream (G-V/G450/G550/G650)</span>
                </div>
                <div class="multi-select-option" data-value="global" data-label="Global">
                  <div class="multi-select-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
                  <span class="multi-select-label">Bombardier Global (5000/6000/7500)</span>
                </div>
                <div class="multi-select-option" data-value="falcon" data-label="Falcon">
                  <div class="multi-select-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
                  <span class="multi-select-label">Dassault Falcon (900/2000/7X/8X)</span>
                </div>
              </div>
              <div class="multi-select-group">
                <div class="multi-select-group-label">Business Jets - Mid/Light</div>
                <div class="multi-select-option" data-value="challenger" data-label="Challenger">
                  <div class="multi-select-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
                  <span class="multi-select-label">Bombardier Challenger (300/350/604/650)</span>
                </div>
                <div class="multi-select-option" data-value="citation" data-label="Citation">
                  <div class="multi-select-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
                  <span class="multi-select-label">Cessna Citation (CJ/XLS/Sovereign/X)</span>
                </div>
                <div class="multi-select-option" data-value="learjet" data-label="Learjet">
                  <div class="multi-select-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
                  <span class="multi-select-label">Learjet (45/60/75)</span>
                </div>
                <div class="multi-select-option" data-value="hawker" data-label="Hawker">
                  <div class="multi-select-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
                  <span class="multi-select-label">Hawker (400/800/900)</span>
                </div>
                <div class="multi-select-option" data-value="phenom" data-label="Phenom">
                  <div class="multi-select-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
                  <span class="multi-select-label">Embraer Phenom (100/300)</span>
                </div>
                <div class="multi-select-option" data-value="praetor" data-label="Praetor">
                  <div class="multi-select-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
                  <span class="multi-select-label">Embraer Praetor (500/600)</span>
                </div>
              </div>
              <!-- Single Engine Turboprops -->
              <div class="multi-select-group">
                <div class="multi-select-group-label">Single Engine Turboprops</div>
                <div class="multi-select-option" data-value="pc12" data-label="PC-12">
                  <div class="multi-select-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
                  <span class="multi-select-label">Pilatus PC-12</span>
                </div>
                <div class="multi-select-option" data-value="pc24" data-label="PC-24">
                  <div class="multi-select-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
                  <span class="multi-select-label">Pilatus PC-24</span>
                </div>
                <div class="multi-select-option" data-value="tbm" data-label="TBM">
                  <div class="multi-select-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
                  <span class="multi-select-label">Daher TBM (850/900/960)</span>
                </div>
                <div class="multi-select-option" data-value="caravan" data-label="Caravan">
                  <div class="multi-select-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
                  <span class="multi-select-label">Cessna Caravan (208/Grand Caravan)</span>
                </div>
                <div class="multi-select-option" data-value="kingair" data-label="King Air">
                  <div class="multi-select-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
                  <span class="multi-select-label">Beechcraft King Air (90/200/350)</span>
                </div>
              </div>
            </div>
            <div class="multi-select-tags" id="aircraftTags"></div>
          </div>
        </div>

        <!-- Type Preference -->
        <div class="alert-section">
          <div class="alert-section-title">Type Preference</div>
          <div class="alert-chips">
            <span class="alert-chip" data-alert-filter="type" data-value="typed">Type-Rated</span>
            <span class="alert-chip" data-alert-filter="type" data-value="ntr">Non-Type-Rated</span>
          </div>
        </div>

        <!-- Operator Type -->
        <div class="alert-section">
          <div class="alert-section-title">Operator Type</div>
          <div class="alert-chips">
            <span class="alert-chip" data-alert-filter="operator" data-value="airline">Airline</span>
            <span class="alert-chip" data-alert-filter="operator" data-value="bizav">BizAv</span>
            <span class="alert-chip" data-alert-filter="operator" data-value="government">Government</span>
            <span class="alert-chip" data-alert-filter="operator" data-value="medical">Medical</span>
            <span class="alert-chip" data-alert-filter="operator" data-value="instructor">Instructor</span>
          </div>
        </div>

        <!-- Perks -->
        <div class="alert-section">
          <div class="alert-section-title">Perks</div>
          <div class="alert-chips">
            <span class="alert-chip" data-alert-filter="perk" data-value="visa">Visa Sponsor</span>
            <span class="alert-chip" data-alert-filter="perk" data-value="direct">Direct Entry</span>
          </div>
        </div>

        <!-- Frequency (Required) -->
        <div class="alert-section" id="frequencySection">
          <div class="alert-section-title">Email Frequency<span class="required">*</span></div>
          <div class="frequency-toggle">
            <div class="frequency-option" data-value="instant" id="freqInstant">
              <span class="freq-icon">⚡</span>
              <div>
                <div class="freq-label">Instant</div>
                <div class="freq-desc">Email per job</div>
              </div>
            </div>
            <div class="frequency-option selected" data-value="digest" id="freqDigest">
              <span class="freq-icon">📅</span>
              <div>
                <div class="freq-label">4-Day Digest</div>
                <div class="freq-desc">Summary every 4 days</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Email -->
        <div class="alert-section" style="margin-bottom:0;">
          <div class="alert-input-group" style="margin-bottom:0;">
            <label for="alertEmail">Email Address<span class="required">*</span></label>
            <input type="email" id="alertEmail" placeholder="you@example.com" required>
          </div>
        </div>
      </div>
      <div class="alert-modal-footer">
        <button class="alert-submit-btn" id="alertSubmitBtn">Subscribe to Alerts</button>
        <p class="alert-disclaimer">We'll send a verification email. You can unsubscribe anytime.</p>
      </div>
    </div>
  </div>

  <!-- Profile Editor Modal -->
  <div class="profile-modal-overlay" id="profileModal">
    <div class="profile-modal">
      <div class="profile-modal-header">
        <h2>Edit Your Profile</h2>
        <button class="profile-modal-close" id="closeProfileModal">&times;</button>
      </div>
      <div class="profile-modal-body">
        <!-- Flight Hours Section -->
        <div class="profile-form-section">
          <h3>Flight Hours</h3>
          <div class="profile-form-row">
            <div class="profile-form-group">
              <label for="profileTotalHours">Total Time</label>
              <input type="number" id="profileTotalHours" placeholder="e.g. 1500" min="0">
            </div>
            <div class="profile-form-group">
              <label for="profilePicHours">PIC Time</label>
              <input type="number" id="profilePicHours" placeholder="e.g. 500" min="0">
            </div>
          </div>
          <div class="profile-form-row">
            <div class="profile-form-group">
              <label for="profileJetTime">Jet Time</label>
              <input type="number" id="profileJetTime" placeholder="e.g. 200" min="0">
            </div>
            <div class="profile-form-group">
              <label for="profileMultiEngine">Multi-Engine</label>
              <input type="number" id="profileMultiEngine" placeholder="e.g. 300" min="0">
            </div>
          </div>
        </div>

        <!-- License Section -->
        <div class="profile-form-section">
          <h3>License</h3>
          <div class="profile-form-row">
            <div class="profile-form-group full-width">
              <label for="profileLicense">Current License</label>
              <select id="profileLicense">
                <option value="PPL">PPL - Private Pilot License</option>
                <option value="CPL">CPL - Commercial Pilot License</option>
                <option value="fATPL">fATPL - Frozen ATPL</option>
                <option value="ATPL">ATPL - Airline Transport Pilot License</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Type Ratings Section -->
        <div class="profile-form-section">
          <h3>Type Ratings</h3>
          <div class="type-ratings-container" id="typeRatingsContainer">
            <!-- Type rating chips will be added here dynamically -->
          </div>
          <div class="add-type-rating" style="position: relative;">
            <input type="text" id="newTypeRating" placeholder="Search type ratings..." autocomplete="off">
            <div class="type-rating-dropdown" id="typeRatingDropdown"></div>
          </div>
          <div class="profile-form-row" style="margin-top: 12px;">
            <div class="profile-form-group full-width">
              <label for="profileTypeTime">Hours on Primary Type</label>
              <input type="number" id="profileTypeTime" placeholder="e.g. 500" min="0">
            </div>
          </div>
        </div>

        <!-- Work Rights Section -->
        <div class="profile-form-section">
          <h3>Work Rights</h3>
          <p style="font-size: 11px; color: #64748b; margin: 0 0 12px 0;">Select regions where you can legally work</p>
          <div class="work-rights-grid">
            <label><input type="checkbox" value="EU" class="work-right-cb"> EU/EEA</label>
            <label><input type="checkbox" value="USA" class="work-right-cb"> USA</label>
            <label><input type="checkbox" value="UK" class="work-right-cb"> UK</label>
            <label><input type="checkbox" value="Middle East" class="work-right-cb"> Middle East</label>
            <label><input type="checkbox" value="Asia" class="work-right-cb"> Asia</label>
            <label><input type="checkbox" value="Africa" class="work-right-cb"> Africa</label>
            <label><input type="checkbox" value="Australia" class="work-right-cb"> Australia</label>
            <label><input type="checkbox" value="Canada" class="work-right-cb"> Canada</label>
            <label><input type="checkbox" value="South America" class="work-right-cb"> S. America</label>
          </div>
        </div>
      </div>
      <div class="profile-modal-footer">
        <button class="profile-cancel-btn" id="cancelProfileBtn">Cancel</button>
        <button class="profile-save-btn" id="saveProfileBtn">Save Profile</button>
      </div>
    </div>
  </div>

  <!-- Salary Notice Modal -->
  <div class="salary-notice-overlay" id="salaryNoticeModal">
    <div class="salary-notice-modal">
      <h3>💰 Sort by Salary</h3>
      <p>Please note that some jobs do not publicly disclose salary information. This sorting feature only works with jobs that have posted their salary. Jobs without salary data will appear at the end of the list.</p>
      <div class="btn-row">
        <button type="button" class="btn-cancel" id="salaryNoticeCancel">Cancel</button>
        <button type="button" class="btn-confirm" id="salaryNoticeConfirm">Got it, Sort by Salary</button>
      </div>
    </div>
  </div>

  <!-- Upgrade to Pro Modal -->
  <div class="upgrade-modal-overlay" id="upgradeModal">
    <div class="upgrade-modal">
      <button class="upgrade-modal-close" id="closeUpgradeModal" type="button">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
      <h3><span>Premium</span> users get</h3>
      <ul class="upgrade-features">
        <li>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
          Instant email alerts on job matches
        </li>
        <li>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
          Smart filters for your experience
        </li>
        <li>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
          Search jobs by map location
        </li>
        <li>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
          Sort jobs by salary
        </li>
        <li>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
          Application tracker
        </li>
      </ul>
      <div class="upgrade-carousel" id="upgradeCarousel">
        <div class="upgrade-carousel-track" id="carouselTrack">
          <img src="images/upgrade-preview.png" alt="Premium features preview" onerror="this.style.display='none'">
          <img src="images/tracker-preview.png" alt="Application Tracker preview" onerror="this.style.display='none'">
        </div>
        <button class="upgrade-carousel-arrow left" id="carouselPrev" type="button">
          <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
        </button>
        <button class="upgrade-carousel-arrow right" id="carouselNext" type="button">
          <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 6 15 12 9 18"></polyline></svg>
        </button>
      </div>
      <div class="upgrade-carousel-dots" id="carouselDots">
        <button class="upgrade-carousel-dot active" type="button"></button>
        <button class="upgrade-carousel-dot" type="button"></button>
      </div>
      <button class="upgrade-buy-btn" id="upgradeBuyBtn" type="button">
        Subscribe <span class="price">$12/mo</span>
      </button>
    </div>
  </div>

  <!-- Map Overlay -->
  <div class="map-overlay" id="mapOverlay">
    <div class="map-container">
      <div class="map-header">
        <h2>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon>
            <line x1="8" y1="2" x2="8" y2="18"></line>
            <line x1="16" y1="6" x2="16" y2="22"></line>
          </svg>
          Job Locations
        </h2>
        <button class="map-close-btn" id="closeMapBtn" type="button">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="map-content">
        <div class="map-loading" id="mapLoading">
          <div class="map-loading-spinner"></div>
          <div class="map-loading-text">Loading map...</div>
        </div>
        <div id="mapbox-map"></div>
        <div class="map-stats" id="mapStats"></div>
        <div class="map-job-preview" id="mapJobPreview">
          <button class="map-job-preview-close" id="closePreview" type="button">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
          <div id="mapJobCardContainer"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Lazy-load external scripts on demand
    let mapboxLoaded = false;
    function loadMapbox() {
      if (mapboxLoaded) return Promise.resolve();
      return new Promise((resolve, reject) => {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css';
        document.head.appendChild(link);

        const script = document.createElement('script');
        script.src = 'https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js';
        script.onload = () => { mapboxLoaded = true; resolve(); };
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    let gumroadLoaded = false;
    function loadGumroad() {
      if (gumroadLoaded) return Promise.resolve();
      return new Promise((resolve) => {
        const script = document.createElement('script');
        script.src = 'https://gumroad.com/js/gumroad.js';
        script.onload = () => { gumroadLoaded = true; resolve(); };
        script.onerror = () => { gumroadLoaded = true; resolve(); }; // non-critical, don't block
        document.head.appendChild(script);
      });
    }

    // Supabase configuration
    const SUPABASE_URL = 'https://ziboktbmbyjbhifsdypa.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InppYm9rdGJtYnlqYmhpZnNkeXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3NjMwODUsImV4cCI6MjA4MjMzOTA4NX0.eayvAsTuezEJZ-SIvEjZmrYaUxmJtntV8pK8fyUBnbY';

    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Premium state (in production this would come from user auth/subscription)
    let isPremium = false;
    let isLoggedIn = false;

    // Saved jobs state
    let savedJobIds = new Set();
    let showingSavedOnly = false;

    // Tracked jobs state
    let trackedJobIds = new Set();

    // Delta filter state - when false, eligibility badges and filtering are disabled
    let deltaFilterEnabled = true;

    // Salary sorting state (premium feature)
    let sortBySalary = false;

    // Pagination state
    const JOBS_PER_PAGE = 10;
    let currentPage = 1;
    let currentFilteredJobs = [];

    // Pilot's profile (loaded from Supabase when logged in)
    let PILOT_PROFILE = {
      totalHours: 1200,
      picHours: 400,
      jetTime: 0,
      multiEngineTime: 0,
      typeRatings: ['A320'],  // Aircraft types the pilot is rated on
      typeTime: { 'A320': 200 },  // Hours on each type
      license: 'CPL',  // Current license: PPL < CPL < ATPL
      workRights: ['EU', 'USA']  // Countries where pilot can legally work
    };

    // License hierarchy (higher = more senior)
    const LICENSE_LEVELS = {
      'PPL': 1,
      'CPL': 2,
      'fATPL': 3,
      'ATPL': 4,
      'ATP': 4  // US equivalent of ATPL
    };

    // Region to countries/cities mapping for location filter
    const REGION_MAPPING = {
      'Europe': [
        'Albania', 'Andorra', 'Austria', 'Belarus', 'Belgium', 'Bosnia', 'Bulgaria', 'Croatia', 'Cyprus', 'Czech', 'Czechia',
        'Denmark', 'Estonia', 'Finland', 'France', 'Germany', 'Greece', 'Hungary', 'Iceland', 'Ireland', 'Italy',
        'Kosovo', 'Latvia', 'Liechtenstein', 'Lithuania', 'Luxembourg', 'Malta', 'Moldova', 'Monaco', 'Montenegro',
        'Netherlands', 'North Macedonia', 'Norway', 'Poland', 'Portugal', 'Romania', 'Russia', 'San Marino', 'Serbia',
        'Slovakia', 'Slovenia', 'Spain', 'Sweden', 'Switzerland', 'Turkey', 'Ukraine', 'United Kingdom', 'UK', 'Britain',
        'Vatican', 'Amsterdam', 'Athens', 'Barcelona', 'Berlin', 'Brussels', 'Budapest', 'Copenhagen', 'Dublin', 'Edinburgh',
        'Frankfurt', 'Geneva', 'Hamburg', 'Helsinki', 'Lisbon', 'London', 'Madrid', 'Milan', 'Munich', 'Oslo', 'Paris',
        'Prague', 'Rome', 'Stockholm', 'Vienna', 'Warsaw', 'Zurich', 'Manchester', 'Birmingham', 'Glasgow', 'Leeds',
        'Liverpool', 'Newcastle', 'Bristol', 'Cardiff', 'Belfast', 'Lyon', 'Marseille', 'Nice', 'Toulouse', 'Cologne',
        'Dusseldorf', 'Stuttgart', 'Hannover', 'Dresden', 'Leipzig', 'Nuremberg', 'Palma', 'Malaga', 'Seville', 'Valencia',
        'Bilbao', 'Alicante', 'Tenerife', 'Gran Canaria', 'Faro', 'Porto', 'Naples', 'Venice', 'Florence', 'Turin', 'Bologna',
        'Gothenburg', 'Malmo', 'Stavanger', 'Bergen', 'Reykjavik', 'Riga', 'Tallinn', 'Vilnius', 'Krakow', 'Gdansk',
        'Bucharest', 'Sofia', 'Zagreb', 'Ljubljana', 'Belgrade', 'Thessaloniki', 'Heraklion', 'Rhodes', 'Corfu'
      ],
      'Middle East': [
        'United Arab Emirates', 'UAE', 'Dubai', 'Abu Dhabi', 'Sharjah', 'Saudi Arabia', 'Riyadh', 'Jeddah', 'Dammam',
        'Qatar', 'Doha', 'Bahrain', 'Manama', 'Kuwait', 'Oman', 'Muscat', 'Jordan', 'Amman', 'Lebanon', 'Beirut',
        'Israel', 'Tel Aviv', 'Iraq', 'Baghdad', 'Iran', 'Tehran', 'Syria', 'Damascus', 'Yemen', 'Palestine',
        'Al Ain', 'Fujairah', 'Ras Al Khaimah', 'Medina', 'Mecca', 'Tabuk', 'Neom'
      ],
      'Asia': [
        'China', 'Japan', 'South Korea', 'Korea', 'India', 'Indonesia', 'Thailand', 'Vietnam', 'Malaysia', 'Singapore',
        'Philippines', 'Taiwan', 'Hong Kong', 'Macau', 'Pakistan', 'Bangladesh', 'Sri Lanka', 'Nepal', 'Myanmar', 'Cambodia',
        'Laos', 'Mongolia', 'Brunei', 'Maldives', 'Bhutan', 'Kazakhstan', 'Uzbekistan', 'Turkmenistan', 'Kyrgyzstan', 'Tajikistan',
        'Afghanistan', 'Beijing', 'Shanghai', 'Guangzhou', 'Shenzhen', 'Chengdu', 'Hangzhou', 'Xian', 'Wuhan', 'Nanjing',
        'Tokyo', 'Osaka', 'Nagoya', 'Fukuoka', 'Sapporo', 'Seoul', 'Busan', 'Incheon', 'Delhi', 'Mumbai', 'Bangalore',
        'Hyderabad', 'Chennai', 'Kolkata', 'Pune', 'Ahmedabad', 'Kochi', 'Goa', 'Jakarta', 'Bali', 'Surabaya', 'Medan',
        'Bangkok', 'Phuket', 'Chiang Mai', 'Pattaya', 'Ho Chi Minh', 'Hanoi', 'Da Nang', 'Kuala Lumpur', 'Penang', 'Langkawi',
        'Manila', 'Cebu', 'Clark', 'Taipei', 'Kaohsiung', 'Karachi', 'Lahore', 'Islamabad', 'Dhaka', 'Colombo', 'Kathmandu',
        'Yangon', 'Phnom Penh', 'Siem Reap', 'Vientiane', 'Ulaanbaatar', 'Male', 'Almaty', 'Nur-Sultan', 'Astana', 'Tashkent'
      ],
      'Oceania': [
        'Australia', 'New Zealand', 'Papua New Guinea', 'Fiji', 'Solomon Islands', 'Vanuatu', 'Samoa', 'Tonga', 'Kiribati',
        'Micronesia', 'Palau', 'Marshall Islands', 'Nauru', 'Tuvalu', 'Guam', 'New Caledonia', 'French Polynesia', 'Tahiti',
        'Sydney', 'Melbourne', 'Brisbane', 'Perth', 'Adelaide', 'Gold Coast', 'Cairns', 'Darwin', 'Hobart', 'Canberra',
        'Auckland', 'Wellington', 'Christchurch', 'Queenstown', 'Hamilton', 'Dunedin', 'Port Moresby', 'Suva', 'Nadi'
      ],
      'United States': [
        'United States', 'USA', 'US', 'America', 'American',
        'Alabama', 'Alaska', 'Arizona', 'Arkansas', 'California', 'Colorado', 'Connecticut', 'Delaware', 'Florida', 'Georgia',
        'Hawaii', 'Idaho', 'Illinois', 'Indiana', 'Iowa', 'Kansas', 'Kentucky', 'Louisiana', 'Maine', 'Maryland',
        'Massachusetts', 'Michigan', 'Minnesota', 'Mississippi', 'Missouri', 'Montana', 'Nebraska', 'Nevada', 'New Hampshire',
        'New Jersey', 'New Mexico', 'New York', 'North Carolina', 'North Dakota', 'Ohio', 'Oklahoma', 'Oregon', 'Pennsylvania',
        'Rhode Island', 'South Carolina', 'South Dakota', 'Tennessee', 'Texas', 'Utah', 'Vermont', 'Virginia', 'Washington',
        'West Virginia', 'Wisconsin', 'Wyoming', 'Puerto Rico', 'Guam',
        'New York City', 'NYC', 'Los Angeles', 'LA', 'Chicago', 'Houston', 'Phoenix', 'Philadelphia', 'San Antonio', 'San Diego',
        'Dallas', 'San Jose', 'Austin', 'Jacksonville', 'Fort Worth', 'Columbus', 'Charlotte', 'San Francisco', 'Indianapolis',
        'Seattle', 'Denver', 'Boston', 'El Paso', 'Nashville', 'Detroit', 'Portland', 'Memphis', 'Oklahoma City', 'Las Vegas',
        'Louisville', 'Baltimore', 'Milwaukee', 'Albuquerque', 'Tucson', 'Fresno', 'Sacramento', 'Mesa', 'Atlanta', 'Kansas City',
        'Colorado Springs', 'Omaha', 'Raleigh', 'Miami', 'Long Beach', 'Virginia Beach', 'Oakland', 'Minneapolis', 'Tampa',
        'New Orleans', 'Honolulu', 'Anchorage', 'Fort Lauderdale', 'Orlando', 'Salt Lake City', 'St. Louis', 'Pittsburgh',
        'Cincinnati', 'Cleveland', 'Tulsa', 'Wichita', 'Arlington', 'Bakersfield', 'Aurora', 'Anaheim', 'Santa Ana', 'Riverside'
      ],
      'Africa': [
        'South Africa', 'Nigeria', 'Kenya', 'Ethiopia', 'Egypt', 'Morocco', 'Ghana', 'Tanzania', 'Angola', 'Mozambique',
        'Cameroon', 'Senegal', 'Tunisia', 'Algeria', 'Libya', 'Sudan', 'Uganda', 'Rwanda', 'Botswana', 'Namibia',
        'Zimbabwe', 'Zambia', 'Malawi', 'Madagascar', 'Mauritius', 'Seychelles', 'Cape Verde', 'Ivory Coast',
        'Johannesburg', 'Cape Town', 'Durban', 'Lagos', 'Abuja', 'Nairobi', 'Addis Ababa', 'Cairo', 'Casablanca',
        'Marrakech', 'Accra', 'Dar es Salaam', 'Luanda', 'Maputo', 'Douala', 'Dakar', 'Tunis', 'Algiers', 'Tripoli',
        'Khartoum', 'Kampala', 'Kigali', 'Gaborone', 'Windhoek', 'Harare', 'Lusaka', 'Antananarivo', 'Zanzibar'
      ],
      'Canada': [
        'Canada', 'Canadian',
        'Toronto', 'Montreal', 'Vancouver', 'Calgary', 'Edmonton', 'Ottawa', 'Winnipeg', 'Quebec City',
        'Hamilton', 'Halifax', 'Victoria', 'Saskatoon', 'Regina', 'St. Johns', 'Kelowna', 'Thunder Bay',
        'Ontario', 'Quebec', 'British Columbia', 'Alberta', 'Manitoba', 'Saskatchewan', 'Nova Scotia',
        'New Brunswick', 'Newfoundland', 'Prince Edward Island', 'Yukon', 'Northwest Territories', 'Nunavut'
      ],
      'South America': [
        'Brazil', 'Argentina', 'Colombia', 'Chile', 'Peru', 'Venezuela', 'Ecuador', 'Bolivia', 'Paraguay', 'Uruguay',
        'Guyana', 'Suriname', 'French Guiana', 'Panama', 'Costa Rica', 'Guatemala', 'Honduras', 'El Salvador',
        'Nicaragua', 'Belize', 'Mexico', 'Cuba', 'Jamaica', 'Dominican Republic', 'Trinidad', 'Barbados', 'Bahamas',
        'Sao Paulo', 'Rio de Janeiro', 'Brasilia', 'Buenos Aires', 'Bogota', 'Santiago', 'Lima', 'Caracas', 'Quito',
        'La Paz', 'Asuncion', 'Montevideo', 'Georgetown', 'Paramaribo', 'Cayenne', 'Panama City', 'San Jose',
        'Guatemala City', 'Tegucigalpa', 'San Salvador', 'Managua', 'Mexico City', 'Cancun', 'Guadalajara', 'Monterrey',
        'Havana', 'Kingston', 'Santo Domingo', 'Port of Spain', 'Nassau', 'Medellin', 'Cartagena', 'Cali'
      ]
    };

    // Map region names to location_bucket prefixes
    const BUCKET_REGION_MAP = {
      'Europe': /^(GB|FR|DE|IT|ES|NL|BE|CH|AT|PT|SE|NO|DK|FI|IS|PL|CZ|HU|RO|BG|HR|RS|SI|SK|EE|LV|LT|CY|MT|LU|GR|IE|AL|BA|ME|MK|XK|MD|TR|UA|EUROPE|EU)(_|$)/,
      'Middle East': /^(AE|SA|QA|BH|OM|KW|JO|LB|IL|IQ|IR|SY|YE|PS|MIDDLE_EAST)(_|$)/,
      'Asia': /^(JP|KR|CN|HK|TW|IN|ID|TH|VN|MY|SG|PH|PK|BD|LK|NP|MM|KH|LA|MN|BN|MV|BT|KZ|UZ|TM|KG|TJ|AF|ASIA)(_|$)/,
      'Oceania': /^(AU|NZ|PG|FJ|SB|VU|WS|TO|KI|FM|PW|MH|NR|TV|GU|NC|PF|OCEANIA)(_|$)/,
      'United States': /^(US)(_|$)/,
      'Africa': /^(ZA|NG|KE|ET|EG|MA|GH|TZ|AO|MZ|CM|SN|TN|DZ|LY|SD|UG|RW|BW|NA|ZW|ZM|MW|MG|MU|SC|CV|CI|AFRICA)(_|$)/,
      'Canada': /^(CA)(_|$)/,
      'South America': /^(BR|AR|CO|CL|PE|VE|EC|BO|PY|UY|GY|SR|GF|PA|CR|GT|HN|SV|NI|BZ|MX|CU|JM|DO|TT|BB|BS|SOUTH_AMERICA|LATIN_AMERICA|CENTRAL_AMERICA)(_|$)/
    };

    // Map pilot work rights values to REGION_MAPPING keys
    const WORK_RIGHTS_TO_REGION = {
      'EU': 'Europe',
      'USA': 'United States',
      'UK': 'Europe',          // UK is included in Europe region mapping
      'Middle East': 'Middle East',
      'Asia': 'Asia',
      'Africa': 'Africa',
      'Australia': 'Oceania',
      'Canada': 'Canada',
      'South America': 'South America'
    };

    // Aircraft type rating families - grouped by type certificate
    // Each entry: typeRating (stored in profile), label (shown in dropdown), variants (DB strings that match)
    const AIRCRAFT_FAMILIES = [
      // Airbus
      { typeRating: 'A220', label: 'A220 (CS300/BD-500)', variants: ['A220'] },
      { typeRating: 'A320', label: 'A320 Family (A318-A321)', variants: ['A320', 'A320 family', 'A320 Family', 'A320fam', 'A32X', 'A321', 'A321neo'] },
      { typeRating: 'A330', label: 'A330', variants: ['A330'] },
      { typeRating: 'A340', label: 'A340', variants: ['A340'] },
      { typeRating: 'A350', label: 'A350', variants: ['A350'] },
      { typeRating: 'A380', label: 'A380', variants: ['A380'] },
      // Boeing
      { typeRating: 'B737', label: 'B737 (all variants incl. NG, MAX)', variants: ['B737', 'B737NG', 'B737 NG', 'B737-200', 'B737-300/900', 'B737 300-900', 'B737-300-900', 'B737-800', 'B737 MAX', 'B737NG/MAX', 'BBJ'] },
      { typeRating: 'B747', label: 'B747 (all variants)', variants: ['B747', 'B747-400', 'B747-8'] },
      { typeRating: 'B757', label: 'B757', variants: ['B757'] },
      { typeRating: 'B767', label: 'B767', variants: ['B767'] },
      { typeRating: 'B777', label: 'B777', variants: ['B777'] },
      { typeRating: 'B787', label: 'B787', variants: ['B787'] },
      // Embraer
      { typeRating: 'ERJ-145', label: 'ERJ-135/145 Family', variants: ['EMB-145', 'ERJ 145', 'ERJ-145', 'ERJ 135/145', 'ERJ family EMB-145', 'EMB135/145'] },
      { typeRating: 'EMB-120', label: 'EMB-120 Brasilia', variants: ['EMB-120'] },
      { typeRating: 'E170/175', label: 'E-Jet E170/E175', variants: ['E170', 'E175', 'EMB 175'] },
      { typeRating: 'E190/195', label: 'E-Jet E190/E195', variants: ['E190', 'E195', 'E195-E2', 'EMB 190', 'Embraer 190-E2'] },
      { typeRating: 'EMB-500', label: 'Phenom 100 (EMB-500)', variants: ['Phenom 100', 'EMB 500'] },
      { typeRating: 'EMB-505', label: 'Phenom 300 (EMB-505)', variants: ['Phenom 300', 'Phenom 300E', 'EMB 505'] },
      { typeRating: 'EMB-135BJ', label: 'Legacy 600/650', variants: ['Legacy 600', 'Legacy 650', 'E35L Legacy'] },
      { typeRating: 'EMB-550', label: 'Legacy 500 / Praetor 600', variants: ['Legacy 500', 'Embraer 550', 'Praetor 600', 'Embraer Praetor 600', 'EMB-550', 'EMB-550 (Praetor)', 'EMB550'] },
      { typeRating: 'E190-Lineage', label: 'Lineage 1000', variants: ['Embraer Lineage 1000'] },
      // Bombardier
      { typeRating: 'CL-600 (CRJ)', label: 'CRJ Series', variants: ['CRJ', 'CRJ 550', 'CRJ-200', 'CRJ1000', 'CRJ Series'] },
      { typeRating: 'CL-600 (Challenger)', label: 'Challenger 604/605/650', variants: ['Challenger 604', 'Challenger 605', 'Challenger 650', 'Challenger 605/650', 'Challenger 650/604/605', 'CL-604', 'CL604', 'CL-605', 'CL605', 'CL-650', 'CL604/605', 'CL-604/605', 'CL-605/650', 'CL605/650'] },
      { typeRating: 'CL-30', label: 'Challenger 300/350/3500', variants: ['CL-30', 'CL30', 'CL-350', 'CL35', 'CL300', 'CL350', 'CL300/350', 'CL300/CL350', 'CL350/3500', 'Challenger 300', 'Challenger 350', 'Challenger 3500', 'Challenger 300/350', 'Challenger 350-3500'] },
      { typeRating: 'BD-700', label: 'Global Express/5000/6000/7500/8000', variants: ['BD-700', 'BD700', 'BD-700 (Global Express)', 'Global', 'Global Express', 'Global 5000', 'Global 6000', 'Global 6500', 'Global 7500', 'Global 8000', 'G7500', 'Bombardier Global 8000'] },
      { typeRating: 'Dash 8', label: 'Dash 8 / Q400 (DHC-8)', variants: ['Dash 8', 'DHC-8', 'Dash 8-100', 'Dash 8-300', 'Dash 8-400', 'Dash 8-Q400', 'Dash Q400', 'Q400', 'Dash 8-100/300'] },
      // Gulfstream
      { typeRating: 'G-IV', label: 'Gulfstream IV/350/400/450', variants: ['G-IV', 'G450', 'G-IV/G350/G400/G450', 'Gulfstream GIV', 'Gulfstream IV-SP', 'Gulfstream 450'] },
      { typeRating: 'G-V', label: 'Gulfstream V/500/550', variants: ['G-V', 'GV', 'G500', 'G550', 'Gulfstream 550', 'Gulfstream G500', 'Gulfstream 500'] },
      { typeRating: 'G200', label: 'Gulfstream G200/G280', variants: ['G200', 'G280', 'Gulfstream 280'] },
      { typeRating: 'G150', label: 'Gulfstream G150', variants: ['G150'] },
      { typeRating: 'G600', label: 'Gulfstream G600', variants: ['G600'] },
      { typeRating: 'G650', label: 'Gulfstream G650/G650ER', variants: ['G650', 'G650ER', 'Gulfstream G650ER', 'Gulfstream G650'] },
      { typeRating: 'G700', label: 'Gulfstream G700/G800', variants: ['G700', 'Gulfstream G800'] },
      // Dassault Falcon
      { typeRating: 'Falcon 2000', label: 'Falcon 2000 series', variants: ['Falcon 2000', 'Falcon 2000LX', 'Falcon 2000LXS', 'Falcon 2000S', 'Falcon 2000EX EASy', 'Falcon DA-EASY/DA-2EASY'] },
      { typeRating: 'Falcon 900', label: 'Falcon 900 series', variants: ['Falcon 900', 'Falcon 900EX', 'Falcon 900EX EASy', 'Falcon 900LX', 'Falcon 900DX', 'Falcon 900 EASy', 'Falcon 900LX/DX'] },
      { typeRating: 'Falcon 7X', label: 'Falcon 7X/8X', variants: ['Falcon 7X', 'Falcon 7X/8X'] },
      { typeRating: 'Falcon 6X', label: 'Falcon 6X', variants: ['Falcon 6X'] },
      { typeRating: 'Falcon 20', label: 'Falcon 20/200', variants: ['Falcon 20/200'] },
      // Cessna Citation
      { typeRating: 'CE-500', label: 'Citation I/II/V/Ultra/Bravo/Encore', variants: ['CE-500', 'CE500', 'Citation Ultra', 'Citation Bravo', 'Citation Ultra/Bravo', 'Citation Ultra/Encore', 'Citation II/SII/Bravo', 'Citation V (560)', 'Citation I / I/SP', 'C500/550/560', 'CE550'] },
      { typeRating: 'CE-525', label: 'Citation CJ1/CJ2/CJ3/CJ4/M2', variants: ['C525', 'CE-525', 'CE525', 'Citation 525', 'CE510S/CE525S', 'CJ3', 'CJ4', 'CJ1+', 'Citation CJ2+', 'Citation CJ3/CJ2/CJ1+', 'Citation M2', 'Citation M2/CJ series', 'Citation M2/CJ', 'M2/CJ series', 'C525A (CJ2)', 'Cessna Citation C525A (CJ2)'] },
      { typeRating: 'CE-560', label: 'Citation Excel/XLS/XLS+', variants: ['CE-560', 'CE-560E', 'CE-560XL', 'CE-560 XLS', 'C560 Citation', 'C560XL/XLS', 'C56X', 'Cessna 560 XLS+', 'Citation Excel', 'Citation XLS', 'CITATION XLS', 'Citation XLS+', 'Citation XLS/XLS+', 'Citation Excel/XLS/XLS+', '560XLS+', 'XLS/XLS+', 'XLS+'] },
      { typeRating: 'CE-680', label: 'Citation Sovereign/Latitude', variants: ['C680', 'C680A', 'Citation Sovereign', 'Citation Sovereign 680', 'Citation Sovereign+', 'Citation Latitude'] },
      { typeRating: 'CE-750', label: 'Citation X/X+', variants: ['CE-750', 'Citation X', 'Citation 650'] },
      // Learjet
      { typeRating: 'LR-45', label: 'Learjet 40/45/75', variants: ['LR-45', 'LR45', 'Learjet 45', 'Lear 45', 'Learjet 45 XR', 'Lear45XR', 'LJ45', 'Learjet 40XR', 'Lear 40XR', 'Learjet 75'] },
      { typeRating: 'LR-60', label: 'Learjet 55/60', variants: ['LR-60', 'LR60', 'Learjet 60', 'Lear 60', 'Learjet 60XR', 'Learjet 60/XR', 'Lear 60XR', 'LEAR 60/60XR', 'Learjet 55'] },
      { typeRating: 'Learjet 35', label: 'Learjet 31/35', variants: ['Learjet', 'Learjet 35', 'Learjet 31A/35A'] },
      // Hawker / BAe
      { typeRating: 'HS-125', label: 'Hawker 800/850/900/4000', variants: ['HS-125', 'Hawker', 'Hawker 800', 'Hawker 800XP', 'Hawker 800XP/850XP', 'Hawker 800/850/900', 'Hawker 900XP', 'Hawker 4000', 'Nextant 400XT'] },
      { typeRating: 'BAe 146', label: 'BAe 146 / Avro RJ', variants: ['BAe 146 / Avro RJ', 'BAe 146-RJ100', 'Avro RJ', 'RJ85/100'] },
      // Beechcraft / King Air
      { typeRating: 'King Air 90', label: 'King Air 90/C90', variants: ['King Air', 'King Air 90', 'King Air C90', 'BE90'] },
      { typeRating: 'King Air 200', label: 'King Air 200 (BE-200)', variants: ['King Air 200', 'B200', 'B200 King Air', 'BE200GT', 'BE20', 'BE20 King Air 200', 'BE02', 'Super King Air'] },
      { typeRating: 'King Air 350', label: 'King Air 350 (BE-300)', variants: ['King Air 350', 'BE-300', 'BE260/360'] },
      { typeRating: 'B1900', label: 'Beechcraft 1900', variants: ['B1900', 'B190', 'BE1900', 'Beechcraft 1900', 'Beechcraft 1900D'] },
      // Turboprops
      { typeRating: 'PC-12', label: 'Pilatus PC-12', variants: ['PC-12', 'PC12', 'PC-12-47E', 'PC-12/47E', 'PC-12NGX', 'PC-12NGX/PRO'] },
      { typeRating: 'PC-24', label: 'Pilatus PC-24', variants: ['PC-24', 'PC24'] },
      { typeRating: 'ATR-42', label: 'ATR 42', variants: ['ATR-42', 'ATR 42'] },
      { typeRating: 'ATR-72', label: 'ATR 72', variants: ['ATR-72', 'ATR 72-600', 'ATR 72/600', 'ATR72-600', 'ATR 72-500', 'ATR72-500/600'] },
      { typeRating: 'DHC-6', label: 'DHC-6 Twin Otter', variants: ['DHC-6', 'DHC-6 Twin Otter', 'DHC-6-300/DHC-6-400', 'DHC6', 'Twin Otter'] },
      { typeRating: 'Saab 340', label: 'Saab 340', variants: ['Saab 340'] },
      { typeRating: 'Saab 2000', label: 'Saab 2000', variants: ['Saab 2000'] },
      { typeRating: 'C208', label: 'Cessna 208 Caravan', variants: ['C208', 'C-208', 'C208B', 'C-208 Amphibian', 'Cessna 208', 'Cessna 208 Caravan', 'Cessna 208B Supervan', 'Cessna Caravan', 'Cessna Grand Caravan', 'Caravan', '208B Grand Caravan'] },
      { typeRating: 'Metro', label: 'Fairchild Metro/Merlin', variants: ['Metro', 'Metroliner', 'SA226/227', 'SA227', 'Metro 2', 'Metro 3', 'Metro 23', 'Merlin'] },
      { typeRating: 'PA-31', label: 'Piper Navajo/Chieftain', variants: ['PA-31', 'PA-31-350', 'PA31 Navajo'] },
      { typeRating: 'Dornier 228', label: 'Dornier 228', variants: ['Dornier 228'] },
      { typeRating: 'DO-328', label: 'Dornier 328', variants: ['DO328-100TP', 'Dornier 328-300'] },
      { typeRating: 'BN-2', label: 'BN-2 Islander', variants: ['BN-2', 'BN-2 Islander', 'BN2 Islander', 'Tecnam P2012'] },
      { typeRating: 'DHC-3', label: 'DHC-3 Otter', variants: ['DHC-3 Otter', 'DHC-3T'] },
      { typeRating: 'DHC-2', label: 'DHC-2 Beaver', variants: ['DHC-2 Beaver', 'deHavilland Beaver'] },
      { typeRating: 'Jetstream 31', label: 'BAe Jetstream 31/32', variants: ['Jetstream 31/32'] },
      // HondaJet
      { typeRating: 'HA-420', label: 'HondaJet HA-420', variants: ['HA-420', 'HA-420 HondaJet', 'HondaJet'] }
    ];

    // Build lookup: variant string (lowercase) → typeRating
    const VARIANT_TO_TYPE = {};
    AIRCRAFT_FAMILIES.forEach(fam => {
      fam.variants.forEach(v => {
        VARIANT_TO_TYPE[v.toLowerCase()] = fam.typeRating;
      });
    });

    // Check if pilot has the type rating required for a job
    // Handles exact matches AND compound/multi-type job aircraft strings
    function pilotHasTypeForJob(pilotTypeRatings, jobAircraft) {
      if (!jobAircraft || !pilotTypeRatings || pilotTypeRatings.length === 0) return false;
      const jobLower = jobAircraft.toLowerCase();

      // For each pilot type rating, get its family and check
      return pilotTypeRatings.some(pilotType => {
        const family = AIRCRAFT_FAMILIES.find(f => f.typeRating === pilotType);
        if (!family) {
          // Legacy/custom type rating — fall back to simple string match
          return jobLower.includes(pilotType.toLowerCase());
        }
        // Check if any variant of this family matches the job aircraft
        return family.variants.some(variant => {
          const varLower = variant.toLowerCase();
          // Exact match
          if (jobLower === varLower) return true;
          // Contains match for compound strings (e.g. "A320/B737" contains "A320")
          // Only match if variant is 3+ chars to avoid false positives
          if (varLower.length >= 3 && jobLower.includes(varLower)) return true;
          return false;
        });
      });
    }

    // Function to check if a location matches a region
    function locationMatchesRegion(jobLocation, jobLocationBucket, selectedRegion) {
      if (!selectedRegion || selectedRegion === '') return true;

      // Primary: use location_bucket if available and classifiable
      if (jobLocationBucket && jobLocationBucket !== 'UNKNOWN' && jobLocationBucket !== '' && jobLocationBucket !== 'LOCATION_UNSPECIFIED') {
        // Worldwide/global jobs match every region
        if (jobLocationBucket === 'WORLDWIDE' || jobLocationBucket.startsWith('GLOBAL_')) return true;
        const bucketRegex = BUCKET_REGION_MAP[selectedRegion];
        if (bucketRegex) {
          return bucketRegex.test(jobLocationBucket);
        }
      }

      // Fallback: text matching on location string
      if (!jobLocation) return false;
      const locationLower = jobLocation.toLowerCase();
      const regionCountries = REGION_MAPPING[selectedRegion];

      if (!regionCountries) {
        return locationLower.includes(selectedRegion.toLowerCase());
      }

      return regionCountries.some(place => locationLower.includes(place.toLowerCase()));
    }

    // Jobs will be loaded from Supabase
    let JOBS = [];

    // Total job counts from Supabase (for header display)
    let totalPilotJobCount = 0;
    let totalCabinCrewJobCount = 0;

    // Store last GMT time from API (for display consistency)
    let lastApiGmtTime = null;

    // Current job type (pilot or cabin_crew)
    let currentJobType = 'pilot';

    // Fetch job count from API endpoint
    async function fetchJobCount(jobType = 'pilot') {
      try {
        const response = await fetch(`/api/get-job-count?type=${jobType}`);
        if (!response.ok) {
          console.error('Failed to fetch job count:', response.statusText);
          return null;
        }
        const data = await response.json();
        return data;
      } catch (error) {
        console.error('Error fetching job count:', error);
        return null;
      }
    }

    // Update job count in header from API
    async function updateJobCountFromAPI(jobType = null) {
      // If no job type specified, use current job type
      const typeToFetch = jobType || currentJobType;
      const countData = await fetchJobCount(typeToFetch);

      if (countData) {
        // Update the appropriate counter
        if (typeToFetch === 'pilot') {
          totalPilotJobCount = countData.count;
        } else {
          totalCabinCrewJobCount = countData.count;
        }

        // Store the GMT time from API
        lastApiGmtTime = countData.gmtTime;

        // Only update display if this matches the currently selected job type
        if (typeToFetch === currentJobType) {
          el("jobCount").textContent = countData.count;
          el("gmtTime").textContent = countData.gmtTime;
        }
      }
    }

    // Fetch pilot jobs from Supabase verified_jobs table (with pagination to get all)
    async function fetchPilotJobs() {
      try {
        let allData = [];
        let page = 0;
        const pageSize = 1000;
        let hasMore = true;

        while (hasMore) {
          const { data, error } = await supabaseClient
            .from('verified_jobs')
            .select('*')
            .order('verified_at', { ascending: false })
            .range(page * pageSize, (page + 1) * pageSize - 1);

          if (error) {
            console.error('Error fetching verified jobs:', error);
            break;
          }

          allData = allData.concat(data);
          hasMore = data.length === pageSize;
          page++;
        }

        const data = allData;
        console.log('Fetched', data.length, 'verified pilot jobs from Supabase');
        // Debug: log first job's license data
        if (data.length > 0) {
          console.log('Sample job license_required:', data[0].license_required, 'type_rated:', data[0].type_rated);
        }

        return data.map(job => {
          let orgName = job.airline || 'Unknown Airline';

          return {
            id: job.id,
            title: job.title || '',
            org: orgName,
            location: job.location || '',
            chips: [job.aircraft, job.rank].filter(Boolean),
            visa: job.visa_sponsor || false,
            direct: job.direct_entry || false,
            license: (() => {
              if (Array.isArray(job.license_required)) return job.license_required;
              if (typeof job.license_required === 'string') {
                try {
                  const parsed = JSON.parse(job.license_required);
                  return Array.isArray(parsed) ? parsed : [parsed];
                } catch { return [job.license_required]; }
              }
              return ['ATPL'];
            })(),
            type: job.type_rated ? 'typed' : 'standard',
            operator_type: job.operator_type || 'airline',
            flightTime: job.total_hours || 0,
            pic: job.pic_hours || 0,
            jetTime: job.jet_time || 0,
            multiEngine: job.multi_engine_time || 0,
            salary: job.salary_usd || 0,
            requiredType: job.type_rated ? (job.aircraft || '') : '',  // Only set required type for type-rated jobs
            minTypeTime: 0,
            workRegion: job.location || 'International',
            logo: job.logo_url || '',
            applyUrl: job.url || '#',
            description: job.description_summary || '',
            requirements: job.requirements || '',
            rank: job.rank || '',
            aircraft: job.aircraft || '',
            typeRated: job.type_rated || false,
            visaSponsor: job.visa_sponsor || false,
            roster: job.roster || '',
            jobType: 'pilot',
            latitude: job.latitude || null,
            longitude: job.longitude || null,
            locationBucket: job.location_bucket || ''
          };
        });
      } catch (err) {
        console.error('Failed to fetch pilot jobs:', err);
        return [];
      }
    }

    // Fetch cabin crew jobs from Supabase verified_cabin_crew_jobs table (with pagination)
    async function fetchCabinCrewJobs() {
      try {
        let allData = [];
        let page = 0;
        const pageSize = 1000;
        let hasMore = true;

        while (hasMore) {
          const { data, error } = await supabaseClient
            .from('verified_cabin_crew_jobs')
            .select('*')
            .order('verified_at', { ascending: false })
            .range(page * pageSize, (page + 1) * pageSize - 1);

          if (error) {
            console.error('Error fetching verified cabin crew jobs:', error);
            break;
          }

          allData = allData.concat(data);
          hasMore = data.length === pageSize;
          page++;
        }

        const data = allData;
        console.log('Fetched', data.length, 'verified cabin crew jobs from Supabase');

        return data.map(job => {
          let orgName = job.airline || 'Unknown Airline';

          return {
            id: job.id,
            title: job.title || '',
            org: orgName,
            location: job.location || '',
            chips: [job.position, job.contract_type].filter(Boolean),
            visa: job.visa_sponsor || false,
            direct: false,
            license: '',
            type: 'standard',
            operator_type: job.operator_type || 'airline',
            experienceYears: job.experience_years || 0,
            languageRequirements: job.language_requirements || '',
            salary: job.salary_usd || '',
            contractType: job.contract_type || '',
            workRegion: job.location || 'International',
            logo: job.logo_url || '',
            applyUrl: job.url || '#',
            description: job.description_summary || '',
            requirements: job.requirements || '',
            position: job.position || '',
            jobType: 'cabin_crew',
            // New cabin crew physical requirement fields
            minHeightCm: job.min_height_cm || null,
            armReachCm: job.arm_reach_cm || null,
            swimmingAbility: job.swimming_ability || false,
            minAge: job.min_age || null,
            benefits: job.benefits || [],
            latitude: job.latitude || null,
            longitude: job.longitude || null,
            locationBucket: job.location_bucket || ''
          };
        });
      } catch (err) {
        console.error('Failed to fetch cabin crew jobs:', err);
        return [];
      }
    }

    // Fetch jobs based on current job type
    async function fetchJobs() {
      if (currentJobType === 'pilot') {
        return await fetchPilotJobs();
      } else {
        return await fetchCabinCrewJobs();
      }
    }

    // Generate JSON-LD structured data for Google Jobs
    function injectJobPostingSchema(jobs) {
      // Remove any existing schema
      const existing = document.getElementById('jobposting-schema');
      if (existing) existing.remove();

      const schema = jobs.slice(0, 20).map(j => {
        const posting = {
          '@type': 'JobPosting',
          'title': j.title,
          'description': j.description || j.title,
          'url': j.applyUrl && j.applyUrl !== '#' ? j.applyUrl : `https://www.aeroscout.net/Jobs.html?job=${j.id}`,
          'hiringOrganization': {
            '@type': 'Organization',
            'name': j.org
          },
          'jobLocationType': 'TELECOMMUTE'
        };

        if (j.logo) {
          posting.hiringOrganization.logo = j.logo;
        }

        if (j.location) {
          posting.jobLocation = {
            '@type': 'Place',
            'address': j.location
          };
          delete posting.jobLocationType;
        }

        if (j.salary && j.salary > 0) {
          posting.baseSalary = {
            '@type': 'MonetaryAmount',
            'currency': 'USD',
            'value': {
              '@type': 'QuantitativeValue',
              'value': j.salary,
              'unitText': 'YEAR'
            }
          };
        }

        if (j.rank) posting.occupationalCategory = j.rank;
        if (j.aircraft) posting.skills = j.aircraft;

        return posting;
      });

      const script = document.createElement('script');
      script.id = 'jobposting-schema';
      script.type = 'application/ld+json';
      script.textContent = JSON.stringify({
        '@context': 'https://schema.org',
        '@graph': schema
      });
      document.head.appendChild(script);
    }

    // Generate single job schema for ?job= view
    function injectSingleJobSchema(j) {
      const existing = document.getElementById('jobposting-schema');
      if (existing) existing.remove();

      const posting = {
        '@context': 'https://schema.org',
        '@type': 'JobPosting',
        'title': j.title,
        'description': j.description || j.title,
        'url': `https://www.aeroscout.net/jobs/${j.id}`,
        'directApply': true,
        'hiringOrganization': {
          '@type': 'Organization',
          'name': j.org
        }
      };

      if (j.logo) {
        posting.hiringOrganization.logo = j.logo;
      }

      if (j.location) {
        posting.jobLocation = {
          '@type': 'Place',
          'address': j.location
        };
      }

      if (j.salary && j.salary > 0) {
        posting.baseSalary = {
          '@type': 'MonetaryAmount',
          'currency': 'USD',
          'value': {
            '@type': 'QuantitativeValue',
            'value': j.salary,
            'unitText': 'YEAR'
          }
        };
      }

      if (j.applyUrl && j.applyUrl !== '#') {
        posting.applicationContact = {
          '@type': 'ContactPoint',
          'url': j.applyUrl
        };
      }

      if (j.rank) posting.occupationalCategory = j.rank;
      if (j.aircraft) posting.skills = j.aircraft;

      const script = document.createElement('script');
      script.id = 'jobposting-schema';
      script.type = 'application/ld+json';
      script.textContent = JSON.stringify(posting);
      document.head.appendChild(script);
    }

    const el = (id) => document.getElementById(id);

    // Dual range slider for flight time
    const ftSliderMin = el("ftSliderMin");
    const ftSliderMax = el("ftSliderMax");
    const ftLabel = el("ftLabel");
    const ftHighlight = el("ftHighlight");

    function syncFT() {
      let minVal = Number(ftSliderMin.value);
      let maxVal = Number(ftSliderMax.value);

      // Ensure min doesn't exceed max
      if (minVal > maxVal) {
        // Swap them
        const temp = minVal;
        minVal = maxVal;
        maxVal = temp;
        ftSliderMin.value = minVal;
        ftSliderMax.value = maxVal;
      }

      // Update label
      const minText = minVal.toLocaleString();
      const maxText = maxVal >= 10000 ? '10,000+' : maxVal.toLocaleString();
      ftLabel.textContent = `${minText} - ${maxText}`;

      // Update highlight bar position
      const percent1 = (minVal / 10000) * 100;
      const percent2 = (maxVal / 10000) * 100;
      ftHighlight.style.left = percent1 + '%';
      ftHighlight.style.width = (percent2 - percent1) + '%';
    }

    ftSliderMin.addEventListener("input", syncFT);
    ftSliderMax.addEventListener("input", syncFT);
    syncFT(); // Initialize

    // Delta slider
    const deltaSlider = el("deltaSlider");
    const deltaLabel = el("deltaLabel");

    function syncDelta() {
      const val = Number(deltaSlider.value);
      if (val === 0) {
        deltaLabel.textContent = "Eligible only";
      } else {
        deltaLabel.textContent = `≤ ${val.toLocaleString()} hrs away`;
      }
    }

    deltaSlider.addEventListener("input", () => {
      syncDelta();
      updateMatchCount();
    });

    // Eligible only checkbox
    const eligibleOnlyCheckbox = el("eligibleOnly");
    eligibleOnlyCheckbox.addEventListener("change", () => {
      if (eligibleOnlyCheckbox.checked) {
        deltaSlider.value = 0;
        syncDelta();
      }
      updateMatchCount();
    });

    // Include blockers checkbox (premium feature)
    const includeBlockersCheckbox = el("includeBlockers");
    includeBlockersCheckbox.addEventListener("change", () => {
      updateMatchCount();
    });

    // Delta filter toggle buttons - turns the whole delta/eligibility filter on/off
    const deltaContent = el("deltaContent");
    const deltaDisabled = el("deltaDisabled");
    const turnOffDeltaBtn = el("turnOffDeltaBtn");
    const turnOnDeltaBtn = el("turnOnDeltaBtn");

    function setDeltaFilterState(enabled) {
      deltaFilterEnabled = enabled;
      if (enabled) {
        deltaContent.style.display = "block";
        deltaDisabled.style.display = "none";
      } else {
        deltaContent.style.display = "none";
        deltaDisabled.style.display = "block";
      }
      // Re-render jobs to show/hide eligibility badges
      apply();
    }

    turnOffDeltaBtn.addEventListener("click", () => setDeltaFilterState(false));
    turnOnDeltaBtn.addEventListener("click", () => setDeltaFilterState(true));

    // Show upgrade modal (reusable for all premium features)
    const upgradeModal = el("upgradeModal");

    function showUpgradeModal() {
      upgradeModal.classList.add("visible");
    }

    function closeUpgradeModal() {
      upgradeModal.classList.remove("visible");
    }

    // Close modal button
    el("closeUpgradeModal").addEventListener("click", closeUpgradeModal);

    // Close modal when clicking outside
    upgradeModal.addEventListener("click", (e) => {
      if (e.target === upgradeModal) closeUpgradeModal();
    });

    // Upgrade modal carousel
    (function() {
      const track = el("carouselTrack");
      const dots = document.querySelectorAll(".upgrade-carousel-dot");
      let currentSlide = 0;
      const totalSlides = track.children.length;

      function goToSlide(n) {
        currentSlide = (n + totalSlides) % totalSlides;
        track.style.transform = `translateX(-${currentSlide * 100}%)`;
        dots.forEach((d, i) => d.classList.toggle("active", i === currentSlide));
      }

      el("carouselPrev").addEventListener("click", () => goToSlide(currentSlide - 1));
      el("carouselNext").addEventListener("click", () => goToSlide(currentSlide + 1));
      dots.forEach((dot, i) => dot.addEventListener("click", () => goToSlide(i)));
    })();

    // Buy button - redirect to Gumroad
    el("upgradeBuyBtn").addEventListener("click", async () => {
      const { data: { session } } = await supabaseClient.auth.getSession();

      if (!session) {
        alert("Please log in to access premium features");
        window.location.href = "login.html";
        return;
      }

      // Store user ID in localStorage so webhook can link the purchase
      localStorage.setItem('pending_gumroad_user_id', session.user.id);
      localStorage.setItem('pending_gumroad_email', session.user.email);

      // Redirect to Gumroad checkout with email prefilled (works on mobile)
      const gumroadUrl = `https://aeroscout.gumroad.com/l/dmtwbg?email=${encodeURIComponent(session.user.email)}&wanted=true`;
      window.location.href = gumroadUrl;
    });

    // Auto-show upgrade modal if coming from pricing page
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('upgrade') === 'true') {
      showUpgradeModal();
      window.history.replaceState({}, '', window.location.pathname);
    }

    // Show upgrade modal when non-premium user tries to access premium feature
    function redirectToUpgrade() {
      showUpgradeModal();
    }

    // Premium unlock button - Gumroad integration
    const premiumLock = el("premiumLock");
    el("unlockBtn").addEventListener("click", showUpgradeModal);

    // Check login status and premium status on page load
    async function checkLoginStatus() {
      const { data: { session } } = await supabaseClient.auth.getSession();
      isLoggedIn = !!session;

      if (session) {
        // Check if user has premium status
        const { data: profile } = await supabaseClient
          .from('profiles')
          .select('is_premium')
          .eq('id', session.user.id)
          .single();

        if (profile && profile.is_premium) {
          isPremium = true;
          updatePremiumUI();
          updateMatchCount();
        }
      }

      // Handle payment success/cancel redirects
      const urlParams = new URLSearchParams(window.location.search);
      const paymentStatus = urlParams.get('payment');

      if (paymentStatus === 'success') {
        // Remove query param from URL
        window.history.replaceState({}, document.title, window.location.pathname);

        // Show success message and refresh premium status
        alert('Payment successful! Welcome to AeroScout Pro!');

        // Re-check premium status (webhook may have already updated it)
        if (session) {
          const { data: profile } = await supabaseClient
            .from('profiles')
            .select('is_premium')
            .eq('id', session.user.id)
            .single();

          if (profile && profile.is_premium) {
            isPremium = true;
            updatePremiumUI();
            updateMatchCount();
            apply();
          }
        }
      } else if (paymentStatus === 'cancelled') {
        window.history.replaceState({}, document.title, window.location.pathname);
        alert('Payment was cancelled. You can upgrade anytime.');
      }

      // Load saved jobs after auth check
      await loadSavedJobs();
      // Load tracked jobs (beta feature)
      await loadTrackedJobs();
    }
    checkLoginStatus();

    function updatePremiumUI() {
      const sortSalaryBtn = el("sortSalaryBtn");
      const trackerProTag = document.querySelector('.tracker-pro-tag');

      if (isPremium) {
        premiumLock.classList.add("hidden");
        // Update sort salary button to unlocked state
        sortSalaryBtn.classList.remove("locked");
        sortSalaryBtn.classList.add("unlocked");
        sortSalaryBtn.innerHTML = '<span>Sort by Salary</span><span class="premium-tag">Pro</span>';
        // Hide Pro tag on Tracker nav button
        if (trackerProTag) trackerProTag.style.display = 'none';
      } else {
        premiumLock.classList.remove("hidden");
        // Keep sort salary button locked
        sortSalaryBtn.classList.add("locked");
        sortSalaryBtn.classList.remove("unlocked");
        sortSalaryBtn.innerHTML = '<span>Sort by Salary</span><span class="premium-tag">Pro</span>';
        // Show Pro tag on Tracker nav button
        if (trackerProTag) trackerProTag.style.display = '';
      }
    }

    function updateMatchCount() {
      const filtered = getFilteredJobs();
      el("matchCount").textContent = `${filtered.length} Jobs`;
    }

    function badgeHTML(chips){
      return chips.map(c => `<span class="chip">${c}</span>`).join("");
    }

    function iconLetter(name){
      const s = (name || "A").trim();
      return (s[0] || "A").toUpperCase();
    }

    // Format salary with commas and handle ranges
    function formatSalary(salary) {
      if (!salary || salary === 0 || salary === "0") return null;

      const salaryStr = String(salary);

      // Check if it's a range (contains hyphen)
      if (salaryStr.includes('-')) {
        const parts = salaryStr.split('-');
        if (parts.length === 2) {
          const low = parseInt(parts[0], 10);
          const high = parseInt(parts[1], 10);
          if (!isNaN(low) && !isNaN(high)) {
            return {
              formatted: `$${low.toLocaleString()}-$${high.toLocaleString()}/yr`,
              isRange: true
            };
          }
        }
      }

      // Single value
      const val = parseInt(salaryStr, 10);
      if (!isNaN(val) && val > 0) {
        return {
          formatted: `$${val.toLocaleString()}/yr`,
          isRange: false
        };
      }

      return null;
    }

    // Toggle job description expand/collapse
    function toggleDescription(expandLink) {
      const card = expandLink.closest('.card');
      const descriptionDiv = card.querySelector('.job-description');

      expandLink.classList.toggle('expanded');
      descriptionDiv.classList.toggle('expanded');

      // Update link text
      if (expandLink.classList.contains('expanded')) {
        expandLink.childNodes[0].textContent = 'Hide description ';
      } else {
        expandLink.childNodes[0].textContent = 'See job description ';
      }
    }

    // Parse requirements JSON and render as bullet list
    function renderRequirements(requirementsJson) {
      if (!requirementsJson) return '';

      try {
        // Parse JSON string to array
        let requirements = requirementsJson;
        if (typeof requirementsJson === 'string') {
          requirements = JSON.parse(requirementsJson);
        }

        if (!Array.isArray(requirements) || requirements.length === 0) {
          return '';
        }

        // Render as bullet list
        const items = requirements.map(req => `<li>${req}</li>`).join('');
        return `<ul class="requirements-list">${items}</ul>`;
      } catch (e) {
        console.warn('Failed to parse requirements:', e);
        return '';
      }
    }

    /**
     * Calculate the eligibility delta for a job
     * Returns an object with all the gaps between pilot profile and job requirements
     *
     * Key concepts:
     * - ttGap/picGap/typeTimeGap = hours the pilot is short (can be built up over time)
     * - hasType = whether pilot has the required type rating (hard blocker if missing)
     * - hasLicense = whether pilot has the required license level (hard blocker if missing)
     * - hasWorkRights = whether pilot can legally work in that region (hard blocker if missing)
     * - hoursGap = the largest hours gap (used for "within X hours" slider)
     * - hasBlocker = true if any hard blocker exists (type/license/work rights)
     */
    function calculateDelta(job) {
      const pilot = PILOT_PROFILE;

      // 1. Total Time Delta - how many hours short?
      const ttGap = Math.max(0, job.flightTime - pilot.totalHours);
      const ttMet = pilot.totalHours >= job.flightTime;

      // 2. PIC Time Delta - how many PIC hours short?
      const picGap = Math.max(0, job.pic - pilot.picHours);
      const picMet = pilot.picHours >= job.pic;

      // 2b. Jet Time Delta - only check if job requires jet time
      const jobJetTime = job.jetTime || 0;
      const jetGap = jobJetTime > 0 ? Math.max(0, jobJetTime - pilot.jetTime) : 0;
      const jetMet = jobJetTime > 0 ? pilot.jetTime >= jobJetTime : true;

      // 2c. Multi-Engine Time Delta - only check if job requires multi-engine time
      const jobME = job.multiEngine || 0;
      const meGap = jobME > 0 ? Math.max(0, jobME - pilot.multiEngineTime) : 0;
      const meMet = jobME > 0 ? pilot.multiEngineTime >= jobME : true;

      // 3. Type Rating Check
      // Only check type rating if the job REQUIRES it (typeRated === true)
      // NTR jobs (typeRated === false) don't require type rating
      const needsType = job.typeRated === true && job.requiredType;
      const hasType = needsType ? pilotHasTypeForJob(pilot.typeRatings, job.requiredType) : true;
      const missingTypeBlocker = needsType && !hasType;

      // 4. Type Time Gap (only if pilot HAS the type rating)
      // If they have the type, check if they have enough hours ON that type
      let typeTimeGap = 0;
      let typeTimeMet = true;
      if (needsType && hasType && job.minTypeTime > 0) {
        const pilotTypeTime = pilot.typeTime[job.requiredType] || 0;
        typeTimeGap = Math.max(0, job.minTypeTime - pilotTypeTime);
        typeTimeMet = pilotTypeTime >= job.minTypeTime;
      }

      // 5. License Check - is pilot's license sufficient?
      // job.license is now an array of acceptable licenses
      const jobLicenses = Array.isArray(job.license) ? job.license : [job.license];
      const pilotLicenseLevel = LICENSE_LEVELS[pilot.license] || 0;
      // Pilot qualifies if their license level >= ANY of the job's acceptable license levels
      const hasLicense = jobLicenses.some(lic => pilotLicenseLevel >= (LICENSE_LEVELS[lic] || 0));
      const missingLicenseBlocker = !hasLicense;
      // For display: show the minimum required license (lowest level in the array)
      const minJobLicenseLevel = Math.min(...jobLicenses.map(lic => LICENSE_LEVELS[lic] || 0));
      const jobLicenseDisplay = jobLicenses.join('/');  // e.g., "CPL/ATPL"

      // 6. Work Rights Check - can pilot legally work in this region?
      // Skip if job offers visa sponsorship or pilot has no work rights set
      const jobLocation = job.workRegion || '';
      const jobBucket = job.locationBucket || '';
      const pilotRights = pilot.workRights || [];
      const needsWorkRights = pilotRights.length > 0 && !job.visa && jobLocation !== '';
      let hasWorkRights = true;
      if (needsWorkRights) {
        // Check if ANY of the pilot's work right regions match the job location
        hasWorkRights = pilotRights.some(right => {
          const regionKey = WORK_RIGHTS_TO_REGION[right];
          if (!regionKey) return false;
          return locationMatchesRegion(jobLocation, jobBucket, regionKey);
        });
      }
      const missingWorkRightsBlocker = needsWorkRights && !hasWorkRights;

      // 7. The "hours gap" includes TT, PIC, jet, multi-engine, and type time (things you can fly toward)
      // Hard blockers (missing type, license, work rights) are NOT included
      const hoursGap = Math.max(ttGap, picGap, jetGap, meGap, typeTimeGap);

      // 8. Any hard blocker present?
      const hasBlocker = missingTypeBlocker || missingLicenseBlocker || missingWorkRightsBlocker;

      // 9. Overall eligibility = ALL requirements must be met
      const isEligible = ttMet && picMet && jetMet && meMet && typeTimeMet && !hasBlocker;

      return {
        // Hours gaps (can be worked toward)
        ttGap,
        ttMet,
        picGap,
        picMet,
        jetGap,
        jetMet,
        jobJetTime,
        meGap,
        meMet,
        jobME,
        typeTimeGap,
        typeTimeMet,
        hoursGap,           // Max of TT, PIC, jet, ME, and type time gaps

        // Type rating
        needsType,
        hasType,
        missingTypeBlocker,

        // License
        hasLicense,
        missingLicenseBlocker,
        jobLicense: jobLicenseDisplay,
        jobLicenses: jobLicenses,
        pilotLicense: pilot.license,

        // Work rights
        needsWorkRights,
        hasWorkRights,
        missingWorkRightsBlocker,
        workRegion: job.workRegion,
        visaSponsored: job.visa,

        // Overall blockers
        hasBlocker,         // TRUE = at least one hard blocker exists
        isEligible,

        // For display in tooltip
        pilotTT: pilot.totalHours,
        jobTT: job.flightTime,
        pilotPIC: pilot.picHours,
        jobPIC: job.pic,
        pilotJetTime: pilot.jetTime,
        pilotMETime: pilot.multiEngineTime,
        pilotTypeTime: pilot.typeTime[job.requiredType] || 0,
        requiredType: job.requiredType,
        minTypeTime: job.minTypeTime
      };
    }

    /**
     * Generate the eligibility badge HTML with tooltip breakdown
     */
    function getEligibilityBadge(job) {
      // If delta filter is disabled, don't show any eligibility badge
      if (!deltaFilterEnabled) {
        return '';
      }

      // For non-premium users, show nothing
      if (!isPremium) {
        return '';
      }

      const delta = calculateDelta(job);

      // Determine tooltip title based on status
      let tooltipTitle = 'Requirements Breakdown';
      if (delta.isEligible) {
        tooltipTitle = '✓ You meet all requirements';
      } else if (delta.hasBlocker) {
        tooltipTitle = '🔴 Blocker(s) found';
      }

      // Build the tooltip content with all checks
      const tooltipHTML = `
        <div class="eligibility-tooltip">
          <div class="tooltip-title">${tooltipTitle}</div>

          <div class="tooltip-row">
            <span class="tooltip-label">Total Time</span>
            <span class="tooltip-value ${delta.ttMet ? 'met' : 'short'}">
              ${delta.pilotTT.toLocaleString()} / ${delta.jobTT.toLocaleString()}
              ${!delta.ttMet ? `<span class="tooltip-gap">(${delta.ttGap.toLocaleString()} short)</span>` : ''}
            </span>
          </div>

          <div class="tooltip-row">
            <span class="tooltip-label">PIC Time</span>
            <span class="tooltip-value ${delta.picMet ? 'met' : 'short'}">
              ${delta.pilotPIC.toLocaleString()} / ${delta.jobPIC.toLocaleString()}
              ${!delta.picMet ? `<span class="tooltip-gap">(${delta.picGap.toLocaleString()} short)</span>` : ''}
            </span>
          </div>

          ${delta.jobJetTime > 0 ? `
          <div class="tooltip-row">
            <span class="tooltip-label">Jet Time</span>
            <span class="tooltip-value ${delta.jetMet ? 'met' : 'short'}">
              ${delta.pilotJetTime.toLocaleString()} / ${delta.jobJetTime.toLocaleString()}
              ${!delta.jetMet ? `<span class="tooltip-gap">(${delta.jetGap.toLocaleString()} short)</span>` : ''}
            </span>
          </div>
          ` : ''}

          ${delta.jobME > 0 ? `
          <div class="tooltip-row">
            <span class="tooltip-label">Multi-Engine</span>
            <span class="tooltip-value ${delta.meMet ? 'met' : 'short'}">
              ${delta.pilotMETime.toLocaleString()} / ${delta.jobME.toLocaleString()}
              ${!delta.meMet ? `<span class="tooltip-gap">(${delta.meGap.toLocaleString()} short)</span>` : ''}
            </span>
          </div>
          ` : ''}

          ${delta.needsType ? `
          <div class="tooltip-row">
            <span class="tooltip-label">Type Rating</span>
            <span class="tooltip-value ${delta.hasType ? 'met' : 'missing'}">
              ${delta.hasType ? `✓ ${delta.requiredType}` : `🔴 Need ${delta.requiredType}`}
            </span>
          </div>
          ${delta.hasType && delta.minTypeTime > 0 ? `
          <div class="tooltip-row">
            <span class="tooltip-label">Time on Type</span>
            <span class="tooltip-value ${delta.typeTimeMet ? 'met' : 'short'}">
              ${delta.pilotTypeTime.toLocaleString()} / ${delta.minTypeTime.toLocaleString()}
              ${!delta.typeTimeMet ? `<span class="tooltip-gap">(${delta.typeTimeGap.toLocaleString()} short)</span>` : ''}
            </span>
          </div>
          ` : ''}
          ` : `
          <div class="tooltip-row">
            <span class="tooltip-label">Type Rating</span>
            <span class="tooltip-value met">Not required ✓</span>
          </div>
          `}

          <div class="tooltip-row">
            <span class="tooltip-label">License</span>
            <span class="tooltip-value ${delta.hasLicense ? 'met' : 'missing'}">
              ${delta.hasLicense ? `✓ ${delta.pilotLicense}` : `🔴 Need ${delta.jobLicense}`}
            </span>
          </div>

          <div class="tooltip-row">
            <span class="tooltip-label">Work Rights</span>
            <span class="tooltip-value ${delta.hasWorkRights ? 'met' : 'missing'}">
              ${delta.visaSponsored ? '✓ Visa sponsored' : delta.hasWorkRights ? `✓ ${delta.workRegion}` : `🔴 No rights (${delta.workRegion})`}
            </span>
          </div>
        </div>
      `;

      // Determine badge style based on eligibility
      let badgeClass, badgeText;

      if (delta.isEligible) {
        // All requirements met
        badgeClass = 'eligible';
        badgeText = '✓ Eligible';
      } else if (delta.missingTypeBlocker) {
        // HARD BLOCKER: Missing type rating
        badgeClass = 'not-eligible';
        badgeText = `🔴 Need ${delta.requiredType}`;
      } else if (delta.missingLicenseBlocker) {
        // HARD BLOCKER: Missing license
        badgeClass = 'not-eligible';
        badgeText = `🔴 Need ${delta.jobLicense}`;
      } else if (delta.missingWorkRightsBlocker) {
        // HARD BLOCKER: No work rights
        badgeClass = 'not-eligible';
        badgeText = `🔴 No work rights`;
      } else if (delta.hoursGap <= 500) {
        // Close on hours (within 500 hrs)
        badgeClass = 'within-reach';
        badgeText = `🟡 ${delta.hoursGap.toLocaleString()} hrs to go`;
      } else {
        // Far on hours
        badgeClass = 'not-eligible';
        badgeText = `${delta.hoursGap.toLocaleString()} hrs to go`;
      }

      return `
        <span class="eligibility-wrapper">
          <span class="eligibility-badge ${badgeClass} clickable">${badgeText}</span>
          ${tooltipHTML}
        </span>
      `;
    }

    // Render job card attributes based on job type
    function renderAttributes(j) {
      if (j.jobType === 'cabin_crew') {
        return `
          <span class="attr-item"><b>Position:</b> <span class="attr-pill">${j.position || 'Flight Attendant'}</span></span>
          <span class="attr-item"><b>Location:</b> <span class="attr-pill">${j.location || 'Not specified'}</span></span>
          ${j.contractType ? `<span class="attr-pill">${j.contractType}</span>` : ''}
          ${j.visa ? '<span class="attr-pill green"><b>Visa Sponsor</b></span>' : ''}
          ${j.swimmingAbility ? '<span class="attr-pill" style="background:#e0f2fe;color:#0369a1;">Swimming Required</span>' : ''}
        `;
      } else {
        return `
          <span class="attr-item"><b>Aircraft:</b> <span class="attr-pill">${j.chips[0] || 'N/A'}</span></span>
          <span class="attr-item"><b>Location:</b> <span class="attr-pill">${j.location || 'Not specified'}</span></span>
          ${j.type === "typed" ? '<span class="attr-pill">Type-rated</span>' : '<span class="attr-pill green">Non-type rated</span>'}
          ${j.visa ? '<span class="attr-pill green"><b>Visa sponsor</b></span>' : ''}
          ${j.direct ? '<span class="attr-pill" style="background:#e3f2fd;color:#1565c0;"><b>Direct Entry</b></span>' : ''}
          ${getEligibilityBadge(j)}
        `;
      }
    }

    // Render stats row based on job type
    function renderStatsRow(j) {
      if (j.jobType === 'cabin_crew') {
        // For cabin crew, show physical requirements, experience, languages, salary
        let stats = '';

        // Physical requirements - Height
        if (j.minHeightCm) {
          stats += `<div class="stat-box">
            <span class="stat-label">Min Height</span>
            <span class="stat-value">${j.minHeightCm} cm</span>
          </div>`;
        }

        // Physical requirements - Age
        if (j.minAge) {
          stats += `<div class="stat-box">
            <span class="stat-label">Min Age</span>
            <span class="stat-value">${j.minAge}+ years</span>
          </div>`;
        }

        // Experience
        if (j.experienceYears > 0) {
          stats += `<div class="stat-box">
            <span class="stat-label">Experience</span>
            <span class="stat-value">${j.experienceYears} ${j.experienceYears === 1 ? 'year' : 'years'}</span>
          </div>`;
        }

        // Parse language requirements
        let languages = [];
        if (j.languageRequirements) {
          try {
            if (typeof j.languageRequirements === 'string') {
              languages = JSON.parse(j.languageRequirements);
            } else {
              languages = j.languageRequirements;
            }
          } catch (e) {
            languages = [j.languageRequirements];
          }
        }

        if (languages && languages.length > 0 && languages[0] !== 'None') {
          stats += `<div class="stat-box">
            <span class="stat-label">Languages</span>
            <span class="stat-value">${Array.isArray(languages) ? languages.join(', ') : languages}</span>
          </div>`;
        }

        if (j.contractType) {
          stats += `<div class="stat-box">
            <span class="stat-label">Contract</span>
            <span class="stat-value">${j.contractType}</span>
          </div>`;
        }

        const salaryInfo = formatSalary(j.salary);
        if (salaryInfo) {
          stats += `<div class="stat-box">
            <span class="stat-label">Salary${salaryInfo.isRange ? ' (range)' : ''}</span>
            <span class="stat-value" style="color: #22c55e;">${salaryInfo.formatted}</span>
          </div>`;
        }

        return stats || '<div class="stat-box"><span class="stat-label">Details</span><span class="stat-value">See description</span></div>';
      } else {
        // For pilots, show flight hours
        let stats = `
          <div class="stat-box">
            <span class="stat-label">Total Time</span>
            <span class="stat-value">${j.flightTime.toLocaleString()} hrs</span>
          </div>
          <div class="stat-box">
            <span class="stat-label">PIC Time</span>
            <span class="stat-value">${j.pic.toLocaleString()} hrs</span>
          </div>
        `;

        if (j.jetTime) {
          stats += `<div class="stat-box">
            <span class="stat-label">Jet Time</span>
            <span class="stat-value">${j.jetTime.toLocaleString()} hrs</span>
          </div>`;
        }

        if (j.multiEngine) {
          stats += `<div class="stat-box">
            <span class="stat-label">Multi-Engine</span>
            <span class="stat-value">${j.multiEngine.toLocaleString()} hrs</span>
          </div>`;
        }

        if (j.roster) {
          stats += `<div class="stat-box">
            <span class="stat-label">Roster</span>
            <span class="stat-value">${j.roster}</span>
          </div>`;
        }

        const salaryInfo = formatSalary(j.salary);
        if (salaryInfo) {
          stats += `<div class="stat-box">
            <span class="stat-label">Salary${salaryInfo.isRange ? ' (range)' : ''}</span>
            <span class="stat-value" style="color: #22c55e;">${salaryInfo.formatted}</span>
          </div>`;
        }

        return stats;
      }
    }

    function render(list, append = false){
      const cards = el("cards");
      const jobsHTML = list.map(j => `
        <article class="card${j.visa ? ' visa-sponsor' : ''}" style="position:relative;">
          <button class="save-btn${savedJobIds.has((j.jobType||'pilot')+'_'+j.id) ? ' saved' : ''}" data-job-id="${j.id}" data-job-type="${j.jobType || 'pilot'}" onclick="toggleSaveJob(${j.id}, '${j.jobType || 'pilot'}', event)" title="Save job">
            <svg viewBox="0 0 24 24"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>
          </button>

          <div class="company-logo">
            <img src="${j.logo}" alt="${j.org}" onerror="this.parentElement.textContent='${iconLetter(j.org)}'">
          </div>

          <h2 class="job-title">${j.title}<span class="airline-name">${j.org}</span></h2>

          <div class="apply-container">
            <a href="${j.applyUrl}" class="apply-btn" target="_blank" rel="noopener noreferrer" onclick="gtag_report_conversion();">Apply Now</a>
            <button class="track-btn${trackedJobIds.has((j.jobType||'pilot')+'_'+j.id) ? ' tracked' : ''}" data-job-id="${j.id}" data-job-type="${j.jobType || 'pilot'}" onclick="toggleTrackJob(${j.id}, '${j.jobType || 'pilot'}', event)" title="Track application">
              <svg viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
              <span>${trackedJobIds.has((j.jobType||'pilot')+'_'+j.id) ? 'Tracked' : 'Track'}</span>
            </button>
          </div>

          <div class="attributes">
            ${renderAttributes(j)}
          </div>

          <div class="stats-row">
            ${renderStatsRow(j)}
          </div>

          <div class="card-footer-actions">
            <button class="share-btn" onclick="shareJob(${j.id}, event)" title="Share job">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/>
              </svg>
              <span>Share</span>
            </button>
            <div class="expand-link" onclick="toggleDescription(this)">
              See job description
              <div class="arrow-v"></div>
            </div>
          </div>

          <div class="job-description">
            ${j.description ? `<div class="job-description-content">${j.description}</div>` : ''}
            ${j.requirements ? `
              <div class="requirements-title">Requirements</div>
              ${renderRequirements(j.requirements)}
            ` : ''}
            ${!j.description && !j.requirements ? `<div class="job-description-content"></div>` : ''}
          </div>
        </article>
      `).join("");

      if (append) {
        cards.innerHTML += jobsHTML;
      } else {
        cards.innerHTML = jobsHTML;
      }

      // Mark saved jobs after rendering
      updateSaveButtons();
      // Mark tracked jobs after rendering
      updateTrackButtons();
    }

    function updateDisplay() {
      // Update job count and GMT time in header
      const displayedCount = Math.min(currentPage * JOBS_PER_PAGE, currentFilteredJobs.length);
      // Show total jobs from Supabase (not filtered count)
      const totalFromDb = currentJobType === 'pilot' ? totalPilotJobCount : totalCabinCrewJobCount;
      el("jobCount").textContent = totalFromDb;

      // Use API time if available, otherwise fallback to local time
      if (lastApiGmtTime) {
        el("gmtTime").textContent = lastApiGmtTime;
      } else {
        const now = new Date();
        const gmtTime = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', timeZone: 'GMT' }) + ' GMT';
        el("gmtTime").textContent = gmtTime;
      }

      // Update header text based on job type
      const jobTypeLabel = currentJobType === 'pilot' ? 'Active pilot jobs' : 'Active cabin crew jobs';
      el("jobTypeLabel").textContent = jobTypeLabel;

      // Update load more section
      const totalJobs = currentFilteredJobs.length;
      el("resultsCount").textContent = `Displaying ${displayedCount} of ${totalJobs} active vacancies`;

      // Hide/show load more button
      const loadMoreBtn = el("loadMoreBtn");
      if (displayedCount >= totalJobs) {
        loadMoreBtn.style.display = 'none';
      } else {
        loadMoreBtn.style.display = 'block';
      }
    }

    function loadMore() {
      currentPage++;
      const startIdx = (currentPage - 1) * JOBS_PER_PAGE;
      const endIdx = currentPage * JOBS_PER_PAGE;
      const nextBatch = currentFilteredJobs.slice(startIdx, endIdx);

      if (nextBatch.length > 0) {
        render(nextBatch, true);
        updateDisplay();
      }
    }

    // Tile filter state
    const tileFilters = {
      ntr: false, typed: false,
      atpl: false, cpl: false, fatpl: false,
      'op-airline': false, 'op-bizav': false, 'op-government': false, 'op-medical': false, 'op-instructor': false,
      visa: false, direct: false
    };

    // Toggle tile active state
    document.querySelectorAll('.filter-tile').forEach(tile => {
      tile.addEventListener('click', () => {
        const filter = tile.dataset.filter;
        tileFilters[filter] = !tileFilters[filter];
        tile.classList.toggle('active');
        updateMatchCount();
      });
    });

    function getFilters(){
      const q = el("q").value.trim().toLowerCase();
      const loc = el("loc").value;

      const perks = {
        visa: tileFilters.visa,
        direct: tileFilters.direct
      };

      const license = {
        atpl: tileFilters.atpl,
        cpl: tileFilters.cpl,
        fatpl: tileFilters.fatpl
      };

      const type = {
        typed: tileFilters.typed,
        ntr: tileFilters.ntr
      };

      const operatorType = {
        airline: tileFilters['op-airline'],
        bizav: tileFilters['op-bizav'],
        government: tileFilters['op-government'],
        medical: tileFilters['op-medical'],
        instructor: tileFilters['op-instructor']
      };

      const minFT = Number(ftSliderMin.value || 0);
      const maxFT = Number(ftSliderMax.value || 10000);
      const deltaEnabled = deltaFilterEnabled;
      const maxDelta = deltaEnabled ? Number(deltaSlider.value) : 3000; // If disabled, treat as max (no filtering)
      const eligibleOnly = eligibleOnlyCheckbox.checked;
      const includeBlockers = includeBlockersCheckbox.checked;

      return { q, loc, perks, license, type, operatorType, minFT, maxFT, maxDelta, deltaEnabled, eligibleOnly, includeBlockers };
    }

    function matchesAny(map){
      const any = Object.values(map).some(Boolean);
      return { any, map };
    }

    // Search scoring: returns 0 for no match, higher = better match
    function searchScore(job, query) {
      if (!query) return 1; // no query = everything matches

      const title = (job.title || '').toLowerCase();
      const org = (job.org || '').toLowerCase();
      const location = (job.location || '').toLowerCase();
      const chips = (job.chips || []).join(' ').toLowerCase();
      const rank = (job.rank || '').toLowerCase();
      const aircraft = (job.aircraft || '').toLowerCase();

      // Build searchable blob (with spaces) and compact version (no spaces)
      const blob = `${title} ${org} ${location} ${chips} ${rank} ${aircraft}`;
      const blobCompact = blob.replace(/\s+/g, '');

      // Split query into tokens
      const tokens = query.split(/\s+/).filter(t => t.length > 0);
      if (tokens.length === 0) return 1;

      // Also try the query as one compact string (for "fly dubai" -> "flydubai")
      const queryCompact = tokens.join('');

      // Check: all tokens must match somewhere in the blob OR compact matches
      const allTokensMatch = tokens.every(token => blob.includes(token));
      const compactMatch = blobCompact.includes(queryCompact);

      if (!allTokensMatch && !compactMatch) return 0; // no match

      // Score based on where/how it matches
      let score = 1;

      // Exact phrase match in blob (highest value)
      if (blob.includes(query)) score += 50;

      // Compact match (e.g. "fly dubai" matches "flydubai")
      if (compactMatch) score += 40;

      // Airline name match (very valuable)
      if (org.includes(query) || org.replace(/\s+/g, '').includes(queryCompact)) score += 30;

      // Title match
      if (title.includes(query) || title.replace(/\s+/g, '').includes(queryCompact)) score += 25;

      // Aircraft match
      if (aircraft.includes(query) || aircraft.replace(/\s+/g, '').includes(queryCompact)) score += 20;

      // Individual token bonuses
      for (const token of tokens) {
        if (org.includes(token)) score += 10;
        if (title.includes(token)) score += 8;
        if (aircraft.includes(token)) score += 6;
        if (rank.includes(token)) score += 5;
        if (location.includes(token)) score += 3;
      }

      return score;
    }

    function getFilteredJobs(){
      const f = getFilters();
      const lic = matchesAny(f.license);
      const typ = matchesAny(f.type);
      const opType = matchesAny(f.operatorType);
      const perk = matchesAny(f.perks);

      // Pre-compute search scores for all jobs
      const searchScores = new Map();
      if (f.q) {
        JOBS.forEach(j => searchScores.set(j.id, searchScore(j, f.q)));
      }

      return JOBS.filter(j => {
        // Saved jobs filter
        if (showingSavedOnly) {
          const key = `${j.jobType || 'pilot'}_${j.id}`;
          if (!savedJobIds.has(key)) return false;
        }
        if (f.q){
          if ((searchScores.get(j.id) || 0) === 0) return false;
        }
        if (f.loc && !locationMatchesRegion(j.location, j.locationBucket, f.loc)) return false;
        // Flight time filter: job's MAX hour requirement must be within selected range
        // A pilot with 200 hours shouldn't see jobs requiring 500 PIC hours even if total hours is 0
        const jobMaxHours = Math.max(j.flightTime || 0, j.pic || 0, j.jetTime || 0, j.multiEngine || 0);
        if (jobMaxHours < f.minFT || jobMaxHours > f.maxFT) return false;

        // "Eligible only" checkbox - works for ALL users (in black profile box)
        if (f.eligibleOnly) {
          const delta = calculateDelta(j);
          if (!delta.isEligible) return false;
        }

        // Delta/Eligibility filter - premium features (golden box)
        if (isPremium && f.deltaEnabled) {
          const delta = calculateDelta(j);

          // Delta slider - "show jobs within X hours"
          if (f.maxDelta < 3000) { // Only filter if slider is not at max

            // If job has hard blockers (missing type/license/work rights)
            if (delta.hasBlocker) {
              // Exclude blockers UNLESS the "include blockers" toggle is on
              if (!f.includeBlockers) return false;
              // If including blockers, still filter by hours gap for planning purposes
            }

            // Filter by hours gap (TT, PIC, type time)
            if (delta.hoursGap > f.maxDelta) return false;
          }
        }

        // Perks - if any selected, job must match at least one
        if (perk.any){
          const matches =
            (f.perks.visa && j.visaSponsor === true) ||
            (f.perks.direct && j.direct);
          if (!matches) return false;
        }

        // License - if any selected, job must match at least one
        if (lic.any){
          // j.license is now an array of acceptable licenses
          const jobLicenses = Array.isArray(j.license) ? j.license : [j.license];
          const ok =
            (f.license.atpl && jobLicenses.some(l => l === "ATPL" || l === "ATP" || l === "fATPL")) ||
            (f.license.cpl && jobLicenses.some(l => l === "CPL")) ||
            (f.license.fatpl && jobLicenses.some(l => l === "fATPL" || l === "CPL"));
          if (!ok) return false;
        }

        // Type - if any selected, job must match at least one
        if (typ.any){
          const matches =
            (f.type.typed && j.typeRated === true) ||
            (f.type.ntr && j.typeRated === false);
          if (!matches) return false;
        }

        // Operator Type - if any selected, job must match at least one
        if (opType.any){
          const matches =
            (f.operatorType.airline && j.operator_type === "airline") ||
            (f.operatorType.bizav && j.operator_type === "bizav") ||
            (f.operatorType.government && j.operator_type === "government") ||
            (f.operatorType.medical && j.operator_type === "medical") ||
            (f.operatorType.instructor && j.operator_type === "instructor");
          if (!matches) return false;
        }

        return true;
      }).sort((a, b) => {
        // Apply salary sorting if enabled (premium feature)
        if (sortBySalary && isPremium) {
          // Parse salary - handle string ranges like "100000-150000" by taking the higher value
          const parseSalary = (salary) => {
            if (!salary) return 0;
            if (typeof salary === 'number') return salary;
            const str = String(salary);
            // Check for range (e.g., "100000-150000")
            if (str.includes('-')) {
              const parts = str.split('-').map(s => parseInt(s.replace(/[^0-9]/g, '')) || 0);
              return Math.max(...parts);
            }
            return parseInt(str.replace(/[^0-9]/g, '')) || 0;
          };

          const salaryA = parseSalary(a.salary);
          const salaryB = parseSalary(b.salary);

          // Sort descending (highest salary first)
          // Jobs without salary (0) go to the end
          if (salaryA === 0 && salaryB === 0) return 0;
          if (salaryA === 0) return 1;  // a goes after b
          if (salaryB === 0) return -1; // b goes after a
          return salaryB - salaryA;
        }
        // Sort by search relevance when there's a query
        if (f.q) {
          const scoreA = searchScores.get(a.id) || 0;
          const scoreB = searchScores.get(b.id) || 0;
          if (scoreA !== scoreB) return scoreB - scoreA;
        }
        return 0; // No sorting, keep original order
      });
    }

    function apply(){
      currentPage = 1;
      currentFilteredJobs = getFilteredJobs();
      const firstBatch = currentFilteredJobs.slice(0, JOBS_PER_PAGE);
      render(firstBatch);
      updateDisplay();
      updateMatchCount();

      // Update URL with current filters (for shareable links)
      updateUrlWithFilters();
    }

    function clearAll(){
      el("q").value = "";
      el("loc").value = "";
      el("eligibleOnly").checked = false;

      // Reset saved filter
      showingSavedOnly = false;
      const savedBtn = document.getElementById('savedJobsBtn');
      if (savedBtn) savedBtn.classList.remove('active');

      // Clear all tile filters
      Object.keys(tileFilters).forEach(key => tileFilters[key] = false);
      document.querySelectorAll('.filter-tile').forEach(tile => tile.classList.remove('active'));

      ftSliderMin.value = 0;
      ftSliderMax.value = 10000;
      syncFT();

      // Reset delta slider and blockers toggle
      deltaSlider.value = 3000;
      syncDelta();
      includeBlockersCheckbox.checked = false;

      // Reset salary sorting
      sortBySalary = false;
      el("sortSalaryBtn").classList.remove("active");

      // Reset pagination and render first batch
      currentPage = 1;
      currentFilteredJobs = JOBS;
      const firstBatch = JOBS.slice(0, JOBS_PER_PAGE);
      render(firstBatch);
      updateDisplay();
      updateMatchCount();

      // Clear URL parameters
      updateUrl({});
    }

    // Update match count on any filter change
    document.querySelectorAll('.filters input').forEach(input => {
      input.addEventListener('change', updateMatchCount);
    });
    ftSliderMin.addEventListener('input', updateMatchCount);
    ftSliderMax.addEventListener('input', updateMatchCount);

    el("applyBtn").addEventListener("click", apply);
    el("clearBtn").addEventListener("click", clearAll);
    el("searchBtn").addEventListener("click", apply);
    el("q").addEventListener("keydown", (e) => { if (e.key === "Enter") apply(); });

    // Job Alert Modal
    const alertModal = el("alertModal");
    const alertBtn = el("alertBtn");
    const closeAlertModal = el("closeAlertModal");
    const alertSubmitBtn = el("alertSubmitBtn");
    const alertEmail = el("alertEmail");
    const alertModalBody = el("alertModalBody");

    // Alert filter state
    const alertFilters = {
      rank: [],              // 'captain', 'senior_fo', 'first_officer', 'second_officer', 'cadet'
      license_authority: [], // 'easa', 'faa', 'uk_caa', 'icao'
      region: [],            // 'europe', 'middle_east', 'asia', etc.
      aircraft: [],          // 'a320', 'b737', etc.
      type: [],              // 'typed', 'ntr'
      operator: [],          // 'airline', 'bizav', etc.
      perk: [],              // 'visa', 'direct'
      frequency: 'digest'    // 'instant' or 'digest' (default: digest = every 4 days)
    };

    // Frequency toggle handler
    const freqInstant = el('freqInstant');
    const freqDigest = el('freqDigest');

    freqInstant.addEventListener('click', () => {
      freqInstant.classList.add('selected');
      freqDigest.classList.remove('selected');
      alertFilters.frequency = 'instant';
    });

    freqDigest.addEventListener('click', () => {
      freqDigest.classList.add('selected');
      freqInstant.classList.remove('selected');
      alertFilters.frequency = 'digest';
    });

    // Chip toggle handler
    document.querySelectorAll('.alert-chip').forEach(chip => {
      chip.addEventListener('click', () => {
        const filterType = chip.dataset.alertFilter;
        const value = chip.dataset.value;

        if (chip.classList.contains('selected')) {
          chip.classList.remove('selected');
          alertFilters[filterType] = alertFilters[filterType].filter(v => v !== value);
        } else {
          chip.classList.add('selected');
          alertFilters[filterType].push(value);
        }
      });
    });

    // Aircraft Multi-Select Dropdown
    const aircraftMultiSelect = el('aircraftMultiSelect');
    const aircraftTrigger = el('aircraftTrigger');
    const aircraftDropdown = el('aircraftDropdown');
    const aircraftPlaceholder = el('aircraftPlaceholder');
    const aircraftTags = el('aircraftTags');

    // Toggle dropdown
    aircraftTrigger.addEventListener('click', (e) => {
      e.stopPropagation();
      aircraftMultiSelect.classList.toggle('open');
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!aircraftMultiSelect.contains(e.target)) {
        aircraftMultiSelect.classList.remove('open');
      }
    });

    // Handle option selection
    aircraftDropdown.querySelectorAll('.multi-select-option').forEach(option => {
      option.addEventListener('click', (e) => {
        e.stopPropagation();
        const value = option.dataset.value;
        const label = option.dataset.label;

        if (option.classList.contains('selected')) {
          // Deselect
          option.classList.remove('selected');
          alertFilters.aircraft = alertFilters.aircraft.filter(v => v !== value);
        } else {
          // Select
          option.classList.add('selected');
          alertFilters.aircraft.push(value);
        }

        updateAircraftTags();
        updateAircraftPlaceholder();
      });
    });

    function updateAircraftPlaceholder() {
      const count = alertFilters.aircraft.length;
      if (count === 0) {
        aircraftPlaceholder.textContent = 'Select aircraft types...';
      } else {
        aircraftPlaceholder.textContent = `${count} aircraft type${count > 1 ? 's' : ''} selected`;
      }
    }

    function updateAircraftTags() {
      aircraftTags.innerHTML = alertFilters.aircraft.map(value => {
        const option = aircraftDropdown.querySelector(`[data-value="${value}"]`);
        const label = option ? option.dataset.label : value;
        return `
          <span class="multi-select-tag" data-value="${value}">
            ${label}
            <span class="multi-select-tag-remove" onclick="removeAircraftTag('${value}')">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </span>
          </span>
        `;
      }).join('');
    }

    // Global function to remove aircraft tag
    window.removeAircraftTag = function(value) {
      alertFilters.aircraft = alertFilters.aircraft.filter(v => v !== value);
      const option = aircraftDropdown.querySelector(`[data-value="${value}"]`);
      if (option) option.classList.remove('selected');
      updateAircraftTags();
      updateAircraftPlaceholder();
    };

    function resetAircraftMultiSelect() {
      alertFilters.aircraft = [];
      aircraftDropdown.querySelectorAll('.multi-select-option').forEach(opt => {
        opt.classList.remove('selected');
      });
      updateAircraftTags();
      updateAircraftPlaceholder();
      aircraftMultiSelect.classList.remove('open');
    }

    function resetAlertModal() {
      // Reset chips
      document.querySelectorAll('.alert-chip').forEach(chip => {
        chip.classList.remove('selected');
      });
      // Reset aircraft multi-select
      resetAircraftMultiSelect();
      // Reset frequency toggle to digest (default)
      freqDigest.classList.add('selected');
      freqInstant.classList.remove('selected');
      alertFilters.frequency = 'digest';
      // Reset filter state
      alertFilters.rank = [];
      alertFilters.license_authority = [];
      alertFilters.region = [];
      alertFilters.aircraft = [];
      alertFilters.type = [];
      alertFilters.operator = [];
      alertFilters.perk = [];
      // Reset inputs
      alertEmail.value = '';
      // Reset button
      alertSubmitBtn.disabled = false;
      alertSubmitBtn.textContent = 'Subscribe to Alerts';
      // Reset modal footer visibility
      const footer = document.querySelector('.alert-modal-footer');
      if (footer) footer.style.display = '';
      // Clear validation errors
      el('rankSection').classList.remove('error');
      el('regionSection').classList.remove('error');
      el('rankError').style.display = 'none';
      el('regionError').style.display = 'none';
    }

    function openAlertModal() {
      if (!isPremium) {
        redirectToUpgrade();
        return;
      }
      resetAlertModal();
      alertModal.classList.add('active');
    }

    function closeAlertModalFn() {
      alertModal.classList.remove('active');
    }

    alertBtn.addEventListener('click', openAlertModal);
    closeAlertModal.addEventListener('click', closeAlertModalFn);
    alertModal.addEventListener('click', (e) => {
      if (e.target === alertModal) closeAlertModalFn();
    });

    alertSubmitBtn.addEventListener('click', async () => {
      // Clear previous validation errors
      el('rankSection').classList.remove('error');
      el('regionSection').classList.remove('error');
      el('rankError').style.display = 'none';
      el('regionError').style.display = 'none';

      // Validate required fields
      let hasErrors = false;

      if (alertFilters.rank.length === 0) {
        el('rankSection').classList.add('error');
        el('rankError').style.display = 'block';
        hasErrors = true;
      }

      if (alertFilters.region.length === 0) {
        el('regionSection').classList.add('error');
        el('regionError').style.display = 'block';
        hasErrors = true;
      }

      const email = alertEmail.value.trim();
      if (!email || !email.includes('@')) {
        alert('Please enter a valid email address');
        return;
      }

      if (hasErrors) {
        // Scroll to first error
        const firstError = document.querySelector('.alert-section.error');
        if (firstError) firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        return;
      }

      alertSubmitBtn.disabled = true;
      alertSubmitBtn.textContent = 'Subscribing...';

      try {
        const filters = {
          rank: alertFilters.rank.length > 0 ? alertFilters.rank : null,
          license_authority: alertFilters.license_authority.length > 0 ? alertFilters.license_authority : null,
          region: alertFilters.region.length > 0 ? alertFilters.region : null,
          aircraft: alertFilters.aircraft.length > 0 ? alertFilters.aircraft : null,
          operator_type: alertFilters.operator.length > 0 ? alertFilters.operator : null,
          type_rated: alertFilters.type.includes('typed') && !alertFilters.type.includes('ntr') ? true :
                      alertFilters.type.includes('ntr') && !alertFilters.type.includes('typed') ? false : null,
          visa_sponsor: alertFilters.perk.includes('visa') ? true : null,
          direct_entry: alertFilters.perk.includes('direct') ? true : null,
          frequency: alertFilters.frequency  // 'instant' or 'daily'
        };

        // Check if user is logged in to link subscription to their profile
        const { data: { session } } = await supabaseClient.auth.getSession();
        const userId = session?.user?.id || null;

        // Insert into Supabase (include user_id if logged in for hour qualification matching)
        const { data, error } = await supabaseClient
          .from('job_alert_subscriptions')
          .insert({
            email: email,
            filters: filters,
            verified: false,
            verification_token: crypto.randomUUID(),
            unsubscribe_token: crypto.randomUUID(),
            active: true,
            user_id: userId  // Links to user_profiles for hour-based matching
          });

        if (error) throw error;

        // Show success message with frequency info
        const freqText = alertFilters.frequency === 'digest'
          ? 'You\'ll receive a digest every 4 days with all matching jobs.'
          : 'You\'ll receive instant notifications for each matching job.';

        alertModalBody.innerHTML = `
          <div class="alert-success">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
            <h3>You're Subscribed!</h3>
            <p>We'll notify you at <strong>${email}</strong> when matching jobs are posted.</p>
            <p style="margin-top: 8px; font-size: 13px; color: #6b7280;">${freqText}</p>
          </div>
        `;
        // Hide footer
        document.querySelector('.alert-modal-footer').style.display = 'none';

      } catch (err) {
        console.error('Subscription error:', err);
        alert('Failed to subscribe. Please try again.');
        alertSubmitBtn.disabled = false;
        alertSubmitBtn.textContent = 'Subscribe to Alerts';
      }
    });

    // Load More button
    el("loadMoreBtn").addEventListener("click", loadMore);

    // Toggle filters panel
    let scrollPosition = 0;

    function openFilters() {
      // Save scroll position and lock body
      scrollPosition = window.pageYOffset;
      document.body.classList.add("filters-open");
      document.body.style.top = `-${scrollPosition}px`;

      const p = el("filtersPanel");
      p.classList.add("show");
      p.style.display = "block";
    }

    function closeFilters() {
      // Unlock body and restore scroll
      document.body.classList.remove("filters-open");
      document.body.style.top = "";
      window.scrollTo(0, scrollPosition);

      const p = el("filtersPanel");
      p.classList.remove("show");
      p.style.display = "none";
    }

    el("toggleFilters").addEventListener("click", () => {
      const p = el("filtersPanel");
      if (p.classList.contains("show")) {
        closeFilters();
      } else {
        openFilters();
      }
    });

    // Also close filters when clicking "Show Results"
    el("applyBtn").addEventListener("click", () => {
      if (window.innerWidth <= 768) {
        closeFilters();
      }
    });

    syncFT();
    syncDelta();
    updatePremiumUI();

    // Job Type Toggle (Pilot/Cabin Crew)
    async function switchJobType(jobType) {
      if (currentJobType === jobType) return;

      currentJobType = jobType;

      // Update toggle button states
      el("pilotBtn").classList.toggle("active", jobType === "pilot");
      el("cabinCrewBtn").classList.toggle("active", jobType === "cabin_crew");

      // Show/hide pilot-specific filters using the pilot-filter class
      const pilotFilters = document.querySelectorAll('.pilot-filter, .profile-summary, .delta-section');

      if (jobType === 'cabin_crew') {
        // Hide pilot-specific filters for cabin crew
        pilotFilters.forEach(elem => {
          if (elem) elem.style.display = 'none';
        });
      } else {
        // Show pilot filters
        pilotFilters.forEach(elem => {
          if (elem) elem.style.display = '';
        });
      }

      // Show loading state
      el("cards").innerHTML = '<div style="padding:40px;text-align:center;color:#6b7890;">Loading jobs...</div>';

      // Update job count from API for the new job type
      await updateJobCountFromAPI(jobType);

      // Fetch new jobs
      JOBS = await fetchJobs();
      currentPage = 1;
      currentFilteredJobs = JOBS;

      if (JOBS.length === 0) {
        el("cards").innerHTML = '<div style="padding:40px;text-align:center;color:#6b7890;">No jobs found.</div>';
        updateDisplay();
        return;
      }

      const initialBatch = JOBS.slice(0, JOBS_PER_PAGE);
      render(initialBatch);
      updateDisplay();
      updateMatchCount();

      // Update URL with job type
      updateUrlWithFilters();
    }

    el("pilotBtn").addEventListener("click", () => switchJobType("pilot"));
    el("cabinCrewBtn").addEventListener("click", () => switchJobType("cabin_crew"));

    // ============================================================
    // PROFILE EDITOR MODAL
    // ============================================================
    const profileModal = el("profileModal");
    const editProfileBtn = el("editProfileBtn");
    const closeProfileModal = el("closeProfileModal");
    const cancelProfileBtn = el("cancelProfileBtn");
    const saveProfileBtn = el("saveProfileBtn");
    const typeRatingsContainer = el("typeRatingsContainer");
    const newTypeRatingInput = el("newTypeRating");
    const typeRatingDropdown = el("typeRatingDropdown");

    // Temporary storage for type ratings being edited
    let editingTypeRatings = [];

    // Open modal (Premium feature)
    editProfileBtn.addEventListener("click", () => {
      if (!isPremium) {
        redirectToUpgrade();
        return;
      }
      populateProfileForm();
      profileModal.classList.add("active");
    });

    // Close modal
    function closeModal() {
      profileModal.classList.remove("active");
      if (typeRatingDropdown) typeRatingDropdown.classList.remove('visible');
    }
    closeProfileModal.addEventListener("click", closeModal);
    cancelProfileBtn.addEventListener("click", closeModal);
    let mouseDownOnOverlay = false;
    profileModal.addEventListener("mousedown", (e) => {
      mouseDownOnOverlay = (e.target === profileModal);
    });
    profileModal.addEventListener("click", (e) => {
      if (e.target === profileModal && mouseDownOnOverlay) closeModal();
      mouseDownOnOverlay = false;
    });

    // ============================================
    // Sort by Salary Feature (Premium)
    // ============================================
    const sortSalaryBtn = el("sortSalaryBtn");
    const salaryNoticeModal = el("salaryNoticeModal");
    const salaryNoticeCancel = el("salaryNoticeCancel");
    const salaryNoticeConfirm = el("salaryNoticeConfirm");

    sortSalaryBtn.addEventListener("click", () => {
      if (!isPremium) {
        redirectToUpgrade();
        return;
      }

      // If already sorting by salary, turn it off
      if (sortBySalary) {
        sortBySalary = false;
        sortSalaryBtn.classList.remove("active");
        apply();
        return;
      }

      // Show the notice modal for premium users
      salaryNoticeModal.classList.add("visible");
    });

    salaryNoticeCancel.addEventListener("click", () => {
      salaryNoticeModal.classList.remove("visible");
    });

    salaryNoticeConfirm.addEventListener("click", () => {
      salaryNoticeModal.classList.remove("visible");
      sortBySalary = true;
      sortSalaryBtn.classList.add("active");
      apply();
    });

    // Close modal on overlay click
    salaryNoticeModal.addEventListener("click", (e) => {
      if (e.target === salaryNoticeModal) {
        salaryNoticeModal.classList.remove("visible");
      }
    });

    // Populate form with current profile data
    function populateProfileForm() {
      el("profileTotalHours").value = PILOT_PROFILE.totalHours || '';
      el("profilePicHours").value = PILOT_PROFILE.picHours || '';
      el("profileJetTime").value = PILOT_PROFILE.jetTime || '';
      el("profileMultiEngine").value = PILOT_PROFILE.multiEngineTime || '';
      el("profileLicense").value = PILOT_PROFILE.license || 'CPL';

      // Get primary type time
      const primaryType = PILOT_PROFILE.typeRatings[0];
      el("profileTypeTime").value = primaryType ? (PILOT_PROFILE.typeTime[primaryType] || '') : '';

      // Type ratings
      editingTypeRatings = [...PILOT_PROFILE.typeRatings];
      renderTypeRatings();

      // Work rights checkboxes
      document.querySelectorAll('.work-right-cb').forEach(cb => {
        cb.checked = PILOT_PROFILE.workRights.includes(cb.value);
      });
    }

    // Render type rating chips
    function renderTypeRatings() {
      typeRatingsContainer.innerHTML = editingTypeRatings.map(type => `
        <span class="type-rating-chip">
          ${type}
          <button class="remove-rating" data-type="${type}">&times;</button>
        </span>
      `).join('');

      // Add remove handlers
      typeRatingsContainer.querySelectorAll('.remove-rating').forEach(btn => {
        btn.addEventListener('click', () => {
          const typeToRemove = btn.dataset.type;
          editingTypeRatings = editingTypeRatings.filter(t => t !== typeToRemove);
          renderTypeRatings();
        });
      });
    }

    // Searchable type rating dropdown
    function renderTypeRatingDropdown(query) {
      const q = (query || '').toLowerCase().trim();

      const matches = !q ? AIRCRAFT_FAMILIES : AIRCRAFT_FAMILIES.filter(fam => {
        return fam.typeRating.toLowerCase().includes(q) ||
               fam.label.toLowerCase().includes(q) ||
               fam.variants.some(v => v.toLowerCase().includes(q));
      });

      if (matches.length === 0) {
        typeRatingDropdown.classList.remove('visible');
        return;
      }

      typeRatingDropdown.innerHTML = matches.map(fam => {
        const alreadyAdded = editingTypeRatings.includes(fam.typeRating);
        return `
          <div class="type-rating-option${alreadyAdded ? ' disabled' : ''}" data-type="${fam.typeRating}">
            <div class="tr-name">${fam.typeRating}${alreadyAdded ? ' ✓' : ''}</div>
            <div class="tr-label">${fam.label}</div>
          </div>
        `;
      }).join('');

      typeRatingDropdown.classList.add('visible');

      // Add click handlers to options
      typeRatingDropdown.querySelectorAll('.type-rating-option:not(.disabled)').forEach(opt => {
        opt.addEventListener('click', () => {
          const type = opt.dataset.type;
          if (!editingTypeRatings.includes(type)) {
            editingTypeRatings.push(type);
            renderTypeRatings();
          }
          newTypeRatingInput.value = '';
          typeRatingDropdown.classList.remove('visible');
        });
      });
    }

    newTypeRatingInput.addEventListener("input", () => {
      renderTypeRatingDropdown(newTypeRatingInput.value);
    });

    newTypeRatingInput.addEventListener("focus", () => {
      renderTypeRatingDropdown(newTypeRatingInput.value);
    });

    // Close dropdown when clicking outside
    document.addEventListener("click", (e) => {
      if (!e.target.closest('.add-type-rating')) {
        typeRatingDropdown.classList.remove('visible');
      }
    });

    // Keyboard navigation for dropdown
    newTypeRatingInput.addEventListener("keydown", (e) => {
      if (e.key === 'Escape') {
        typeRatingDropdown.classList.remove('visible');
      }
      if (e.key === 'Enter') {
        e.preventDefault();
        const firstOption = typeRatingDropdown.querySelector('.type-rating-option:not(.disabled)');
        if (firstOption && typeRatingDropdown.classList.contains('visible')) {
          firstOption.click();
        }
      }
    });

    // Update profile display string
    function updateProfileDisplay() {
      const totalHrs = PILOT_PROFILE.totalHours.toLocaleString();
      const license = PILOT_PROFILE.license;
      const types = PILOT_PROFILE.typeRatings.length > 0 ? PILOT_PROFILE.typeRatings.join(', ') : 'No type';
      el("profileDisplay").textContent = `${totalHrs}h Total · ${license} · ${types}`;
    }

    // Save profile to Supabase
    saveProfileBtn.addEventListener("click", async () => {
      saveProfileBtn.disabled = true;
      saveProfileBtn.textContent = "Saving...";

      try {
        // Get form values
        const totalHours = parseInt(el("profileTotalHours").value) || 0;
        const picHours = parseInt(el("profilePicHours").value) || 0;
        const jetTime = parseInt(el("profileJetTime").value) || 0;
        const multiEngineTime = parseInt(el("profileMultiEngine").value) || 0;
        const license = el("profileLicense").value;
        const typeTime = parseInt(el("profileTypeTime").value) || 0;

        // Get work rights
        const workRights = [];
        document.querySelectorAll('.work-right-cb:checked').forEach(cb => {
          workRights.push(cb.value);
        });

        // Build type time object
        const typeTimeObj = {};
        editingTypeRatings.forEach((type, idx) => {
          // First type gets the specified hours, others get 0
          typeTimeObj[type] = idx === 0 ? typeTime : 0;
        });

        // Update local profile
        PILOT_PROFILE = {
          totalHours,
          picHours,
          jetTime,
          multiEngineTime,
          typeRatings: editingTypeRatings,
          typeTime: typeTimeObj,
          license,
          workRights
        };

        // Check if user is logged in
        const { data: { session } } = await supabaseClient.auth.getSession();

        if (session) {
          // Save to Supabase
          const { error } = await supabaseClient
            .from('user_profiles')
            .upsert({
              user_id: session.user.id,
              total_hours: totalHours,
              pic_hours: picHours,
              jet_time: jetTime,
              multi_engine_time: multiEngineTime,
              license: license,
              type_ratings: editingTypeRatings,
              type_time: typeTimeObj,
              work_rights: workRights,
              updated_at: new Date().toISOString()
            }, {
              onConflict: 'user_id'
            });

          if (error) {
            console.error('Error saving profile:', error);
            alert('Failed to save profile to database. Changes saved locally.');
          }
        } else {
          // Not logged in - save to localStorage
          localStorage.setItem('pilotProfile', JSON.stringify(PILOT_PROFILE));
        }

        // Update display and re-render jobs
        updateProfileDisplay();
        apply(); // Re-render to update eligibility calculations
        closeModal();

      } catch (err) {
        console.error('Error saving profile:', err);
        alert('An error occurred while saving. Please try again.');
      } finally {
        saveProfileBtn.disabled = false;
        saveProfileBtn.textContent = "Save Profile";
      }
    });

    // Load profile from Supabase or localStorage
    async function loadUserProfile() {
      try {
        const { data: { session } } = await supabaseClient.auth.getSession();

        if (session) {
          // Try to load from Supabase
          const { data, error } = await supabaseClient
            .from('user_profiles')
            .select('*')
            .eq('user_id', session.user.id)
            .single();

          if (data && !error) {
            PILOT_PROFILE = {
              totalHours: data.total_hours || 0,
              picHours: data.pic_hours || 0,
              jetTime: data.jet_time || 0,
              multiEngineTime: data.multi_engine_time || 0,
              typeRatings: data.type_ratings || [],
              typeTime: data.type_time || {},
              license: data.license || 'CPL',
              workRights: data.work_rights || []
            };
            updateProfileDisplay();
          }
        } else {
          // Try localStorage
          const saved = localStorage.getItem('pilotProfile');
          if (saved) {
            PILOT_PROFILE = JSON.parse(saved);
            updateProfileDisplay();
          }
        }
      } catch (err) {
        console.error('Error loading profile:', err);
      }
    }

    // ============================================
    // SHAREABLE URL SYSTEM
    // ============================================

    // Single job view mode
    let singleJobMode = false;
    let singleJobId = null;

    // Get URL parameters
    function getUrlParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        job: params.get('job'),           // Single job ID: ?job=4694
        search: params.get('search'),     // Search query: ?search=a320
        airline: params.get('airline'),   // Airline filter: ?airline=royal-jordanian
        location: params.get('location'), // Location filter: ?location=europe
        aircraft: params.get('aircraft'), // Aircraft filter: ?aircraft=b737
        type: params.get('type')          // Job type: ?type=cabin_crew
      };
    }

    // Update URL without reloading page
    function updateUrl(params) {
      const url = new URL(window.location.href);

      // Clear existing search params
      url.search = '';

      // Add non-empty params
      Object.entries(params).forEach(([key, value]) => {
        if (value && value.trim && value.trim() !== '') {
          url.searchParams.set(key, value);
        } else if (value && !value.trim) {
          url.searchParams.set(key, value);
        }
      });

      // Update URL without reload
      window.history.replaceState({}, '', url.toString());
    }

    // Update URL with current filter state (called after apply())
    function updateUrlWithFilters() {
      const searchVal = el("q").value.trim();
      const locVal = el("loc").value;

      // Build params object - only include non-empty values
      const params = {};

      if (searchVal) params.search = searchVal;
      if (locVal) params.location = locVal;
      if (currentJobType !== 'pilot') params.type = currentJobType;

      // Update URL (empty params = clean URL)
      updateUrl(params);
    }

    // Generate shareable link for a job
    function slugifyStr(str) {
      return String(str).toLowerCase().trim()
        .replace(/[^\w\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .replace(/^-+|-+$/g, '');
    }

    function getShareableJobLink(jobId) {
      // Use SSR URL with SEO slug for shared links
      const job = JOBS.find(j => j.id === jobId);
      let slug = String(jobId);
      if (job) {
        const parts = [job.title, job.org].filter(Boolean).map(slugifyStr).filter(Boolean);
        if (parts.length > 0) slug = `${parts.join('-')}-${jobId}`;
      }
      const base = `https://www.aeroscout.net/jobs/${slug}`;
      if (job && job.jobType === 'cabin_crew') {
        return base + '?type=cabin_crew';
      }
      return base;
    }

    // Generate shareable link for current filters
    function getShareableFilterLink() {
      const url = new URL(window.location.href);
      url.search = '';

      const searchVal = el("q").value.trim();
      const locVal = el("loc").value;

      if (searchVal) url.searchParams.set('search', searchVal);
      if (locVal) url.searchParams.set('location', locVal);
      if (currentJobType !== 'pilot') url.searchParams.set('type', currentJobType);

      return url.toString();
    }

    // Copy to clipboard helper
    async function copyToClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        return true;
      } catch (err) {
        console.error('Failed to copy:', err);
        return false;
      }
    }

    // Share job function (called from share button)
    async function shareJob(jobId, event) {
      event.stopPropagation();
      const link = getShareableJobLink(jobId);

      if (await copyToClipboard(link)) {
        // Show toast notification
        showToast('Link copied to clipboard!');
      }
    }

    // Show toast notification
    function showToast(message) {
      // Remove existing toast if any
      const existingToast = document.querySelector('.share-toast');
      if (existingToast) existingToast.remove();

      const toast = document.createElement('div');
      toast.className = 'share-toast';
      toast.textContent = message;
      toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #0b2a6f;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        z-index: 10000;
        animation: toastFade 2s ease-in-out forwards;
      `;
      document.body.appendChild(toast);

      setTimeout(() => toast.remove(), 2000);
    }

    // Add toast animation CSS
    const toastStyle = document.createElement('style');
    toastStyle.textContent = `
      @keyframes toastFade {
        0% { opacity: 0; transform: translateX(-50%) translateY(20px); }
        15% { opacity: 1; transform: translateX(-50%) translateY(0); }
        85% { opacity: 1; transform: translateX(-50%) translateY(0); }
        100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
      }
    `;
    document.head.appendChild(toastStyle);

    // ── Saved Jobs Functions ─────────────────────────────────────────
    async function loadSavedJobs() {
      if (!isLoggedIn) { savedJobIds.clear(); updateSavedCount(); return; }
      try {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (!session) return;
        const { data } = await supabaseClient
          .from('saved_jobs')
          .select('job_id, job_type')
          .eq('user_id', session.user.id);
        savedJobIds = new Set((data || []).map(d => `${d.job_type}_${d.job_id}`));
        updateSavedCount();
        updateSaveButtons();
      } catch (err) {
        console.error('Failed to load saved jobs:', err);
      }
    }

    async function toggleSaveJob(jobId, jobType, event) {
      event.stopPropagation();
      if (!isLoggedIn) {
        showToast('Log in to save jobs');
        setTimeout(() => { window.location.href = 'login.html'; }, 800);
        return;
      }
      const key = `${jobType}_${jobId}`;
      const btn = event.currentTarget;

      try {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (!session) return;

        if (savedJobIds.has(key)) {
          await supabaseClient.from('saved_jobs')
            .delete()
            .eq('user_id', session.user.id)
            .eq('job_id', jobId)
            .eq('job_type', jobType);
          savedJobIds.delete(key);
          btn.classList.remove('saved');
          showToast('Job removed from saved');
        } else {
          await supabaseClient.from('saved_jobs')
            .insert({ user_id: session.user.id, job_id: jobId, job_type: jobType });
          savedJobIds.add(key);
          btn.classList.add('saved');
          showToast('Job saved!');
        }
        updateSavedCount();
      } catch (err) {
        console.error('Failed to toggle save:', err);
        showToast('Something went wrong');
      }
    }

    function updateSaveButtons() {
      document.querySelectorAll('.save-btn[data-job-id]').forEach(btn => {
        const id = btn.dataset.jobId;
        const type = btn.dataset.jobType || 'pilot';
        if (savedJobIds.has(`${type}_${id}`)) btn.classList.add('saved');
        else btn.classList.remove('saved');
      });
    }

    function updateSavedCount() {
      const counter = document.getElementById('savedCount');
      if (counter) counter.textContent = savedJobIds.size;
      const badge = document.getElementById('savedBadge');
      if (badge) badge.style.display = savedJobIds.size > 0 ? 'flex' : 'none';
    }

    function toggleSavedFilter() {
      if (!isLoggedIn) {
        showToast('Log in to save jobs');
        return;
      }
      showingSavedOnly = !showingSavedOnly;
      const btn = document.getElementById('savedJobsBtn');
      if (btn) btn.classList.toggle('active', showingSavedOnly);
      apply();
    }
    // ── End Saved Jobs Functions ──────────────────────────────────────

    // ── Tracked Jobs Functions (Beta) ────────────────────────────────
    async function loadTrackedJobs() {
      if (!isLoggedIn) { trackedJobIds.clear(); return; }
      try {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (!session) return;
        const { data } = await supabaseClient
          .from('tracked_jobs')
          .select('job_id, job_type')
          .eq('user_id', session.user.id);
        trackedJobIds = new Set((data || []).map(d => `${d.job_type}_${d.job_id}`));
        updateTrackButtons();
      } catch (err) {
        console.error('Failed to load tracked jobs:', err);
      }
    }

    async function toggleTrackJob(jobId, jobType, event) {
      event.stopPropagation();
      if (!isLoggedIn) {
        showToast('Log in to track jobs');
        setTimeout(() => { window.location.href = 'login.html'; }, 800);
        return;
      }
      if (!isPremium) {
        redirectToUpgrade();
        return;
      }
      const key = `${jobType}_${jobId}`;
      const btn = event.currentTarget;

      try {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (!session) return;

        if (trackedJobIds.has(key)) {
          await supabaseClient.from('tracked_jobs')
            .delete()
            .eq('user_id', session.user.id)
            .eq('job_id', jobId)
            .eq('job_type', jobType);
          trackedJobIds.delete(key);
          btn.classList.remove('tracked');
          btn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg><span>Track</span>`;
          showToast('Removed from tracker');
        } else {
          await supabaseClient.from('tracked_jobs')
            .insert({ user_id: session.user.id, job_id: jobId, job_type: jobType, status: 'saved', notes: '' });
          trackedJobIds.add(key);
          btn.classList.add('tracked');
          btn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg><span>Tracked</span>`;
          showToast('Added to tracker!');
        }
      } catch (err) {
        console.error('Failed to toggle track:', err);
        showToast('Something went wrong');
      }
    }

    function updateTrackButtons() {
      document.querySelectorAll('.track-btn[data-job-id]').forEach(btn => {
        const id = btn.dataset.jobId;
        const type = btn.dataset.jobType || 'pilot';
        const key = `${type}_${id}`;
        if (trackedJobIds.has(key)) {
          btn.classList.add('tracked');
          btn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg><span>Tracked</span>`;
        } else {
          btn.classList.remove('tracked');
          btn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg><span>Track</span>`;
        }
      });
    }
    // ── End Tracked Jobs Functions ────────────────────────────────────

    // Intercept mailto: apply links - show popup instead of opening mail
    document.addEventListener('click', function(e) {
      const link = e.target.closest('a.apply-btn');
      if (!link) return;
      const href = link.getAttribute('href') || '';
      if (!href.startsWith('mailto:')) return;
      e.preventDefault();
      e.stopPropagation();
      const email = href.replace('mailto:', '');
      const existing = document.getElementById('emailModal');
      if (existing) existing.remove();
      const modal = document.createElement('div');
      modal.id = 'emailModal';
      modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:10000;display:flex;align-items:center;justify-content:center;';
      modal.innerHTML = '<div style="background:white;border-radius:10px;padding:24px 28px;max-width:360px;width:90%;text-align:center;box-shadow:0 8px 30px rgba(0,0,0,0.25);position:relative;"><button onclick="document.getElementById(\'emailModal\').remove()" style="position:absolute;top:8px;right:12px;background:none;border:none;font-size:20px;cursor:pointer;color:#999;">&times;</button><p style="margin:0 0 10px;color:#555;font-size:14px;">Send resume to</p><p style="margin:0;font-size:17px;font-weight:700;color:#0b2a6f;">' + email + '</p></div>';
      modal.addEventListener('click', function(ev) { if (ev.target === modal) modal.remove(); });
      document.body.appendChild(modal);
      return false;
    }, true);

    // Apply URL parameters to filters
    function applyUrlParams(params) {
      if (params.search) {
        el("q").value = params.search;
      }
      if (params.location) {
        el("loc").value = params.location;
      }
      if (params.type === 'cabin_crew') {
        // Switch to cabin crew tab
        currentJobType = 'cabin_crew';
      }
    }

    // Render single job view
    function renderSingleJob(job) {
      const cards = el("cards");

      // Add back button and single job view
      cards.innerHTML = `
        <div class="single-job-header" style="margin-bottom: 16px;">
          <button onclick="exitSingleJobView()" class="back-btn" style="
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: linear-gradient(135deg, #0b2a6f, #1b66ff);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
          ">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            Back to all jobs
          </button>
        </div>
      `;

      // Render the single job card
      const jobHTML = `
        <article class="card${job.visa ? ' visa-sponsor' : ''}" style="position:relative;">
          <button class="save-btn${savedJobIds.has((job.jobType||'pilot')+'_'+job.id) ? ' saved' : ''}" data-job-id="${job.id}" data-job-type="${job.jobType || 'pilot'}" onclick="toggleSaveJob(${job.id}, '${job.jobType || 'pilot'}', event)" title="Save job">
            <svg viewBox="0 0 24 24"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>
          </button>

          <div class="company-logo">
            <img src="${job.logo}" alt="${job.org}" onerror="this.parentElement.textContent='${iconLetter(job.org)}'">
          </div>

          <h2 class="job-title">${job.title}<span class="airline-name">${job.org}</span></h2>

          <div class="apply-container">
            <a href="${job.applyUrl}" class="apply-btn" target="_blank" rel="noopener noreferrer" onclick="gtag_report_conversion();">Apply Now</a>
            <button class="track-btn${trackedJobIds.has((job.jobType||'pilot')+'_'+job.id) ? ' tracked' : ''}" data-job-id="${job.id}" data-job-type="${job.jobType || 'pilot'}" onclick="toggleTrackJob(${job.id}, '${job.jobType || 'pilot'}', event)" title="Track application">
              <svg viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
              <span>${trackedJobIds.has((job.jobType||'pilot')+'_'+job.id) ? 'Tracked' : 'Track'}</span>
            </button>
          </div>

          <div class="attributes">
            ${renderAttributes(job)}
          </div>

          <div class="stats-row">
            ${renderStatsRow(job)}
          </div>

          <div class="card-footer-actions">
            <button class="share-btn" onclick="shareJob(${job.id}, event)" title="Share job">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/>
              </svg>
              <span>Share</span>
            </button>
          </div>

          <div class="job-description" style="display: block; max-height: none;">
            ${job.description ? `<div class="job-description-content">${job.description}</div>` : ''}
            ${job.requirements ? `
              <div class="requirements-title">Requirements</div>
              ${renderRequirements(job.requirements)}
            ` : ''}
          </div>
        </article>
      `;

      cards.innerHTML += jobHTML;
    }

    // Exit single job view
    function exitSingleJobView() {
      singleJobMode = false;
      singleJobId = null;

      // Clear URL params
      const url = new URL(window.location.href);
      url.search = '';
      window.history.replaceState({}, '', url.toString());

      // Re-render all jobs
      currentFilteredJobs = JOBS;
      const initialBatch = JOBS.slice(0, JOBS_PER_PAGE);
      render(initialBatch);
      updateDisplay();
      updateMatchCount();
    }

    // Initialize: fetch jobs from Supabase and render
    async function init() {
      // Load user profile first
      await loadUserProfile();
      // Show loading state
      el("cards").innerHTML = '<div style="padding:40px;text-align:center;color:#6b7890;">Loading jobs...</div>';

      // Get URL parameters BEFORE fetching
      const urlParams = getUrlParams();

      // Switch job type if specified in URL
      if (urlParams.type === 'cabin_crew') {
        currentJobType = 'cabin_crew';
        // Update UI tabs
        document.querySelectorAll('.job-type-btn').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.type === 'cabin_crew');
        });
      }

      // Fetch accurate job counts from API for both job types
      await Promise.all([
        updateJobCountFromAPI('pilot'),
        updateJobCountFromAPI('cabin_crew')
      ]);

      JOBS = await fetchJobs();

      if (JOBS.length === 0) {
        el("cards").innerHTML = '<div style="padding:40px;text-align:center;color:#6b7890;">No jobs found. Check your Supabase connection.</div>';
        return;
      }

      // Handle URL parameters AFTER jobs are loaded
      // (urlParams already declared above)

      // SINGLE JOB VIEW: ?job=4694
      if (urlParams.job) {
        const jobId = parseInt(urlParams.job);
        const job = JOBS.find(j => j.id === jobId);

        if (job) {
          singleJobMode = true;
          singleJobId = jobId;
          renderSingleJob(job);
          injectSingleJobSchema(job);
          updateDisplay();
          return; // Don't render normal list
        } else {
          // Job not found in current type, try fetching from the other type
          const otherJobs = currentJobType === 'pilot' ? await fetchCabinCrewJobs() : await fetchPilotJobs();
          const otherJob = otherJobs.find(j => j.id === jobId);

          if (otherJob) {
            singleJobMode = true;
            singleJobId = jobId;
            renderSingleJob(otherJob);
            injectSingleJobSchema(otherJob);
            updateDisplay();
            return;
          } else {
            // Job truly not found
            showToast('Job not found');
          }
        }
      }

      // SEARCH/FILTER VIEW: ?search=a320&airline=emirates&location=europe
      if (urlParams.search || urlParams.airline || urlParams.location) {
        // Apply search term (combines airline and general search)
        const searchTerms = [urlParams.search, urlParams.airline].filter(Boolean).join(' ');
        if (searchTerms) {
          el("q").value = searchTerms;
        }

        // Apply location filter
        if (urlParams.location) {
          el("loc").value = urlParams.location;
        }

        // Apply filters and render
        apply();
        injectJobPostingSchema(JOBS);
        return;
      }

      // Default: show all jobs
      currentFilteredJobs = JOBS;
      const initialBatch = JOBS.slice(0, JOBS_PER_PAGE);
      render(initialBatch);
      injectJobPostingSchema(JOBS);
      updateDisplay();
      updateMatchCount();

      // Update job counts every 60 seconds to keep them fresh
      setInterval(async () => {
        await Promise.all([
          updateJobCountFromAPI('pilot'),
          updateJobCountFromAPI('cabin_crew')
        ]);
      }, 60000);
    }

    // ============================================
    // MAP SEARCH FUNCTIONALITY
    // ============================================

    // Mapbox access token - Replace with your token from https://mapbox.com
    const MAPBOX_TOKEN = 'pk.eyJ1IjoiYW5kcmlmcmV5cmEiLCJhIjoiY21rNXNkZ2dyMDlmMTNxcjNzb3l0ejdlaCJ9.9DPoZNg_5L_Odkp_ooFeBQ';

    // Map instance
    let mapInstance = null;
    let mapInitialized = false;

    // Build GeoJSON from pre-stored coordinates (no geocoding needed)
    function buildGeoJSON() {
      const locationMap = new Map();

      // Group jobs by their coordinates (rounded to avoid floating point mismatches)
      JOBS.forEach(job => {
        if (job.latitude && job.longitude) {
          const key = `${job.latitude.toFixed(4)},${job.longitude.toFixed(4)}`;
          if (!locationMap.has(key)) {
            locationMap.set(key, { lat: job.latitude, lng: job.longitude, location: job.location, jobs: [] });
          }
          locationMap.get(key).jobs.push(job);
        }
      });

      const features = [];
      locationMap.forEach(({ lat, lng, location, jobs }) => {
        features.push({
          type: 'Feature',
          geometry: {
            type: 'Point',
            coordinates: [lng, lat]
          },
          properties: {
            location: location,
            jobCount: jobs.length,
            jobs: jobs.map(j => ({
              id: j.id,
              title: j.title,
              org: j.org,
              applyUrl: j.applyUrl
            }))
          }
        });
      });

      const totalJobs = features.reduce((sum, f) => sum + f.properties.jobCount, 0);
      el('mapStats').innerHTML = `<strong>${totalJobs}</strong> jobs across <strong>${locationMap.size}</strong> locations`;

      return {
        type: 'FeatureCollection',
        features
      };
    }

    // Initialize Mapbox map
    async function initMap() {
      if (MAPBOX_TOKEN === 'YOUR_MAPBOX_ACCESS_TOKEN_HERE') {
        el('mapLoading').innerHTML = `
          <div style="text-align: center; padding: 20px;">
            <div style="font-size: 48px; margin-bottom: 16px;">🗺️</div>
            <h3 style="margin: 0 0 8px; color: #0e1830;">Mapbox Token Required</h3>
            <p style="color: #6b7890; margin: 0; max-width: 400px;">
              To enable the map feature, add your Mapbox access token in the JavaScript code.
              <br><br>
              Get a free token at <a href="https://mapbox.com" target="_blank" style="color: #1b66ff;">mapbox.com</a>
            </p>
          </div>
        `;
        return;
      }

      if (mapInitialized && mapInstance) {
        // Map already exists, just update data
        updateMapData();
        el('mapLoading').classList.add('hidden');
        return;
      }

      try {
        // Lazy-load Mapbox GL JS on first use
        await loadMapbox();
        mapboxgl.accessToken = MAPBOX_TOKEN;

        mapInstance = new mapboxgl.Map({
          container: 'mapbox-map',
          style: 'mapbox://styles/mapbox/satellite-streets-v12',
          center: [0, 25],
          zoom: 1.8,
          projection: 'mercator'
        });

        mapInstance.addControl(new mapboxgl.NavigationControl(), 'top-right');

        mapInstance.on('load', () => {
          updateMapData();
          el('mapLoading').classList.add('hidden');
          mapInitialized = true;
        });

      } catch (error) {
        console.error('Map initialization failed:', error);
        el('mapLoading').innerHTML = `
          <div style="text-align: center; padding: 20px;">
            <div style="font-size: 48px; margin-bottom: 16px;">⚠️</div>
            <h3 style="margin: 0 0 8px; color: #0e1830;">Map Failed to Load</h3>
            <p style="color: #6b7890; margin: 0;">Please check your Mapbox token and try again.</p>
          </div>
        `;
      }
    }

    // Update map data (used for initial load and refresh)
    function updateMapData() {
      const geojson = buildGeoJSON();

      // Remove existing source and layers if they exist
      if (mapInstance.getSource('jobs')) {
        mapInstance.removeLayer('clusters');
        mapInstance.removeLayer('cluster-count');
        mapInstance.removeLayer('unclustered-point');
        mapInstance.removeSource('jobs');
      }

      // Add clustered source
      mapInstance.addSource('jobs', {
        type: 'geojson',
        data: geojson,
        cluster: true,
        clusterMaxZoom: 14,
        clusterRadius: 50
      });

      // Cluster circles
      mapInstance.addLayer({
        id: 'clusters',
        type: 'circle',
        source: 'jobs',
        filter: ['has', 'point_count'],
        paint: {
          'circle-color': [
            'step',
            ['get', 'point_count'],
            '#1b66ff',   // Blue for small clusters
            10, '#00b7a8', // Teal for medium clusters
            30, '#0b2a6f'  // Navy for large clusters
          ],
          'circle-radius': [
            'step',
            ['get', 'point_count'],
            18,   // Small cluster
            10, 24, // Medium cluster
            30, 32  // Large cluster
          ],
          'circle-stroke-width': 3,
          'circle-stroke-color': '#ffffff'
        }
      });

      // Cluster count labels
      mapInstance.addLayer({
        id: 'cluster-count',
        type: 'symbol',
        source: 'jobs',
        filter: ['has', 'point_count'],
        layout: {
          'text-field': ['get', 'point_count_abbreviated'],
          'text-font': ['DIN Pro Medium', 'Arial Unicode MS Bold'],
          'text-size': 13
        },
        paint: {
          'text-color': '#ffffff'
        }
      });

      // Individual job pins
      mapInstance.addLayer({
        id: 'unclustered-point',
        type: 'circle',
        source: 'jobs',
        filter: ['!', ['has', 'point_count']],
        paint: {
          'circle-color': '#1b66ff',
          'circle-radius': 10,
          'circle-stroke-width': 3,
          'circle-stroke-color': '#ffffff'
        }
      });

      // Click on cluster to zoom in
      mapInstance.on('click', 'clusters', (e) => {
        const features = mapInstance.queryRenderedFeatures(e.point, { layers: ['clusters'] });
        const clusterId = features[0].properties.cluster_id;
        mapInstance.getSource('jobs').getClusterExpansionZoom(clusterId, (err, zoom) => {
          if (err) return;
          mapInstance.easeTo({
            center: features[0].geometry.coordinates,
            zoom: zoom
          });
        });
      });

      // Click on individual point to show popup
      mapInstance.on('click', 'unclustered-point', (e) => {
        const coordinates = e.features[0].geometry.coordinates.slice();
        const props = e.features[0].properties;
        const location = props.location;
        const jobs = JSON.parse(props.jobs);
        const jobCount = props.jobCount;

        // Store jobs for this location globally for click handler
        window.currentMapJobs = jobs;
        window.currentMapLocation = location;

        // Build popup HTML with clickable job items
        const jobListHTML = jobs.slice(0, 5).map((j, idx) => `
          <div class="job-popup-item" style="cursor:pointer;" onclick="showJobPreview(${idx})">
            <div class="job-popup-title">${j.title}</div>
            <div class="job-popup-airline">${j.org}</div>
          </div>
        `).join('');

        const moreText = jobCount > 5 ? `<div style="padding:8px 16px;font-size:11px;color:#6b7890;">+ ${jobCount - 5} more jobs</div>` : '';

        new mapboxgl.Popup({ offset: 15, maxWidth: '320px' })
          .setLngLat(coordinates)
          .setHTML(`
            <div class="job-popup">
              <div class="job-popup-header">
                <div class="job-popup-location">${location}</div>
                <div class="job-popup-count">${jobCount} job${jobCount > 1 ? 's' : ''} available</div>
              </div>
              <div class="job-popup-body">
                ${jobListHTML}
                ${moreText}
              </div>
              <div class="job-popup-footer">
                <button class="job-popup-view-btn" onclick="showJobPreview(0)">
                  View ${jobCount > 1 ? 'Jobs' : 'Job'}
                </button>
              </div>
            </div>
          `)
          .addTo(mapInstance);
      });

      // Change cursor on hover
      mapInstance.on('mouseenter', 'clusters', () => {
        mapInstance.getCanvas().style.cursor = 'pointer';
      });
      mapInstance.on('mouseleave', 'clusters', () => {
        mapInstance.getCanvas().style.cursor = '';
      });
      mapInstance.on('mouseenter', 'unclustered-point', () => {
        mapInstance.getCanvas().style.cursor = 'pointer';
      });
      mapInstance.on('mouseleave', 'unclustered-point', () => {
        mapInstance.getCanvas().style.cursor = '';
      });
    }

    // Show job preview panel at bottom of map
    function showJobPreview(jobIndex) {
      const job = window.currentMapJobs[jobIndex];
      if (!job) return;

      // Find full job data from JOBS array
      const j = JOBS.find(x => x.id === job.id) || job;

      // Render the full job card HTML (same as main page)
      const cardHTML = `
        <article class="card${j.visa ? ' visa-sponsor' : ''}" style="position:relative;">
          <div class="company-logo">
            <img src="${j.logo || ''}" alt="${j.org}" onerror="this.parentElement.textContent='${iconLetter(j.org)}'">
          </div>

          <h2 class="job-title">${j.title}<span class="airline-name">${j.org}</span></h2>

          <div class="apply-container">
            <a href="${j.applyUrl}" class="apply-btn" target="_blank" rel="noopener noreferrer" onclick="gtag_report_conversion();">Apply Now</a>
            <button class="track-btn${trackedJobIds.has((j.jobType||'pilot')+'_'+j.id) ? ' tracked' : ''}" data-job-id="${j.id}" data-job-type="${j.jobType || 'pilot'}" onclick="toggleTrackJob(${j.id}, '${j.jobType || 'pilot'}', event)" title="Track application">
              <svg viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
              <span>${trackedJobIds.has((j.jobType||'pilot')+'_'+j.id) ? 'Tracked' : 'Track'}</span>
            </button>
          </div>

          <div class="attributes">
            ${renderAttributes(j)}
          </div>

          <div class="stats-row">
            ${renderStatsRow(j)}
          </div>

          <div class="expand-link" onclick="toggleDescription(this)">
            See job description
            <div class="arrow-v"></div>
          </div>

          <div class="job-description">
            ${j.description ? `<div class="job-description-content">${j.description}</div>` : ''}
            ${j.requirements ? `
              <div class="requirements-title">Requirements</div>
              ${renderRequirements(j.requirements)}
            ` : ''}
            ${!j.description && !j.requirements ? `<div class="job-description-content">No description available.</div>` : ''}
          </div>
        </article>
      `;

      el('mapJobCardContainer').innerHTML = cardHTML;

      // Show the preview panel
      el('mapJobPreview').classList.add('visible');
    }

    // Hide job preview panel
    function hideJobPreview() {
      el('mapJobPreview').classList.remove('visible');
    }

    // Filter jobs by location (called from popup)
    function filterByLocation(location) {
      // Close map overlay
      closeMap();

      // Set location filter (find the location select and set value)
      const locSelect = el('loc');
      if (locSelect) {
        // Check if option exists, if not just search
        const options = Array.from(locSelect.options);
        const matchingOption = options.find(opt => opt.value === location || opt.textContent === location);
        if (matchingOption) {
          locSelect.value = matchingOption.value;
        }
      }

      // Apply filter by searching for the location
      const searchInput = el('q');
      if (searchInput) {
        searchInput.value = location;
      }

      // Trigger filter application
      apply();
    }

    // Open map overlay (Premium feature)
    function openMap() {
      if (!isPremium) {
        redirectToUpgrade();
        return;
      }

      el('mapOverlay').classList.add('visible');
      document.body.style.overflow = 'hidden';

      // Reset loading state
      el('mapLoading').classList.remove('hidden');
      el('mapLoading').innerHTML = `
        <div class="map-loading-spinner"></div>
        <div class="map-loading-text">Loading map...</div>
      `;

      // Initialize or update map
      setTimeout(() => {
        initMap();
        if (mapInstance) {
          mapInstance.resize();
        }
      }, 100);
    }

    // Close map overlay
    function closeMap() {
      el('mapOverlay').classList.remove('visible');
      document.body.style.overflow = '';
      hideJobPreview();
    }

    // Map event listeners
    el('openMapBtn').addEventListener('click', openMap);
    el('closeMapBtn').addEventListener('click', closeMap);
    el('closePreview').addEventListener('click', hideJobPreview);
    el('mapOverlay').addEventListener('click', (e) => {
      if (e.target === el('mapOverlay')) closeMap();
    });

    // Close map with Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && el('mapOverlay').classList.contains('visible')) {
        closeMap();
      }
    });

    init();
  </script>
  <!-- Vercel Analytics -->
  <script defer src="/_vercel/insights/script.js"></script>
</body>
</html>