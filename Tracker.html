<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex, nofollow" />
  <title>AeroScout | Application Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --nav:#0b2a6f;--nav2:#081a45;--text:#0e1830;--muted:#6b7890;--accent:#1b66ff;--accent2:#00b7a8;
      --shadow:0 18px 46px rgba(13,36,90,.14);--softShadow:0 10px 26px rgba(13,36,90,.10);
      --radius:22px;--maxw:1900px;--borderSoft:rgba(255,255,255,.22);--innerStroke:rgba(12,28,64,.05);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html{height:100%}
    body{min-height:100%;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--text);background:#07183d}

    .site-logo{text-decoration:none;color:white;font-size:1.4rem;font-weight:800;letter-spacing:.5px;white-space:nowrap}

    .stage{min-height:100vh;position:relative;background:#07183d}
    .stage::before{content:"";position:fixed;inset:-24px;z-index:0;background-image:url("/images/jobs-bg.webp");background-size:cover;background-position:78% center;filter:blur(2.5px) saturate(1.15) contrast(1.05);transform:scale(1.03)}
    .stage::after{content:"";position:fixed;inset:0;z-index:1;pointer-events:none;background:radial-gradient(1100px 700px at 70% 15%,rgba(255,255,255,.22),transparent 62%),radial-gradient(900px 600px at 20% 25%,rgba(27,102,255,.14),transparent 62%),radial-gradient(900px 600px at 85% 35%,rgba(0,183,168,.10),transparent 62%),linear-gradient(180deg,rgba(7,24,61,.55),rgba(255,255,255,.10) 55%,rgba(255,255,255,.20))}
    .shell{max-width:var(--maxw);margin:0 auto;padding:22px 18px 0;position:relative;z-index:2;min-height:100vh}
    .frame{background:rgba(255,255,255,.78);border:1px solid var(--borderSoft);border-bottom:none;border-radius:calc(var(--radius)+10px) calc(var(--radius)+10px) 0 0;box-shadow:var(--shadow);backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px);padding:12px;padding-bottom:0;min-height:calc(100vh - 22px)}

    .topbar{background:linear-gradient(90deg,var(--nav),var(--nav2));border-radius:18px;padding:14px;color:#fff;box-shadow:var(--softShadow);position:sticky;top:14px;z-index:10;border:1px solid rgba(255,255,255,.10)}
    .topbar-row{display:flex;align-items:center;gap:16px}
    .topbar-nav{display:flex;align-items:center;gap:6px;margin-left:auto}
    .topbar-link{background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.18);border-radius:999px;padding:9px 16px;color:#fff;font-size:13px;font-weight:600;text-decoration:none;white-space:nowrap;transition:background .15s}
    .topbar-link:hover{background:rgba(255,255,255,.20)}
    .topbar-link.active{background:rgba(255,255,255,.18)}

    /* Layout */
    .layout{display:grid;grid-template-columns:220px 1fr;gap:16px;margin-top:14px;align-items:start}

    /* Panels */
    .panel{background:rgba(255,255,255,.86);border:1px solid var(--borderSoft);border-radius:var(--radius);box-shadow:var(--softShadow);overflow:visible;position:relative}
    .panel::before{content:"";position:absolute;inset:0;border-radius:inherit;box-shadow:inset 0 0 0 1px var(--innerStroke);pointer-events:none}

    /* ── Sidebar ── */
    .sidebar{padding:18px;position:sticky;top:80px}
    .sidebar-title{font-size:11px;font-weight:700;color:#94a3b8;text-transform:uppercase;letter-spacing:.8px;margin-bottom:10px}

    .stat-total{background:#0a192f;color:white;padding:14px 16px;border-radius:10px;margin-bottom:18px;display:flex;justify-content:space-between;align-items:center}
    .stat-total-label{font-size:11px;opacity:.6;text-transform:uppercase;letter-spacing:.5px}
    .stat-total-val{font-size:22px;font-weight:800}

    /* Clean filter buttons - no colored backgrounds */
    .filter-list{display:flex;flex-direction:column;gap:4px;margin-bottom:18px}
    .filter-item{display:flex;align-items:center;justify-content:space-between;padding:9px 12px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:500;color:#475569;border:1px solid transparent;transition:all .15s;background:transparent}
    .filter-item:hover{background:#f1f5f9}
    .filter-item.active{background:#f1f5f9;font-weight:700;color:var(--text);border-color:#e2e8f0}
    .filter-item .fi-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
    .filter-item .fi-label{flex:1;margin-left:10px}
    .filter-item .fi-count{font-size:12px;font-weight:700;color:#94a3b8;min-width:20px;text-align:right}
    .filter-item.active .fi-count{color:var(--text)}

    .import-bar{background:linear-gradient(135deg,#1b66ff,#00b7a8);color:white;padding:12px;border-radius:10px;text-align:center;font-weight:700;cursor:pointer;font-size:13px;border:none;width:100%;box-shadow:0 4px 14px rgba(27,102,255,.25);display:flex;align-items:center;justify-content:center;gap:8px;transition:all .2s}
    .import-bar:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(27,102,255,.35)}

    /* ── Content area ── */
    .content{padding:20px 20px 40px}

    /* Column headers */
    .col-head{display:grid;grid-template-columns:2.2fr 1fr 1.4fr 1fr 70px 120px;gap:16px;padding:0 20px 12px 60px;font-size:11px;font-weight:700;color:#94a3b8;text-transform:uppercase;letter-spacing:.7px;border-bottom:1px solid #e8ecf2}

    /* ── Job rows ── */
    .jrow{border-bottom:1px solid #f0f3f7;position:relative}
    .jrow:last-child{border-bottom:none}
    .jrow-main{display:grid;grid-template-columns:2.2fr 1fr 1.4fr 1fr 70px 120px;gap:16px;align-items:center;padding:16px 20px 16px 20px;cursor:pointer;transition:background .1s}
    .jrow-main:hover{background:#fafbfd}

    .j-airline{display:flex;align-items:center;gap:14px}
    .j-logo{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:13px;color:#fff;flex-shrink:0;letter-spacing:.3px;overflow:hidden}
    .j-logo img{width:40px;height:40px;border-radius:50%;object-fit:contain;background:#f0f3f7}
    .j-info{min-width:0}
    .j-name{font-size:14px;font-weight:700;color:#1e293b;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .j-title{font-size:12px;color:#94a3b8;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .j-aircraft{font-size:14px;font-weight:600;color:#334155}
    .j-aircraft-sub{font-size:10px;color:#cbd5e1;margin-top:2px}

    .j-location{display:flex;align-items:center;gap:6px;font-size:13px;color:#475569}
    .ldot{width:6px;height:6px;border-radius:50%;background:#ef4444;flex-shrink:0}

    .j-salary{font-size:14px;font-weight:600;color:#334155}
    .j-salary-sub{font-size:10px;color:#cbd5e1;margin-top:2px}

    .j-date{font-size:12px;color:#94a3b8}

    /* Status badge - works independently of row expand */
    .sbadge-wrap{position:relative;z-index:5}
    .sbadge{display:inline-flex;align-items:center;gap:5px;font-size:12px;font-weight:600;border-radius:20px;padding:6px 14px;cursor:pointer;border:1px solid;white-space:nowrap;transition:filter .15s;user-select:none}
    .sbadge:hover{filter:brightness(.93)}
    .sbadge[data-s="saved"]{color:#64748b;background:#f1f5f9;border-color:#e2e8f0}
    .sbadge[data-s="applied"]{color:#1d4ed8;background:#eff6ff;border-color:#bfdbfe}
    .sbadge[data-s="interview"]{color:#b45309;background:#fffbeb;border-color:#fde68a}
    .sbadge[data-s="offer"]{color:#059669;background:#ecfdf5;border-color:#a7f3d0}
    .sbadge[data-s="rejected"]{color:#dc2626;background:#fef2f2;border-color:#fecaca}

    .sdd{position:absolute;right:0;top:calc(100% + 6px);background:#fff;border-radius:10px;padding:6px;box-shadow:0 10px 40px rgba(0,0,0,.18);border:1px solid #e2e8f0;z-index:200;min-width:150px;display:none}
    .sdd.open{display:block}
    .sdd-opt{display:flex;align-items:center;gap:8px;width:100%;padding:8px 10px;border:none;border-radius:6px;background:transparent;color:#475569;font-size:13px;font-weight:500;cursor:pointer;text-align:left;transition:background .1s}
    .sdd-opt:hover{background:#f8fafc}
    .sdd-opt.cur{font-weight:700;color:var(--accent)}
    .sdd-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}

    /* Expand chevron */
    .j-chevron{color:#cbd5e1;font-size:11px;transition:transform .2s;text-align:right;padding-right:4px;cursor:pointer}
    .jrow.open .j-chevron{transform:rotate(180deg)}

    /* Expanded panel */
    .jrow-exp{display:none;padding:0 20px 18px 74px}
    .jrow.open .jrow-exp{display:block}
    .exp-label{font-size:12px;font-weight:600;color:#475569;margin:8px 0 6px}
    .exp-notes{width:100%;max-width:560px;min-height:60px;border:1px solid #e2e8f0;border-radius:8px;padding:10px 12px;font-size:13px;color:#334155;resize:vertical;font-family:inherit;outline:none;background:#fff;line-height:1.5}
    .exp-notes:focus{border-color:var(--accent)}
    .exp-saved{font-size:11px;color:var(--accent2);margin-top:4px;opacity:0;transition:opacity .3s}
    .exp-saved.on{opacity:1}
    .exp-btns{display:flex;gap:8px;margin-top:10px}
    .btn-s{background:none;border:1px solid #e2e8f0;color:#475569;padding:6px 14px;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;text-decoration:none;transition:all .15s}
    .btn-s:hover{border-color:var(--accent);color:var(--accent)}
    .btn-d{background:none;border:1px solid #fecaca;color:#dc2626;padding:6px 14px;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;transition:all .15s}
    .btn-d:hover{background:#fef2f2}

    /* States */
    .empty-state{text-align:center;padding:60px 20px;color:var(--muted)}
    .empty-state h3{font-size:17px;color:var(--text);margin:0 0 6px}
    .empty-state p{font-size:13px;margin:0}
    .auth-prompt{text-align:center;padding:80px 20px}
    .auth-prompt h2{font-size:20px;color:var(--text);margin:0 0 8px}
    .auth-prompt p{font-size:14px;color:var(--muted);margin:0 0 24px}
    .btn-primary{background:linear-gradient(135deg,#fff,#dbe8ff);color:#0b2a6f;border:none;border-radius:999px;padding:12px 28px;font-weight:800;cursor:pointer;box-shadow:0 10px 18px rgba(0,0,0,.18);text-decoration:none;font-size:14px;display:inline-block}
    .loading-state{text-align:center;padding:60px;color:var(--muted);font-size:14px}

    .mobile-toggle{display:none;margin-top:8px;width:100%;gap:8px;justify-content:center;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18);border-radius:10px;padding:10px 16px;color:#fff;font-size:13px;font-weight:700;cursor:pointer;align-items:center}

    /* ── Tablet ── */
    @media(max-width:1100px){
      .col-head,.jrow-main{grid-template-columns:2fr 1fr 1.2fr 1fr 60px 110px}
    }

    /* ── Mobile sidebar collapse ── */
    @media(max-width:980px){
      .layout{grid-template-columns:1fr}
      .sidebar-panel{display:none}
      .sidebar-panel.show{display:block;position:fixed;inset:0;z-index:1000;border-radius:0;overflow-y:auto;background:white}
      .mobile-toggle{display:flex!important}
    }

    /* ── Mobile ── */
    @media(max-width:768px){
      html,body{overflow-x:hidden}
      .stage::before,.stage::after{display:none}
      .shell{padding:0;background:#f8fafc}
      .frame{padding:0;border-radius:0;min-height:auto;background:#f8fafc;border:none;box-shadow:none}
      .topbar{padding:12px 16px;border-radius:0;position:sticky;top:0}
      .topbar-row{flex-wrap:wrap}
      .topbar-nav{width:100%;justify-content:flex-end;margin-top:4px}
      .content{padding:10px}
      .col-head{display:none}

      .jrow-main{display:flex;flex-wrap:wrap;gap:10px;padding:14px;align-items:flex-start}
      .j-airline{flex:1 1 auto;min-width:0}
      .j-aircraft,.j-salary-col,.j-date{display:none}
      .j-location{flex:1 1 100%;order:3;font-size:12px;padding-left:54px;margin-top:-4px}
      .sbadge-wrap{order:2;flex-shrink:0}
      .j-chevron{display:none}

      .jrow-exp{padding:0 14px 14px 14px}
      .exp-notes{max-width:100%}

      /* Show salary + aircraft below on mobile */
      .j-mobile-meta{display:flex;gap:12px;flex:1 1 100%;order:4;padding-left:54px;font-size:12px;color:#64748b;margin-top:2px}
      .j-mobile-meta b{color:#334155;font-weight:600}
    }
    @media(min-width:769px){
      .j-mobile-meta{display:none}
    }
  </style>
</head>
<body>
  <div class="stage">
    <div class="shell">
      <div class="frame">

        <header class="topbar">
          <div class="topbar-row">
            <a href="index.html" class="site-logo">AEROSCOUT</a>
            <nav class="topbar-nav">
              <a href="Jobs.html?beta=true" class="topbar-link">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:4px"><path d="M21 21l-4.2-4.2m1.7-5.3a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>Jobs
              </a>
              <a href="Tracker.html?beta=true" class="topbar-link active">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:4px"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>Tracker
              </a>
            </nav>
          </div>
          <button class="mobile-toggle" id="toggleSidebar" type="button">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="6" x2="20" y2="6"/><line x1="6" y1="12" x2="18" y2="12"/><line x1="8" y1="18" x2="16" y2="18"/></svg>Overview
          </button>
        </header>

        <div id="loadingState" class="loading-state" style="margin-top:40px;">Loading...</div>

        <div id="authPrompt" style="display:none;">
          <div class="panel" style="margin-top:14px;">
            <div class="auth-prompt">
              <h2>Application Tracker</h2>
              <p>Sign in to track your job applications across airlines.</p>
              <a href="login.html" class="btn-primary">Log In</a>
            </div>
          </div>
        </div>

        <main class="layout" id="mainGrid" style="display:none;">

          <aside class="panel sidebar-panel" id="sidebarPanel">
            <div class="sidebar">
              <div class="stat-total">
                <span class="stat-total-label">Total tracked</span>
                <span class="stat-total-val" id="totalCount">0</span>
              </div>

              <div class="sidebar-title">Status</div>
              <div class="filter-list" id="filterList">
                <div class="filter-item active" data-status="all" onclick="setFilter('all')">
                  <span class="fi-dot" style="background:#475569"></span>
                  <span class="fi-label">All</span>
                  <span class="fi-count" id="cAll">0</span>
                </div>
                <div class="filter-item" data-status="saved" onclick="setFilter('saved')">
                  <span class="fi-dot" style="background:#94a3b8"></span>
                  <span class="fi-label">Saved</span>
                  <span class="fi-count" id="cSaved">0</span>
                </div>
                <div class="filter-item" data-status="applied" onclick="setFilter('applied')">
                  <span class="fi-dot" style="background:#3b82f6"></span>
                  <span class="fi-label">Applied</span>
                  <span class="fi-count" id="cApplied">0</span>
                </div>
                <div class="filter-item" data-status="interview" onclick="setFilter('interview')">
                  <span class="fi-dot" style="background:#f59e0b"></span>
                  <span class="fi-label">Interview</span>
                  <span class="fi-count" id="cInterview">0</span>
                </div>
                <div class="filter-item" data-status="offer" onclick="setFilter('offer')">
                  <span class="fi-dot" style="background:#10b981"></span>
                  <span class="fi-label">Offer</span>
                  <span class="fi-count" id="cOffer">0</span>
                </div>
                <div class="filter-item" data-status="rejected" onclick="setFilter('rejected')">
                  <span class="fi-dot" style="background:#ef4444"></span>
                  <span class="fi-label">Rejected</span>
                  <span class="fi-count" id="cRejected">0</span>
                </div>
              </div>

              <button class="import-bar" onclick="importSavedJobs()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Import Saved Jobs
              </button>
            </div>
          </aside>

          <section class="panel" style="overflow:visible">
            <div class="content">
              <div class="col-head">
                <div>Airline</div>
                <div>Aircraft</div>
                <div>Location</div>
                <div>Salary</div>
                <div>Saved</div>
                <div style="text-align:center">Status</div>
              </div>
              <div id="rowsList"></div>
              <div id="emptyState" class="empty-state" style="display:none;">
                <h3>No applications tracked yet</h3>
                <p>Save jobs from the job board, then import them here to track your progress.</p>
              </div>
            </div>
          </section>

        </main>
      </div>
    </div>
  </div>

  <script>
    if(new URLSearchParams(location.search).get('beta')!=='true') location.href='Jobs.html';

    const SB='https://ziboktbmbyjbhifsdypa.supabase.co';
    const SK='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InppYm9rdGJtYnlqYmhpZnNkeXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3NjMwODUsImV4cCI6MjA4MjMzOTA4NX0.eayvAsTuezEJZ-SIvEjZmrYaUxmJtntV8pK8fyUBnbY';
    const{createClient}=supabase;const sb=createClient(SB,SK);

    const STS=['saved','applied','interview','offer','rejected'];
    const LBL={saved:'Saved',applied:'Applied',interview:'Interview',offer:'Offer',rejected:'Rejected'};
    const ICO={saved:'\u2605',applied:'\u270E',interview:'\u25CF',offer:'\u2794',rejected:'\u2715'};
    const DOT={saved:'#94a3b8',applied:'#3b82f6',interview:'#f59e0b',offer:'#10b981',rejected:'#ef4444'};
    const BG=['#c0392b','#2980b9','#27ae60','#8e44ad','#d35400','#16a085','#2c3e50','#e74c3c','#3498db','#1abc9c'];

    let tracked=[],details={},filter='all',expanded=null,user=null,nTimers={};

    document.getElementById('toggleSidebar').addEventListener('click',()=>{
      const p=document.getElementById('sidebarPanel');
      p.classList.toggle('show');
      document.body.style.overflow=p.classList.contains('show')?'hidden':'';
    });

    document.addEventListener('click',e=>{
      if(!e.target.closest('.sbadge-wrap'))
        document.querySelectorAll('.sdd.open').forEach(d=>d.classList.remove('open'));
    });

    async function init(){
      const{data:{session}}=await sb.auth.getSession();
      document.getElementById('loadingState').style.display='none';
      if(!session){document.getElementById('authPrompt').style.display='';return}
      user=session.user;
      document.getElementById('mainGrid').style.display='';
      await load();
    }

    async function load(){
      const{data}=await sb.from('tracked_jobs').select('*').eq('user_id',user.id).order('updated_at',{ascending:false});
      tracked=data||[];details={};

      const pIds=tracked.filter(t=>t.job_type==='pilot').map(t=>t.job_id);
      const cIds=tracked.filter(t=>t.job_type==='cabin_crew').map(t=>t.job_id);

      if(pIds.length){
        const{data:p}=await sb.from('verified_jobs').select('id,title,airline,aircraft,aircraft_family,location,salary_usd,rank,rank_bucket,url,logo_url,company_id').in('id',pIds);
        if(p){
          const co=[...new Set(p.filter(x=>x.company_id).map(x=>x.company_id))];
          let lg={};
          if(co.length){const{data:c}=await sb.from('final_companies').select('id,logo_url').in('id',co);if(c)c.forEach(x=>{lg[x.id]=x.logo_url})}
          p.forEach(j=>{j.logo=j.logo_url||lg[j.company_id]||null;details['p_'+j.id]=j});
        }
      }
      if(cIds.length){
        const{data:c}=await sb.from('verified_cabin_crew_jobs').select('id,title,airline,location,salary_usd,position,url,logo_url').in('id',cIds);
        if(c)c.forEach(j=>{j.logo=j.logo_url||null;details['c_'+j.id]=j});
      }
      render();
    }

    function render(){updateCounts();renderRows()}

    function hc(s){let h=0;for(let i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i);h|=0}return Math.abs(h)}

    function updateCounts(){
      const c={all:tracked.length};STS.forEach(s=>{c[s]=0});
      tracked.forEach(t=>{c[t.status]=(c[t.status]||0)+1});
      document.getElementById('totalCount').textContent=tracked.length;
      document.getElementById('cAll').textContent=c.all;
      STS.forEach(s=>{const el=document.getElementById('c'+s.charAt(0).toUpperCase()+s.slice(1));if(el)el.textContent=c[s]});
      document.querySelectorAll('.filter-item').forEach(el=>{el.classList.toggle('active',el.dataset.status===filter)});
    }

    function renderRows(){
      const list=filter==='all'?tracked:tracked.filter(t=>t.status===filter);
      const el=document.getElementById('rowsList');
      const empty=document.getElementById('emptyState');

      if(!list.length){
        el.innerHTML='';empty.style.display='';
        empty.querySelector('h3').textContent=tracked.length&&filter!=='all'
          ?'No '+LBL[filter].toLowerCase()+' applications'
          :'No applications tracked yet';
        empty.querySelector('p').textContent=tracked.length&&filter!=='all'
          ?'Change the status of a tracked job to see it here.'
          :'Save jobs from the job board, then import them here to track your progress.';
        return;
      }
      empty.style.display='none';

      el.innerHTML=list.map(t=>{
        const key=(t.job_type==='pilot'?'p_':'c_')+t.job_id;
        const job=details[key];
        const isOpen=expanded===t.id;
        const date=new Date(t.created_at).toLocaleDateString('en-GB',{day:'numeric',month:'short'});

        if(!job) return `<div class="jrow"><div class="jrow-main" style="grid-template-columns:1fr auto"><div class="j-airline"><div class="j-logo" style="background:#94a3b8">?</div><div class="j-info"><div class="j-name">Job unavailable</div><div class="j-title">May have been removed</div></div></div><button class="btn-d" onclick="event.stopPropagation();remove('${t.id}')">Remove</button></div></div>`;

        const airline=job.airline||'Unknown';
        const code=airline.substring(0,2).toUpperCase();
        const bg=BG[hc(airline)%BG.length];
        const aircraft=job.aircraft||job.aircraft_family||'\u2014';
        const loc=job.location||'\u2014';
        const salary=job.salary_usd||'\u2014';
        const title=job.title||'';

        const logoHtml=job.logo
          ?`<div class="j-logo"><img src="${job.logo}" alt="${code}" onerror="this.parentElement.style.background='${bg}';this.parentElement.innerHTML='${code}'"></div>`
          :`<div class="j-logo" style="background:${bg}">${code}</div>`;

        const ddOpts=STS.map(s=>
          `<button class="sdd-opt${s===t.status?' cur':''}" onclick="event.stopPropagation();updStatus('${t.id}','${s}')"><span class="sdd-dot" style="background:${DOT[s]}"></span>${LBL[s]}</button>`
        ).join('');

        return `<div class="jrow${isOpen?' open':''}">
          <div class="jrow-main" onclick="toggleExp('${t.id}')">
            <div class="j-airline">
              ${logoHtml}
              <div class="j-info">
                <div class="j-name">${airline}</div>
                <div class="j-title">${title}</div>
              </div>
            </div>
            <div>
              <div class="j-aircraft">${aircraft}</div>
              <div class="j-aircraft-sub">Aircraft</div>
            </div>
            <div class="j-location"><span class="ldot"></span>${loc}</div>
            <div class="j-salary-col">
              <div class="j-salary">${salary}</div>
              <div class="j-salary-sub">Salary</div>
            </div>
            <div class="j-date">${date}</div>
            <div class="sbadge-wrap" onclick="event.stopPropagation()">
              <div class="sbadge" data-s="${t.status}" onclick="toggleDD('${t.id}')">
                <span>${ICO[t.status]}</span> ${LBL[t.status]}
              </div>
              <div class="sdd" id="dd-${t.id}">${ddOpts}</div>
            </div>
            <div class="j-mobile-meta">
              ${aircraft!=='\u2014'?'<span><b>'+aircraft+'</b></span>':''}
              ${salary!=='\u2014'?'<span>'+salary+'</span>':''}
            </div>
          </div>
          <div class="jrow-exp">
            <div class="exp-label">Notes</div>
            <textarea class="exp-notes" id="n-${t.id}" placeholder="Interview date, contact info, prep notes..." oninput="onN('${t.id}')" onclick="event.stopPropagation()">${t.notes||''}</textarea>
            <div class="exp-saved" id="si-${t.id}">Saved</div>
            <div class="exp-btns">
              <a class="btn-s" href="${job.url}" target="_blank" rel="noopener" onclick="event.stopPropagation()">View Original Posting</a>
              <button class="btn-d" onclick="event.stopPropagation();remove('${t.id}')">Remove</button>
            </div>
          </div>
        </div>`;
      }).join('');
    }

    function setFilter(s){
      filter=s;
      const p=document.getElementById('sidebarPanel');
      if(p.classList.contains('show')){p.classList.remove('show');document.body.style.overflow=''}
      render();
    }

    function toggleExp(id){expanded=expanded===id?null:id;renderRows()}

    function toggleDD(id){
      const el=document.getElementById('dd-'+id);
      document.querySelectorAll('.sdd.open').forEach(d=>{if(d!==el)d.classList.remove('open')});
      el.classList.toggle('open');
    }

    async function updStatus(id,status){
      document.querySelectorAll('.sdd.open').forEach(d=>d.classList.remove('open'));
      const{error}=await sb.from('tracked_jobs').update({status}).eq('id',id).eq('user_id',user.id);
      if(error)return;
      const t=tracked.find(j=>j.id===id);if(t)t.status=status;
      render();
    }

    function onN(id){if(nTimers[id])clearTimeout(nTimers[id]);nTimers[id]=setTimeout(()=>saveN(id),800)}

    async function saveN(id){
      const el=document.getElementById('n-'+id);if(!el)return;
      const{error}=await sb.from('tracked_jobs').update({notes:el.value}).eq('id',id).eq('user_id',user.id);
      if(error)return;
      const t=tracked.find(j=>j.id===id);if(t)t.notes=el.value;
      const ind=document.getElementById('si-'+id);
      if(ind){ind.classList.add('on');setTimeout(()=>ind.classList.remove('on'),1500)}
    }

    async function remove(id){
      if(!confirm('Remove this application from your tracker?'))return;
      await sb.from('tracked_jobs').delete().eq('id',id).eq('user_id',user.id);
      tracked=tracked.filter(j=>j.id!==id);
      if(expanded===id)expanded=null;
      render();
    }

    async function importSavedJobs(){
      const{data:saved,error}=await sb.from('saved_jobs').select('*').eq('user_id',user.id);
      if(error||!saved){alert('Could not load saved jobs.');return}
      if(!saved.length){alert('No saved jobs found. Save some from the job board first.');return}
      const ex=new Set(tracked.map(j=>j.job_type+'_'+j.job_id));
      const imp=saved.filter(s=>!ex.has(s.job_type+'_'+s.job_id));
      if(!imp.length){alert('All saved jobs are already tracked.');return}
      const rows=imp.map(s=>({user_id:user.id,job_id:s.job_id,job_type:s.job_type,status:'saved',notes:''}));
      const{error:e2}=await sb.from('tracked_jobs').insert(rows);
      if(e2){alert('Error importing.');return}
      alert('Imported '+imp.length+' job'+(imp.length>1?'s':'')+'.');
      await load();
    }

    init();
  </script>
</body>
</html>