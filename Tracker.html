<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex, nofollow" />
  <title>AeroScout | Application Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --nav:#0b2a6f;--nav2:#081a45;--text:#0e1830;--muted:#6b7890;--accent:#1b66ff;--accent2:#00b7a8;
      --shadow:0 18px 46px rgba(13,36,90,.14);--softShadow:0 10px 26px rgba(13,36,90,.10);
      --radius:22px;--maxw:1900px;--borderSoft:rgba(255,255,255,.22);--innerStroke:rgba(12,28,64,.05);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--text);background:#07183d}

    .site-logo{text-decoration:none;color:white;font-size:1.4rem;font-weight:800;letter-spacing:.5px;white-space:nowrap}

    .stage{min-height:100%;position:relative;background:#07183d}
    .stage::before{content:"";position:fixed;inset:-24px;z-index:0;background-image:url("/images/jobs-bg.webp");background-size:cover;background-position:78% center;filter:blur(2.5px) saturate(1.15) contrast(1.05);transform:scale(1.03)}
    .stage::after{content:"";position:fixed;inset:0;z-index:1;pointer-events:none;background:radial-gradient(1100px 700px at 70% 15%,rgba(255,255,255,.22),transparent 62%),radial-gradient(900px 600px at 20% 25%,rgba(27,102,255,.14),transparent 62%),radial-gradient(900px 600px at 85% 35%,rgba(0,183,168,.10),transparent 62%),linear-gradient(180deg,rgba(7,24,61,.55),rgba(255,255,255,.10) 55%,rgba(255,255,255,.20))}
    .shell{max-width:var(--maxw);margin:0 auto;padding:22px 18px 0;position:relative;z-index:2;min-height:100vh}
    .frame{background:rgba(255,255,255,.78);border:1px solid var(--borderSoft);border-bottom:none;border-radius:calc(var(--radius)+10px) calc(var(--radius)+10px) 0 0;box-shadow:var(--shadow);backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px);padding:12px;padding-bottom:0;min-height:calc(100vh - 22px)}

    .topbar{background:linear-gradient(90deg,var(--nav),var(--nav2));border-radius:18px;padding:14px;color:#fff;box-shadow:var(--softShadow);position:sticky;top:14px;z-index:10;border:1px solid rgba(255,255,255,.10)}
    .topbar-row{display:flex;align-items:center;gap:16px}
    .topbar-nav{display:flex;align-items:center;gap:6px;margin-left:auto}
    .topbar-link{background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.18);border-radius:999px;padding:9px 16px;color:#fff;font-size:13px;font-weight:600;text-decoration:none;white-space:nowrap;transition:background .15s}
    .topbar-link:hover{background:rgba(255,255,255,.20)}
    .topbar-link.active{background:rgba(255,255,255,.18)}

    .grid{display:grid;grid-template-columns:240px 1fr;gap:16px;margin-top:14px;align-items:start}

    .panel{background:rgba(255,255,255,.86);border:1px solid var(--borderSoft);border-radius:var(--radius);box-shadow:var(--softShadow);overflow:hidden;position:relative}
    .panel::before{content:"";position:absolute;inset:0;border-radius:inherit;box-shadow:inset 0 0 0 1px var(--innerStroke);pointer-events:none}
    .sidebar{padding:20px;position:sticky;top:80px}

    /* Sidebar */
    .summary-card{background:#0a192f;color:white;padding:16px;border-radius:12px;margin-bottom:20px}
    .summary-row{display:flex;justify-content:space-between;align-items:baseline;padding:6px 0}
    .summary-label{font-size:11px;opacity:.6;text-transform:uppercase;letter-spacing:.5px}
    .summary-val{font-size:18px;font-weight:800}
    .section-title{font-size:13px;font-weight:800;color:#0a192f;margin-bottom:12px}

    .tile-group{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px}
    .filter-tile{background:#f8fafc;border:1px solid #e2e8f0;padding:12px;border-radius:8px;text-align:center;cursor:pointer;transition:all .2s;font-size:13px;font-weight:600;color:#334155}
    .filter-tile:hover{border-color:#3b82f6;color:#3b82f6}
    .filter-tile.active{background:#3b82f6;color:white;border-color:#3b82f6;box-shadow:0 4px 10px rgba(59,130,246,.3)}
    .tile-count{display:block;font-size:20px;font-weight:800;margin-bottom:2px}
    .filter-tile.active .tile-count{color:white}
    .tile-all{grid-column:1/-1}
    .sdot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:5px}
    .sdot-saved{background:#94a3b8}.sdot-applied{background:#3b82f6}.sdot-interview{background:#f59e0b}.sdot-offer{background:#10b981}.sdot-rejected{background:#ef4444}

    .import-bar{background:linear-gradient(135deg,#1b66ff,#00b7a8);color:white;padding:14px;border-radius:10px;text-align:center;font-weight:700;cursor:pointer;font-size:14px;border:none;width:100%;box-shadow:0 4px 14px rgba(27,102,255,.25);display:flex;align-items:center;justify-content:center;gap:8px;transition:all .2s}
    .import-bar:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(27,102,255,.35)}

    /* Right content */
    .content-area{padding:20px}

    /* Column headers */
    .col-headers{display:grid;grid-template-columns:2fr 1fr 1.2fr 1fr 80px 120px 28px;gap:12px;padding:0 16px 10px 58px;font-size:11px;font-weight:700;color:#94a3b8;text-transform:uppercase;letter-spacing:.8px;border-bottom:1px solid #e8ecf2}

    /* Job rows */
    .job-row{display:grid;grid-template-columns:2fr 1fr 1.2fr 1fr 80px 120px 28px;gap:12px;align-items:center;padding:14px 16px 14px 16px;border-bottom:1px solid #f0f3f7;transition:background .1s;cursor:pointer}
    .job-row:hover{background:#f8fafc}
    .job-row:last-child{border-bottom:none}

    .row-airline{display:flex;align-items:center;gap:12px}
    .row-logo{width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:12px;color:#fff;flex-shrink:0;letter-spacing:.3px}
    .row-logo img{width:38px;height:38px;border-radius:50%;object-fit:contain;background:#f0f3f7}
    .row-airline-info{min-width:0}
    .row-airline-name{font-size:14px;font-weight:700;color:#1e293b;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .row-airline-rank{font-size:11px;color:#94a3b8;margin-top:1px}

    .row-aircraft{font-size:13px;font-weight:600;color:#334155}
    .row-aircraft-label{font-size:10px;color:#cbd5e1;margin-top:1px}

    .row-location{display:flex;align-items:center;gap:4px;font-size:13px;color:#475569}
    .loc-dot{width:6px;height:6px;border-radius:50%;background:#ef4444;flex-shrink:0}

    .row-salary{font-size:13px;font-weight:600;color:#334155}
    .row-salary-label{font-size:10px;color:#cbd5e1;margin-top:1px}

    .row-date{font-size:12px;color:#94a3b8}

    /* Status badges */
    .status-badge{display:inline-flex;align-items:center;gap:5px;font-size:12px;font-weight:600;border-radius:20px;padding:5px 12px;cursor:pointer;border:1px solid;white-space:nowrap;transition:filter .15s;position:relative}
    .status-badge:hover{filter:brightness(.95)}
    .status-badge[data-s="saved"]{color:#64748b;background:#f1f5f9;border-color:#e2e8f0}
    .status-badge[data-s="applied"]{color:#1d4ed8;background:#eff6ff;border-color:#bfdbfe}
    .status-badge[data-s="interview"]{color:#b45309;background:#fffbeb;border-color:#fde68a}
    .status-badge[data-s="offer"]{color:#059669;background:#ecfdf5;border-color:#a7f3d0}
    .status-badge[data-s="rejected"]{color:#dc2626;background:#fef2f2;border-color:#fecaca}

    .badge-icon{font-size:10px}

    /* Dropdown */
    .status-dd{position:absolute;right:0;top:calc(100% + 4px);background:#fff;border-radius:8px;padding:4px;box-shadow:0 8px 30px rgba(0,0,0,.15);border:1px solid #e2e8f0;z-index:100;min-width:140px;display:none}
    .status-dd.open{display:block}
    .dd-option{display:flex;align-items:center;gap:8px;width:100%;padding:8px 10px;border:none;border-radius:6px;background:transparent;color:#475569;font-size:13px;font-weight:500;cursor:pointer;text-align:left}
    .dd-option:hover{background:#f8fafc}
    .dd-option.current{font-weight:700;color:var(--accent)}

    .row-arrow{color:#cbd5e1;font-size:12px;text-align:center;transition:transform .2s}
    .row-arrow.open{transform:rotate(180deg)}

    /* Expanded panel */
    .row-expanded{display:none;padding:0 16px 16px 58px;border-bottom:1px solid #f0f3f7}
    .row-expanded.open{display:block}
    .notes-label{font-size:12px;font-weight:600;color:#475569;margin:10px 0 6px}
    .notes-area{width:100%;max-width:600px;min-height:56px;border:1px solid #e2e8f0;border-radius:8px;padding:8px 12px;font-size:13px;color:#334155;resize:vertical;font-family:inherit;outline:none;background:#fff;line-height:1.5}
    .notes-area:focus{border-color:var(--accent)}
    .notes-ind{font-size:11px;color:var(--accent2);margin-top:4px;opacity:0;transition:opacity .3s}
    .notes-ind.on{opacity:1}
    .exp-btns{display:flex;gap:8px;margin-top:10px}
    .btn-s{background:none;border:1px solid #e2e8f0;color:#475569;padding:6px 14px;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;text-decoration:none;transition:all .15s}
    .btn-s:hover{border-color:var(--accent);color:var(--accent)}
    .btn-d{background:none;border:1px solid #fecaca;color:#dc2626;padding:6px 14px;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;transition:all .15s}
    .btn-d:hover{background:#fef2f2}

    /* States */
    .empty{text-align:center;padding:60px 20px;color:var(--muted)}
    .empty h3{font-size:17px;color:var(--text);margin:0 0 6px}
    .empty p{font-size:13px;margin:0}
    .auth-prompt{text-align:center;padding:80px 20px}
    .auth-prompt h2{font-size:20px;color:var(--text);margin:0 0 8px}
    .auth-prompt p{font-size:14px;color:var(--muted);margin:0 0 24px}
    .btn-primary{background:linear-gradient(135deg,#fff,#dbe8ff);color:#0b2a6f;border:none;border-radius:999px;padding:12px 28px;font-weight:800;cursor:pointer;box-shadow:0 10px 18px rgba(0,0,0,.18);text-decoration:none;font-size:14px;display:inline-block}
    .loading-state{text-align:center;padding:60px;color:var(--muted);font-size:14px}

    .mobile-toggle{display:none;margin-top:8px;width:100%;gap:8px;justify-content:center;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18);border-radius:10px;padding:10px 16px;color:#fff;font-size:13px;font-weight:700;cursor:pointer;align-items:center}

    @media(max-width:1100px){
      .col-headers,.job-row{grid-template-columns:2fr 1fr 1.2fr 1fr 70px 110px 24px}
    }
    @media(max-width:980px){
      .grid{grid-template-columns:1fr}
      .sidebar-panel{display:none}
      .sidebar-panel.show{display:block;position:fixed;inset:0;z-index:1000;border-radius:0;overflow-y:auto;background:white}
      .mobile-toggle{display:flex!important}
      .col-headers{display:none}
      .job-row{grid-template-columns:1fr auto auto;padding:12px 14px;gap:8px}
      .row-aircraft,.row-location,.row-salary,.row-date{display:none}
      .row-arrow{display:none}
    }
    @media(max-width:768px){
      html,body{overflow-x:hidden;height:auto}
      .stage::before,.stage::after{display:none}
      .shell{padding:0;background:#f8fafc}
      .frame{padding:0;border-radius:0;min-height:auto;background:#f8fafc;border:none;box-shadow:none}
      .topbar{padding:12px 16px;border-radius:0;position:sticky;top:0}
      .topbar-row{flex-wrap:wrap}
      .topbar-nav{width:100%;justify-content:flex-end;margin-top:4px}
      .content-area{padding:12px}
      .row-expanded{padding-left:14px}
    }
  </style>
</head>
<body>
  <div class="stage">
    <div class="shell">
      <div class="frame">

        <header class="topbar">
          <div class="topbar-row">
            <a href="index.html" class="site-logo">AEROSCOUT</a>
            <nav class="topbar-nav">
              <a href="Jobs.html?beta=true" class="topbar-link">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:4px"><path d="M21 21l-4.2-4.2m1.7-5.3a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>Jobs
              </a>
              <a href="Tracker.html?beta=true" class="topbar-link active">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:4px"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>Tracker
              </a>
            </nav>
          </div>
          <button class="mobile-toggle" id="toggleSidebar" type="button">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="6" x2="20" y2="6"/><line x1="6" y1="12" x2="18" y2="12"/><line x1="8" y1="18" x2="16" y2="18"/></svg>Overview
          </button>
        </header>

        <div id="loadingState" class="loading-state" style="margin-top:40px;">Loading...</div>

        <div id="authPrompt" style="display:none;">
          <div class="panel" style="margin-top:14px;">
            <div class="auth-prompt">
              <h2>Application Tracker</h2>
              <p>Sign in to track your job applications across airlines.</p>
              <a href="login.html" class="btn-primary">Log In</a>
            </div>
          </div>
        </div>

        <main class="grid" id="mainGrid" style="display:none;">

          <aside class="panel sidebar-panel" id="sidebarPanel">
            <div class="sidebar">
              <div class="summary-card">
                <div class="summary-row">
                  <span class="summary-label">Total tracked</span>
                  <span class="summary-val" id="totalCount">0</span>
                </div>
              </div>
              <div class="section-title">Filter by Status</div>
              <div class="tile-group">
                <div class="filter-tile tile-all active" data-status="all" onclick="setFilter('all')"><span class="tile-count" id="cAll">0</span>All</div>
                <div class="filter-tile" data-status="saved" onclick="setFilter('saved')"><span class="tile-count" id="cSaved">0</span><span class="sdot sdot-saved"></span>Saved</div>
                <div class="filter-tile" data-status="applied" onclick="setFilter('applied')"><span class="tile-count" id="cApplied">0</span><span class="sdot sdot-applied"></span>Applied</div>
                <div class="filter-tile" data-status="interview" onclick="setFilter('interview')"><span class="tile-count" id="cInterview">0</span><span class="sdot sdot-interview"></span>Interview</div>
                <div class="filter-tile" data-status="offer" onclick="setFilter('offer')"><span class="tile-count" id="cOffer">0</span><span class="sdot sdot-offer"></span>Offer</div>
                <div class="filter-tile" data-status="rejected" onclick="setFilter('rejected')"><span class="tile-count" id="cRejected">0</span><span class="sdot sdot-rejected"></span>Rejected</div>
              </div>
              <button class="import-bar" onclick="importSavedJobs()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Import Saved Jobs
              </button>
            </div>
          </aside>

          <section class="panel">
            <div class="content-area">
              <div class="col-headers">
                <div>Airline</div>
                <div>Aircraft</div>
                <div>Location</div>
                <div>Salary</div>
                <div>Saved</div>
                <div>Status</div>
                <div></div>
              </div>
              <div id="rowsList"></div>
              <div id="emptyState" class="empty" style="display:none;">
                <h3>No applications tracked yet</h3>
                <p>Save jobs from the job board, then import them here to track your progress.</p>
              </div>
            </div>
          </section>

        </main>
      </div>
    </div>
  </div>

  <script>
    if(new URLSearchParams(location.search).get('beta')!=='true') location.href='Jobs.html';

    const SB_URL='https://ziboktbmbyjbhifsdypa.supabase.co';
    const SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InppYm9rdGJtYnlqYmhpZnNkeXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3NjMwODUsImV4cCI6MjA4MjMzOTA4NX0.eayvAsTuezEJZ-SIvEjZmrYaUxmJtntV8pK8fyUBnbY';
    const{createClient}=supabase;
    const sb=createClient(SB_URL,SB_KEY);

    const STS=['saved','applied','interview','offer','rejected'];
    const STS_LABEL={saved:'Saved',applied:'Applied',interview:'Interview',offer:'Offer',rejected:'Rejected'};
    const STS_ICON={saved:'&#9733;',applied:'&#9998;',interview:'&#9899;',offer:'&#10132;',rejected:'&#10005;'};
    // Logo background colors per airline code
    const LOGO_COLORS=['#c0392b','#2980b9','#27ae60','#8e44ad','#d35400','#16a085','#2c3e50','#e74c3c','#3498db','#1abc9c'];

    let tracked=[],details={},filter='all',expanded=null,user=null,noteTimers={};

    document.getElementById('toggleSidebar').addEventListener('click',()=>{
      const p=document.getElementById('sidebarPanel');
      p.classList.toggle('show');
      document.body.style.overflow=p.classList.contains('show')?'hidden':'';
    });

    // Close status dropdowns on outside click
    document.addEventListener('click',e=>{
      if(!e.target.closest('.status-badge'))
        document.querySelectorAll('.status-dd.open').forEach(d=>d.classList.remove('open'));
    });

    async function init(){
      const{data:{session}}=await sb.auth.getSession();
      document.getElementById('loadingState').style.display='none';
      if(!session){document.getElementById('authPrompt').style.display='';return}
      user=session.user;
      document.getElementById('mainGrid').style.display='';
      await load();
    }

    async function load(){
      const{data}=await sb.from('tracked_jobs').select('*').eq('user_id',user.id).order('updated_at',{ascending:false});
      tracked=data||[];
      details={};

      const pIds=tracked.filter(t=>t.job_type==='pilot').map(t=>t.job_id);
      const cIds=tracked.filter(t=>t.job_type==='cabin_crew').map(t=>t.job_id);

      if(pIds.length){
        const{data:p}=await sb.from('verified_jobs').select('id,title,airline,aircraft,aircraft_family,location,salary_usd,rank,rank_bucket,url,logo_url,company_id').in('id',pIds);
        if(p){
          const coids=[...new Set(p.filter(x=>x.company_id).map(x=>x.company_id))];
          let logos={};
          if(coids.length){const{data:co}=await sb.from('final_companies').select('id,logo_url').in('id',coids);if(co)co.forEach(c=>{logos[c.id]=c.logo_url})}
          p.forEach(j=>{j.logo=j.logo_url||logos[j.company_id]||null;details['p_'+j.id]=j});
        }
      }
      if(cIds.length){
        const{data:c}=await sb.from('verified_cabin_crew_jobs').select('id,title,airline,location,salary_usd,position,url,logo_url').in('id',cIds);
        if(c)c.forEach(j=>{j.logo=j.logo_url||null;details['c_'+j.id]=j});
      }
      render();
    }

    function render(){updateCounts();renderRows()}

    function updateCounts(){
      const c={all:tracked.length};STS.forEach(s=>{c[s]=0});
      tracked.forEach(t=>{c[t.status]=(c[t.status]||0)+1});
      document.getElementById('totalCount').textContent=tracked.length;
      document.getElementById('cAll').textContent=c.all;
      STS.forEach(s=>{const el=document.getElementById('c'+s.charAt(0).toUpperCase()+s.slice(1));if(el)el.textContent=c[s]});
      document.querySelectorAll('.filter-tile').forEach(el=>{el.classList.toggle('active',el.dataset.status===filter)});
    }

    function hashCode(s){let h=0;for(let i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i);h|=0}return Math.abs(h)}

    function renderRows(){
      const list=filter==='all'?tracked:tracked.filter(t=>t.status===filter);
      const container=document.getElementById('rowsList');
      const empty=document.getElementById('emptyState');

      if(!list.length){
        container.innerHTML='';empty.style.display='';
        if(tracked.length&&filter!=='all'){
          empty.querySelector('h3').textContent='No '+STS_LABEL[filter].toLowerCase()+' applications';
          empty.querySelector('p').textContent='Change the status of a tracked job to see it here.';
        }else{
          empty.querySelector('h3').textContent='No applications tracked yet';
          empty.querySelector('p').textContent='Save jobs from the job board, then import them here to track your progress.';
        }
        return;
      }
      empty.style.display='none';

      container.innerHTML=list.map(t=>{
        const key=(t.job_type==='pilot'?'p_':'c_')+t.job_id;
        const job=details[key];
        const isOpen=expanded===t.id;
        const date=new Date(t.created_at).toLocaleDateString('en-GB',{day:'numeric',month:'short'});

        if(!job) return `<div class="job-row"><div class="row-airline"><div class="row-logo" style="background:#94a3b8">?</div><div class="row-airline-info"><div class="row-airline-name">Job unavailable</div><div class="row-airline-rank">May have been removed</div></div></div><div></div><div><button class="btn-d" onclick="remove('${t.id}')">Remove</button></div></div>`;

        const airline=job.airline||'Unknown';
        const code=airline.substring(0,2).toUpperCase();
        const bgColor=LOGO_COLORS[hashCode(airline)%LOGO_COLORS.length];
        const aircraft=job.aircraft||job.aircraft_family||'\u2014';
        const loc=job.location||'\u2014';
        const salary=job.salary_usd||'\u2014';
        const rank=job.rank||job.rank_bucket||job.position||'';

        const logoHtml=job.logo
          ?`<div class="row-logo"><img src="${job.logo}" alt="${code}" onerror="this.parentElement.style.background='${bgColor}';this.parentElement.innerHTML='${code}'"></div>`
          :`<div class="row-logo" style="background:${bgColor}">${code}</div>`;

        const ddOptions=STS.map(s=>
          `<button class="dd-option${s===t.status?' current':''}" onclick="event.stopPropagation();updateStatus('${t.id}','${s}')"><span class="sdot sdot-${s}"></span>${STS_LABEL[s]}</button>`
        ).join('');

        return `
          <div class="job-row" onclick="toggleExpand('${t.id}')">
            <div class="row-airline">
              ${logoHtml}
              <div class="row-airline-info">
                <div class="row-airline-name">${airline}</div>
                <div class="row-airline-rank">${rank}</div>
              </div>
            </div>
            <div>
              <div class="row-aircraft">${aircraft}</div>
              <div class="row-aircraft-label">Aircraft</div>
            </div>
            <div class="row-location"><span class="loc-dot"></span>${loc}</div>
            <div>
              <div class="row-salary">${salary}</div>
              <div class="row-salary-label">Salary</div>
            </div>
            <div class="row-date">${date}</div>
            <div style="position:relative" onclick="event.stopPropagation()">
              <div class="status-badge" data-s="${t.status}" onclick="toggleDD('${t.id}')">
                <span class="badge-icon">${STS_ICON[t.status]}</span> ${STS_LABEL[t.status]}
              </div>
              <div class="status-dd" id="dd-${t.id}">${ddOptions}</div>
            </div>
            <div class="row-arrow${isOpen?' open':''}">&#9662;</div>
          </div>
          <div class="row-expanded${isOpen?' open':''}" id="exp-${t.id}">
            <div class="notes-label">Notes</div>
            <textarea class="notes-area" id="notes-${t.id}" placeholder="Interview date, contact info, prep notes..." oninput="onNote('${t.id}')" onclick="event.stopPropagation()">${t.notes||''}</textarea>
            <div class="notes-ind" id="si-${t.id}">Saved</div>
            <div class="exp-btns">
              <a class="btn-s" href="${job.url}" target="_blank" rel="noopener" onclick="event.stopPropagation()">View Original Posting</a>
              <button class="btn-d" onclick="event.stopPropagation();remove('${t.id}')">Remove</button>
            </div>
          </div>`;
      }).join('');
    }

    function setFilter(s){
      filter=s;
      const p=document.getElementById('sidebarPanel');
      if(p.classList.contains('show')){p.classList.remove('show');document.body.style.overflow=''}
      render();
    }

    function toggleExpand(id){expanded=expanded===id?null:id;renderRows()}

    function toggleDD(id){
      document.querySelectorAll('.status-dd.open').forEach(d=>{if(d.id!=='dd-'+id)d.classList.remove('open')});
      document.getElementById('dd-'+id).classList.toggle('open');
    }

    async function updateStatus(id,status){
      document.querySelectorAll('.status-dd.open').forEach(d=>d.classList.remove('open'));
      const{error}=await sb.from('tracked_jobs').update({status}).eq('id',id).eq('user_id',user.id);
      if(error){console.error(error);return}
      const t=tracked.find(j=>j.id===id);if(t)t.status=status;
      render();
    }

    function onNote(id){if(noteTimers[id])clearTimeout(noteTimers[id]);noteTimers[id]=setTimeout(()=>saveNote(id),800)}

    async function saveNote(id){
      const el=document.getElementById('notes-'+id);if(!el)return;
      const{error}=await sb.from('tracked_jobs').update({notes:el.value}).eq('id',id).eq('user_id',user.id);
      if(error)return;
      const t=tracked.find(j=>j.id===id);if(t)t.notes=el.value;
      const ind=document.getElementById('si-'+id);
      if(ind){ind.classList.add('on');setTimeout(()=>ind.classList.remove('on'),1500)}
    }

    async function remove(id){
      if(!confirm('Remove this application from your tracker?'))return;
      await sb.from('tracked_jobs').delete().eq('id',id).eq('user_id',user.id);
      tracked=tracked.filter(j=>j.id!==id);
      if(expanded===id)expanded=null;
      render();
    }

    async function importSavedJobs(){
      const{data:saved,error}=await sb.from('saved_jobs').select('*').eq('user_id',user.id);
      if(error||!saved){alert('Could not load saved jobs.');return}
      if(!saved.length){alert('No saved jobs found. Save some from the job board first.');return}
      const existing=new Set(tracked.map(j=>j.job_type+'_'+j.job_id));
      const toImport=saved.filter(s=>!existing.has(s.job_type+'_'+s.job_id));
      if(!toImport.length){alert('All saved jobs are already tracked.');return}
      const rows=toImport.map(s=>({user_id:user.id,job_id:s.job_id,job_type:s.job_type,status:'saved',notes:''}));
      const{error:e2}=await sb.from('tracked_jobs').insert(rows);
      if(e2){alert('Error importing.');return}
      alert('Imported '+toImport.length+' job'+(toImport.length>1?'s':'')+'.');
      await load();
    }

    init();
  </script>
</body>
</html>