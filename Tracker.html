<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex, nofollow" />
  <title>AeroScout | Application Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --nav:#0b2a6f;--nav2:#081a45;--text:#0e1830;--muted:#6b7890;--accent:#1b66ff;--accent2:#00b7a8;
      --shadow:0 18px 46px rgba(13,36,90,.14);--softShadow:0 10px 26px rgba(13,36,90,.10);
      --radius:22px;--maxw:1900px;--borderSoft:rgba(255,255,255,.22);--innerStroke:rgba(12,28,64,.05);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html{height:100%}
    body{min-height:100%;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--text);background:#07183d}

    .site-logo{text-decoration:none;color:white;font-size:1.4rem;font-weight:800;letter-spacing:.5px;white-space:nowrap}

    .stage{min-height:100vh;position:relative;background:#07183d}
    .stage::before{content:"";position:fixed;inset:-24px;z-index:0;background-image:url("/images/jobs-bg.webp");background-size:cover;background-position:78% center;filter:blur(2.5px) saturate(1.15) contrast(1.05);transform:scale(1.03)}
    .stage::after{content:"";position:fixed;inset:0;z-index:1;pointer-events:none;background:radial-gradient(1100px 700px at 70% 15%,rgba(255,255,255,.22),transparent 62%),radial-gradient(900px 600px at 20% 25%,rgba(27,102,255,.14),transparent 62%),radial-gradient(900px 600px at 85% 35%,rgba(0,183,168,.10),transparent 62%),linear-gradient(180deg,rgba(7,24,61,.55),rgba(255,255,255,.10) 55%,rgba(255,255,255,.20))}
    .shell{max-width:var(--maxw);margin:0 auto;padding:22px 18px 0;position:relative;z-index:2;min-height:100vh}
    .frame{background:rgba(255,255,255,.78);border:1px solid var(--borderSoft);border-bottom:none;border-radius:calc(var(--radius)+10px) calc(var(--radius)+10px) 0 0;box-shadow:var(--shadow);backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px);padding:12px;padding-bottom:0;min-height:calc(100vh - 22px)}

    .topbar{background:linear-gradient(90deg,var(--nav),var(--nav2));border-radius:18px;padding:14px;color:#fff;box-shadow:var(--softShadow);position:sticky;top:14px;z-index:10;border:1px solid rgba(255,255,255,.10)}
    .topbar-row{display:flex;align-items:center;gap:16px}
    .topbar-nav{display:flex;align-items:center;gap:6px;margin-left:auto}
    .topbar-link{background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.18);border-radius:999px;padding:9px 16px;color:#fff;font-size:13px;font-weight:600;text-decoration:none;white-space:nowrap;transition:background .15s}
    .topbar-link:hover{background:rgba(255,255,255,.20)}
    .topbar-link.active{background:rgba(255,255,255,.18)}

    .layout{display:grid;grid-template-columns:220px 1fr;gap:16px;margin-top:14px;align-items:start}

    .panel{background:rgba(255,255,255,.86);border:1px solid var(--borderSoft);border-radius:var(--radius);box-shadow:var(--softShadow);overflow:visible;position:relative}
    .panel::before{content:"";position:absolute;inset:0;border-radius:inherit;box-shadow:inset 0 0 0 1px var(--innerStroke);pointer-events:none;z-index:0}

    /* ── Sidebar ── */
    .sidebar{padding:18px;position:sticky;top:80px}
    .sidebar-label{font-size:11px;font-weight:700;color:#94a3b8;text-transform:uppercase;letter-spacing:.8px;margin-bottom:10px}

    .stat-total{background:#0a192f;color:white;padding:14px 16px;border-radius:10px;margin-bottom:18px;display:flex;justify-content:space-between;align-items:center}
    .stat-total-label{font-size:11px;opacity:.6;text-transform:uppercase;letter-spacing:.5px}
    .stat-total-val{font-size:22px;font-weight:800}

    .filter-list{display:flex;flex-direction:column;gap:3px;margin-bottom:18px}
    .fi{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:500;color:#475569;border:1px solid transparent;transition:all .15s;background:transparent}
    .fi:hover{background:#f1f5f9}
    .fi.active{background:#f1f5f9;font-weight:700;color:var(--text);border-color:#e2e8f0}
    .fi-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
    .fi-name{flex:1}
    .fi-ct{font-size:12px;font-weight:700;color:#94a3b8;min-width:16px;text-align:right}
    .fi.active .fi-ct{color:var(--text)}

    .import-bar{background:#fff;color:#475569;padding:12px;border-radius:10px;text-align:center;font-weight:600;cursor:pointer;font-size:13px;border:1px solid #e2e8f0;width:100%;display:flex;align-items:center;justify-content:center;gap:8px;transition:all .15s}
    .import-bar:hover{border-color:#94a3b8;color:var(--text);background:#f8fafc}

    /* ── Content ── */
    .content{padding:16px}

    .col-head{display:grid;grid-template-columns:2.4fr 1.2fr 1.6fr 1.2fr 0.6fr 1fr;gap:0;padding:0 24px 12px 68px;font-size:11px;font-weight:700;color:#1e293b;text-transform:uppercase;letter-spacing:.7px}

    .job-cards{display:flex;flex-direction:column;gap:0}

    /* ── Job card ── */
    .jcard{background:#fff;border-bottom:1px solid #eef1f6;overflow:visible;position:relative;transition:background .15s}
    .jcard:first-child{border-radius:12px 12px 0 0}
    .jcard:last-child{border-radius:0 0 12px 12px;border-bottom:none}
    .jcard:only-child{border-radius:12px}
    .jcard:hover{background:#fafbfd}

    .jcard-main{display:grid;grid-template-columns:2.4fr 1.2fr 1.6fr 1.2fr 0.6fr 1fr;gap:0;align-items:center;padding:24px 24px 24px 24px;cursor:pointer}

    .j-airline{display:flex;align-items:center;gap:14px}
    .j-logo{width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:14px;color:#fff;flex-shrink:0;letter-spacing:.3px;overflow:hidden}
    .j-logo img{width:48px;height:48px;border-radius:50%;object-fit:contain;background:#f0f3f7}
    .j-info{min-width:0}
    .j-name{font-size:16px;font-weight:700;color:#1e293b;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .j-sub{font-size:12px;color:#94a3b8;margin-top:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:180px}

    .j-aircraft{font-size:14px;font-weight:600;color:#334155;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .j-aircraft-label{font-size:10px;color:#cbd5e1;margin-top:2px}

    .j-location{font-size:14px;color:#334155;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .j-salary{font-size:14px;font-weight:600;color:#334155;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .j-salary-label{font-size:10px;color:#cbd5e1;margin-top:2px}

    .j-date{font-size:12px;color:#1e293b}

    /* Status badge */
    .sb-wrap{position:relative;z-index:1;text-align:center}
    .sb-wrap.dd-active{z-index:200}

    .sb{display:inline-flex;align-items:center;gap:5px;font-size:12px;font-weight:600;border-radius:20px;padding:7px 16px;cursor:pointer;border:1px solid;white-space:nowrap;transition:filter .15s;user-select:none}
    .sb:hover{filter:brightness(.93)}
    .sb[data-s="saved"]{color:#64748b;background:#f1f5f9;border-color:#e2e8f0}
    .sb[data-s="applied"]{color:#1d4ed8;background:#eff6ff;border-color:#bfdbfe}
    .sb[data-s="interview"]{color:#b45309;background:#fffbeb;border-color:#fde68a}
    .sb[data-s="offer"]{color:#059669;background:#ecfdf5;border-color:#a7f3d0}
    .sb[data-s="rejected"]{color:#dc2626;background:#fef2f2;border-color:#fecaca}

    .sdd{position:absolute;right:0;top:calc(100% + 6px);background:#fff;border-radius:10px;padding:6px;box-shadow:0 10px 40px rgba(0,0,0,.18);border:1px solid #e2e8f0;min-width:160px;display:none}
    .sdd.open{display:block}
    .sdd-opt{display:flex;align-items:center;gap:8px;width:100%;padding:9px 12px;border:none;border-radius:6px;background:transparent;color:#475569;font-size:13px;font-weight:500;cursor:pointer;text-align:left;transition:background .1s}
    .sdd-opt:hover{background:#f8fafc}
    .sdd-opt.cur{font-weight:700;color:var(--accent)}
    .sdd-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}

    /* Expanded */
    .jcard-exp{display:none;padding:0 24px 24px 86px;border-top:1px solid #f0f3f7}
    .jcard.open .jcard-exp{display:block}
    .exp-label{font-size:12px;font-weight:600;color:#475569;margin:16px 0 8px}
    .exp-notes{width:100%;max-width:560px;min-height:72px;border:1px solid #e2e8f0;border-radius:8px;padding:12px 14px;font-size:13px;color:#000;resize:vertical;font-family:inherit;outline:none;background:#fff;line-height:1.5}
    .exp-notes:focus{border-color:var(--accent)}
    .exp-ind{font-size:11px;color:var(--accent2);margin-top:4px;opacity:0;transition:opacity .3s}
    .exp-ind.on{opacity:1}
    .exp-btns{display:flex;gap:10px;margin-top:14px}
    .btn-s{background:none;border:1px solid #e2e8f0;color:#475569;padding:8px 18px;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;text-decoration:none;transition:all .15s}
    .btn-s:hover{border-color:var(--accent);color:var(--accent)}
    .btn-d{background:none;border:1px solid #fecaca;color:#dc2626;padding:8px 18px;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;transition:all .15s}
    .btn-d:hover{background:#fef2f2}

    /* States */
    .empty-state{text-align:center;padding:60px 20px;color:var(--muted)}
    .empty-state h3{font-size:17px;color:var(--text);margin:0 0 6px}
    .empty-state p{font-size:13px;margin:0}
    .auth-prompt{text-align:center;padding:80px 20px}
    .auth-prompt h2{font-size:20px;color:var(--text);margin:0 0 8px}
    .auth-prompt p{font-size:14px;color:var(--muted);margin:0 0 24px}
    .btn-primary{background:linear-gradient(135deg,#fff,#dbe8ff);color:#0b2a6f;border:none;border-radius:999px;padding:12px 28px;font-weight:800;cursor:pointer;box-shadow:0 10px 18px rgba(0,0,0,.18);text-decoration:none;font-size:14px;display:inline-block}
    .loading-state{text-align:center;padding:60px;color:var(--muted);font-size:14px}

    .mobile-toggle{display:none}

    @media(max-width:1050px){
      .j-name{font-size:14px}
      .j-sub{max-width:140px}
    }

    @media(max-width:980px){
      .layout{grid-template-columns:1fr}
      .sidebar-panel{display:none!important}
    }

    @media(max-width:768px){
      html,body{overflow-x:hidden;width:100vw;max-width:100vw}
      .stage{min-width:0}
      .stage::before,.stage::after{display:none}
      .shell{padding:0;background:#f8fafc;max-width:100vw;overflow-x:hidden}
      .frame{padding:0;border-radius:0;min-height:auto;background:#f8fafc;border:none;box-shadow:none;overflow:hidden}
      .topbar{padding:10px 14px;border-radius:0;position:sticky;top:0}
      .topbar-row{flex-wrap:nowrap}
      .topbar-nav{width:auto;margin-top:0}
      .topbar-link{padding:7px 12px;font-size:12px}
      .site-logo{font-size:1.1rem}
      .layout{display:block!important}
      .content{padding:8px}
      .col-head{display:none!important}
      .panel{border-radius:12px;overflow:visible}
      .panel::before{display:none}

      .jcard{border-bottom:1px solid #eef1f6;border-radius:0!important;overflow:visible}
      .jcard:first-child{border-radius:12px 12px 0 0!important}
      .jcard:last-child{border-radius:0 0 12px 12px!important;border-bottom:none}

      .jcard-main{display:flex!important;flex-wrap:wrap;gap:0;padding:14px 12px;align-items:center;width:100%}

      .j-airline{display:flex;align-items:center;gap:10px;flex:1;min-width:0;overflow:hidden}
      .j-logo{width:38px;height:38px;flex-shrink:0}
      .j-logo img{width:38px;height:38px}
      .j-info{min-width:0;overflow:hidden}
      .j-name{font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
      .j-sub{max-width:none!important;font-size:11px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#94a3b8}

      .sb-wrap{flex-shrink:0;margin-left:8px}
      .sb{padding:5px 10px;font-size:11px}
      .sdd{right:auto;left:auto;right:0;min-width:140px}

      .j-col-aircraft,.j-col-location,.j-col-salary,.j-col-date{display:none!important}

      .j-mobile-meta{display:flex!important;gap:6px 12px;width:100%;padding-left:48px;font-size:11px;color:#64748b;margin-top:6px;flex-wrap:wrap}
      .j-mobile-meta span{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:calc(100vw - 80px)}
      .j-mobile-meta b{color:#334155;font-weight:600}

      .jcard-exp{padding:0 12px 14px 12px!important}
      .exp-notes{max-width:100%;min-height:56px;font-size:13px}
      .exp-btns{flex-wrap:wrap;gap:8px}
      .btn-s,.btn-d{padding:8px 14px;font-size:11px}

    }
    @media(min-width:769px){
      .j-mobile-meta{display:none!important}
    }
  </style>
  <script type="text/javascript">
      (function(c,l,a,r,i,t,y){
          c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
          t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
          y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
      })(window, document, "clarity", "script", "vl40k47zay");
  </script>
</head>
<body>
  <div class="stage">
    <div class="shell">
      <div class="frame">

        <header class="topbar">
          <div class="topbar-row">
            <a href="index.html" class="site-logo">AEROSCOUT</a>
            <nav class="topbar-nav">
              <a href="Jobs.html" class="topbar-link">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:4px"><path d="M21 21l-4.2-4.2m1.7-5.3a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>Jobs
              </a>
              <a href="Tracker.html" class="topbar-link active">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:4px"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>Tracker
              </a>
            </nav>
          </div>
        </header>

        <div id="loadingState" class="loading-state" style="margin-top:40px;">Loading...</div>

        <div id="authPrompt" style="display:none;">
          <div class="panel" style="margin-top:14px;">
            <div class="auth-prompt">
              <h2>Application Tracker</h2>
              <p>Sign in to track your job applications across airlines.</p>
              <a href="login.html" class="btn-primary">Log In</a>
            </div>
          </div>
        </div>

        <div id="premiumGate" style="display:none;">
          <div class="panel" style="margin-top:14px;">
            <div class="auth-prompt">
              <h2>Application Tracker</h2>
              <p>Track your applications, interviews, and offers across airlines — all in one place.</p>
              <p style="margin-top:8px;font-size:13px;color:#64748b;">This feature is available with AeroScout Pro.</p>
              <a href="pricing.html" class="btn-primary" style="margin-top:16px;">Upgrade to Pro</a>
            </div>
          </div>
        </div>

        <main class="layout" id="mainGrid" style="display:none;">

          <aside class="panel sidebar-panel" id="sidebarPanel">
            <div class="sidebar">
              <div class="stat-total">
                <span class="stat-total-label">Total tracked</span>
                <span class="stat-total-val" id="totalCount">0</span>
              </div>
              <div class="sidebar-label">Status</div>
              <div class="filter-list">
                <div class="fi active" data-status="all" onclick="setFilter('all')"><span class="fi-dot" style="background:#475569"></span><span class="fi-name">All</span><span class="fi-ct" id="cAll">0</span></div>
                <div class="fi" data-status="saved" onclick="setFilter('saved')"><span class="fi-dot" style="background:#94a3b8"></span><span class="fi-name">Saved</span><span class="fi-ct" id="cSaved">0</span></div>
                <div class="fi" data-status="applied" onclick="setFilter('applied')"><span class="fi-dot" style="background:#3b82f6"></span><span class="fi-name">Applied</span><span class="fi-ct" id="cApplied">0</span></div>
                <div class="fi" data-status="interview" onclick="setFilter('interview')"><span class="fi-dot" style="background:#f59e0b"></span><span class="fi-name">Interview</span><span class="fi-ct" id="cInterview">0</span></div>
                <div class="fi" data-status="offer" onclick="setFilter('offer')"><span class="fi-dot" style="background:#10b981"></span><span class="fi-name">Offer</span><span class="fi-ct" id="cOffer">0</span></div>
                <div class="fi" data-status="rejected" onclick="setFilter('rejected')"><span class="fi-dot" style="background:#ef4444"></span><span class="fi-name">Rejected</span><span class="fi-ct" id="cRejected">0</span></div>
              </div>
              <button class="import-bar" onclick="importSavedJobs()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Import Saved Jobs
              </button>
            </div>
          </aside>

          <section class="panel" style="overflow:visible">
            <div class="content">
              <div class="col-head">
                <div>Airline</div>
                <div>Aircraft</div>
                <div>Location</div>
                <div>Salary</div>
                <div>Saved</div>
                <div style="text-align:center">Status</div>
              </div>
              <div class="job-cards" id="cardsList"></div>
              <div id="emptyState" class="empty-state" style="display:none;">
                <h3>No applications tracked yet</h3>
                <p>Save jobs from the job board, then import them here to track your progress.</p>
              </div>
            </div>
          </section>

        </main>
      </div>
    </div>
  </div>

  <script>
    const isBeta=new URLSearchParams(location.search).get('beta')==='true';

    const SB='https://ziboktbmbyjbhifsdypa.supabase.co';
    const SK='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InppYm9rdGJtYnlqYmhpZnNkeXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3NjMwODUsImV4cCI6MjA4MjMzOTA4NX0.eayvAsTuezEJZ-SIvEjZmrYaUxmJtntV8pK8fyUBnbY';
    const{createClient}=supabase;const sb=createClient(SB,SK);

    const STS=['saved','applied','interview','offer','rejected'];
    const LBL={saved:'Saved',applied:'Applied',interview:'Interview',offer:'Offer',rejected:'Rejected'};
    const ICO={saved:'\u2605',applied:'\u270E',interview:'\u25CF',offer:'\u2794',rejected:'\u2715'};
    const DOT={saved:'#94a3b8',applied:'#3b82f6',interview:'#f59e0b',offer:'#10b981',rejected:'#ef4444'};
    const BG=['#c0392b','#2980b9','#27ae60','#8e44ad','#d35400','#16a085','#2c3e50','#e74c3c','#f39c12','#1abc9c'];

    let tracked=[],details={},filter='all',expanded=null,user=null,nT={},activeDD=null;

    document.addEventListener('click',e=>{if(!e.target.closest('.sb-wrap'))closeDD()});

    function closeDD(){
      if(activeDD){activeDD.classList.remove('open');activeDD.closest('.sb-wrap').classList.remove('dd-active');activeDD=null}
    }

    async function init(){
      const{data:{session}}=await sb.auth.getSession();
      document.getElementById('loadingState').style.display='none';
      if(!session){document.getElementById('authPrompt').style.display='';return}
      user=session.user;

      // Beta: check premium subscription
      if(isBeta){
        const{data:prof}=await sb.from('profiles').select('is_premium').eq('id',user.id).single();
        if(!prof||!prof.is_premium){document.getElementById('premiumGate').style.display='';return}
      }

      document.getElementById('mainGrid').style.display='';
      await load();
    }

    async function load(){
      const{data}=await sb.from('tracked_jobs').select('*').eq('user_id',user.id).order('updated_at',{ascending:false});
      tracked=data||[];details={};
      const pIds=tracked.filter(t=>t.job_type==='pilot').map(t=>t.job_id);
      const cIds=tracked.filter(t=>t.job_type==='cabin_crew').map(t=>t.job_id);
      if(pIds.length){
        const{data:p}=await sb.from('public_verified_jobs').select('id,title,airline,aircraft,aircraft_family,location,salary_usd,rank,rank_bucket,url,logo_url,company_id').in('id',pIds);
        if(p){
          const co=[...new Set(p.filter(x=>x.company_id).map(x=>x.company_id))];let lg={};
          if(co.length){const{data:c}=await sb.from('final_companies').select('id,logo_url').in('id',co);if(c)c.forEach(x=>{lg[x.id]=x.logo_url})}
          p.forEach(j=>{j.logo=j.logo_url||lg[j.company_id]||null;details['p_'+j.id]=j});
        }
      }
      if(cIds.length){
        const{data:c}=await sb.from('public_verified_cabin_crew_jobs').select('id,title,airline,location,salary_usd,position,url,logo_url').in('id',cIds);
        if(c)c.forEach(j=>{j.logo=j.logo_url||null;details['c_'+j.id]=j});
      }
      render();
    }

    function render(){updateCounts();renderCards()}
    function hc(s){let h=0;for(let i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i);h|=0}return Math.abs(h)}

    function updateCounts(){
      const c={all:tracked.length};STS.forEach(s=>{c[s]=0});
      tracked.forEach(t=>{c[t.status]=(c[t.status]||0)+1});
      document.getElementById('totalCount').textContent=tracked.length;
      document.getElementById('cAll').textContent=c.all;
      STS.forEach(s=>{const el=document.getElementById('c'+s.charAt(0).toUpperCase()+s.slice(1));if(el)el.textContent=c[s]});
      document.querySelectorAll('.fi').forEach(el=>{el.classList.toggle('active',el.dataset.status===filter)});
    }

    function renderCards(){
      const list=filter==='all'?tracked:tracked.filter(t=>t.status===filter);
      const el=document.getElementById('cardsList');
      const empty=document.getElementById('emptyState');
      if(!list.length){
        el.innerHTML='';empty.style.display='';
        empty.querySelector('h3').textContent=tracked.length&&filter!=='all'?'No '+LBL[filter].toLowerCase()+' applications':'No applications tracked yet';
        empty.querySelector('p').textContent=tracked.length&&filter!=='all'?'Change the status of a tracked job to see it here.':'Save jobs from the job board, then import them here to track your progress.';
        return;
      }
      empty.style.display='none';

      el.innerHTML=list.map(t=>{
        const key=(t.job_type==='pilot'?'p_':'c_')+t.job_id;
        const job=details[key];
        const isOpen=expanded===t.id;
        const date=new Date(t.created_at).toLocaleDateString('en-GB',{day:'numeric',month:'short'});

        if(!job) return `<div class="jcard"><div class="jcard-main" style="display:flex;justify-content:space-between;align-items:center"><div class="j-airline"><div class="j-logo" style="background:#94a3b8">?</div><div class="j-info"><div class="j-name">Job unavailable</div><div class="j-sub">May have been removed</div></div></div><button class="btn-d" onclick="event.stopPropagation();remove('${t.id}')">Remove</button></div></div>`;

        const airline=job.airline||'Unknown';
        const code=airline.substring(0,2).toUpperCase();
        const bg=BG[hc(airline)%BG.length];
        const aircraft=job.aircraft||job.aircraft_family||'\u2014';
        const loc=job.location||'\u2014';
        const salary=job.salary_usd||'\u2014';
        const title=job.title||'';

        const logoHtml=job.logo
          ?`<div class="j-logo"><img src="${job.logo}" alt="${code}" onerror="this.parentElement.style.background='${bg}';this.parentElement.innerHTML='${code}'"></div>`
          :`<div class="j-logo" style="background:${bg}">${code}</div>`;

        const ddOpts=STS.map(s=>
          `<button class="sdd-opt${s===t.status?' cur':''}" onclick="event.stopPropagation();updStatus('${t.id}','${s}')"><span class="sdd-dot" style="background:${DOT[s]}"></span>${LBL[s]}</button>`
        ).join('');

        return `<div class="jcard${isOpen?' open':''}">
          <div class="jcard-main" onclick="toggleExp('${t.id}')">
            <div class="j-airline">
              ${logoHtml}
              <div class="j-info">
                <div class="j-name">${airline}</div>
                <div class="j-sub" title="${title}">${title}</div>
              </div>
            </div>
            <div class="j-col-aircraft">
              <div class="j-aircraft">${aircraft}</div>
            </div>
            <div class="j-col-location">
              <div class="j-location" title="${loc}">${loc}</div>
            </div>
            <div class="j-col-salary">
              <div class="j-salary">${salary}</div>
            </div>
            <div class="j-col-date">
              <div class="j-date">${date}</div>
            </div>
            <div class="sb-wrap" onclick="event.stopPropagation()">
              <div class="sb" data-s="${t.status}" onclick="toggleDD(this,'${t.id}')">
                <span>${ICO[t.status]}</span> ${LBL[t.status]}
              </div>
              <div class="sdd" id="dd-${t.id}">${ddOpts}</div>
            </div>
            <div class="j-mobile-meta">
              ${aircraft!=='\u2014'?'<span><b>'+aircraft+'</b></span>':''}
              ${loc!=='\u2014'?'<span>'+loc+'</span>':''}
              ${salary!=='\u2014'?'<span>'+salary+'</span>':''}
            </div>
          </div>
          <div class="jcard-exp">
            <div class="exp-label">Notes</div>
            <textarea class="exp-notes" id="n-${t.id}" placeholder="Interview date, contact info, prep notes..." oninput="onN('${t.id}')" onclick="event.stopPropagation()">${t.notes||''}</textarea>
            <div class="exp-ind" id="si-${t.id}">Saved</div>
            <div class="exp-btns">
              <a class="btn-s" href="${job.url}" target="_blank" rel="noopener" onclick="event.stopPropagation()">View Original Posting</a>
              <button class="btn-d" onclick="event.stopPropagation();remove('${t.id}')">Remove</button>
            </div>
          </div>
        </div>`;
      }).join('');
    }

    function setFilter(s){
      filter=s;
      render();
    }

    function toggleExp(id){expanded=expanded===id?null:id;renderCards()}

    function toggleDD(badge,id){
      const dd=document.getElementById('dd-'+id);const wrap=badge.closest('.sb-wrap');
      if(activeDD&&activeDD!==dd)closeDD();
      if(dd.classList.contains('open')){closeDD()}
      else{
        // Check if dropdown would overflow viewport bottom
        const rect=badge.getBoundingClientRect();
        const spaceBelow=window.innerHeight-rect.bottom;
        if(spaceBelow<300){
          dd.style.top='auto';
          dd.style.bottom='calc(100% + 6px)';
        }else{
          dd.style.top='calc(100% + 6px)';
          dd.style.bottom='auto';
        }
        dd.classList.add('open');wrap.classList.add('dd-active');activeDD=dd;
      }
    }

    async function updStatus(id,status){
      closeDD();
      const{error}=await sb.from('tracked_jobs').update({status}).eq('id',id).eq('user_id',user.id);
      if(error)return;
      const t=tracked.find(j=>j.id===id);if(t)t.status=status;render();
    }

    function onN(id){if(nT[id])clearTimeout(nT[id]);nT[id]=setTimeout(()=>saveN(id),800)}

    async function saveN(id){
      const el=document.getElementById('n-'+id);if(!el)return;
      const{error}=await sb.from('tracked_jobs').update({notes:el.value}).eq('id',id).eq('user_id',user.id);
      if(error)return;
      const t=tracked.find(j=>j.id===id);if(t)t.notes=el.value;
      const ind=document.getElementById('si-'+id);
      if(ind){ind.classList.add('on');setTimeout(()=>ind.classList.remove('on'),1500)}
    }

    async function remove(id){
      if(!confirm('Remove this application from your tracker?'))return;
      await sb.from('tracked_jobs').delete().eq('id',id).eq('user_id',user.id);
      tracked=tracked.filter(j=>j.id!==id);if(expanded===id)expanded=null;render();
    }

    async function importSavedJobs(){
      const{data:saved,error}=await sb.from('saved_jobs').select('*').eq('user_id',user.id);
      if(error||!saved){alert('Could not load saved jobs.');return}
      if(!saved.length){alert('No saved jobs found.');return}
      const ex=new Set(tracked.map(j=>j.job_type+'_'+j.job_id));
      const imp=saved.filter(s=>!ex.has(s.job_type+'_'+s.job_id));
      if(!imp.length){alert('All saved jobs are already tracked.');return}
      const rows=imp.map(s=>({user_id:user.id,job_id:s.job_id,job_type:s.job_type,status:'saved',notes:''}));
      const{error:e2}=await sb.from('tracked_jobs').insert(rows);
      if(e2){alert('Error importing.');return}
      alert('Imported '+imp.length+' job'+(imp.length>1?'s':'')+'.');await load();
    }

    init();
  </script>
</body>
</html>