<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AeroScout | Browse Roles</title>
  <!-- Mapbox GL JS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
  <style>
    :root{
      --nav:#0b2a6f;
      --nav2:#081a45;
      --text:#0e1830;
      --muted:#6b7890;
      --accent:#1b66ff;
      --accent2:#00b7a8;

      --shadow: 0 18px 46px rgba(13, 36, 90, .14);
      --softShadow: 0 10px 26px rgba(13, 36, 90, .10);

      --radius:22px;
      --maxw:1540px;

      --borderSoft: rgba(255,255,255,.22);
      --innerStroke: rgba(12, 28, 64, .05);
      --lineSoft: rgba(210,222,245,.55);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:#07183d;
    }

    /* ✅ AIRPLANE BACKGROUND THAT READS AS "WING + SKY" */
    .stage{
      min-height:100%;
      position:relative;
      background:#07183d; /* fallback */
    }

    /* Photo layer (blurred slightly so UI is readable but still clearly a photo) */
    .stage::before{
      content:"";
      position:fixed;
      inset:-24px; /* extend so blur doesn’t show edges */
      z-index:0;

      /* IMPORTANT: This image is DIFFERENT from the one you posted. */
      background-image: url("https://images.unsplash.com/photo-1506012787146-f92b2d7d6d96?auto=format&fit=crop&w=2600&q=80");
      background-size: cover;
      background-position: 78% center; /* push wing into the visible right side */
      background-repeat:no-repeat;

      filter: blur(2.5px) saturate(1.15) contrast(1.05);
      transform: scale(1.03);
    }

    /* Overlay layer (lighter than before so the wing/sky is visible) */
    .stage::after{
      content:"";
      position:fixed;
      inset:0;
      z-index:1;
      pointer-events:none;

      background:
        radial-gradient(1100px 700px at 70% 15%, rgba(255,255,255,.22), transparent 62%),
        radial-gradient(900px 600px at 20% 25%, rgba(27,102,255,.14), transparent 62%),
        radial-gradient(900px 600px at 85% 35%, rgba(0,183,168,.10), transparent 62%),
        linear-gradient(180deg, rgba(7,24,61,.55), rgba(255,255,255,.10) 55%, rgba(255,255,255,.20));
    }

    .shell{
      max-width: 1900px;
      margin: 0 auto;
      padding: 22px 18px 0;
      position:relative;
      z-index:2; /* above background layers */
      min-height: 100vh;
    }

    .frame{
      background: rgba(255,255,255,.78);
      border: 1px solid var(--borderSoft);
      border-bottom: none;
      border-radius: calc(var(--radius) + 10px) calc(var(--radius) + 10px) 0 0;
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      padding: 12px;
      padding-bottom: 0;
      min-height: calc(100vh - 22px);
    }

    .topbar{
      background: linear-gradient(90deg, var(--nav), var(--nav2));
      border-radius: 18px;
      padding: 14px 14px;
      color:#fff;
      box-shadow: var(--softShadow);
      position:sticky;
      top:14px;
      z-index:10;
      border: 1px solid rgba(255,255,255,.10);
    }

    .topbar-row{
      display:grid;
      grid-template-columns: 1.7fr 1fr auto;
      gap:12px;
      align-items:center;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      letter-spacing:.2px;
      white-space:nowrap;
    }
    .logo{
      width:34px;height:34px;
      border-radius:10px;
      background:
        radial-gradient(circle at 30% 30%, #ffffff, rgba(255,255,255,.0) 55%),
        linear-gradient(135deg, rgba(27,102,255,1), rgba(0,183,168,1));
      box-shadow: 0 6px 18px rgba(0,0,0,.18);
      position:relative;
    }
    .logo:after{
      content:"";
      position:absolute; inset:9px 8px 9px 8px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,.55);
    }

    .pill{
      display:flex;
      align-items:center;
      gap:10px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 999px;
      padding: 14px 18px;
      backdrop-filter: blur(10px);
    }
    .pill input, .pill select{
      width:100%;
      background: transparent;
      border:none;
      outline:none;
      color:#fff;
      font-size: 15px;
    }
    .pill select option{color:#111}
    .pill .icon{width:18px;height:18px;opacity:.9;flex:0 0 auto}

    .btn{
      background: linear-gradient(135deg, #ffffff, #dbe8ff);
      color: #0b2a6f;
      border:none;
      border-radius: 999px;
      padding: 11px 14px;
      font-weight:800;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:10px;
      box-shadow: 0 10px 18px rgba(0,0,0,.18);
      transition: transform .12s ease, filter .12s ease;
      white-space:nowrap;
    }
    .btn:hover{transform: translateY(-1px); filter: brightness(1.02);}
    .btn:active{transform: translateY(0); filter: brightness(.98);}

    .meta{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:10px;
      font-size:13px;
      opacity:.92;
      white-space:nowrap;
    }

    .grid{
      display:grid;
      grid-template-columns: 300px 1fr;
      gap:16px;
      margin-top:14px;
      align-items:start;
    }

    .panel{
      background: rgba(255,255,255,.86);
      border: 1px solid var(--borderSoft);
      border-radius: var(--radius);
      box-shadow: var(--softShadow);
      overflow:hidden;
      position:relative;
    }
    .panel::before{
      content:"";
      position:absolute; inset:0;
      border-radius: inherit;
      box-shadow: inset 0 0 0 1px var(--innerStroke);
      pointer-events:none;
    }

    .filters{ padding:20px; }
    #filtersPanel{ position:sticky; top:20px; align-self:start; max-height:calc(100vh - 40px); overflow-y:auto; }

    /* Profile Summary Card */
    .profile-summary {
      background: #0a192f;
      color: white;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 24px;
    }
    .profile-label {
      font-size: 11px;
      opacity: 0.7;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .profile-val {
      font-size: 14px;
      font-weight: 700;
      margin: 4px 0 12px 0;
      display: block;
    }
    .profile-summary .eligible-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .profile-summary .eligible-toggle label {
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
    }
    .profile-summary input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }
    .profile-summary .edit-profile-btn {
      background: rgba(255,255,255,0.15);
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
      margin-top: 10px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .profile-summary .edit-profile-btn:hover {
      background: rgba(255,255,255,0.25);
    }

    /* Profile Editor Modal */
    .profile-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.6);
      z-index: 10000;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(4px);
    }
    .profile-modal-overlay.active {
      display: flex;
    }
    .profile-modal {
      background: white;
      border-radius: 16px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .profile-modal-header {
      background: #0a192f;
      color: white;
      padding: 20px 24px;
      border-radius: 16px 16px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .profile-modal-header h2 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
    }
    .profile-modal-close {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.2s;
    }
    .profile-modal-close:hover {
      opacity: 1;
    }
    .profile-modal-body {
      padding: 24px;
    }
    .profile-form-section {
      margin-bottom: 24px;
    }
    .profile-form-section h3 {
      font-size: 13px;
      font-weight: 700;
      color: #0a192f;
      margin: 0 0 12px 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .profile-form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }
    .profile-form-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .profile-form-group.full-width {
      grid-column: span 2;
    }
    .profile-form-group label {
      font-size: 11px;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
    }
    .profile-form-group input,
    .profile-form-group select {
      padding: 10px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s;
    }
    .profile-form-group input:focus,
    .profile-form-group select:focus {
      outline: none;
      border-color: #1e3a5f;
    }
    .type-ratings-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .type-rating-chip {
      display: flex;
      align-items: center;
      gap: 6px;
      background: #e8f4fd;
      color: #1e3a5f;
      padding: 6px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    .type-rating-chip .remove-rating {
      background: none;
      border: none;
      color: #1e3a5f;
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
      opacity: 0.6;
    }
    .type-rating-chip .remove-rating:hover {
      opacity: 1;
    }
    .add-type-rating {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    .add-type-rating input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 13px;
    }
    .add-type-rating button {
      padding: 8px 16px;
      background: #1e3a5f;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      cursor: pointer;
    }
    .work-rights-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }
    .work-rights-grid label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #334155;
      cursor: pointer;
    }
    .work-rights-grid input[type="checkbox"] {
      width: 16px;
      height: 16px;
    }
    .profile-modal-footer {
      padding: 16px 24px;
      border-top: 1px solid #e2e8f0;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
    .profile-modal-footer button {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .profile-cancel-btn {
      background: #f1f5f9;
      border: none;
      color: #64748b;
    }
    .profile-cancel-btn:hover {
      background: #e2e8f0;
    }
    .profile-save-btn {
      background: #1e3a5f;
      border: none;
      color: white;
    }
    .profile-save-btn:hover {
      background: #2d4a6f;
    }
    .profile-save-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Section Titles */
    .section-title {
      font-size: 13px;
      font-weight: 800;
      color: #0a192f;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .section-title span {
      font-weight: 500;
      color: #64748b;
      font-size: 12px;
    }

    /* Filter Tiles */
    .tile-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 20px;
    }
    .filter-tile {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 13px;
      font-weight: 600;
      color: #334155;
    }
    .filter-tile:hover {
      border-color: #3b82f6;
      color: #3b82f6;
    }
    .filter-tile.active {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
      box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
    }

    /* Range Slider */
    .range-section {
      margin: 20px 0;
    }
    .range-slider {
      width: 100%;
      margin: 10px 0;
      cursor: pointer;
      -webkit-appearance: none;
      height: 6px;
      background: #e2e8f0;
      border-radius: 3px;
      outline: none;
    }
    .range-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      background: white;
      border: 3px solid #3b82f6;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    .range-slider::-moz-range-thumb {
      width: 18px;
      height: 18px;
      background: white;
      border: 3px solid #3b82f6;
      border-radius: 50%;
      cursor: pointer;
    }
    .range-labels {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #64748b;
    }

    /* Result Bar */
    .result-bar {
      margin-top: 20px;
      background: #3b82f6;
      color: white;
      padding: 14px;
      border-radius: 10px;
      text-align: center;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      transition: background 0.15s ease;
      border: none;
      width: 100%;
    }
    .result-bar:hover {
      background: #2563eb;
    }
    .result-count {
      background: rgba(255,255,255,0.2);
      padding: 3px 10px;
      border-radius: 4px;
      font-size: 12px;
    }

    /* Job Type Toggle (Pilot/Cabin Crew) */
    .job-type-toggle {
      display: flex;
      background: #e8eef7;
      border-radius: 12px;
      padding: 4px;
      margin-bottom: 16px;
    }
    .job-type-btn {
      flex: 1;
      padding: 12px 16px;
      border: none;
      background: transparent;
      border-radius: 9px;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      color: #6b7890;
    }
    .job-type-btn.active {
      background: linear-gradient(135deg, var(--nav), var(--nav2));
      color: #fff;
      box-shadow: 0 4px 12px rgba(11, 42, 111, 0.25);
    }
    .job-type-btn:hover:not(.active) {
      background: rgba(11, 42, 111, 0.08);
    }

    /* Clear Filters Button */
    .clear-btn {
      width: 100%;
      background: transparent;
      border: 1px dashed #6b7890;
      color: #6b7890;
      padding: 12px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.15s ease;
      margin-top: 10px;
    }
    .clear-btn:hover {
      background: #f1f5f9;
      border-color: #3b82f6;
      color: #3b82f6;
    }

    /* Eligibility Delta Slider */
    .delta-section {
      background: #fef9e7;
      border: 1px solid #f9e79f;
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 20px;
      position: relative;
    }

    /* Premium Lock Overlay */
    .premium-lock {
      position: absolute;
      inset: 0;
      background: rgba(254, 249, 231, 0.85);
      backdrop-filter: blur(3px);
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      z-index: 5;
    }
    .premium-lock.hidden {
      display: none;
    }
    .premium-lock-icon {
      font-size: 20px;
    }
    .premium-lock-text {
      font-size: 12px;
      font-weight: 700;
      color: #7d6608;
    }
    .premium-unlock-btn {
      background: linear-gradient(135deg, #f4d03f, #e9b32a);
      color: #5a4a00;
      border: none;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .premium-unlock-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(244, 208, 63, 0.4);
    }

    /* Premium badge styling */
    .premium-badge {
      background: linear-gradient(135deg, #f4d03f, #e9b32a);
      color: #5a4a00;
      font-size: 9px;
      font-weight: 800;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 6px;
      text-transform: uppercase;
    }

    /* Sort by Salary Button */
    .sort-salary-section {
      margin: 16px 0;
    }
    .sort-salary-btn {
      width: 100%;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .sort-salary-btn.unlocked {
      background: linear-gradient(135deg, #f4d03f, #e9b32a);
      border: 1px solid #d4a82a;
      color: #5a4a00;
    }
    .sort-salary-btn.unlocked:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(244, 208, 63, 0.4);
    }
    .sort-salary-btn.unlocked.active {
      background: linear-gradient(135deg, #e9b32a, #d4a000);
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1), 0 4px 12px rgba(244, 208, 63, 0.4);
    }
    .sort-salary-btn.locked {
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
      color: #94a3b8;
      cursor: not-allowed;
      position: relative;
    }
    .sort-salary-btn .lock-icon {
      font-size: 14px;
    }
    .sort-salary-btn .premium-tag {
      font-size: 9px;
      background: linear-gradient(135deg, #f4d03f, #e9b32a);
      color: #5a4a00;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 800;
      text-transform: uppercase;
    }

    /* Salary Notice Modal */
    .salary-notice-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
    }
    .salary-notice-overlay.visible {
      opacity: 1;
      visibility: visible;
    }
    .salary-notice-modal {
      background: white;
      border-radius: 12px;
      padding: 24px;
      max-width: 400px;
      margin: 20px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.3);
      transform: scale(0.9);
      transition: transform 0.2s ease;
    }
    .salary-notice-overlay.visible .salary-notice-modal {
      transform: scale(1);
    }
    .salary-notice-modal h3 {
      margin: 0 0 12px 0;
      font-size: 16px;
      color: #1e293b;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .salary-notice-modal p {
      margin: 0 0 20px 0;
      font-size: 14px;
      color: #64748b;
      line-height: 1.5;
    }
    .salary-notice-modal .btn-row {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    .salary-notice-modal .btn-cancel {
      padding: 8px 16px;
      border: 1px solid #e2e8f0;
      background: white;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      color: #64748b;
    }
    .salary-notice-modal .btn-confirm {
      padding: 8px 16px;
      border: none;
      background: linear-gradient(135deg, #f4d03f, #e9b32a);
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      color: #5a4a00;
    }
    .salary-notice-modal .btn-confirm:hover {
      box-shadow: 0 4px 12px rgba(244, 208, 63, 0.4);
    }

    .delta-section .section-title {
      margin-bottom: 8px;
      color: #7d6608;
    }
    .delta-section .section-title span {
      color: #b7950b;
      font-weight: 700;
    }
    .delta-slider {
      width: 100%;
      margin: 8px 0;
      cursor: pointer;
      -webkit-appearance: none;
      height: 6px;
      background: linear-gradient(90deg, #f9e79f 0%, #f4d03f 100%);
      border-radius: 3px;
      outline: none;
    }
    .delta-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      background: white;
      border: 3px solid #f4d03f;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    .delta-slider::-moz-range-thumb {
      width: 18px;
      height: 18px;
      background: white;
      border: 3px solid #f4d03f;
      border-radius: 50%;
      cursor: pointer;
    }
    .delta-labels {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: #7d6608;
    }

    /* Eligibility Badges */
    .eligibility-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
    }
    .eligibility-badge.eligible {
      background: #d4edda;
      color: #155724;
    }
    .eligibility-badge.within-reach {
      background: #fff3cd;
      color: #856404;
    }
    .eligibility-badge.not-eligible {
      background: #f8d7da;
      color: #721c24;
    }

    /* Eligibility badge with tooltip */
    .eligibility-wrapper {
      position: relative;
      display: inline-block;
    }
    .eligibility-badge.clickable {
      cursor: pointer;
      transition: transform 0.1s ease;
    }
    .eligibility-badge.clickable:hover {
      transform: scale(1.05);
    }

    /* Breakdown Tooltip */
    .eligibility-tooltip {
      position: absolute;
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      background: #1e293b;
      color: white;
      padding: 12px 14px;
      border-radius: 10px;
      font-size: 12px;
      min-width: 220px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.25);
      z-index: 100;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s ease, visibility 0.2s ease;
    }
    .eligibility-wrapper:hover .eligibility-tooltip,
    .eligibility-tooltip.visible {
      opacity: 1;
      visibility: visible;
    }
    .eligibility-tooltip::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: #1e293b;
    }
    .tooltip-title {
      font-weight: 700;
      font-size: 13px;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(255,255,255,0.15);
    }
    .tooltip-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 6px 0;
    }
    .tooltip-label {
      color: #94a3b8;
    }
    .tooltip-value {
      font-weight: 600;
    }
    .tooltip-value.met {
      color: #4ade80;
    }
    .tooltip-value.short {
      color: #fbbf24;
    }
    .tooltip-value.missing {
      color: #f87171;
    }
    .tooltip-gap {
      font-size: 10px;
      opacity: 0.7;
      margin-left: 6px;
    }

    .results-head{ padding:14px 14px 0; }

    .banner{
      height:150px;
      border-radius: 18px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.30);
      box-shadow: 0 12px 26px rgba(13,36,90,.10);
      background:
        linear-gradient(90deg, rgba(11,42,111,.82), rgba(11,42,111,.22)),
        radial-gradient(900px 260px at 80% 50%, rgba(255,255,255,.25), transparent 65%),
        linear-gradient(180deg, #6fb1ff, #d4f0ff 55%, rgba(255,255,255,.85));
      display:flex;
      align-items:flex-end;
      padding:16px;
      color:#fff;
    }
    .banner .tag{
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.22);
      border-radius:999px;
      padding:7px 10px;
      font-weight:800;
      font-size:12px;
      letter-spacing:.3px;
      width:max-content;
    }
    .banner h2{ margin:8px 0 0; font-size:18px; line-height:1.2; }
    .banner p{ margin:6px 0 0; opacity:.9; font-size:13px; max-width: 74ch; }

    .cards{ padding:10px; display:grid; gap:8px; }

    /* Load More Section */
    .load-more-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px 0;
      border-top: 1px solid #e2e8f0;
      margin: 20px 14px 0;
    }

    .load-more-btn {
      background: #ffffff;
      color: #0f172a;
      border: 1.5px solid #0f172a;
      padding: 12px 30px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      font-size: 0.85rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      transition: 0.2s;
      border-radius: 4px;
    }

    .load-more-btn:hover {
      background: #0f172a;
      color: #ffffff;
    }

    .load-more-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .results-count {
      font-size: 0.75rem;
      color: #64748b;
      margin-top: 12px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .alert-signup {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px dashed #e2e8f0;
      text-align: center;
    }

    .alert-btn {
      background: linear-gradient(135deg, #0b2a6f, #081a45);
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 0.8rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
      border-radius: 4px;
      transition: 0.2s;
    }

    .alert-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(11, 42, 111, 0.3);
    }

    .alert-text {
      font-size: 0.7rem;
      color: #94a3b8;
      margin-top: 8px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .card {
      background: white;
      border-radius: 14px;
      border: 1px solid #e2e8f0;
      padding: 16px 20px;
      display: grid;
      grid-template-columns: 110px 1fr 150px;
      grid-template-rows: auto auto auto;
      gap: 6px 14px;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.08);
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }
    .card.visa-sponsor {
      background: #f1f8e9;
      border-color: #a5d6a7;
    }

    .company-logo {
      grid-row: 1 / span 2;
      width: 98px;
      height: 98px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 24px;
      color: #0b2a6f;
    }
    .company-logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .job-title {
      font-size: 16px;
      font-weight: 700;
      margin: 0;
      color: #1e293b;
      align-self: center;
    }

    .airline-name {
      margin-left: 12px;
      font-size: 12px;
      font-weight: 500;
      color: #475569;
      letter-spacing: 0.3px;
      background: rgba(71, 85, 105, 0.06);
      padding: 2px 8px;
      border-radius: 4px;
      border: 1px solid rgba(71, 85, 105, 0.15);
    }

    .attributes {
      display: flex;
      gap: 10px;
      color: #64748b;
      font-size: 12px;
      flex-wrap: wrap;
      align-items: center;
    }
    .attr-item b {
      color: #334155;
    }
    .attr-pill {
      background: #e3f2fd;
      color: #1565c0;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }
    .attr-pill.green {
      background: white;
      color: #2e7d32;
      border: 1.5px solid #4caf50;
    }

    .apply-container {
      text-align: right;
      grid-column: 3;
      grid-row: 1;
      align-self: center;
    }
    .apply-btn {
      background: #0b2a6f;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 600;
      font-size: 13px;
      display: inline-block;
      transition: background 0.15s ease;
    }
    .apply-btn:hover {
      background: #081a45;
    }

    .stats-row {
      grid-column: 2;
      display: flex;
      gap: 24px;
      margin-top: 4px;
      padding-top: 8px;
      border-top: 1px dashed #e2e8f0;
    }
    .stat-box {
      display: flex;
      flex-direction: column;
    }
    .stat-label {
      font-size: 10px;
      text-transform: uppercase;
      color: #94a3b8;
      font-weight: 700;
    }
    .stat-value {
      font-size: 15px;
      font-weight: 700;
      color: #0f172a;
    }

    .expand-link {
      grid-column: 3;
      grid-row: 3;
      text-align: right;
      color: #64748b;
      font-size: 12px;
      text-decoration: none;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 6px;
      align-self: end;
      cursor: pointer;
    }
    .expand-link:hover {
      color: #334155;
      text-decoration: underline;
    }
    .arrow-v {
      width: 8px;
      height: 8px;
      border-right: 2px solid currentColor;
      border-bottom: 2px solid currentColor;
      transform: rotate(45deg);
      margin-bottom: 4px;
      transition: transform 0.2s ease;
    }
    .expand-link.expanded .arrow-v {
      transform: rotate(-135deg);
      margin-bottom: 0;
      margin-top: 4px;
    }

    /* Expandable job description section */
    .job-description {
      grid-column: 1 / -1;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease, padding 0.3s ease;
      background: #f8fafc;
      border-radius: 10px;
      margin-top: 0;
    }
    .job-description.expanded {
      max-height: 400px;
      overflow-y: auto;
      padding: 16px 20px;
      margin-top: 12px;
      border: 1px solid #e2e8f0;
    }
    .job-description-content {
      font-size: 14px;
      line-height: 1.6;
      color: #000000;
    }
    .job-description-content:empty::before {
      content: "No description available for this position.";
      color: #94a3b8;
      font-style: italic;
    }

    /* Requirements list styling */
    .requirements-list {
      list-style: none;
      padding: 0;
      margin: 8px 0 0 0;
    }
    .requirements-list li {
      position: relative;
      padding-left: 16px;
      margin-bottom: 6px;
      font-size: 13px;
      line-height: 1.5;
      color: #1e293b;
    }
    .requirements-list li::before {
      content: "•";
      position: absolute;
      left: 0;
      color: #0b2a6f;
      font-weight: bold;
    }
    .requirements-title {
      font-weight: 600;
      color: #475569;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 12px;
      margin-bottom: 4px;
    }

    .save-btn {
      position: absolute;
      top: 0;
      right: 0;
      background: #f5f5f5;
      border: none;
      cursor: pointer;
      padding: 8px 10px;
      border-radius: 0 16px 0 12px;
      transition: background 0.15s ease;
    }
    .save-btn:hover {
      background: #e0e0e0;
    }
    .save-btn svg {
      width: 18px;
      height: 18px;
      fill: none;
      stroke: #666;
      stroke-width: 2;
    }
    .save-btn:hover svg {
      stroke: #333;
    }

    .mobile-toggle{ display:none; margin-top:12px; width:100%; }

    /* Tablet breakpoint */
    @media (max-width: 980px){
      .topbar-row{ grid-template-columns: 1fr; }
      .meta{ justify-content: flex-start; }
      .grid{ grid-template-columns: 1fr; }
      .mobile-toggle{ display: block; }
      .card{ grid-template-columns: 52px 1fr; }
      .stats{ display: none; }
      .stage::before, .stage::after{ position: absolute; }
      #filtersPanel { display: none; }
    }

    /* Mobile Styles */
    @media (max-width: 768px) {
      html, body {
        overflow-x: hidden;
        overflow-y: auto;
        height: auto;
      }

      /* Hide fixed logo on mobile */
      a[href="index.html"][style*="position:fixed"] {
        display: none !important;
      }

      .stage { min-height: auto; }
      .stage::before { display: none; }
      .stage::after { display: none; }

      .shell {
        padding: 0;
        background: #f8fafc;
      }

      .frame {
        padding: 0;
        border-radius: 0;
        min-height: auto;
        background: #f8fafc;
        border: none;
        box-shadow: none;
      }

      /* Top bar / Header - Clean compact design */
      .topbar {
        padding: 12px 16px;
        border-radius: 0;
        position: sticky;
        top: 0;
        margin: 0;
        background: var(--nav);
      }

      .topbar-row {
        gap: 8px;
        display: grid;
        grid-template-columns: 1fr auto;
        align-items: center;
      }

      .pill {
        padding: 10px 14px;
        border-radius: 8px;
        background: rgba(255,255,255,0.15);
        border: none;
      }
      .pill input, .pill select {
        font-size: 15px;
      }
      .pill .icon { width: 16px; height: 16px; }

      /* Hide location dropdown on mobile */
      .pill:has(select) { display: none; }

      .btn {
        padding: 10px 16px;
        font-size: 13px;
        border-radius: 8px;
        white-space: nowrap;
      }
      .btn .icon { display: none; }

      .meta {
        grid-column: 1 / -1;
        font-size: 11px;
        justify-content: center;
        margin-top: 6px;
        text-align: center;
        opacity: 0.8;
      }

      .mobile-toggle {
        grid-column: 1 / -1;
        margin-top: 8px;
        border-radius: 8px;
        padding: 10px 16px;
        font-size: 13px;
      }

      /* Filter panel - fullscreen overlay with close button */
      #filtersPanel {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1000;
        border-radius: 0;
        max-height: 100vh;
        overflow-y: auto;
        background: white;
      }

      #filtersPanel.show { display: block; }

      .filters {
        padding: 20px;
        padding-top: 70px;
        padding-bottom: 100px;
      }

      /* Close button for filters - actual clickable button */
      .close-filters-btn {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        padding: 18px 20px;
        background: var(--nav);
        color: white;
        font-weight: 700;
        font-size: 15px;
        z-index: 1001;
        border: none;
        cursor: pointer;
        text-align: left;
        display: none;
        font-family: inherit;
      }
      .close-filters-btn:active {
        background: var(--nav2);
      }
      #filtersPanel.show .close-filters-btn {
        display: block;
      }

      .profile-summary {
        padding: 16px;
        margin-bottom: 20px;
        border-radius: 10px;
      }

      .tile-group {
        gap: 8px;
        margin-bottom: 20px;
      }
      .filter-tile {
        padding: 12px 8px;
        font-size: 12px;
        border-radius: 8px;
      }

      .section-title {
        font-size: 13px;
        margin-bottom: 10px;
        margin-top: 16px;
      }
      .section-title:first-of-type { margin-top: 0; }

      .delta-section {
        padding: 14px;
        margin-bottom: 16px;
        border-radius: 10px;
      }

      .result-bar {
        border-radius: 8px;
        padding: 14px;
        margin-top: 20px;
      }

      .clear-btn {
        border-radius: 8px;
        padding: 12px;
      }

      /* Lock body scroll when filters open */
      body.filters-open {
        overflow: hidden;
        position: fixed;
        width: 100%;
      }

      /* Main content area */
      .grid { margin-top: 0; }

      .panel {
        border-radius: 0;
        border: none;
        box-shadow: none;
        background: transparent;
      }
      .panel::before { display: none; }

      /* Job Cards - Apply button top right */
      .cards {
        padding: 12px;
        gap: 10px;
        background: #f8fafc;
      }

      .card {
        display: block;
        position: relative;
        padding: 14px;
        padding-top: 16px;
        border-radius: 10px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
      }

      .company-logo {
        width: 83px;
        height: 83px;
        font-size: 20px;
        float: left;
        margin-right: 14px;
        margin-bottom: 10px;
      }

      .job-title {
        font-size: 14px;
        line-height: 1.3;
        margin-bottom: 2px;
        padding-right: 100px;
      }

      .airline-name {
        display: block;
        margin-left: 0;
        margin-top: 4px;
        margin-bottom: 6px;
        font-size: 12px;
        background: none;
        border: none;
        padding: 0;
        color: #64748b;
      }
      .airline-name::before {
        content: none;
      }

      /* Apply button - top right corner */
      .apply-container {
        position: absolute;
        top: 14px;
        right: 14px;
        text-align: right;
        margin: 0;
      }

      .apply-btn {
        padding: 8px 14px;
        font-size: 11px;
        border-radius: 6px;
        display: inline-block;
      }

      .attributes {
        clear: both;
        flex-wrap: wrap;
        gap: 5px;
        font-size: 11px;
        margin-top: 10px;
        display: flex;
      }

      .attr-item {
        font-size: 11px;
      }
      .attr-item b { display: none; }

      .attr-pill {
        font-size: 10px;
        padding: 3px 7px;
        border-radius: 4px;
      }

      .stats-row {
        display: flex;
        gap: 16px;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #eee;
      }

      .stat-label { font-size: 9px; }
      .stat-value { font-size: 13px; }

      .expand-link {
        display: flex;
        margin-top: 10px;
        font-size: 12px;
      }

      .save-btn {
        display: none;
      }

      /* Load more section */
      .load-more-container {
        padding: 24px 16px;
        margin: 0;
        background: #f8fafc;
        border-top: none;
      }
      .load-more-btn {
        padding: 12px 20px;
        font-size: 0.75rem;
        border-radius: 6px;
      }
      .results-count {
        font-size: 0.65rem;
        margin-top: 10px;
      }

      /* Banner */
      .banner {
        display: none;
      }

      /* Eligibility badges */
      .eligibility-badge {
        font-size: 9px;
        padding: 2px 6px;
      }
      .eligibility-tooltip {
        display: none;
      }
    }

    /* Small phones */
    @media (max-width: 380px) {
      .topbar { padding: 10px 12px; }

      .pill { padding: 8px 12px; }
      .pill input, .pill select { font-size: 14px; }

      .cards { padding: 10px; gap: 8px; }

      .card { padding: 12px; }
      .job-title { font-size: 13px; padding-right: 90px; }
      .airline-name {
        display: block;
        font-size: 11px;
        margin-left: 0;
        margin-top: 3px;
        background: none;
        border: none;
        padding: 0;
      }
      .airline-name::before { content: none; }

      .company-logo { width: 70px; height: 70px; }

      .apply-btn { padding: 6px 10px; font-size: 10px; }

      .attr-pill { font-size: 9px; padding: 2px 5px; }

      .stats-row { gap: 12px; }
      .stat-value { font-size: 12px; }

      .expand-link { font-size: 11px; }
    }

    .svg{display:block}

    /* Map Search Button */
    .map-search-btn {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 14px 16px;
      background: linear-gradient(135deg, #1b66ff 0%, #00b7a8 100%);
      border: none;
      border-radius: 12px;
      color: #fff;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 16px;
      box-shadow: 0 4px 14px rgba(27, 102, 255, 0.25);
    }
    .map-search-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(27, 102, 255, 0.35);
    }
    .map-search-btn:active {
      transform: translateY(0);
    }
    .map-search-btn svg {
      flex-shrink: 0;
    }

    /* Map Overlay */
    .map-overlay {
      position: fixed;
      inset: 0;
      background: rgba(7, 24, 61, 0.85);
      backdrop-filter: blur(8px);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    .map-overlay.visible {
      opacity: 1;
      visibility: visible;
    }
    .map-container {
      width: 94%;
      height: 90%;
      max-width: 1600px;
      background: #fff;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 30px 80px rgba(0, 0, 0, 0.4);
      display: flex;
      flex-direction: column;
      transform: scale(0.95);
      transition: transform 0.3s ease;
    }
    .map-overlay.visible .map-container {
      transform: scale(1);
    }
    .map-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      background: linear-gradient(90deg, var(--nav), var(--nav2));
      color: #fff;
    }
    .map-header h2 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .map-close-btn {
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.25);
      color: #fff;
      width: 36px;
      height: 36px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .map-close-btn:hover {
      background: rgba(255, 255, 255, 0.25);
    }
    .map-content {
      flex: 1;
      position: relative;
    }
    #mapbox-map {
      width: 100%;
      height: 100%;
    }
    .map-loading {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #f8fafc;
      gap: 12px;
    }
    .map-loading.hidden {
      display: none;
    }
    .map-loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #e2e8f0;
      border-top-color: #1b66ff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .map-loading-text {
      font-size: 14px;
      color: var(--muted);
    }
    .map-stats {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(255, 255, 255, 0.95);
      padding: 12px 16px;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      font-size: 13px;
      z-index: 10;
    }
    .map-stats strong {
      color: var(--accent);
    }

    /* Mapbox popup customization */
    .mapboxgl-popup-content {
      padding: 0;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      min-width: 260px;
    }
    .mapboxgl-popup-close-button {
      font-size: 20px;
      padding: 8px 12px;
      color: #fff;
      z-index: 10;
    }
    .mapboxgl-popup-close-button:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    .job-popup {
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    .job-popup-header {
      background: linear-gradient(135deg, var(--nav), var(--nav2));
      color: #fff;
      padding: 14px 16px;
    }
    .job-popup-location {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .job-popup-count {
      font-size: 12px;
      opacity: 0.85;
    }
    .job-popup-body {
      padding: 12px 16px;
      max-height: 200px;
      overflow-y: auto;
    }
    .job-popup-item {
      padding: 10px 0;
      border-bottom: 1px solid #f1f5f9;
    }
    .job-popup-item:last-child {
      border-bottom: none;
    }
    .job-popup-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 2px;
    }
    .job-popup-airline {
      font-size: 11px;
      color: var(--muted);
    }
    .job-popup-footer {
      padding: 12px 16px;
      background: #f8fafc;
      border-top: 1px solid #e2e8f0;
    }
    .job-popup-view-btn {
      width: 100%;
      padding: 10px 16px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .job-popup-view-btn:hover {
      background: #0052cc;
    }

    /* Cluster markers */
    .cluster-marker {
      background: linear-gradient(135deg, #1b66ff, #00b7a8);
      color: #fff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      box-shadow: 0 4px 14px rgba(27, 102, 255, 0.4);
      border: 3px solid #fff;
    }

    /* Map Job Preview Panel */
    .map-job-preview {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.98);
      border-top: 1px solid #e2e8f0;
      padding: 12px 16px;
      transform: translateY(100%);
      transition: transform 0.3s ease;
      z-index: 20;
      box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.15);
    }
    .map-job-preview.visible {
      transform: translateY(0);
    }
    .map-job-preview-close {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #f1f5f9;
      border: none;
      width: 28px;
      height: 28px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 5;
    }
    .map-job-preview-close:hover {
      background: #e2e8f0;
    }
    .map-job-preview .card {
      box-shadow: none;
      border: none;
      background: transparent;
      margin: 0;
      padding: 8px 0;
    }
    .map-job-preview .save-btn {
      display: none;
    }
  </style>
</head>

<body>
  <div class="stage">
    <!-- Logo positioned on the background -->
    <a href="index.html" style="position:fixed;top:28px;left:28px;z-index:100;text-decoration:none;color:white;font-size:1.5rem;font-weight:800;letter-spacing:0.5px;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;">AEROSCOUT</a>

    <div class="shell">
      <div class="frame">
        <header class="topbar">
          <div class="topbar-row">
            <div class="pill">
              <svg class="icon svg" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M21 21l-4.2-4.2m1.7-5.3a7 7 0 11-14 0 7 7 0 0114 0z" stroke="white" stroke-width="2" stroke-linecap="round"/>
              </svg>
              <input id="q" placeholder="Search position, operator, aircraft…" />
            </div>

            <div class="pill">
              <svg class="icon svg" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M12 21s7-4.6 7-11a7 7 0 10-14 0c0 6.4 7 11 7 11z" stroke="white" stroke-width="2" stroke-linecap="round"/>
                <path d="M12 11.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z" stroke="white" stroke-width="2"/>
              </svg>
              <select id="loc">
                <option value="">Any location</option>
                <option>United States</option>
                <option>Europe</option>
                <option>Middle East</option>
                <option>Asia</option>
                <option>Oceania</option>
              </select>
            </div>

            <button class="btn" id="searchBtn" type="button">
              <svg class="icon svg" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M10 18a8 8 0 100-16 8 8 0 000 16z" stroke="#0b2a6f" stroke-width="2"/>
                <path d="M21 21l-4.35-4.35" stroke="#0b2a6f" stroke-width="2" stroke-linecap="round"/>
              </svg>
              Search
            </button>

            <div class="meta" style="grid-column: 1 / -1;">
              <span id="count" style="font-size:15px;font-weight:700;"><span id="jobTypeLabel">Active pilot jobs</span> as of <span id="gmtTime"></span>: <span id="jobCount">0</span></span>
            </div>
          </div>

          <button class="btn mobile-toggle" id="toggleFilters" type="button">Toggle Filters</button>
        </header>

        <main class="grid">
          <aside class="panel" id="filtersPanel">
            <div class="filters">
              <!-- Job Type Toggle (Pilot/Cabin Crew) -->
              <div class="job-type-toggle">
                <button class="job-type-btn active" id="pilotBtn" data-type="pilot">Pilot Jobs</button>
                <button class="job-type-btn" id="cabinCrewBtn" data-type="cabin_crew">Cabin Crew</button>
              </div>

              <!-- Search by Map Button -->
              <button class="map-search-btn" id="openMapBtn" type="button">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon>
                  <line x1="8" y1="2" x2="8" y2="18"></line>
                  <line x1="16" y1="6" x2="16" y2="22"></line>
                </svg>
                Search by Map
              </button>

              <!-- Profile Summary Card -->
              <div class="profile-summary">
                <span class="profile-label">Your Experience</span>
                <span class="profile-val" id="profileDisplay">1,200h Total · CPL · A320</span>
                <div class="eligible-toggle">
                  <input type="checkbox" id="eligibleOnly">
                  <label for="eligibleOnly">Show eligible only</label>
                </div>
                <button class="edit-profile-btn" id="editProfileBtn">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                  </svg>
                  Edit Profile
                </button>
              </div>

              <!-- Eligibility Delta Slider (Premium Feature) -->
              <div class="delta-section" id="deltaSection">
                <div class="premium-lock" id="premiumLock">
                  <span class="premium-lock-icon">🔒</span>
                  <span class="premium-lock-text">Premium Feature</span>
                  <button class="premium-unlock-btn" id="unlockBtn">Upgrade to Pro</button>
                </div>
                <div class="delta-content" id="deltaContent">
                  <div class="section-title">Jobs within reach <span class="premium-badge">Pro</span> <span id="deltaLabel" style="margin-left:auto;">≤ 3,000 hrs away</span></div>
                  <input type="range" class="delta-slider" id="deltaSlider" min="0" max="3000" step="100" value="3000">
                  <div class="delta-labels">
                    <span>Eligible now</span>
                    <span>3,000 hrs away</span>
                  </div>
                  <!-- Include blockers toggle -->
                  <div class="blocker-toggle" style="margin-top:12px; padding-top:10px; border-top:1px dashed #f9e79f;">
                    <label style="display:flex; align-items:center; gap:8px; font-size:11px; color:#7d6608; cursor:pointer;">
                      <input type="checkbox" id="includeBlockers" style="width:14px; height:14px;">
                      <span>Include jobs with blockers</span>
                    </label>
                    <div style="font-size:10px; color:#b7950b; margin-top:4px; margin-left:22px;">Show type ratings & licenses I don't have</div>
                  </div>
                  <!-- Turn off button -->
                  <button type="button" id="turnOffDeltaBtn" style="width:100%; margin-top:12px; padding:8px 12px; background:#f5ecd3; border:1px solid #d4c896; border-radius:6px; color:#7d6608; font-size:12px; cursor:pointer; transition:all 0.2s;">Turn off Eligibility</button>
                </div>
                <!-- Disabled state message -->
                <div class="delta-disabled" id="deltaDisabled" style="display:none; text-align:center; padding:10px;">
                  <div style="font-size:12px; color:#7d6608; margin-bottom:8px;">Eligibility filter is off</div>
                  <button type="button" id="turnOnDeltaBtn" style="padding:6px 16px; background:#1e3a5f; border:none; border-radius:6px; color:white; font-size:12px; cursor:pointer;">Turn on</button>
                </div>
              </div>

              <!-- Type Preference (Pilot only) -->
              <div class="section-title pilot-filter" id="typePrefTitle">Type Preference</div>
              <div class="tile-group pilot-filter" id="typePrefGroup">
                <div class="filter-tile" data-filter="ntr" id="ntrTile">NTR</div>
                <div class="filter-tile" data-filter="typed" id="typedTile">Type-Rated</div>
              </div>

              <!-- License (Pilot only) -->
              <div class="section-title pilot-filter" id="licenseTitle">License</div>
              <div class="tile-group pilot-filter" id="licenseGroup">
                <div class="filter-tile" data-filter="atpl" id="atplTile">ATPL</div>
                <div class="filter-tile" data-filter="cpl" id="cplTile">CPL</div>
                <div class="filter-tile" data-filter="fatpl" id="fatplTile">fATPL</div>
              </div>

              <!-- Operator Type -->
              <div class="section-title">Operator Type</div>
              <div class="tile-group">
                <div class="filter-tile" data-filter="op-airline" id="opAirlineTile">Airline</div>
                <div class="filter-tile" data-filter="op-bizav" id="opBizavTile">BizAv</div>
                <div class="filter-tile" data-filter="op-government" id="opGovernmentTile">Government</div>
                <div class="filter-tile" data-filter="op-medical" id="opMedicalTile">Medical</div>
                <div class="filter-tile" data-filter="op-instructor" id="opInstructorTile">Instructor</div>
              </div>

              <!-- Perks -->
              <div class="section-title">Perks</div>
              <div class="tile-group">
                <div class="filter-tile" data-filter="visa" id="visaTile">Visa Sponsor</div>
                <div class="filter-tile" data-filter="direct" id="directTile">Direct Entry</div>
              </div>

              <!-- Sort by Salary (Premium Feature) -->
              <div class="sort-salary-section">
                <button type="button" class="sort-salary-btn locked" id="sortSalaryBtn">
                  <span class="lock-icon">🔒</span>
                  <span>Sort by Salary</span>
                  <span class="premium-tag">Pro</span>
                </button>
              </div>

              <!-- Flight Time Range (Pilot only) -->
              <div class="section-title pilot-filter" id="flightTimeTitle">Total Flight Time <span id="ftLabel">0 - 10,000+</span></div>
              <div class="range-section pilot-filter" id="flightTimeSection">
                <input type="range" class="range-slider" id="ftSlider" min="0" max="10000" step="100" value="10000">
                <div class="range-labels">
                  <span>0 hrs</span>
                  <span>10,000+</span>
                </div>
              </div>

              <!-- Result Bar -->
              <button class="result-bar" id="applyBtn" type="button">
                <span>Show Results</span>
                <span class="result-count" id="matchCount">6 Jobs</span>
              </button>
              <button class="clear-btn" id="clearBtn" type="button">Clear Filters</button>
            </div>
          </aside>

          <section class="panel">
            <div class="cards" id="cards"></div>
            <div class="load-more-container" id="loadMoreContainer">
              <button class="load-more-btn" id="loadMoreBtn">Load More Jobs</button>
              <div class="results-count" id="resultsCount">Displaying 0 of 0 active vacancies</div>
            </div>
          </section>
        </main>
      </div>
    </div>
  </div>

  <!-- Profile Editor Modal -->
  <div class="profile-modal-overlay" id="profileModal">
    <div class="profile-modal">
      <div class="profile-modal-header">
        <h2>Edit Your Profile</h2>
        <button class="profile-modal-close" id="closeProfileModal">&times;</button>
      </div>
      <div class="profile-modal-body">
        <!-- Flight Hours Section -->
        <div class="profile-form-section">
          <h3>Flight Hours</h3>
          <div class="profile-form-row">
            <div class="profile-form-group">
              <label for="profileTotalHours">Total Time</label>
              <input type="number" id="profileTotalHours" placeholder="e.g. 1500" min="0">
            </div>
            <div class="profile-form-group">
              <label for="profilePicHours">PIC Time</label>
              <input type="number" id="profilePicHours" placeholder="e.g. 500" min="0">
            </div>
          </div>
          <div class="profile-form-row">
            <div class="profile-form-group">
              <label for="profileJetTime">Jet Time</label>
              <input type="number" id="profileJetTime" placeholder="e.g. 200" min="0">
            </div>
            <div class="profile-form-group">
              <label for="profileMultiEngine">Multi-Engine</label>
              <input type="number" id="profileMultiEngine" placeholder="e.g. 300" min="0">
            </div>
          </div>
        </div>

        <!-- License Section -->
        <div class="profile-form-section">
          <h3>License</h3>
          <div class="profile-form-row">
            <div class="profile-form-group full-width">
              <label for="profileLicense">Current License</label>
              <select id="profileLicense">
                <option value="PPL">PPL - Private Pilot License</option>
                <option value="CPL">CPL - Commercial Pilot License</option>
                <option value="fATPL">fATPL - Frozen ATPL</option>
                <option value="ATPL">ATPL - Airline Transport Pilot License</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Type Ratings Section -->
        <div class="profile-form-section">
          <h3>Type Ratings</h3>
          <div class="type-ratings-container" id="typeRatingsContainer">
            <!-- Type rating chips will be added here dynamically -->
          </div>
          <div class="add-type-rating">
            <input type="text" id="newTypeRating" placeholder="e.g. A320, B737, ATR 72...">
            <button type="button" id="addTypeRatingBtn">Add</button>
          </div>
          <div class="profile-form-row" style="margin-top: 12px;">
            <div class="profile-form-group full-width">
              <label for="profileTypeTime">Hours on Primary Type</label>
              <input type="number" id="profileTypeTime" placeholder="e.g. 500" min="0">
            </div>
          </div>
        </div>

        <!-- Work Rights Section -->
        <div class="profile-form-section">
          <h3>Work Rights</h3>
          <p style="font-size: 11px; color: #64748b; margin: 0 0 12px 0;">Select regions where you can legally work</p>
          <div class="work-rights-grid">
            <label><input type="checkbox" value="EU" class="work-right-cb"> EU/EEA</label>
            <label><input type="checkbox" value="USA" class="work-right-cb"> USA</label>
            <label><input type="checkbox" value="UK" class="work-right-cb"> UK</label>
            <label><input type="checkbox" value="Middle East" class="work-right-cb"> Middle East</label>
            <label><input type="checkbox" value="Asia" class="work-right-cb"> Asia</label>
            <label><input type="checkbox" value="Africa" class="work-right-cb"> Africa</label>
            <label><input type="checkbox" value="Australia" class="work-right-cb"> Australia</label>
            <label><input type="checkbox" value="Canada" class="work-right-cb"> Canada</label>
            <label><input type="checkbox" value="South America" class="work-right-cb"> S. America</label>
          </div>
        </div>
      </div>
      <div class="profile-modal-footer">
        <button class="profile-cancel-btn" id="cancelProfileBtn">Cancel</button>
        <button class="profile-save-btn" id="saveProfileBtn">Save Profile</button>
      </div>
    </div>
  </div>

  <!-- Salary Notice Modal -->
  <div class="salary-notice-overlay" id="salaryNoticeModal">
    <div class="salary-notice-modal">
      <h3>💰 Sort by Salary</h3>
      <p>Please note that some jobs do not publicly disclose salary information. This sorting feature only works with jobs that have posted their salary. Jobs without salary data will appear at the end of the list.</p>
      <div class="btn-row">
        <button type="button" class="btn-cancel" id="salaryNoticeCancel">Cancel</button>
        <button type="button" class="btn-confirm" id="salaryNoticeConfirm">Got it, Sort by Salary</button>
      </div>
    </div>
  </div>

  <!-- Map Overlay -->
  <div class="map-overlay" id="mapOverlay">
    <div class="map-container">
      <div class="map-header">
        <h2>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon>
            <line x1="8" y1="2" x2="8" y2="18"></line>
            <line x1="16" y1="6" x2="16" y2="22"></line>
          </svg>
          Job Locations
        </h2>
        <button class="map-close-btn" id="closeMapBtn" type="button">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="map-content">
        <div class="map-loading" id="mapLoading">
          <div class="map-loading-spinner"></div>
          <div class="map-loading-text">Loading map...</div>
        </div>
        <div id="mapbox-map"></div>
        <div class="map-stats" id="mapStats"></div>
        <div class="map-job-preview" id="mapJobPreview">
          <button class="map-job-preview-close" id="closePreview" type="button">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
          <div id="mapJobCardContainer"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.paddle.com/paddle/v2/paddle.js"></script>
  <script>
    // Supabase configuration
    const SUPABASE_URL = 'https://ziboktbmbyjbhifsdypa.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InppYm9rdGJtYnlqYmhpZnNkeXBhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3NjMwODUsImV4cCI6MjA4MjMzOTA4NX0.eayvAsTuezEJZ-SIvEjZmrYaUxmJtntV8pK8fyUBnbY';

    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Premium state (in production this would come from user auth/subscription)
    let isPremium = false;
    let isLoggedIn = false;

    // Delta filter state - when false, eligibility badges and filtering are disabled
    let deltaFilterEnabled = true;

    // Salary sorting state (premium feature)
    let sortBySalary = false;

    // Pagination state
    const JOBS_PER_PAGE = 10;
    let currentPage = 1;
    let currentFilteredJobs = [];

    // Pilot's profile (loaded from Supabase when logged in)
    let PILOT_PROFILE = {
      totalHours: 1200,
      picHours: 400,
      jetTime: 0,
      multiEngineTime: 0,
      typeRatings: ['A320'],  // Aircraft types the pilot is rated on
      typeTime: { 'A320': 200 },  // Hours on each type
      license: 'CPL',  // Current license: PPL < CPL < ATPL
      workRights: ['EU', 'USA']  // Countries where pilot can legally work
    };

    // License hierarchy (higher = more senior)
    const LICENSE_LEVELS = {
      'PPL': 1,
      'CPL': 2,
      'fATPL': 3,
      'ATPL': 4,
      'ATP': 4  // US equivalent of ATPL
    };

    // Jobs will be loaded from Supabase
    let JOBS = [];

    // Current job type (pilot or cabin_crew)
    let currentJobType = 'pilot';

    // Fetch pilot jobs from Supabase verified_jobs table
    async function fetchPilotJobs() {
      try {
        const { data, error } = await supabaseClient
          .from('verified_jobs')
          .select('*')
          .order('verified_at', { ascending: false });

        if (error) {
          console.error('Error fetching verified jobs:', error);
          return [];
        }

        console.log('Fetched', data.length, 'verified pilot jobs from Supabase');
        // Debug: log first job's license data
        if (data.length > 0) {
          console.log('Sample job license_required:', data[0].license_required, 'type_rated:', data[0].type_rated);
        }

        return data.map(job => {
          let orgName = job.airline || 'Unknown Airline';

          return {
            id: job.id,
            title: job.title || '',
            org: orgName,
            location: job.location || '',
            chips: [job.aircraft, job.rank].filter(Boolean),
            featured: false,
            visa: job.visa_sponsor || false,
            direct: job.direct_entry || false,
            license: Array.isArray(job.license_required) ? job.license_required : (job.license_required ? [job.license_required] : ['ATPL']),
            type: job.type_rated ? 'typed' : 'standard',
            operator_type: job.operator_type || 'airline',
            flightTime: job.total_hours || 0,
            pic: job.pic_hours || 0,
            jetTime: job.jet_time || 0,
            multiEngine: job.multi_engine_time || 0,
            salary: job.salary_usd || 0,
            requiredType: job.type_rated ? (job.aircraft || '') : '',  // Only set required type for type-rated jobs
            minTypeTime: 0,
            workRegion: job.location || 'International',
            logo: job.logo_url || '',
            applyUrl: job.url || '#',
            description: job.description_summary || '',
            requirements: job.requirements || '',
            rank: job.rank || '',
            aircraft: job.aircraft || '',
            typeRated: job.type_rated || false,
            visaSponsor: job.visa_sponsor || false,
            roster: job.roster || '',
            jobType: 'pilot'
          };
        });
      } catch (err) {
        console.error('Failed to fetch pilot jobs:', err);
        return [];
      }
    }

    // Fetch cabin crew jobs from Supabase verified_cabin_crew_jobs table
    async function fetchCabinCrewJobs() {
      try {
        const { data, error } = await supabaseClient
          .from('verified_cabin_crew_jobs')
          .select('*')
          .order('verified_at', { ascending: false });

        if (error) {
          console.error('Error fetching verified cabin crew jobs:', error);
          return [];
        }

        console.log('Fetched', data.length, 'verified cabin crew jobs from Supabase');

        return data.map(job => {
          let orgName = job.airline || 'Unknown Airline';

          return {
            id: job.id,
            title: job.title || '',
            org: orgName,
            location: job.location || '',
            chips: [job.position, job.contract_type].filter(Boolean),
            featured: false,
            visa: false,
            direct: false,
            license: '',
            type: 'standard',
            operator_type: job.operator_type || 'airline',
            experienceYears: job.experience_years || 0,
            languageRequirements: job.language_requirements || '',
            salary: job.salary_usd || 0,
            contractType: job.contract_type || '',
            workRegion: job.location || 'International',
            logo: job.logo_url || '',
            applyUrl: job.url || '#',
            description: job.description_summary || '',
            requirements: job.requirements || '',
            position: job.position || '',
            jobType: 'cabin_crew'
          };
        });
      } catch (err) {
        console.error('Failed to fetch cabin crew jobs:', err);
        return [];
      }
    }

    // Fetch jobs based on current job type
    async function fetchJobs() {
      if (currentJobType === 'pilot') {
        return await fetchPilotJobs();
      } else {
        return await fetchCabinCrewJobs();
      }
    }

    const el = (id) => document.getElementById(id);

    const ftSlider = el("ftSlider");
    const ftLabel = el("ftLabel");

    function syncFT(){
      const val = Number(ftSlider.value);
      ftLabel.textContent = val >= 10000 ? '0 - 10,000+' : '0 - ' + val.toLocaleString();
    }

    ftSlider.addEventListener("input", syncFT);

    // Delta slider
    const deltaSlider = el("deltaSlider");
    const deltaLabel = el("deltaLabel");

    function syncDelta() {
      const val = Number(deltaSlider.value);
      if (val === 0) {
        deltaLabel.textContent = "Eligible only";
      } else {
        deltaLabel.textContent = `≤ ${val.toLocaleString()} hrs away`;
      }
    }

    deltaSlider.addEventListener("input", () => {
      syncDelta();
      updateMatchCount();
    });

    // Eligible only checkbox
    const eligibleOnlyCheckbox = el("eligibleOnly");
    eligibleOnlyCheckbox.addEventListener("change", () => {
      if (eligibleOnlyCheckbox.checked) {
        deltaSlider.value = 0;
        syncDelta();
      }
      updateMatchCount();
    });

    // Include blockers checkbox (premium feature)
    const includeBlockersCheckbox = el("includeBlockers");
    includeBlockersCheckbox.addEventListener("change", () => {
      updateMatchCount();
    });

    // Delta filter toggle buttons - turns the whole delta/eligibility filter on/off
    const deltaContent = el("deltaContent");
    const deltaDisabled = el("deltaDisabled");
    const turnOffDeltaBtn = el("turnOffDeltaBtn");
    const turnOnDeltaBtn = el("turnOnDeltaBtn");

    function setDeltaFilterState(enabled) {
      deltaFilterEnabled = enabled;
      if (enabled) {
        deltaContent.style.display = "block";
        deltaDisabled.style.display = "none";
      } else {
        deltaContent.style.display = "none";
        deltaDisabled.style.display = "block";
      }
      // Re-render jobs to show/hide eligibility badges
      apply();
    }

    turnOffDeltaBtn.addEventListener("click", () => setDeltaFilterState(false));
    turnOnDeltaBtn.addEventListener("click", () => setDeltaFilterState(true));

    // Premium unlock button - Stripe integration
    const premiumLock = el("premiumLock");
    el("unlockBtn").addEventListener("click", async () => {
      // Check if user is logged in
      const { data: { session } } = await supabaseClient.auth.getSession();

      if (!session) {
        // User not logged in - redirect to login
        alert("Please log in to access premium features");
        window.location.href = "login.html";
        return;
      }

      // User is logged in - open Paddle checkout
      try {
        el("unlockBtn").textContent = "Loading...";
        el("unlockBtn").disabled = true;

        const response = await fetch('/api/create-checkout', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            userId: session.user.id,
            userEmail: session.user.email,
          }),
        });

        const data = await response.json();

        if (data.error) {
          throw new Error(data.error);
        }

        // Initialize Paddle and open checkout
        Paddle.Initialize({
          token: 'live_3c0845cd663dcb34c0bd743dba0',  // Client-side token from Paddle
          checkout: {
            settings: {
              displayMode: 'overlay',
              theme: 'light',
              locale: 'en',
              successUrl: data.successUrl,
            }
          }
        });

        // Open Paddle checkout overlay
        Paddle.Checkout.open({
          items: [{ priceId: data.priceId, quantity: 1 }],
          customer: {
            email: data.customerEmail,
          },
          customData: data.customData,
        });

        el("unlockBtn").textContent = "Upgrade to Pro";
        el("unlockBtn").disabled = false;
      } catch (error) {
        console.error('Checkout error:', error);
        alert('Failed to start checkout. Please try again.');
        el("unlockBtn").textContent = "Upgrade to Pro";
        el("unlockBtn").disabled = false;
      }
    });

    // Check login status and premium status on page load
    async function checkLoginStatus() {
      const { data: { session } } = await supabaseClient.auth.getSession();
      isLoggedIn = !!session;

      if (session) {
        // Check if user has premium status
        const { data: profile } = await supabaseClient
          .from('profiles')
          .select('is_premium')
          .eq('id', session.user.id)
          .single();

        if (profile && profile.is_premium) {
          isPremium = true;
          updatePremiumUI();
          updateMatchCount();
        }
      }

      // Handle payment success/cancel redirects
      const urlParams = new URLSearchParams(window.location.search);
      const paymentStatus = urlParams.get('payment');

      if (paymentStatus === 'success') {
        // Remove query param from URL
        window.history.replaceState({}, document.title, window.location.pathname);

        // Show success message and refresh premium status
        alert('Payment successful! Welcome to AeroScout Pro!');

        // Re-check premium status (webhook may have already updated it)
        if (session) {
          const { data: profile } = await supabaseClient
            .from('profiles')
            .select('is_premium')
            .eq('id', session.user.id)
            .single();

          if (profile && profile.is_premium) {
            isPremium = true;
            updatePremiumUI();
            updateMatchCount();
            apply();
          }
        }
      } else if (paymentStatus === 'cancelled') {
        window.history.replaceState({}, document.title, window.location.pathname);
        alert('Payment was cancelled. You can upgrade anytime.');
      }
    }
    checkLoginStatus();

    function updatePremiumUI() {
      const sortSalaryBtn = el("sortSalaryBtn");
      if (isPremium) {
        premiumLock.classList.add("hidden");
        // Update sort salary button to unlocked state
        sortSalaryBtn.classList.remove("locked");
        sortSalaryBtn.classList.add("unlocked");
        sortSalaryBtn.innerHTML = '<span>Sort by Salary</span><span class="premium-tag">Pro</span>';
      } else {
        premiumLock.classList.remove("hidden");
        // Keep sort salary button locked
        sortSalaryBtn.classList.add("locked");
        sortSalaryBtn.classList.remove("unlocked");
        sortSalaryBtn.innerHTML = '<span class="lock-icon">🔒</span><span>Sort by Salary</span><span class="premium-tag">Pro</span>';
      }
    }

    function updateMatchCount() {
      const filtered = getFilteredJobs();
      el("matchCount").textContent = `${filtered.length} Jobs`;
    }

    function badgeHTML(chips, featured){
      const chipEls = chips.map(c => `<span class="chip">${c}</span>`).join("");
      const feat = featured ? `<span class="chip green">Featured</span>` : "";
      return feat + chipEls;
    }

    function iconLetter(name){
      const s = (name || "A").trim();
      return (s[0] || "A").toUpperCase();
    }

    // Format salary with commas and handle ranges
    function formatSalary(salary) {
      if (!salary || salary === 0 || salary === "0") return null;

      const salaryStr = String(salary);

      // Check if it's a range (contains hyphen)
      if (salaryStr.includes('-')) {
        const parts = salaryStr.split('-');
        if (parts.length === 2) {
          const low = parseInt(parts[0], 10);
          const high = parseInt(parts[1], 10);
          if (!isNaN(low) && !isNaN(high)) {
            return {
              formatted: `$${low.toLocaleString()}-$${high.toLocaleString()}/yr`,
              isRange: true
            };
          }
        }
      }

      // Single value
      const val = parseInt(salaryStr, 10);
      if (!isNaN(val) && val > 0) {
        return {
          formatted: `$${val.toLocaleString()}/yr`,
          isRange: false
        };
      }

      return null;
    }

    // Toggle job description expand/collapse
    function toggleDescription(expandLink) {
      const card = expandLink.closest('.card');
      const descriptionDiv = card.querySelector('.job-description');

      expandLink.classList.toggle('expanded');
      descriptionDiv.classList.toggle('expanded');

      // Update link text
      if (expandLink.classList.contains('expanded')) {
        expandLink.childNodes[0].textContent = 'Hide description ';
      } else {
        expandLink.childNodes[0].textContent = 'See job description ';
      }
    }

    // Parse requirements JSON and render as bullet list
    function renderRequirements(requirementsJson) {
      if (!requirementsJson) return '';

      try {
        // Parse JSON string to array
        let requirements = requirementsJson;
        if (typeof requirementsJson === 'string') {
          requirements = JSON.parse(requirementsJson);
        }

        if (!Array.isArray(requirements) || requirements.length === 0) {
          return '';
        }

        // Render as bullet list
        const items = requirements.map(req => `<li>${req}</li>`).join('');
        return `<ul class="requirements-list">${items}</ul>`;
      } catch (e) {
        console.warn('Failed to parse requirements:', e);
        return '';
      }
    }

    /**
     * Calculate the eligibility delta for a job
     * Returns an object with all the gaps between pilot profile and job requirements
     *
     * Key concepts:
     * - ttGap/picGap/typeTimeGap = hours the pilot is short (can be built up over time)
     * - hasType = whether pilot has the required type rating (hard blocker if missing)
     * - hasLicense = whether pilot has the required license level (hard blocker if missing)
     * - hasWorkRights = whether pilot can legally work in that region (hard blocker if missing)
     * - hoursGap = the largest hours gap (used for "within X hours" slider)
     * - hasBlocker = true if any hard blocker exists (type/license/work rights)
     */
    function calculateDelta(job) {
      const pilot = PILOT_PROFILE;

      // 1. Total Time Delta - how many hours short?
      const ttGap = Math.max(0, job.flightTime - pilot.totalHours);
      const ttMet = pilot.totalHours >= job.flightTime;

      // 2. PIC Time Delta - how many PIC hours short?
      const picGap = Math.max(0, job.pic - pilot.picHours);
      const picMet = pilot.picHours >= job.pic;

      // 3. Type Rating Check
      // Only check type rating if the job REQUIRES it (typeRated === true)
      // NTR jobs (typeRated === false) don't require type rating
      const needsType = job.typeRated === true && job.requiredType;
      const hasType = needsType ? pilot.typeRatings.includes(job.requiredType) : true;
      const missingTypeBlocker = needsType && !hasType;

      // 4. Type Time Gap (only if pilot HAS the type rating)
      // If they have the type, check if they have enough hours ON that type
      let typeTimeGap = 0;
      let typeTimeMet = true;
      if (needsType && hasType && job.minTypeTime > 0) {
        const pilotTypeTime = pilot.typeTime[job.requiredType] || 0;
        typeTimeGap = Math.max(0, job.minTypeTime - pilotTypeTime);
        typeTimeMet = pilotTypeTime >= job.minTypeTime;
      }

      // 5. License Check - is pilot's license sufficient?
      // job.license is now an array of acceptable licenses
      const jobLicenses = Array.isArray(job.license) ? job.license : [job.license];
      const pilotLicenseLevel = LICENSE_LEVELS[pilot.license] || 0;
      // Pilot qualifies if their license level >= ANY of the job's acceptable license levels
      const hasLicense = jobLicenses.some(lic => pilotLicenseLevel >= (LICENSE_LEVELS[lic] || 0));
      const missingLicenseBlocker = !hasLicense;
      // For display: show the minimum required license (lowest level in the array)
      const minJobLicenseLevel = Math.min(...jobLicenses.map(lic => LICENSE_LEVELS[lic] || 0));
      const jobLicenseDisplay = jobLicenses.join('/');  // e.g., "CPL/ATPL"

      // 6. Work Rights Check - can pilot legally work in this region?
      // If job provides visa sponsorship, work rights are not required
      // Note: For now, skip work rights check since job.workRegion contains full location strings
      // (e.g., "Dubai, UAE") but pilot.workRights contains region codes (e.g., "EU", "USA")
      // TODO: Implement proper location-to-region mapping
      const needsWorkRights = false;  // Disabled until we have proper region mapping
      const hasWorkRights = true;
      const missingWorkRightsBlocker = false;

      // 7. The "hours gap" includes TT, PIC, and type time (things you can fly toward)
      // Hard blockers (missing type, license, work rights) are NOT included
      const hoursGap = Math.max(ttGap, picGap, typeTimeGap);

      // 8. Any hard blocker present?
      const hasBlocker = missingTypeBlocker || missingLicenseBlocker || missingWorkRightsBlocker;

      // 9. Overall eligibility = ALL requirements must be met
      const isEligible = ttMet && picMet && typeTimeMet && !hasBlocker;

      return {
        // Hours gaps (can be worked toward)
        ttGap,
        ttMet,
        picGap,
        picMet,
        typeTimeGap,
        typeTimeMet,
        hoursGap,           // Max of TT, PIC, and type time gaps

        // Type rating
        needsType,
        hasType,
        missingTypeBlocker,

        // License
        hasLicense,
        missingLicenseBlocker,
        jobLicense: jobLicenseDisplay,
        jobLicenses: jobLicenses,
        pilotLicense: pilot.license,

        // Work rights
        needsWorkRights,
        hasWorkRights,
        missingWorkRightsBlocker,
        workRegion: job.workRegion,
        visaSponsored: job.visa,

        // Overall blockers
        hasBlocker,         // TRUE = at least one hard blocker exists
        isEligible,

        // For display in tooltip
        pilotTT: pilot.totalHours,
        jobTT: job.flightTime,
        pilotPIC: pilot.picHours,
        jobPIC: job.pic,
        pilotTypeTime: pilot.typeTime[job.requiredType] || 0,
        requiredType: job.requiredType,
        minTypeTime: job.minTypeTime
      };
    }

    /**
     * Generate the eligibility badge HTML with tooltip breakdown
     */
    function getEligibilityBadge(job) {
      // If delta filter is disabled, don't show any eligibility badge
      if (!deltaFilterEnabled) {
        return '';
      }

      // For non-premium users, show a teaser badge that prompts upgrade
      if (!isPremium) {
        return '<span class="eligibility-badge" style="background:#f3f4f6;color:#9ca3af;cursor:pointer;" title="Upgrade to Pro to see eligibility">🔒 Eligibility</span>';
      }

      const delta = calculateDelta(job);

      // Determine tooltip title based on status
      let tooltipTitle = 'Requirements Breakdown';
      if (delta.isEligible) {
        tooltipTitle = '✓ You meet all requirements';
      } else if (delta.hasBlocker) {
        tooltipTitle = '🔴 Blocker(s) found';
      }

      // Build the tooltip content with all checks
      const tooltipHTML = `
        <div class="eligibility-tooltip">
          <div class="tooltip-title">${tooltipTitle}</div>

          <div class="tooltip-row">
            <span class="tooltip-label">Total Time</span>
            <span class="tooltip-value ${delta.ttMet ? 'met' : 'short'}">
              ${delta.pilotTT.toLocaleString()} / ${delta.jobTT.toLocaleString()}
              ${!delta.ttMet ? `<span class="tooltip-gap">(${delta.ttGap.toLocaleString()} short)</span>` : ''}
            </span>
          </div>

          <div class="tooltip-row">
            <span class="tooltip-label">PIC Time</span>
            <span class="tooltip-value ${delta.picMet ? 'met' : 'short'}">
              ${delta.pilotPIC.toLocaleString()} / ${delta.jobPIC.toLocaleString()}
              ${!delta.picMet ? `<span class="tooltip-gap">(${delta.picGap.toLocaleString()} short)</span>` : ''}
            </span>
          </div>

          ${delta.needsType ? `
          <div class="tooltip-row">
            <span class="tooltip-label">Type Rating</span>
            <span class="tooltip-value ${delta.hasType ? 'met' : 'missing'}">
              ${delta.hasType ? `✓ ${delta.requiredType}` : `🔴 Need ${delta.requiredType}`}
            </span>
          </div>
          ${delta.hasType && delta.minTypeTime > 0 ? `
          <div class="tooltip-row">
            <span class="tooltip-label">Time on Type</span>
            <span class="tooltip-value ${delta.typeTimeMet ? 'met' : 'short'}">
              ${delta.pilotTypeTime.toLocaleString()} / ${delta.minTypeTime.toLocaleString()}
              ${!delta.typeTimeMet ? `<span class="tooltip-gap">(${delta.typeTimeGap.toLocaleString()} short)</span>` : ''}
            </span>
          </div>
          ` : ''}
          ` : `
          <div class="tooltip-row">
            <span class="tooltip-label">Type Rating</span>
            <span class="tooltip-value met">Not required ✓</span>
          </div>
          `}

          <div class="tooltip-row">
            <span class="tooltip-label">License</span>
            <span class="tooltip-value ${delta.hasLicense ? 'met' : 'missing'}">
              ${delta.hasLicense ? `✓ ${delta.pilotLicense}` : `🔴 Need ${delta.jobLicense}`}
            </span>
          </div>

          <div class="tooltip-row">
            <span class="tooltip-label">Work Rights</span>
            <span class="tooltip-value ${delta.hasWorkRights ? 'met' : 'missing'}">
              ${delta.visaSponsored ? '✓ Visa sponsored' : delta.hasWorkRights ? `✓ ${delta.workRegion}` : `🔴 No rights (${delta.workRegion})`}
            </span>
          </div>
        </div>
      `;

      // Determine badge style based on eligibility
      let badgeClass, badgeText;

      if (delta.isEligible) {
        // All requirements met
        badgeClass = 'eligible';
        badgeText = '✓ Eligible';
      } else if (delta.missingTypeBlocker) {
        // HARD BLOCKER: Missing type rating
        badgeClass = 'not-eligible';
        badgeText = `🔴 Need ${delta.requiredType}`;
      } else if (delta.missingLicenseBlocker) {
        // HARD BLOCKER: Missing license
        badgeClass = 'not-eligible';
        badgeText = `🔴 Need ${delta.jobLicense}`;
      } else if (delta.missingWorkRightsBlocker) {
        // HARD BLOCKER: No work rights
        badgeClass = 'not-eligible';
        badgeText = `🔴 No work rights`;
      } else if (delta.hoursGap <= 500) {
        // Close on hours (within 500 hrs)
        badgeClass = 'within-reach';
        badgeText = `🟡 ${delta.hoursGap.toLocaleString()} hrs to go`;
      } else {
        // Far on hours
        badgeClass = 'not-eligible';
        badgeText = `${delta.hoursGap.toLocaleString()} hrs to go`;
      }

      return `
        <span class="eligibility-wrapper">
          <span class="eligibility-badge ${badgeClass} clickable">${badgeText}</span>
          ${tooltipHTML}
        </span>
      `;
    }

    // Render job card attributes based on job type
    function renderAttributes(j) {
      if (j.jobType === 'cabin_crew') {
        return `
          <span class="attr-item"><b>Position:</b> <span class="attr-pill">${j.position || 'Flight Attendant'}</span></span>
          <span class="attr-item"><b>Location:</b> <span class="attr-pill">${j.location || 'Not specified'}</span></span>
          ${j.contractType ? `<span class="attr-pill">${j.contractType}</span>` : ''}
          ${j.visa ? '<span class="attr-pill green"><b>Visa sponsor</b></span>' : ''}
        `;
      } else {
        return `
          <span class="attr-item"><b>Aircraft:</b> <span class="attr-pill">${j.chips[0] || 'N/A'}</span></span>
          <span class="attr-item"><b>Location:</b> <span class="attr-pill">${j.location || 'Not specified'}</span></span>
          ${j.type === "typed" ? '<span class="attr-pill">Type-rated</span>' : '<span class="attr-pill green">Non-type rated</span>'}
          ${j.visa ? '<span class="attr-pill green"><b>Visa sponsor</b></span>' : ''}
          ${j.direct ? '<span class="attr-pill" style="background:#e3f2fd;color:#1565c0;"><b>Direct Entry</b></span>' : ''}
          ${getEligibilityBadge(j)}
        `;
      }
    }

    // Render stats row based on job type
    function renderStatsRow(j) {
      if (j.jobType === 'cabin_crew') {
        // For cabin crew, show experience years, languages, contract type
        let stats = '';

        if (j.experienceYears > 0) {
          stats += `<div class="stat-box">
            <span class="stat-label">Experience</span>
            <span class="stat-value">${j.experienceYears} ${j.experienceYears === 1 ? 'year' : 'years'}</span>
          </div>`;
        }

        // Parse language requirements
        let languages = [];
        if (j.languageRequirements) {
          try {
            if (typeof j.languageRequirements === 'string') {
              languages = JSON.parse(j.languageRequirements);
            } else {
              languages = j.languageRequirements;
            }
          } catch (e) {
            languages = [j.languageRequirements];
          }
        }

        if (languages && languages.length > 0 && languages[0] !== 'None') {
          stats += `<div class="stat-box">
            <span class="stat-label">Languages</span>
            <span class="stat-value">${Array.isArray(languages) ? languages.join(', ') : languages}</span>
          </div>`;
        }

        if (j.contractType) {
          stats += `<div class="stat-box">
            <span class="stat-label">Contract</span>
            <span class="stat-value">${j.contractType}</span>
          </div>`;
        }

        const salaryInfo = formatSalary(j.salary);
        if (salaryInfo) {
          stats += `<div class="stat-box">
            <span class="stat-label">Salary${salaryInfo.isRange ? ' (range)' : ''}</span>
            <span class="stat-value" style="color: #22c55e;">${salaryInfo.formatted}</span>
          </div>`;
        }

        return stats || '<div class="stat-box"><span class="stat-label">Details</span><span class="stat-value">See description</span></div>';
      } else {
        // For pilots, show flight hours
        let stats = `
          <div class="stat-box">
            <span class="stat-label">Total Time</span>
            <span class="stat-value">${j.flightTime.toLocaleString()} hrs</span>
          </div>
          <div class="stat-box">
            <span class="stat-label">PIC Time</span>
            <span class="stat-value">${j.pic.toLocaleString()} hrs</span>
          </div>
        `;

        if (j.jetTime) {
          stats += `<div class="stat-box">
            <span class="stat-label">Jet Time</span>
            <span class="stat-value">${j.jetTime.toLocaleString()} hrs</span>
          </div>`;
        }

        if (j.multiEngine) {
          stats += `<div class="stat-box">
            <span class="stat-label">Multi-Engine</span>
            <span class="stat-value">${j.multiEngine.toLocaleString()} hrs</span>
          </div>`;
        }

        if (j.roster) {
          stats += `<div class="stat-box">
            <span class="stat-label">Roster</span>
            <span class="stat-value">${j.roster}</span>
          </div>`;
        }

        const salaryInfo = formatSalary(j.salary);
        if (salaryInfo) {
          stats += `<div class="stat-box">
            <span class="stat-label">Salary${salaryInfo.isRange ? ' (range)' : ''}</span>
            <span class="stat-value" style="color: #22c55e;">${salaryInfo.formatted}</span>
          </div>`;
        }

        return stats;
      }
    }

    function render(list, append = false){
      const cards = el("cards");
      const jobsHTML = list.map(j => `
        <article class="card${j.visa ? ' visa-sponsor' : ''}" style="position:relative;">
          <button class="save-btn" title="Save job">
            <svg viewBox="0 0 24 24"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>
          </button>

          <div class="company-logo">
            <img src="${j.logo}" alt="${j.org}" onerror="this.parentElement.textContent='${iconLetter(j.org)}'">
          </div>

          <h2 class="job-title">${j.title}<span class="airline-name">${j.org}</span></h2>

          <div class="apply-container">
            <a href="${j.applyUrl}" class="apply-btn" target="_blank" rel="noopener noreferrer">Apply Now</a>
          </div>

          <div class="attributes">
            ${renderAttributes(j)}
          </div>

          <div class="stats-row">
            ${renderStatsRow(j)}
          </div>

          <div class="expand-link" onclick="toggleDescription(this)">
            See job description
            <div class="arrow-v"></div>
          </div>

          <div class="job-description">
            ${j.description ? `<div class="job-description-content">${j.description}</div>` : ''}
            ${j.requirements ? `
              <div class="requirements-title">Requirements</div>
              ${renderRequirements(j.requirements)}
            ` : ''}
            ${!j.description && !j.requirements ? `<div class="job-description-content"></div>` : ''}
          </div>
        </article>
      `).join("");

      if (append) {
        cards.innerHTML += jobsHTML;
      } else {
        cards.innerHTML = jobsHTML;
      }
    }

    function updateDisplay() {
      // Update job count and GMT time in header
      const displayedCount = Math.min(currentPage * JOBS_PER_PAGE, currentFilteredJobs.length);
      el("jobCount").textContent = displayedCount;
      const now = new Date();
      const gmtTime = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', timeZone: 'GMT' }) + ' GMT';
      el("gmtTime").textContent = gmtTime;

      // Update header text based on job type
      const jobTypeLabel = currentJobType === 'pilot' ? 'Active pilot jobs' : 'Active cabin crew jobs';
      el("jobTypeLabel").textContent = jobTypeLabel;

      // Update load more section
      const totalJobs = currentFilteredJobs.length;
      el("resultsCount").textContent = `Displaying ${displayedCount} of ${totalJobs} active vacancies`;

      // Hide/show load more button
      const loadMoreBtn = el("loadMoreBtn");
      if (displayedCount >= totalJobs) {
        loadMoreBtn.style.display = 'none';
      } else {
        loadMoreBtn.style.display = 'block';
      }
    }

    function loadMore() {
      currentPage++;
      const startIdx = (currentPage - 1) * JOBS_PER_PAGE;
      const endIdx = currentPage * JOBS_PER_PAGE;
      const nextBatch = currentFilteredJobs.slice(startIdx, endIdx);

      if (nextBatch.length > 0) {
        render(nextBatch, true);
        updateDisplay();
      }
    }

    // Tile filter state
    const tileFilters = {
      ntr: false, typed: false,
      atpl: false, cpl: false, fatpl: false,
      'op-airline': false, 'op-bizav': false, 'op-government': false, 'op-medical': false, 'op-instructor': false,
      visa: false, direct: false
    };

    // Toggle tile active state
    document.querySelectorAll('.filter-tile').forEach(tile => {
      tile.addEventListener('click', () => {
        const filter = tile.dataset.filter;
        tileFilters[filter] = !tileFilters[filter];
        tile.classList.toggle('active');
        updateMatchCount();
      });
    });

    function getFilters(){
      const q = el("q").value.trim().toLowerCase();
      const loc = el("loc").value;

      const perks = {
        visa: tileFilters.visa,
        direct: tileFilters.direct
      };

      const license = {
        atpl: tileFilters.atpl,
        cpl: tileFilters.cpl,
        fatpl: tileFilters.fatpl
      };

      const type = {
        typed: tileFilters.typed,
        ntr: tileFilters.ntr
      };

      const operatorType = {
        airline: tileFilters['op-airline'],
        bizav: tileFilters['op-bizav'],
        government: tileFilters['op-government'],
        medical: tileFilters['op-medical'],
        instructor: tileFilters['op-instructor']
      };

      const maxFT = Number(ftSlider.value || 10000);
      const deltaEnabled = deltaFilterEnabled;
      const maxDelta = deltaEnabled ? Number(deltaSlider.value) : 3000; // If disabled, treat as max (no filtering)
      const eligibleOnly = eligibleOnlyCheckbox.checked;
      const includeBlockers = includeBlockersCheckbox.checked;

      return { q, loc, perks, license, type, operatorType, maxFT, maxDelta, deltaEnabled, eligibleOnly, includeBlockers };
    }

    function matchesAny(map){
      const any = Object.values(map).some(Boolean);
      return { any, map };
    }

    function getFilteredJobs(){
      const f = getFilters();
      const lic = matchesAny(f.license);
      const typ = matchesAny(f.type);
      const opType = matchesAny(f.operatorType);
      const perk = matchesAny(f.perks);

      return JOBS.filter(j => {
        if (f.q){
          const blob = `${j.title} ${j.org} ${j.location} ${j.chips.join(" ")}`.toLowerCase();
          if (!blob.includes(f.q)) return false;
        }
        if (f.loc && !j.location.includes(f.loc)) return false;
        if (j.flightTime > f.maxFT) return false;

        // "Eligible only" checkbox - works for ALL users (in black profile box)
        if (f.eligibleOnly) {
          const delta = calculateDelta(j);
          // Debug: log why jobs are being filtered
          if (!delta.isEligible) {
            console.log(`Job "${j.title}" not eligible:`, {
              ttMet: delta.ttMet, pilotTT: PILOT_PROFILE.totalHours, jobTT: j.flightTime,
              picMet: delta.picMet, pilotPIC: PILOT_PROFILE.picHours, jobPIC: j.pic,
              hasLicense: delta.hasLicense, pilotLicense: PILOT_PROFILE.license, jobLicense: j.license,
              hasBlocker: delta.hasBlocker, missingTypeBlocker: delta.missingTypeBlocker, missingLicenseBlocker: delta.missingLicenseBlocker
            });
          }
          if (!delta.isEligible) return false;
        }

        // Delta/Eligibility filter - premium features (golden box)
        if (isPremium && f.deltaEnabled) {
          const delta = calculateDelta(j);

          // Delta slider - "show jobs within X hours"
          if (f.maxDelta < 3000) { // Only filter if slider is not at max

            // If job has hard blockers (missing type/license/work rights)
            if (delta.hasBlocker) {
              // Exclude blockers UNLESS the "include blockers" toggle is on
              if (!f.includeBlockers) return false;
              // If including blockers, still filter by hours gap for planning purposes
            }

            // Filter by hours gap (TT, PIC, type time)
            if (delta.hoursGap > f.maxDelta) return false;
          }
        }

        // Perks - if any selected, job must match at least one
        if (perk.any){
          const matches =
            (f.perks.visa && j.visaSponsor === true) ||
            (f.perks.direct && j.direct);
          if (!matches) return false;
        }

        // License - if any selected, job must match at least one
        if (lic.any){
          // j.license is now an array of acceptable licenses
          const jobLicenses = Array.isArray(j.license) ? j.license : [j.license];
          const ok =
            (f.license.atpl && jobLicenses.some(l => l === "ATPL" || l === "ATP" || l === "fATPL")) ||
            (f.license.cpl && jobLicenses.some(l => l === "CPL")) ||
            (f.license.fatpl && jobLicenses.some(l => l === "fATPL" || l === "CPL"));
          if (!ok) return false;
        }

        // Type - if any selected, job must match at least one
        if (typ.any){
          const matches =
            (f.type.typed && j.typeRated === true) ||
            (f.type.ntr && j.typeRated === false);
          if (!matches) return false;
        }

        // Operator Type - if any selected, job must match at least one
        if (opType.any){
          const matches =
            (f.operatorType.airline && j.operator_type === "airline") ||
            (f.operatorType.bizav && j.operator_type === "bizav") ||
            (f.operatorType.government && j.operator_type === "government") ||
            (f.operatorType.medical && j.operator_type === "medical") ||
            (f.operatorType.instructor && j.operator_type === "instructor");
          if (!matches) return false;
        }

        return true;
      }).sort((a, b) => {
        // Apply salary sorting if enabled (premium feature)
        if (sortBySalary && isPremium) {
          // Parse salary - handle string ranges like "100000-150000" by taking the higher value
          const parseSalary = (salary) => {
            if (!salary) return 0;
            if (typeof salary === 'number') return salary;
            const str = String(salary);
            // Check for range (e.g., "100000-150000")
            if (str.includes('-')) {
              const parts = str.split('-').map(s => parseInt(s.replace(/[^0-9]/g, '')) || 0);
              return Math.max(...parts);
            }
            return parseInt(str.replace(/[^0-9]/g, '')) || 0;
          };

          const salaryA = parseSalary(a.salary);
          const salaryB = parseSalary(b.salary);

          // Sort descending (highest salary first)
          // Jobs without salary (0) go to the end
          if (salaryA === 0 && salaryB === 0) return 0;
          if (salaryA === 0) return 1;  // a goes after b
          if (salaryB === 0) return -1; // b goes after a
          return salaryB - salaryA;
        }
        return 0; // No sorting, keep original order
      });
    }

    function apply(){
      currentPage = 1;
      currentFilteredJobs = getFilteredJobs();
      const firstBatch = currentFilteredJobs.slice(0, JOBS_PER_PAGE);
      render(firstBatch);
      updateDisplay();
      updateMatchCount();
    }

    function clearAll(){
      el("q").value = "";
      el("loc").value = "";
      el("eligibleOnly").checked = false;

      // Clear all tile filters
      Object.keys(tileFilters).forEach(key => tileFilters[key] = false);
      document.querySelectorAll('.filter-tile').forEach(tile => tile.classList.remove('active'));

      ftSlider.value = 10000;
      syncFT();

      // Reset delta slider and blockers toggle
      deltaSlider.value = 3000;
      syncDelta();
      includeBlockersCheckbox.checked = false;

      // Reset salary sorting
      sortBySalary = false;
      el("sortSalaryBtn").classList.remove("active");

      // Reset pagination and render first batch
      currentPage = 1;
      currentFilteredJobs = JOBS;
      const firstBatch = JOBS.slice(0, JOBS_PER_PAGE);
      render(firstBatch);
      updateDisplay();
      updateMatchCount();
    }

    // Update match count on any filter change
    document.querySelectorAll('.filters input').forEach(input => {
      input.addEventListener('change', updateMatchCount);
    });
    ftSlider.addEventListener('input', updateMatchCount);

    el("applyBtn").addEventListener("click", apply);
    el("clearBtn").addEventListener("click", clearAll);
    el("searchBtn").addEventListener("click", apply);
    el("q").addEventListener("keydown", (e) => { if (e.key === "Enter") apply(); });

    // Load More button
    el("loadMoreBtn").addEventListener("click", loadMore);

    // Toggle filters panel
    let scrollPosition = 0;

    function openFilters() {
      // Save scroll position and lock body
      scrollPosition = window.pageYOffset;
      document.body.classList.add("filters-open");
      document.body.style.top = `-${scrollPosition}px`;

      const p = el("filtersPanel");
      p.classList.add("show");
      p.style.display = "block";
    }

    function closeFilters() {
      // Unlock body and restore scroll
      document.body.classList.remove("filters-open");
      document.body.style.top = "";
      window.scrollTo(0, scrollPosition);

      const p = el("filtersPanel");
      p.classList.remove("show");
      p.style.display = "none";
    }

    el("toggleFilters").addEventListener("click", () => {
      const p = el("filtersPanel");
      if (p.classList.contains("show")) {
        closeFilters();
      } else {
        openFilters();
      }
    });

    // Also close filters when clicking "Show Results"
    el("applyBtn").addEventListener("click", () => {
      if (window.innerWidth <= 768) {
        closeFilters();
      }
    });

    syncFT();
    syncDelta();
    updatePremiumUI();

    // Job Type Toggle (Pilot/Cabin Crew)
    async function switchJobType(jobType) {
      if (currentJobType === jobType) return;

      currentJobType = jobType;

      // Update toggle button states
      el("pilotBtn").classList.toggle("active", jobType === "pilot");
      el("cabinCrewBtn").classList.toggle("active", jobType === "cabin_crew");

      // Show/hide pilot-specific filters using the pilot-filter class
      const pilotFilters = document.querySelectorAll('.pilot-filter, .profile-summary, .delta-section');

      if (jobType === 'cabin_crew') {
        // Hide pilot-specific filters for cabin crew
        pilotFilters.forEach(elem => {
          if (elem) elem.style.display = 'none';
        });
      } else {
        // Show pilot filters
        pilotFilters.forEach(elem => {
          if (elem) elem.style.display = '';
        });
      }

      // Show loading state
      el("cards").innerHTML = '<div style="padding:40px;text-align:center;color:#6b7890;">Loading jobs...</div>';

      // Fetch new jobs
      JOBS = await fetchJobs();
      currentPage = 1;
      currentFilteredJobs = JOBS;

      if (JOBS.length === 0) {
        el("cards").innerHTML = '<div style="padding:40px;text-align:center;color:#6b7890;">No jobs found.</div>';
        updateDisplay();
        return;
      }

      const initialBatch = JOBS.slice(0, JOBS_PER_PAGE);
      render(initialBatch);
      updateDisplay();
      updateMatchCount();
    }

    el("pilotBtn").addEventListener("click", () => switchJobType("pilot"));
    el("cabinCrewBtn").addEventListener("click", () => switchJobType("cabin_crew"));

    // ============================================================
    // PROFILE EDITOR MODAL
    // ============================================================
    const profileModal = el("profileModal");
    const editProfileBtn = el("editProfileBtn");
    const closeProfileModal = el("closeProfileModal");
    const cancelProfileBtn = el("cancelProfileBtn");
    const saveProfileBtn = el("saveProfileBtn");
    const typeRatingsContainer = el("typeRatingsContainer");
    const newTypeRatingInput = el("newTypeRating");
    const addTypeRatingBtn = el("addTypeRatingBtn");

    // Temporary storage for type ratings being edited
    let editingTypeRatings = [];

    // Open modal
    editProfileBtn.addEventListener("click", () => {
      populateProfileForm();
      profileModal.classList.add("active");
    });

    // Close modal
    function closeModal() {
      profileModal.classList.remove("active");
    }
    closeProfileModal.addEventListener("click", closeModal);
    cancelProfileBtn.addEventListener("click", closeModal);
    profileModal.addEventListener("click", (e) => {
      if (e.target === profileModal) closeModal();
    });

    // ============================================
    // Sort by Salary Feature (Premium)
    // ============================================
    const sortSalaryBtn = el("sortSalaryBtn");
    const salaryNoticeModal = el("salaryNoticeModal");
    const salaryNoticeCancel = el("salaryNoticeCancel");
    const salaryNoticeConfirm = el("salaryNoticeConfirm");

    sortSalaryBtn.addEventListener("click", () => {
      if (!isPremium) {
        // Non-premium users - show upgrade prompt
        alert("Sort by Salary is a Premium feature. Upgrade to Pro to unlock!");
        return;
      }

      // If already sorting by salary, turn it off
      if (sortBySalary) {
        sortBySalary = false;
        sortSalaryBtn.classList.remove("active");
        apply();
        return;
      }

      // Show the notice modal for premium users
      salaryNoticeModal.classList.add("visible");
    });

    salaryNoticeCancel.addEventListener("click", () => {
      salaryNoticeModal.classList.remove("visible");
    });

    salaryNoticeConfirm.addEventListener("click", () => {
      salaryNoticeModal.classList.remove("visible");
      sortBySalary = true;
      sortSalaryBtn.classList.add("active");
      apply();
    });

    // Close modal on overlay click
    salaryNoticeModal.addEventListener("click", (e) => {
      if (e.target === salaryNoticeModal) {
        salaryNoticeModal.classList.remove("visible");
      }
    });

    // Populate form with current profile data
    function populateProfileForm() {
      el("profileTotalHours").value = PILOT_PROFILE.totalHours || '';
      el("profilePicHours").value = PILOT_PROFILE.picHours || '';
      el("profileJetTime").value = PILOT_PROFILE.jetTime || '';
      el("profileMultiEngine").value = PILOT_PROFILE.multiEngineTime || '';
      el("profileLicense").value = PILOT_PROFILE.license || 'CPL';

      // Get primary type time
      const primaryType = PILOT_PROFILE.typeRatings[0];
      el("profileTypeTime").value = primaryType ? (PILOT_PROFILE.typeTime[primaryType] || '') : '';

      // Type ratings
      editingTypeRatings = [...PILOT_PROFILE.typeRatings];
      renderTypeRatings();

      // Work rights checkboxes
      document.querySelectorAll('.work-right-cb').forEach(cb => {
        cb.checked = PILOT_PROFILE.workRights.includes(cb.value);
      });
    }

    // Render type rating chips
    function renderTypeRatings() {
      typeRatingsContainer.innerHTML = editingTypeRatings.map(type => `
        <span class="type-rating-chip">
          ${type}
          <button class="remove-rating" data-type="${type}">&times;</button>
        </span>
      `).join('');

      // Add remove handlers
      typeRatingsContainer.querySelectorAll('.remove-rating').forEach(btn => {
        btn.addEventListener('click', () => {
          const typeToRemove = btn.dataset.type;
          editingTypeRatings = editingTypeRatings.filter(t => t !== typeToRemove);
          renderTypeRatings();
        });
      });
    }

    // Add new type rating
    addTypeRatingBtn.addEventListener("click", () => {
      const newType = newTypeRatingInput.value.trim().toUpperCase();
      if (newType && !editingTypeRatings.includes(newType)) {
        editingTypeRatings.push(newType);
        renderTypeRatings();
        newTypeRatingInput.value = '';
      }
    });

    // Enter key to add type rating
    newTypeRatingInput.addEventListener("keypress", (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        addTypeRatingBtn.click();
      }
    });

    // Update profile display string
    function updateProfileDisplay() {
      const totalHrs = PILOT_PROFILE.totalHours.toLocaleString();
      const license = PILOT_PROFILE.license;
      const types = PILOT_PROFILE.typeRatings.length > 0 ? PILOT_PROFILE.typeRatings.join(', ') : 'No type';
      el("profileDisplay").textContent = `${totalHrs}h Total · ${license} · ${types}`;
    }

    // Save profile to Supabase
    saveProfileBtn.addEventListener("click", async () => {
      saveProfileBtn.disabled = true;
      saveProfileBtn.textContent = "Saving...";

      try {
        // Get form values
        const totalHours = parseInt(el("profileTotalHours").value) || 0;
        const picHours = parseInt(el("profilePicHours").value) || 0;
        const jetTime = parseInt(el("profileJetTime").value) || 0;
        const multiEngineTime = parseInt(el("profileMultiEngine").value) || 0;
        const license = el("profileLicense").value;
        const typeTime = parseInt(el("profileTypeTime").value) || 0;

        // Get work rights
        const workRights = [];
        document.querySelectorAll('.work-right-cb:checked').forEach(cb => {
          workRights.push(cb.value);
        });

        // Build type time object
        const typeTimeObj = {};
        editingTypeRatings.forEach((type, idx) => {
          // First type gets the specified hours, others get 0
          typeTimeObj[type] = idx === 0 ? typeTime : 0;
        });

        // Update local profile
        PILOT_PROFILE = {
          totalHours,
          picHours,
          jetTime,
          multiEngineTime,
          typeRatings: editingTypeRatings,
          typeTime: typeTimeObj,
          license,
          workRights
        };

        // Check if user is logged in
        const { data: { session } } = await supabaseClient.auth.getSession();

        if (session) {
          // Save to Supabase
          const { error } = await supabaseClient
            .from('user_profiles')
            .upsert({
              user_id: session.user.id,
              total_hours: totalHours,
              pic_hours: picHours,
              jet_time: jetTime,
              multi_engine_time: multiEngineTime,
              license: license,
              type_ratings: editingTypeRatings,
              type_time: typeTimeObj,
              work_rights: workRights,
              updated_at: new Date().toISOString()
            }, {
              onConflict: 'user_id'
            });

          if (error) {
            console.error('Error saving profile:', error);
            alert('Failed to save profile to database. Changes saved locally.');
          }
        } else {
          // Not logged in - save to localStorage
          localStorage.setItem('pilotProfile', JSON.stringify(PILOT_PROFILE));
        }

        // Update display and re-render jobs
        updateProfileDisplay();
        apply(); // Re-render to update eligibility calculations
        closeModal();

      } catch (err) {
        console.error('Error saving profile:', err);
        alert('An error occurred while saving. Please try again.');
      } finally {
        saveProfileBtn.disabled = false;
        saveProfileBtn.textContent = "Save Profile";
      }
    });

    // Load profile from Supabase or localStorage
    async function loadUserProfile() {
      try {
        const { data: { session } } = await supabaseClient.auth.getSession();

        if (session) {
          // Try to load from Supabase
          const { data, error } = await supabaseClient
            .from('user_profiles')
            .select('*')
            .eq('user_id', session.user.id)
            .single();

          if (data && !error) {
            PILOT_PROFILE = {
              totalHours: data.total_hours || 0,
              picHours: data.pic_hours || 0,
              jetTime: data.jet_time || 0,
              multiEngineTime: data.multi_engine_time || 0,
              typeRatings: data.type_ratings || [],
              typeTime: data.type_time || {},
              license: data.license || 'CPL',
              workRights: data.work_rights || []
            };
            updateProfileDisplay();
          }
        } else {
          // Try localStorage
          const saved = localStorage.getItem('pilotProfile');
          if (saved) {
            PILOT_PROFILE = JSON.parse(saved);
            updateProfileDisplay();
          }
        }
      } catch (err) {
        console.error('Error loading profile:', err);
      }
    }

    // Initialize: fetch jobs from Supabase and render
    async function init() {
      // Load user profile first
      await loadUserProfile();
      // Show loading state
      el("cards").innerHTML = '<div style="padding:40px;text-align:center;color:#6b7890;">Loading jobs...</div>';

      JOBS = await fetchJobs();

      if (JOBS.length === 0) {
        el("cards").innerHTML = '<div style="padding:40px;text-align:center;color:#6b7890;">No jobs found. Check your Supabase connection.</div>';
        return;
      }

      currentFilteredJobs = JOBS;
      const initialBatch = JOBS.slice(0, JOBS_PER_PAGE);
      render(initialBatch);
      updateDisplay();
      updateMatchCount();
    }

    // ============================================
    // MAP SEARCH FUNCTIONALITY
    // ============================================

    // Mapbox access token - Replace with your token from https://mapbox.com
    const MAPBOX_TOKEN = 'pk.eyJ1IjoiYW5kcmlmcmV5cmEiLCJhIjoiY21rNXNkZ2dyMDlmMTNxcjNzb3l0ejdlaCJ9.9DPoZNg_5L_Odkp_ooFeBQ';

    // Location cache to avoid repeated geocoding
    const locationCache = {};

    // Map instance
    let mapInstance = null;
    let mapInitialized = false;

    // Geocode a location string to coordinates using Mapbox Geocoding API
    async function geocodeLocation(locationText) {
      if (!locationText || locationText.trim() === '') return null;

      const cleanLocation = locationText.trim();

      // Check cache first
      if (locationCache[cleanLocation]) {
        return locationCache[cleanLocation];
      }

      try {
        const response = await fetch(
          `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(cleanLocation)}.json?access_token=${MAPBOX_TOKEN}&limit=1`
        );
        const data = await response.json();

        if (data.features && data.features.length > 0) {
          const [lng, lat] = data.features[0].center;
          const result = { lng, lat, name: data.features[0].place_name };
          locationCache[cleanLocation] = result;
          return result;
        }
      } catch (error) {
        console.warn('Geocoding failed for:', cleanLocation, error);
      }

      return null;
    }

    // Get unique locations from current jobs
    function getUniqueLocations() {
      const locationMap = new Map();

      JOBS.forEach(job => {
        if (job.location && job.location.trim()) {
          const loc = job.location.trim();
          if (!locationMap.has(loc)) {
            locationMap.set(loc, []);
          }
          locationMap.get(loc).push(job);
        }
      });

      return locationMap;
    }

    // Build GeoJSON from geocoded locations
    async function buildGeoJSON() {
      const locationMap = getUniqueLocations();
      const features = [];
      let geocodedCount = 0;
      let failedCount = 0;

      const loadingText = el('mapLoading').querySelector('.map-loading-text');
      const totalLocations = locationMap.size;
      let processedCount = 0;

      // Process locations in parallel batches
      const entries = Array.from(locationMap.entries());
      const batchSize = 5; // Geocode 5 at a time to avoid rate limits

      for (let i = 0; i < entries.length; i += batchSize) {
        const batch = entries.slice(i, i + batchSize);

        const results = await Promise.all(
          batch.map(async ([locationText, jobs]) => {
            const coords = await geocodeLocation(locationText);
            processedCount++;
            loadingText.textContent = `Geocoding locations... (${processedCount}/${totalLocations})`;

            if (coords) {
              geocodedCount++;
              return {
                type: 'Feature',
                geometry: {
                  type: 'Point',
                  coordinates: [coords.lng, coords.lat]
                },
                properties: {
                  location: locationText,
                  jobCount: jobs.length,
                  jobs: jobs.map(j => ({
                    id: j.id,
                    title: j.title,
                    org: j.org,
                    applyUrl: j.applyUrl
                  }))
                }
              };
            } else {
              failedCount++;
              return null;
            }
          })
        );

        features.push(...results.filter(Boolean));
      }

      // Update stats
      const totalJobs = features.reduce((sum, f) => sum + f.properties.jobCount, 0);
      el('mapStats').innerHTML = `<strong>${totalJobs}</strong> jobs across <strong>${geocodedCount}</strong> locations`;

      return {
        type: 'FeatureCollection',
        features
      };
    }

    // Initialize Mapbox map
    async function initMap() {
      if (MAPBOX_TOKEN === 'YOUR_MAPBOX_ACCESS_TOKEN_HERE') {
        el('mapLoading').innerHTML = `
          <div style="text-align: center; padding: 20px;">
            <div style="font-size: 48px; margin-bottom: 16px;">🗺️</div>
            <h3 style="margin: 0 0 8px; color: #0e1830;">Mapbox Token Required</h3>
            <p style="color: #6b7890; margin: 0; max-width: 400px;">
              To enable the map feature, add your Mapbox access token in the JavaScript code.
              <br><br>
              Get a free token at <a href="https://mapbox.com" target="_blank" style="color: #1b66ff;">mapbox.com</a>
            </p>
          </div>
        `;
        return;
      }

      if (mapInitialized && mapInstance) {
        // Map already exists, just update data
        await updateMapData();
        el('mapLoading').classList.add('hidden');
        return;
      }

      try {
        mapboxgl.accessToken = MAPBOX_TOKEN;

        mapInstance = new mapboxgl.Map({
          container: 'mapbox-map',
          style: 'mapbox://styles/mapbox/satellite-streets-v12',
          center: [0, 25],
          zoom: 1.8,
          projection: 'mercator'
        });

        mapInstance.addControl(new mapboxgl.NavigationControl(), 'top-right');

        mapInstance.on('load', async () => {
          await updateMapData();
          el('mapLoading').classList.add('hidden');
          mapInitialized = true;
        });

      } catch (error) {
        console.error('Map initialization failed:', error);
        el('mapLoading').innerHTML = `
          <div style="text-align: center; padding: 20px;">
            <div style="font-size: 48px; margin-bottom: 16px;">⚠️</div>
            <h3 style="margin: 0 0 8px; color: #0e1830;">Map Failed to Load</h3>
            <p style="color: #6b7890; margin: 0;">Please check your Mapbox token and try again.</p>
          </div>
        `;
      }
    }

    // Update map data (used for initial load and refresh)
    async function updateMapData() {
      const geojson = await buildGeoJSON();

      // Remove existing source and layers if they exist
      if (mapInstance.getSource('jobs')) {
        mapInstance.removeLayer('clusters');
        mapInstance.removeLayer('cluster-count');
        mapInstance.removeLayer('unclustered-point');
        mapInstance.removeSource('jobs');
      }

      // Add clustered source
      mapInstance.addSource('jobs', {
        type: 'geojson',
        data: geojson,
        cluster: true,
        clusterMaxZoom: 14,
        clusterRadius: 50
      });

      // Cluster circles
      mapInstance.addLayer({
        id: 'clusters',
        type: 'circle',
        source: 'jobs',
        filter: ['has', 'point_count'],
        paint: {
          'circle-color': [
            'step',
            ['get', 'point_count'],
            '#1b66ff',   // Blue for small clusters
            10, '#00b7a8', // Teal for medium clusters
            30, '#0b2a6f'  // Navy for large clusters
          ],
          'circle-radius': [
            'step',
            ['get', 'point_count'],
            18,   // Small cluster
            10, 24, // Medium cluster
            30, 32  // Large cluster
          ],
          'circle-stroke-width': 3,
          'circle-stroke-color': '#ffffff'
        }
      });

      // Cluster count labels
      mapInstance.addLayer({
        id: 'cluster-count',
        type: 'symbol',
        source: 'jobs',
        filter: ['has', 'point_count'],
        layout: {
          'text-field': ['get', 'point_count_abbreviated'],
          'text-font': ['DIN Pro Medium', 'Arial Unicode MS Bold'],
          'text-size': 13
        },
        paint: {
          'text-color': '#ffffff'
        }
      });

      // Individual job pins
      mapInstance.addLayer({
        id: 'unclustered-point',
        type: 'circle',
        source: 'jobs',
        filter: ['!', ['has', 'point_count']],
        paint: {
          'circle-color': '#1b66ff',
          'circle-radius': 10,
          'circle-stroke-width': 3,
          'circle-stroke-color': '#ffffff'
        }
      });

      // Click on cluster to zoom in
      mapInstance.on('click', 'clusters', (e) => {
        const features = mapInstance.queryRenderedFeatures(e.point, { layers: ['clusters'] });
        const clusterId = features[0].properties.cluster_id;
        mapInstance.getSource('jobs').getClusterExpansionZoom(clusterId, (err, zoom) => {
          if (err) return;
          mapInstance.easeTo({
            center: features[0].geometry.coordinates,
            zoom: zoom
          });
        });
      });

      // Click on individual point to show popup
      mapInstance.on('click', 'unclustered-point', (e) => {
        const coordinates = e.features[0].geometry.coordinates.slice();
        const props = e.features[0].properties;
        const location = props.location;
        const jobs = JSON.parse(props.jobs);
        const jobCount = props.jobCount;

        // Store jobs for this location globally for click handler
        window.currentMapJobs = jobs;
        window.currentMapLocation = location;

        // Build popup HTML with clickable job items
        const jobListHTML = jobs.slice(0, 5).map((j, idx) => `
          <div class="job-popup-item" style="cursor:pointer;" onclick="showJobPreview(${idx})">
            <div class="job-popup-title">${j.title}</div>
            <div class="job-popup-airline">${j.org}</div>
          </div>
        `).join('');

        const moreText = jobCount > 5 ? `<div style="padding:8px 16px;font-size:11px;color:#6b7890;">+ ${jobCount - 5} more jobs</div>` : '';

        new mapboxgl.Popup({ offset: 15, maxWidth: '320px' })
          .setLngLat(coordinates)
          .setHTML(`
            <div class="job-popup">
              <div class="job-popup-header">
                <div class="job-popup-location">${location}</div>
                <div class="job-popup-count">${jobCount} job${jobCount > 1 ? 's' : ''} available</div>
              </div>
              <div class="job-popup-body">
                ${jobListHTML}
                ${moreText}
              </div>
              <div class="job-popup-footer">
                <button class="job-popup-view-btn" onclick="showJobPreview(0)">
                  View ${jobCount > 1 ? 'Jobs' : 'Job'}
                </button>
              </div>
            </div>
          `)
          .addTo(mapInstance);
      });

      // Change cursor on hover
      mapInstance.on('mouseenter', 'clusters', () => {
        mapInstance.getCanvas().style.cursor = 'pointer';
      });
      mapInstance.on('mouseleave', 'clusters', () => {
        mapInstance.getCanvas().style.cursor = '';
      });
      mapInstance.on('mouseenter', 'unclustered-point', () => {
        mapInstance.getCanvas().style.cursor = 'pointer';
      });
      mapInstance.on('mouseleave', 'unclustered-point', () => {
        mapInstance.getCanvas().style.cursor = '';
      });
    }

    // Show job preview panel at bottom of map
    function showJobPreview(jobIndex) {
      const job = window.currentMapJobs[jobIndex];
      if (!job) return;

      // Find full job data from JOBS array
      const j = JOBS.find(x => x.id === job.id) || job;

      // Render the full job card HTML (same as main page)
      const cardHTML = `
        <article class="card${j.visa ? ' visa-sponsor' : ''}" style="position:relative;">
          <div class="company-logo">
            <img src="${j.logo || ''}" alt="${j.org}" onerror="this.parentElement.textContent='${iconLetter(j.org)}'">
          </div>

          <h2 class="job-title">${j.title}<span class="airline-name">${j.org}</span></h2>

          <div class="apply-container">
            <a href="${j.applyUrl}" class="apply-btn" target="_blank" rel="noopener noreferrer">Apply Now</a>
          </div>

          <div class="attributes">
            ${renderAttributes(j)}
          </div>

          <div class="stats-row">
            ${renderStatsRow(j)}
          </div>

          <div class="expand-link" onclick="toggleDescription(this)">
            See job description
            <div class="arrow-v"></div>
          </div>

          <div class="job-description">
            ${j.description ? `<div class="job-description-content">${j.description}</div>` : ''}
            ${j.requirements ? `
              <div class="requirements-title">Requirements</div>
              ${renderRequirements(j.requirements)}
            ` : ''}
            ${!j.description && !j.requirements ? `<div class="job-description-content">No description available.</div>` : ''}
          </div>
        </article>
      `;

      el('mapJobCardContainer').innerHTML = cardHTML;

      // Show the preview panel
      el('mapJobPreview').classList.add('visible');
    }

    // Hide job preview panel
    function hideJobPreview() {
      el('mapJobPreview').classList.remove('visible');
    }

    // Filter jobs by location (called from popup)
    function filterByLocation(location) {
      // Close map overlay
      closeMap();

      // Set location filter (find the location select and set value)
      const locSelect = el('loc');
      if (locSelect) {
        // Check if option exists, if not just search
        const options = Array.from(locSelect.options);
        const matchingOption = options.find(opt => opt.value === location || opt.textContent === location);
        if (matchingOption) {
          locSelect.value = matchingOption.value;
        }
      }

      // Apply filter by searching for the location
      const searchInput = el('q');
      if (searchInput) {
        searchInput.value = location;
      }

      // Trigger filter application
      apply();
    }

    // Open map overlay
    function openMap() {
      el('mapOverlay').classList.add('visible');
      document.body.style.overflow = 'hidden';

      // Reset loading state
      el('mapLoading').classList.remove('hidden');
      el('mapLoading').innerHTML = `
        <div class="map-loading-spinner"></div>
        <div class="map-loading-text">Loading map...</div>
      `;

      // Initialize or update map
      setTimeout(() => {
        initMap();
        if (mapInstance) {
          mapInstance.resize();
        }
      }, 100);
    }

    // Close map overlay
    function closeMap() {
      el('mapOverlay').classList.remove('visible');
      document.body.style.overflow = '';
      hideJobPreview();
    }

    // Map event listeners
    el('openMapBtn').addEventListener('click', openMap);
    el('closeMapBtn').addEventListener('click', closeMap);
    el('closePreview').addEventListener('click', hideJobPreview);
    el('mapOverlay').addEventListener('click', (e) => {
      if (e.target === el('mapOverlay')) closeMap();
    });

    // Close map with Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && el('mapOverlay').classList.contains('visible')) {
        closeMap();
      }
    });

    init();
  </script>
</body>
</html>